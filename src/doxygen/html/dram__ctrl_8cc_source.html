<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>gem5: mem/dram_ctrl.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>mem/dram_ctrl.cc</h1><a href="dram__ctrl_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2010-2014 ARM Limited</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * The license below extends only to copyright in the software and shall</span>
<a name="l00006"></a>00006 <span class="comment"> * not be construed as granting a license to any other intellectual</span>
<a name="l00007"></a>00007 <span class="comment"> * property including but not limited to intellectual property relating</span>
<a name="l00008"></a>00008 <span class="comment"> * to a hardware implementation of the functionality of the software</span>
<a name="l00009"></a>00009 <span class="comment"> * licensed hereunder.  You may use the software subject to the license</span>
<a name="l00010"></a>00010 <span class="comment"> * terms below provided that you ensure that this notice is replicated</span>
<a name="l00011"></a>00011 <span class="comment"> * unmodified and in its entirety in all distributions of the software,</span>
<a name="l00012"></a>00012 <span class="comment"> * modified or unmodified, in source code or in binary form.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * Copyright (c) 2013 Amin Farmahini-Farahani</span>
<a name="l00015"></a>00015 <span class="comment"> * All rights reserved.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00018"></a>00018 <span class="comment"> * modification, are permitted provided that the following conditions are</span>
<a name="l00019"></a>00019 <span class="comment"> * met: redistributions of source code must retain the above copyright</span>
<a name="l00020"></a>00020 <span class="comment"> * notice, this list of conditions and the following disclaimer;</span>
<a name="l00021"></a>00021 <span class="comment"> * redistributions in binary form must reproduce the above copyright</span>
<a name="l00022"></a>00022 <span class="comment"> * notice, this list of conditions and the following disclaimer in the</span>
<a name="l00023"></a>00023 <span class="comment"> * documentation and/or other materials provided with the distribution;</span>
<a name="l00024"></a>00024 <span class="comment"> * neither the name of the copyright holders nor the names of its</span>
<a name="l00025"></a>00025 <span class="comment"> * contributors may be used to endorse or promote products derived from</span>
<a name="l00026"></a>00026 <span class="comment"> * this software without specific prior written permission.</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00029"></a>00029 <span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00030"></a>00030 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00031"></a>00031 <span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="l00032"></a>00032 <span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00033"></a>00033 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="l00034"></a>00034 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00035"></a>00035 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00036"></a>00036 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00037"></a>00037 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00038"></a>00038 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00039"></a>00039 <span class="comment"> *</span>
<a name="l00040"></a>00040 <span class="comment"> * Authors: Andreas Hansson</span>
<a name="l00041"></a>00041 <span class="comment"> *          Ani Udipi</span>
<a name="l00042"></a>00042 <span class="comment"> *          Neha Agarwal</span>
<a name="l00043"></a>00043 <span class="comment"> *          Omar Naji</span>
<a name="l00044"></a>00044 <span class="comment"> */</span>
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="bitfield_8hh.html">base/bitfield.hh</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="base_2trace_8hh.html">base/trace.hh</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;debug/DRAM.hh&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;debug/DRAMPower.hh&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;debug/DRAMState.hh&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;debug/Drain.hh&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="dram__ctrl_8hh.html" title="DRAMCtrl declaration.">mem/dram_ctrl.hh</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="sim_2system_8hh.html">sim/system.hh</a>&quot;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="keyword">using namespace </span>std;
<a name="l00056"></a>00056 <span class="keyword">using namespace </span>Data;
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="classDRAMCtrl.html#a2e87a3a11f35da670f669bc771a11679">00058</a> <a class="code" href="classDRAMCtrl.html#a2e87a3a11f35da670f669bc771a11679">DRAMCtrl::DRAMCtrl</a>(<span class="keyword">const</span> DRAMCtrlParams* <a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>) :
<a name="l00059"></a>00059     <a class="code" href="classAbstractMemory.html" title="An abstract memory represents a contiguous block of physical memory, with an associated...">AbstractMemory</a>(p),
<a name="l00060"></a>00060     port(<a class="code" href="trace_8cc.html#a166fa10b86d8faa127fb7c78191e3e60">name</a>() + <span class="stringliteral">&quot;.port&quot;</span>, *this), isTimingMode(false),
<a name="l00061"></a>00061     retryRdReq(false), retryWrReq(false),
<a name="l00062"></a>00062     busState(READ),
<a name="l00063"></a>00063     nextReqEvent(this), respondEvent(this),
<a name="l00064"></a>00064     drainManager(NULL),
<a name="l00065"></a>00065     deviceSize(p-&gt;device_size),
<a name="l00066"></a>00066     deviceBusWidth(p-&gt;device_bus_width), burstLength(p-&gt;burst_length),
<a name="l00067"></a>00067     deviceRowBufferSize(p-&gt;device_rowbuffer_size),
<a name="l00068"></a>00068     devicesPerRank(p-&gt;devices_per_rank),
<a name="l00069"></a>00069     burstSize((devicesPerRank * burstLength * deviceBusWidth) / 8),
<a name="l00070"></a>00070     rowBufferSize(devicesPerRank * deviceRowBufferSize),
<a name="l00071"></a>00071     columnsPerRowBuffer(rowBufferSize / burstSize),
<a name="l00072"></a>00072     columnsPerStripe(range.interleaved() ? range.<a class="code" href="namespaceX86ISA.html#a4037b1891345dbb729af0b7a594c7553">granularity</a>() / burstSize : 1),
<a name="l00073"></a>00073     ranksPerChannel(p-&gt;ranks_per_channel),
<a name="l00074"></a>00074     bankGroupsPerRank(p-&gt;bank_groups_per_rank),
<a name="l00075"></a>00075     bankGroupArch(p-&gt;bank_groups_per_rank &gt; 0),
<a name="l00076"></a>00076     banksPerRank(p-&gt;banks_per_rank), channels(p-&gt;channels), rowsPerBank(0),
<a name="l00077"></a>00077     readBufferSize(p-&gt;read_buffer_size),
<a name="l00078"></a>00078     writeBufferSize(p-&gt;write_buffer_size),
<a name="l00079"></a>00079     writeHighThreshold(writeBufferSize * p-&gt;write_high_thresh_perc / 100.0),
<a name="l00080"></a>00080     writeLowThreshold(writeBufferSize * p-&gt;write_low_thresh_perc / 100.0),
<a name="l00081"></a>00081     minWritesPerSwitch(p-&gt;min_writes_per_switch),
<a name="l00082"></a>00082     writesThisTime(0), readsThisTime(0),
<a name="l00083"></a>00083     tCK(p-&gt;tCK), tWTR(p-&gt;tWTR), tRTW(p-&gt;tRTW), tCS(p-&gt;tCS), tBURST(p-&gt;tBURST),
<a name="l00084"></a>00084     tCCD_L(p-&gt;tCCD_L), tRCD(p-&gt;tRCD), tCL(p-&gt;tCL), tRP(p-&gt;tRP), tRAS(p-&gt;tRAS),
<a name="l00085"></a>00085     tWR(p-&gt;tWR), tRTP(p-&gt;tRTP), tRFC(p-&gt;tRFC), tREFI(p-&gt;tREFI), tRRD(p-&gt;tRRD),
<a name="l00086"></a>00086     tRRD_L(p-&gt;tRRD_L), tXAW(p-&gt;tXAW), activationLimit(p-&gt;activation_limit),
<a name="l00087"></a>00087     memSchedPolicy(p-&gt;mem_sched_policy), addrMapping(p-&gt;addr_mapping),
<a name="l00088"></a>00088     pageMgmt(p-&gt;page_policy),
<a name="l00089"></a>00089     maxAccessesPerRow(p-&gt;max_accesses_per_row),
<a name="l00090"></a>00090     frontendLatency(p-&gt;static_frontend_latency),
<a name="l00091"></a>00091     backendLatency(p-&gt;static_backend_latency),
<a name="l00092"></a>00092     busBusyUntil(0), prevArrival(0),
<a name="l00093"></a>00093     nextReqTime(0), activeRank(0), timeStampOffset(0)
<a name="l00094"></a>00094 {
<a name="l00095"></a>00095     <span class="comment">// sanity check the ranks since we rely on bit slicing for the</span>
<a name="l00096"></a>00096     <span class="comment">// address decoding</span>
<a name="l00097"></a>00097     <a class="code" href="base_2misc_8hh.html#a2127c4f5f05a25aea5ffc00677fc3ffe" title="Conditional fatal macro that checks the supplied condition and only causes a fatal...">fatal_if</a>(!<a class="code" href="intmath_8hh.html#a841bd9f3c8fcf1527fd307b6aeb9382a">isPowerOf2</a>(<a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>), <span class="stringliteral">&quot;DRAM rank count of %d is not &quot;</span>
<a name="l00098"></a>00098              <span class="stringliteral">&quot;allowed, must be a power of two\n&quot;</span>, <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++) {
<a name="l00101"></a>00101         <a class="code" href="classDRAMCtrl_1_1Rank.html" title="Rank class includes a vector of banks.">Rank</a>* rank = <span class="keyword">new</span> <a class="code" href="classDRAMCtrl_1_1Rank.html" title="Rank class includes a vector of banks.">Rank</a>(*<span class="keyword">this</span>, p);
<a name="l00102"></a>00102         <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>.push_back(rank);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104         rank-&gt;<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.resize(<a class="code" href="classDRAMCtrl.html#a672f14358c685122136d12a52eda5056">activationLimit</a>, 0);
<a name="l00105"></a>00105         rank-&gt;<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>.resize(<a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>);
<a name="l00106"></a>00106         rank-&gt;<a class="code" href="classDRAMCtrl_1_1Rank.html#ac2a0c59264a34d8d6712ac4e763cd915" title="Current Rank index.">rank</a> = <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a> = 0; <a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a> &lt; <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>; <a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>++) {
<a name="l00109"></a>00109             rank-&gt;<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>[<a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>].bank = <a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>;
<a name="l00110"></a>00110             <span class="comment">// GDDR addressing of banks to BG is linear.</span>
<a name="l00111"></a>00111             <span class="comment">// Here we assume that all DRAM generations address bank groups as</span>
<a name="l00112"></a>00112             <span class="comment">// follows:</span>
<a name="l00113"></a>00113             <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a0f8e4a158ae37c8d2925a9fa327691f0">bankGroupArch</a>) {
<a name="l00114"></a>00114                 <span class="comment">// Simply assign lower bits to bank group in order to</span>
<a name="l00115"></a>00115                 <span class="comment">// rotate across bank groups as banks are incremented</span>
<a name="l00116"></a>00116                 <span class="comment">// e.g. with 4 banks per bank group and 16 banks total:</span>
<a name="l00117"></a>00117                 <span class="comment">//    banks 0,4,8,12  are in bank group 0</span>
<a name="l00118"></a>00118                 <span class="comment">//    banks 1,5,9,13  are in bank group 1</span>
<a name="l00119"></a>00119                 <span class="comment">//    banks 2,6,10,14 are in bank group 2</span>
<a name="l00120"></a>00120                 <span class="comment">//    banks 3,7,11,15 are in bank group 3</span>
<a name="l00121"></a>00121                 rank-&gt;<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>[<a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>].bankgr = <a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a> % <a class="code" href="classDRAMCtrl.html#a146a0c2b6b2fc67b55d32c07336835ee">bankGroupsPerRank</a>;
<a name="l00122"></a>00122             } <span class="keywordflow">else</span> {
<a name="l00123"></a>00123                 <span class="comment">// No bank groups; simply assign to bank number</span>
<a name="l00124"></a>00124                 rank-&gt;<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>[<a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>].bankgr = <a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>;
<a name="l00125"></a>00125             }
<a name="l00126"></a>00126         }
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="comment">// perform a basic check of the write thresholds</span>
<a name="l00130"></a>00130     <span class="keywordflow">if</span> (p-&gt;write_low_thresh_perc &gt;= p-&gt;write_high_thresh_perc)
<a name="l00131"></a>00131         <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Write buffer low threshold %d must be smaller than the &quot;</span>
<a name="l00132"></a>00132               <span class="stringliteral">&quot;high threshold %d\n&quot;</span>, p-&gt;write_low_thresh_perc,
<a name="l00133"></a>00133               p-&gt;write_high_thresh_perc);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="comment">// determine the rows per bank by looking at the total capacity</span>
<a name="l00136"></a>00136     uint64_t capacity = <a class="code" href="base_2types_8hh.html#adcc3cf526a71c0dfaae020d432c78b83" title="uint64_t constant">ULL</a>(1) &lt;&lt; <a class="code" href="intmath_8hh.html#a85317359c479b5019fc3608810682fb0">ceilLog2</a>(<a class="code" href="classAbstractMemory.html#ac59f603c2428f8cdb228997baa5b9768" title="Get the memory size.">AbstractMemory::size</a>());
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="comment">// determine the dram actual capacity from the DRAM config in Mbytes</span>
<a name="l00139"></a>00139     uint64_t deviceCapacity = <a class="code" href="classDRAMCtrl.html#a377540fe2bbf8f3465c13f27f37d228c" title="The following are basic design parameters of the memory controller, and are initialized...">deviceSize</a> / (1024 * 1024) * <a class="code" href="classDRAMCtrl.html#a72d0aec53605ee36ff410dd8970a0eaa">devicesPerRank</a> *
<a name="l00140"></a>00140         ranksPerChannel;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <span class="comment">// if actual DRAM size does not match memory capacity in system warn!</span>
<a name="l00143"></a>00143     <span class="keywordflow">if</span> (deviceCapacity != capacity / (1024 * 1024))
<a name="l00144"></a>00144         <a class="code" href="base_2misc_8hh.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;DRAM device capacity (%d Mbytes) does not match the &quot;</span>
<a name="l00145"></a>00145              <span class="stringliteral">&quot;address range assigned (%d Mbytes)\n&quot;</span>, deviceCapacity,
<a name="l00146"></a>00146              capacity / (1024 * 1024));
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Memory capacity %lld (%lld) bytes\n&quot;</span>, capacity,
<a name="l00149"></a>00149             <a class="code" href="classAbstractMemory.html#ac59f603c2428f8cdb228997baa5b9768" title="Get the memory size.">AbstractMemory::size</a>());
<a name="l00150"></a>00150 
<a name="l00151"></a>00151     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Row buffer size %d bytes with %d columns per row buffer\n&quot;</span>,
<a name="l00152"></a>00152             <a class="code" href="classDRAMCtrl.html#a1bda0f1e662b24759e050ed828b9f0c2">rowBufferSize</a>, <a class="code" href="classDRAMCtrl.html#ae187868f5c8a209363ab6b5d0ad721e6">columnsPerRowBuffer</a>);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <a class="code" href="classDRAMCtrl.html#ad29fab6a3b46686b09be87f38049dee0">rowsPerBank</a> = capacity / (<a class="code" href="classDRAMCtrl.html#a1bda0f1e662b24759e050ed828b9f0c2">rowBufferSize</a> * <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a> * ranksPerChannel);
<a name="l00155"></a>00155 
<a name="l00156"></a>00156     <span class="comment">// some basic sanity checks</span>
<a name="l00157"></a>00157     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a845143aad659120f25f1d26c06574660">tREFI</a> &lt;= <a class="code" href="classDRAMCtrl.html#a1edd216a091aa2ec675985c16134d626">tRP</a> || <a class="code" href="classDRAMCtrl.html#a845143aad659120f25f1d26c06574660">tREFI</a> &lt;= <a class="code" href="classDRAMCtrl.html#aad8f72c5b11730c9346de00a53d108fe">tRFC</a>) {
<a name="l00158"></a>00158         <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;tREFI (%d) must be larger than tRP (%d) and tRFC (%d)\n&quot;</span>,
<a name="l00159"></a>00159               <a class="code" href="classDRAMCtrl.html#a845143aad659120f25f1d26c06574660">tREFI</a>, <a class="code" href="classDRAMCtrl.html#a1edd216a091aa2ec675985c16134d626">tRP</a>, <a class="code" href="classDRAMCtrl.html#aad8f72c5b11730c9346de00a53d108fe">tRFC</a>);
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162     <span class="comment">// basic bank group architecture checks -&gt;</span>
<a name="l00163"></a>00163     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a0f8e4a158ae37c8d2925a9fa327691f0">bankGroupArch</a>) {
<a name="l00164"></a>00164         <span class="comment">// must have at least one bank per bank group</span>
<a name="l00165"></a>00165         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a146a0c2b6b2fc67b55d32c07336835ee">bankGroupsPerRank</a> &gt; <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>) {
<a name="l00166"></a>00166             <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;banks per rank (%d) must be equal to or larger than &quot;</span>
<a name="l00167"></a>00167                   <span class="stringliteral">&quot;banks groups per rank (%d)\n&quot;</span>,
<a name="l00168"></a>00168                   <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>, <a class="code" href="classDRAMCtrl.html#a146a0c2b6b2fc67b55d32c07336835ee">bankGroupsPerRank</a>);
<a name="l00169"></a>00169         }
<a name="l00170"></a>00170         <span class="comment">// must have same number of banks in each bank group</span>
<a name="l00171"></a>00171         <span class="keywordflow">if</span> ((<a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a> % <a class="code" href="classDRAMCtrl.html#a146a0c2b6b2fc67b55d32c07336835ee">bankGroupsPerRank</a>) != 0) {
<a name="l00172"></a>00172             <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Banks per rank (%d) must be evenly divisible by bank groups &quot;</span>
<a name="l00173"></a>00173                   <span class="stringliteral">&quot;per rank (%d) for equal banks per bank group\n&quot;</span>,
<a name="l00174"></a>00174                   <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>, bankGroupsPerRank);
<a name="l00175"></a>00175         }
<a name="l00176"></a>00176         <span class="comment">// tCCD_L should be greater than minimal, back-to-back burst delay</span>
<a name="l00177"></a>00177         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a5a598180d4af2be89f5f209b40b9d03e">tCCD_L</a> &lt;= <a class="code" href="classDRAMCtrl.html#aab4d9d3128f0373a72c28be6a4d02923">tBURST</a>) {
<a name="l00178"></a>00178             <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;tCCD_L (%d) should be larger than tBURST (%d) when &quot;</span>
<a name="l00179"></a>00179                   <span class="stringliteral">&quot;bank groups per rank (%d) is greater than 1\n&quot;</span>,
<a name="l00180"></a>00180                   <a class="code" href="classDRAMCtrl.html#a5a598180d4af2be89f5f209b40b9d03e">tCCD_L</a>, <a class="code" href="classDRAMCtrl.html#aab4d9d3128f0373a72c28be6a4d02923">tBURST</a>, bankGroupsPerRank);
<a name="l00181"></a>00181         }
<a name="l00182"></a>00182         <span class="comment">// tRRD_L is greater than minimal, same bank group ACT-to-ACT delay</span>
<a name="l00183"></a>00183         <span class="comment">// some datasheets might specify it equal to tRRD</span>
<a name="l00184"></a>00184         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a45b442edfd5e743e0ab20184e03b6ea2">tRRD_L</a> &lt; <a class="code" href="classDRAMCtrl.html#a534e8ffd35d85f2016c2c98d0b50cf2c">tRRD</a>) {
<a name="l00185"></a>00185             <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;tRRD_L (%d) should be larger than tRRD (%d) when &quot;</span>
<a name="l00186"></a>00186                   <span class="stringliteral">&quot;bank groups per rank (%d) is greater than 1\n&quot;</span>,
<a name="l00187"></a>00187                   <a class="code" href="classDRAMCtrl.html#a45b442edfd5e743e0ab20184e03b6ea2">tRRD_L</a>, <a class="code" href="classDRAMCtrl.html#a534e8ffd35d85f2016c2c98d0b50cf2c">tRRD</a>, bankGroupsPerRank);
<a name="l00188"></a>00188         }
<a name="l00189"></a>00189     }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="keywordtype">void</span>
<a name="l00194"></a><a class="code" href="classDRAMCtrl.html#a088ce3c7956af09dc2895f814d2f76fd">00194</a> <a class="code" href="classDRAMCtrl.html#a088ce3c7956af09dc2895f814d2f76fd" title="Initialise this memory.">DRAMCtrl::init</a>()
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196     <a class="code" href="classDRAMCtrl.html#a088ce3c7956af09dc2895f814d2f76fd" title="Initialise this memory.">AbstractMemory::init</a>();
<a name="l00197"></a>00197 
<a name="l00198"></a>00198    <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl.html#a87ee1aa46b80d77aea809cf3d00dbc31" title="Our incoming port, for a multi-ported controller add a crossbar in front of it.">port</a>.<a class="code" href="classBaseSlavePort.html#abcc0500ed927088c400b25abecae5c8c">isConnected</a>()) {
<a name="l00199"></a>00199         <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;DRAMCtrl %s is unconnected!\n&quot;</span>, <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00200"></a>00200     } <span class="keywordflow">else</span> {
<a name="l00201"></a>00201         <a class="code" href="classDRAMCtrl.html#a87ee1aa46b80d77aea809cf3d00dbc31" title="Our incoming port, for a multi-ported controller add a crossbar in front of it.">port</a>.<a class="code" href="classSlavePort.html#a335e5649623f9976259f34aa10bbebdd" title="Called by the owner to send a range change.">sendRangeChange</a>();
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204     <span class="comment">// a bit of sanity checks on the interleaving, save it for here to</span>
<a name="l00205"></a>00205     <span class="comment">// ensure that the system pointer is initialised</span>
<a name="l00206"></a>00206     <span class="keywordflow">if</span> (<a class="code" href="classAbstractMemory.html#a461dae592dd96034616faabf931d2fdf">range</a>.<a class="code" href="classAddrRange.html#a14afd5b81ec02effb3b2a9100b3611e7" title="Determine if the range is interleaved or not.">interleaved</a>()) {
<a name="l00207"></a>00207         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a2c555ba14d5fb51ab6857af93a274051">channels</a> != <a class="code" href="classAbstractMemory.html#a461dae592dd96034616faabf931d2fdf">range</a>.<a class="code" href="classAddrRange.html#add428312a9dced4977bbdb36a988e2bf" title="Determine the number of interleaved address stripes this range is part of.">stripes</a>())
<a name="l00208"></a>00208             <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;%s has %d interleaved address stripes but %d channel(s)\n&quot;</span>,
<a name="l00209"></a>00209                   <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>(), <a class="code" href="classAbstractMemory.html#a461dae592dd96034616faabf931d2fdf">range</a>.<a class="code" href="classAddrRange.html#add428312a9dced4977bbdb36a988e2bf" title="Determine the number of interleaved address stripes this range is part of.">stripes</a>(), <a class="code" href="classDRAMCtrl.html#a2c555ba14d5fb51ab6857af93a274051">channels</a>);
<a name="l00210"></a>00210 
<a name="l00211"></a>00211         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a062d374384c092ae901cd1316684799b">addrMapping</a> == Enums::RoRaBaChCo) {
<a name="l00212"></a>00212             <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a1bda0f1e662b24759e050ed828b9f0c2">rowBufferSize</a> != <a class="code" href="classAbstractMemory.html#a461dae592dd96034616faabf931d2fdf">range</a>.<a class="code" href="classAddrRange.html#aab600318c0d3d5922c518f7691410b93" title="Determing the interleaving granularity of the range.">granularity</a>()) {
<a name="l00213"></a>00213                 <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Channel interleaving of %s doesn&apos;t match RoRaBaChCo &quot;</span>
<a name="l00214"></a>00214                       <span class="stringliteral">&quot;address map\n&quot;</span>, <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00215"></a>00215             }
<a name="l00216"></a>00216         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a062d374384c092ae901cd1316684799b">addrMapping</a> == Enums::RoRaBaCoCh ||
<a name="l00217"></a>00217                    <a class="code" href="classDRAMCtrl.html#a062d374384c092ae901cd1316684799b">addrMapping</a> == Enums::RoCoRaBaCh) {
<a name="l00218"></a>00218             <span class="comment">// for the interleavings with channel bits in the bottom,</span>
<a name="l00219"></a>00219             <span class="comment">// if the system uses a channel striping granularity that</span>
<a name="l00220"></a>00220             <span class="comment">// is larger than the DRAM burst size, then map the</span>
<a name="l00221"></a>00221             <span class="comment">// sequential accesses within a stripe to a number of</span>
<a name="l00222"></a>00222             <span class="comment">// columns in the DRAM, effectively placing some of the</span>
<a name="l00223"></a>00223             <span class="comment">// lower-order column bits as the least-significant bits</span>
<a name="l00224"></a>00224             <span class="comment">// of the address (above the ones denoting the burst size)</span>
<a name="l00225"></a>00225             assert(<a class="code" href="classDRAMCtrl.html#a2c4b08a55047b3c2ca605d75843fba4e">columnsPerStripe</a> &gt;= 1);
<a name="l00226"></a>00226 
<a name="l00227"></a>00227             <span class="comment">// channel striping has to be done at a granularity that</span>
<a name="l00228"></a>00228             <span class="comment">// is equal or larger to a cache line</span>
<a name="l00229"></a>00229             <span class="keywordflow">if</span> (<a class="code" href="classAbstractMemory.html#a3982da9ac617ec2f310f4d4740615804" title="read the system pointer Implemented for completeness with the setter">system</a>()-&gt;cacheLineSize() &gt; <a class="code" href="classAbstractMemory.html#a461dae592dd96034616faabf931d2fdf">range</a>.<a class="code" href="classAddrRange.html#aab600318c0d3d5922c518f7691410b93" title="Determing the interleaving granularity of the range.">granularity</a>()) {
<a name="l00230"></a>00230                 <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Channel interleaving of %s must be at least as large &quot;</span>
<a name="l00231"></a>00231                       <span class="stringliteral">&quot;as the cache line size\n&quot;</span>, <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00232"></a>00232             }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234             <span class="comment">// ...and equal or smaller than the row-buffer size</span>
<a name="l00235"></a>00235             <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a1bda0f1e662b24759e050ed828b9f0c2">rowBufferSize</a> &lt; <a class="code" href="classAbstractMemory.html#a461dae592dd96034616faabf931d2fdf">range</a>.<a class="code" href="classAddrRange.html#aab600318c0d3d5922c518f7691410b93" title="Determing the interleaving granularity of the range.">granularity</a>()) {
<a name="l00236"></a>00236                 <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Channel interleaving of %s must be at most as large &quot;</span>
<a name="l00237"></a>00237                       <span class="stringliteral">&quot;as the row-buffer size\n&quot;</span>, <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00238"></a>00238             }
<a name="l00239"></a>00239             <span class="comment">// this is essentially the check above, so just to be sure</span>
<a name="l00240"></a>00240             assert(<a class="code" href="classDRAMCtrl.html#a2c4b08a55047b3c2ca605d75843fba4e">columnsPerStripe</a> &lt;= <a class="code" href="classDRAMCtrl.html#ae187868f5c8a209363ab6b5d0ad721e6">columnsPerRowBuffer</a>);
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242     }
<a name="l00243"></a>00243 }
<a name="l00244"></a>00244 
<a name="l00245"></a>00245 <span class="keywordtype">void</span>
<a name="l00246"></a><a class="code" href="classDRAMCtrl.html#ab9e388cee37d7256a9d60dd0ff527a66">00246</a> <a class="code" href="classDRAMCtrl.html#ab9e388cee37d7256a9d60dd0ff527a66" title="startup() is the final initialization call before simulation.">DRAMCtrl::startup</a>()
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248     <span class="comment">// remember the memory system mode of operation</span>
<a name="l00249"></a>00249     <a class="code" href="classDRAMCtrl.html#a8a67548a130229c2a7be4383f9082c85" title="Remeber if the memory system is in timing mode.">isTimingMode</a> = <a class="code" href="classAbstractMemory.html#a3982da9ac617ec2f310f4d4740615804" title="read the system pointer Implemented for completeness with the setter">system</a>()-&gt;<a class="code" href="classSystem.html#a38e4aae7c6118a9a03c2a2b1b83d56fd" title="Is the system in timing mode?">isTimingMode</a>();
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a8a67548a130229c2a7be4383f9082c85" title="Remeber if the memory system is in timing mode.">isTimingMode</a>) {
<a name="l00252"></a>00252         <span class="comment">// timestamp offset should be in clock cycles for DRAMPower</span>
<a name="l00253"></a>00253         <a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a> = <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(<a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>(), <a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255         <span class="comment">// update the start tick for the precharge accounting to the</span>
<a name="l00256"></a>00256         <span class="comment">// current tick</span>
<a name="l00257"></a>00257         <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> : <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>) {
<a name="l00258"></a>00258             <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;startup(<a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() + <a class="code" href="classDRAMCtrl.html#a845143aad659120f25f1d26c06574660">tREFI</a> - <a class="code" href="classDRAMCtrl.html#a1edd216a091aa2ec675985c16134d626">tRP</a>);
<a name="l00259"></a>00259         }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261         <span class="comment">// shift the bus busy time sufficiently far ahead that we never</span>
<a name="l00262"></a>00262         <span class="comment">// have to worry about negative values when computing the time for</span>
<a name="l00263"></a>00263         <span class="comment">// the next request, this will add an insignificant bubble at the</span>
<a name="l00264"></a>00264         <span class="comment">// start of simulation</span>
<a name="l00265"></a>00265         <a class="code" href="classDRAMCtrl.html#a14f669b4a31a66dd15e42f02a7f0cb62" title="Till when has the main data bus been spoken for already?">busBusyUntil</a> = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() + <a class="code" href="classDRAMCtrl.html#a1edd216a091aa2ec675985c16134d626">tRP</a> + <a class="code" href="classDRAMCtrl.html#a135f02135b5947e4bd4924a73af5f35c">tRCD</a> + <a class="code" href="classDRAMCtrl.html#ae7ebffccab6cd342fddbcba75aee6c3b">tCL</a>;
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a>
<a name="l00270"></a><a class="code" href="classDRAMCtrl.html#a3ddb47f5fb5188a2f7c63ae3b6fb6adb">00270</a> <a class="code" href="classDRAMCtrl.html#a3ddb47f5fb5188a2f7c63ae3b6fb6adb">DRAMCtrl::recvAtomic</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt)
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;recvAtomic: %s 0x%x\n&quot;</span>, pkt-&gt;<a class="code" href="classPacket.html#a50fa8e54b8b71b0d6879307680517697" title="Return the string name of the cmd field (for debugging and tracing).">cmdString</a>(), pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>());
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="comment">// do the actual memory access and turn the packet into a response</span>
<a name="l00275"></a>00275     <a class="code" href="classAbstractMemory.html#a4f8bf048c846bef573325f47a0603b09" title="Perform an untimed memory access and update all the state (e.g.">access</a>(pkt);
<a name="l00276"></a>00276 
<a name="l00277"></a>00277     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> latency = 0;
<a name="l00278"></a>00278     <span class="keywordflow">if</span> (!pkt-&gt;<a class="code" href="classPacket.html#a3e04f59de35e82a50c48e0ca903a64cb">memInhibitAsserted</a>() &amp;&amp; pkt-&gt;<a class="code" href="classPacket.html#a9f23402c9a7438f2edab83d028f58d3b">hasData</a>()) {
<a name="l00279"></a>00279         <span class="comment">// this value is not supposed to be accurate, just enough to</span>
<a name="l00280"></a>00280         <span class="comment">// keep things going, mimic a closed page</span>
<a name="l00281"></a>00281         latency = <a class="code" href="classDRAMCtrl.html#a1edd216a091aa2ec675985c16134d626">tRP</a> + <a class="code" href="classDRAMCtrl.html#a135f02135b5947e4bd4924a73af5f35c">tRCD</a> + <a class="code" href="classDRAMCtrl.html#ae7ebffccab6cd342fddbcba75aee6c3b">tCL</a>;
<a name="l00282"></a>00282     }
<a name="l00283"></a>00283     <span class="keywordflow">return</span> latency;
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 <span class="keywordtype">bool</span>
<a name="l00287"></a><a class="code" href="classDRAMCtrl.html#a665bd267ecb592be30072d227221bc97">00287</a> <a class="code" href="classDRAMCtrl.html#a665bd267ecb592be30072d227221bc97" title="Check if the read queue has room for more entries.">DRAMCtrl::readQueueFull</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> neededEntries)<span class="keyword"> const</span>
<a name="l00288"></a>00288 <span class="keyword"></span>{
<a name="l00289"></a>00289     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Read queue limit %d, current size %d, entries needed %d\n&quot;</span>,
<a name="l00290"></a>00290             <a class="code" href="classDRAMCtrl.html#ab4f3dbe59b69329fe8d70a8951771f74">readBufferSize</a>, <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.size() + <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.size(),
<a name="l00291"></a>00291             neededEntries);
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="keywordflow">return</span>
<a name="l00294"></a>00294         (<a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.size() + <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.size() + neededEntries) &gt; <a class="code" href="classDRAMCtrl.html#ab4f3dbe59b69329fe8d70a8951771f74">readBufferSize</a>;
<a name="l00295"></a>00295 }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297 <span class="keywordtype">bool</span>
<a name="l00298"></a><a class="code" href="classDRAMCtrl.html#a692d54b6d5d615a5a691af7b09f60ef0">00298</a> <a class="code" href="classDRAMCtrl.html#a692d54b6d5d615a5a691af7b09f60ef0" title="Check if the write queue has room for more entries.">DRAMCtrl::writeQueueFull</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> neededEntries)<span class="keyword"> const</span>
<a name="l00299"></a>00299 <span class="keyword"></span>{
<a name="l00300"></a>00300     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Write queue limit %d, current size %d, entries needed %d\n&quot;</span>,
<a name="l00301"></a>00301             <a class="code" href="classDRAMCtrl.html#aab40112977e0294a7a000ca34beda431">writeBufferSize</a>, <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size(), neededEntries);
<a name="l00302"></a>00302     <span class="keywordflow">return</span> (<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size() + neededEntries) &gt; <a class="code" href="classDRAMCtrl.html#aab40112977e0294a7a000ca34beda431">writeBufferSize</a>;
<a name="l00303"></a>00303 }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 <a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMCtrl::DRAMPacket</a>*
<a name="l00306"></a>00306 <a class="code" href="classDRAMCtrl.html#a2aad4dd7b85f1f0b1ac395e429b819d7" title="Address decoder to figure out physical mapping onto ranks, banks, and rows.">DRAMCtrl::decodeAddr</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> dramPktAddr, <span class="keywordtype">unsigned</span> size,
<a name="l00307"></a>00307                        <span class="keywordtype">bool</span> isRead)
<a name="l00308"></a>00308 {
<a name="l00309"></a>00309     <span class="comment">// decode the address based on the address mapping scheme, with</span>
<a name="l00310"></a>00310     <span class="comment">// Ro, Ra, Co, Ba and Ch denoting row, rank, column, bank and</span>
<a name="l00311"></a>00311     <span class="comment">// channel, respectively</span>
<a name="l00312"></a>00312     uint8_t rank;
<a name="l00313"></a>00313     uint8_t bank;
<a name="l00314"></a>00314     <span class="comment">// use a 64-bit unsigned during the computations as the row is</span>
<a name="l00315"></a>00315     <span class="comment">// always the top bits, and check before creating the DRAMPacket</span>
<a name="l00316"></a>00316     uint64_t row;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="comment">// truncate the address to a DRAM burst, which makes it unique to</span>
<a name="l00319"></a>00319     <span class="comment">// a specific column, row, bank, rank and channel</span>
<a name="l00320"></a>00320     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceX86ISA.html#a79b5c08c190167d17c9b9b3fd40112f6">addr</a> = dramPktAddr / <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     <span class="comment">// we have removed the lowest order address bits that denote the</span>
<a name="l00323"></a>00323     <span class="comment">// position within the column</span>
<a name="l00324"></a>00324     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a062d374384c092ae901cd1316684799b">addrMapping</a> == Enums::RoRaBaChCo) {
<a name="l00325"></a>00325         <span class="comment">// the lowest order bits denote the column to ensure that</span>
<a name="l00326"></a>00326         <span class="comment">// sequential cache lines occupy the same row</span>
<a name="l00327"></a>00327         addr = addr / <a class="code" href="classDRAMCtrl.html#ae187868f5c8a209363ab6b5d0ad721e6">columnsPerRowBuffer</a>;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329         <span class="comment">// take out the channel part of the address</span>
<a name="l00330"></a>00330         addr = addr / <a class="code" href="classDRAMCtrl.html#a2c555ba14d5fb51ab6857af93a274051">channels</a>;
<a name="l00331"></a>00331 
<a name="l00332"></a>00332         <span class="comment">// after the channel bits, get the bank bits to interleave</span>
<a name="l00333"></a>00333         <span class="comment">// over the banks</span>
<a name="l00334"></a>00334         bank = addr % <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>;
<a name="l00335"></a>00335         addr = addr / <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337         <span class="comment">// after the bank, we get the rank bits which thus interleaves</span>
<a name="l00338"></a>00338         <span class="comment">// over the ranks</span>
<a name="l00339"></a>00339         rank = addr % <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>;
<a name="l00340"></a>00340         addr = addr / <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>;
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         <span class="comment">// lastly, get the row bits</span>
<a name="l00343"></a>00343         row = addr % <a class="code" href="classDRAMCtrl.html#ad29fab6a3b46686b09be87f38049dee0">rowsPerBank</a>;
<a name="l00344"></a>00344         addr = addr / <a class="code" href="classDRAMCtrl.html#ad29fab6a3b46686b09be87f38049dee0">rowsPerBank</a>;
<a name="l00345"></a>00345     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a062d374384c092ae901cd1316684799b">addrMapping</a> == Enums::RoRaBaCoCh) {
<a name="l00346"></a>00346         <span class="comment">// take out the lower-order column bits</span>
<a name="l00347"></a>00347         addr = addr / <a class="code" href="classDRAMCtrl.html#a2c4b08a55047b3c2ca605d75843fba4e">columnsPerStripe</a>;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         <span class="comment">// take out the channel part of the address</span>
<a name="l00350"></a>00350         addr = addr / <a class="code" href="classDRAMCtrl.html#a2c555ba14d5fb51ab6857af93a274051">channels</a>;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352         <span class="comment">// next, the higher-order column bites</span>
<a name="l00353"></a>00353         addr = addr / (<a class="code" href="classDRAMCtrl.html#ae187868f5c8a209363ab6b5d0ad721e6">columnsPerRowBuffer</a> / <a class="code" href="classDRAMCtrl.html#a2c4b08a55047b3c2ca605d75843fba4e">columnsPerStripe</a>);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         <span class="comment">// after the column bits, we get the bank bits to interleave</span>
<a name="l00356"></a>00356         <span class="comment">// over the banks</span>
<a name="l00357"></a>00357         bank = addr % <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>;
<a name="l00358"></a>00358         addr = addr / <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360         <span class="comment">// after the bank, we get the rank bits which thus interleaves</span>
<a name="l00361"></a>00361         <span class="comment">// over the ranks</span>
<a name="l00362"></a>00362         rank = addr % <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>;
<a name="l00363"></a>00363         addr = addr / <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365         <span class="comment">// lastly, get the row bits</span>
<a name="l00366"></a>00366         row = addr % <a class="code" href="classDRAMCtrl.html#ad29fab6a3b46686b09be87f38049dee0">rowsPerBank</a>;
<a name="l00367"></a>00367         addr = addr / <a class="code" href="classDRAMCtrl.html#ad29fab6a3b46686b09be87f38049dee0">rowsPerBank</a>;
<a name="l00368"></a>00368     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a062d374384c092ae901cd1316684799b">addrMapping</a> == Enums::RoCoRaBaCh) {
<a name="l00369"></a>00369         <span class="comment">// optimise for closed page mode and utilise maximum</span>
<a name="l00370"></a>00370         <span class="comment">// parallelism of the DRAM (at the cost of power)</span>
<a name="l00371"></a>00371 
<a name="l00372"></a>00372         <span class="comment">// take out the lower-order column bits</span>
<a name="l00373"></a>00373         addr = addr / <a class="code" href="classDRAMCtrl.html#a2c4b08a55047b3c2ca605d75843fba4e">columnsPerStripe</a>;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         <span class="comment">// take out the channel part of the address, not that this has</span>
<a name="l00376"></a>00376         <span class="comment">// to match with how accesses are interleaved between the</span>
<a name="l00377"></a>00377         <span class="comment">// controllers in the address mapping</span>
<a name="l00378"></a>00378         addr = addr / <a class="code" href="classDRAMCtrl.html#a2c555ba14d5fb51ab6857af93a274051">channels</a>;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         <span class="comment">// start with the bank bits, as this provides the maximum</span>
<a name="l00381"></a>00381         <span class="comment">// opportunity for parallelism between requests</span>
<a name="l00382"></a>00382         bank = addr % <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>;
<a name="l00383"></a>00383         addr = addr / <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385         <span class="comment">// next get the rank bits</span>
<a name="l00386"></a>00386         rank = addr % <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>;
<a name="l00387"></a>00387         addr = addr / <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389         <span class="comment">// next, the higher-order column bites</span>
<a name="l00390"></a>00390         addr = addr / (<a class="code" href="classDRAMCtrl.html#ae187868f5c8a209363ab6b5d0ad721e6">columnsPerRowBuffer</a> / <a class="code" href="classDRAMCtrl.html#a2c4b08a55047b3c2ca605d75843fba4e">columnsPerStripe</a>);
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <span class="comment">// lastly, get the row bits</span>
<a name="l00393"></a>00393         row = addr % <a class="code" href="classDRAMCtrl.html#ad29fab6a3b46686b09be87f38049dee0">rowsPerBank</a>;
<a name="l00394"></a>00394         addr = addr / <a class="code" href="classDRAMCtrl.html#ad29fab6a3b46686b09be87f38049dee0">rowsPerBank</a>;
<a name="l00395"></a>00395     } <span class="keywordflow">else</span>
<a name="l00396"></a>00396         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Unknown address mapping policy chosen!&quot;</span>);
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     assert(rank &lt; <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>);
<a name="l00399"></a>00399     assert(bank &lt; <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>);
<a name="l00400"></a>00400     assert(row &lt; <a class="code" href="classDRAMCtrl.html#ad29fab6a3b46686b09be87f38049dee0">rowsPerBank</a>);
<a name="l00401"></a>00401     assert(row &lt; <a class="code" href="classDRAMCtrl_1_1Bank.html#a81fa13164d43b203076fcdacde0fb6c8">Bank::NO_ROW</a>);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Address: %lld Rank %d Bank %d Row %d\n&quot;</span>,
<a name="l00404"></a>00404             dramPktAddr, rank, bank, row);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="comment">// create the corresponding DRAM packet with the entry time and</span>
<a name="l00407"></a>00407     <span class="comment">// ready time set to the current tick, the latter will be updated</span>
<a name="l00408"></a>00408     <span class="comment">// later</span>
<a name="l00409"></a>00409     uint16_t bank_id = <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a> * rank + bank;
<a name="l00410"></a>00410     <span class="keywordflow">return</span> <span class="keyword">new</span> DRAMPacket(pkt, isRead, rank, bank, row, bank_id, dramPktAddr,
<a name="l00411"></a>00411                           size, <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[rank]-&gt;banks[bank], *<a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[rank]);
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 <span class="keywordtype">void</span>
<a name="l00415"></a><a class="code" href="classDRAMCtrl.html#a89ace0260a5feca88628aa2bd678642c">00415</a> <a class="code" href="classDRAMCtrl.html#a89ace0260a5feca88628aa2bd678642c" title="When a new read comes in, first check if the write q has a pending request to the...">DRAMCtrl::addToReadQueue</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pktCount)
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417     <span class="comment">// only add to the read queue here. whenever the request is</span>
<a name="l00418"></a>00418     <span class="comment">// eventually done, set the readyTime, and call schedule()</span>
<a name="l00419"></a>00419     assert(!pkt-&gt;<a class="code" href="classPacket.html#a2bfee2cdcdfd22a227f0254b7dd56249">isWrite</a>());
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     assert(pktCount != 0);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <span class="comment">// if the request size is larger than burst size, the pkt is split into</span>
<a name="l00424"></a>00424     <span class="comment">// multiple DRAM packets</span>
<a name="l00425"></a>00425     <span class="comment">// Note if the pkt starting address is not aligened to burst size, the</span>
<a name="l00426"></a>00426     <span class="comment">// address of first DRAM packet is kept unaliged. Subsequent DRAM packets</span>
<a name="l00427"></a>00427     <span class="comment">// are aligned to burst size boundaries. This is to ensure we accurately</span>
<a name="l00428"></a>00428     <span class="comment">// check read packets against packets in write queue.</span>
<a name="l00429"></a>00429     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> addr = pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>();
<a name="l00430"></a>00430     <span class="keywordtype">unsigned</span> pktsServicedByWrQ = 0;
<a name="l00431"></a>00431     <a class="code" href="classDRAMCtrl_1_1BurstHelper.html" title="A burst helper helps organize and manage a packet that is larger than the DRAM burst...">BurstHelper</a>* burst_helper = NULL;
<a name="l00432"></a>00432     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> cnt = 0; cnt &lt; pktCount; ++cnt) {
<a name="l00433"></a>00433         <span class="keywordtype">unsigned</span> size = std::min((addr | (<a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a> - 1)) + 1,
<a name="l00434"></a>00434                         pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>() + pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>()) - addr;
<a name="l00435"></a>00435         <a class="code" href="classDRAMCtrl.html#a3a77806d4ec83769799fd9cbc3024027">readPktSize</a>[<a class="code" href="intmath_8hh.html#a85317359c479b5019fc3608810682fb0">ceilLog2</a>(size)]++;
<a name="l00436"></a>00436         <a class="code" href="classDRAMCtrl.html#a9f29a99e44a63f7c54f396d42ec29c4a">readBursts</a>++;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438         <span class="comment">// First check write buffer to see if the data is already at</span>
<a name="l00439"></a>00439         <span class="comment">// the controller</span>
<a name="l00440"></a>00440         <span class="keywordtype">bool</span> foundInWrQ = <span class="keyword">false</span>;
<a name="l00441"></a>00441         <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.begin(); <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> != <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.end(); ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l00442"></a>00442             <span class="comment">// check if the read is subsumed in the write entry we are</span>
<a name="l00443"></a>00443             <span class="comment">// looking at</span>
<a name="l00444"></a>00444             <span class="keywordflow">if</span> ((*i)-&gt;addr &lt;= addr &amp;&amp;
<a name="l00445"></a>00445                 (addr + size) &lt;= ((*i)-&gt;addr + (*i)-&gt;size)) {
<a name="l00446"></a>00446                 foundInWrQ = <span class="keyword">true</span>;
<a name="l00447"></a>00447                 <a class="code" href="classDRAMCtrl.html#aef20a1d281cf709372d7764085099517">servicedByWrQ</a>++;
<a name="l00448"></a>00448                 pktsServicedByWrQ++;
<a name="l00449"></a>00449                 <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Read to addr %lld with size %d serviced by &quot;</span>
<a name="l00450"></a>00450                         <span class="stringliteral">&quot;write queue\n&quot;</span>, addr, size);
<a name="l00451"></a>00451                 <a class="code" href="classDRAMCtrl.html#a5dde296a293f780e9aba9c7e55bc2f02">bytesReadWrQ</a> += <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>;
<a name="l00452"></a>00452                 <span class="keywordflow">break</span>;
<a name="l00453"></a>00453             }
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456         <span class="comment">// If not found in the write q, make a DRAM packet and</span>
<a name="l00457"></a>00457         <span class="comment">// push it onto the read queue</span>
<a name="l00458"></a>00458         <span class="keywordflow">if</span> (!foundInWrQ) {
<a name="l00459"></a>00459 
<a name="l00460"></a>00460             <span class="comment">// Make the burst helper for split packets</span>
<a name="l00461"></a>00461             <span class="keywordflow">if</span> (pktCount &gt; 1 &amp;&amp; burst_helper == NULL) {
<a name="l00462"></a>00462                 <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Read to addr %lld translates to %d &quot;</span>
<a name="l00463"></a>00463                         <span class="stringliteral">&quot;dram requests\n&quot;</span>, pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>(), pktCount);
<a name="l00464"></a>00464                 burst_helper = <span class="keyword">new</span> <a class="code" href="classDRAMCtrl_1_1BurstHelper.html" title="A burst helper helps organize and manage a packet that is larger than the DRAM burst...">BurstHelper</a>(pktCount);
<a name="l00465"></a>00465             }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467             <a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMPacket</a>* dram_pkt = <a class="code" href="classDRAMCtrl.html#a2aad4dd7b85f1f0b1ac395e429b819d7" title="Address decoder to figure out physical mapping onto ranks, banks, and rows.">decodeAddr</a>(pkt, addr, size, <span class="keyword">true</span>);
<a name="l00468"></a>00468             dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a989ec86491b77ec1d1febb9f4eba287b" title="A pointer to the BurstHelper if this DRAMPacket is a split packet If not a split...">burstHelper</a> = burst_helper;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470             assert(!<a class="code" href="classDRAMCtrl.html#a665bd267ecb592be30072d227221bc97" title="Check if the read queue has room for more entries.">readQueueFull</a>(1));
<a name="l00471"></a>00471             <a class="code" href="classDRAMCtrl.html#a69579ae38ad58ab0a4f2a045026c078f">rdQLenPdf</a>[<a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.size() + <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.size()]++;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Adding to read queue\n&quot;</span>);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475             <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.push_back(dram_pkt);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477             <span class="comment">// Update stats</span>
<a name="l00478"></a>00478             <a class="code" href="classDRAMCtrl.html#aee32fb42bdd298319a24f82878398487">avgRdQLen</a> = <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.size() + <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.size();
<a name="l00479"></a>00479         }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481         <span class="comment">// Starting address of next dram pkt (aligend to burstSize boundary)</span>
<a name="l00482"></a>00482         addr = (addr | (<a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a> - 1)) + 1;
<a name="l00483"></a>00483     }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     <span class="comment">// If all packets are serviced by write queue, we send the repsonse back</span>
<a name="l00486"></a>00486     <span class="keywordflow">if</span> (pktsServicedByWrQ == pktCount) {
<a name="l00487"></a>00487         <a class="code" href="classDRAMCtrl.html#a2d8b5823fa1899c3eb0e3a0aed1663f6" title="When a packet reaches its &amp;quot;readyTime&amp;quot; in the response Q, use the &amp;quot;access()&amp;quot;...">accessAndRespond</a>(pkt, <a class="code" href="classDRAMCtrl.html#a09bfc4deb4906dbc01007b1a4420224d" title="Pipeline latency of the controller frontend.">frontendLatency</a>);
<a name="l00488"></a>00488         <span class="keywordflow">return</span>;
<a name="l00489"></a>00489     }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     <span class="comment">// Update how many split packets are serviced by write queue</span>
<a name="l00492"></a>00492     <span class="keywordflow">if</span> (burst_helper != NULL)
<a name="l00493"></a>00493         burst_helper-&gt;<a class="code" href="classDRAMCtrl_1_1BurstHelper.html#ae0815101bc7957f13ce9351e574039c5" title="Number of DRAM bursts serviced so far for a system packet.">burstsServiced</a> = pktsServicedByWrQ;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     <span class="comment">// If we are not already scheduled to get a request out of the</span>
<a name="l00496"></a>00496     <span class="comment">// queue, do so now</span>
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>()) {
<a name="l00498"></a>00498         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Request scheduled immediately\n&quot;</span>);
<a name="l00499"></a>00499         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="keywordtype">void</span>
<a name="l00504"></a><a class="code" href="classDRAMCtrl.html#a637e6d86494bd6ee839df478a9025427">00504</a> <a class="code" href="classDRAMCtrl.html#a637e6d86494bd6ee839df478a9025427" title="Decode the incoming pkt, create a dram_pkt and push to the back of the write queue...">DRAMCtrl::addToWriteQueue</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pktCount)
<a name="l00505"></a>00505 {
<a name="l00506"></a>00506     <span class="comment">// only add to the write queue here. whenever the request is</span>
<a name="l00507"></a>00507     <span class="comment">// eventually done, set the readyTime, and call schedule()</span>
<a name="l00508"></a>00508     assert(pkt-&gt;<a class="code" href="classPacket.html#a2bfee2cdcdfd22a227f0254b7dd56249">isWrite</a>());
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     <span class="comment">// if the request size is larger than burst size, the pkt is split into</span>
<a name="l00511"></a>00511     <span class="comment">// multiple DRAM packets</span>
<a name="l00512"></a>00512     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> addr = pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>();
<a name="l00513"></a>00513     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> cnt = 0; cnt &lt; pktCount; ++cnt) {
<a name="l00514"></a>00514         <span class="keywordtype">unsigned</span> size = std::min((addr | (<a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a> - 1)) + 1,
<a name="l00515"></a>00515                         pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>() + pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>()) - addr;
<a name="l00516"></a>00516         <a class="code" href="classDRAMCtrl.html#a3df581e1ab71e7895d3894e700beac79">writePktSize</a>[<a class="code" href="intmath_8hh.html#a85317359c479b5019fc3608810682fb0">ceilLog2</a>(size)]++;
<a name="l00517"></a>00517         <a class="code" href="classDRAMCtrl.html#a62d593c9cf45e7c36be919ce2b8a7673">writeBursts</a>++;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519         <span class="comment">// see if we can merge with an existing item in the write</span>
<a name="l00520"></a>00520         <span class="comment">// queue and keep track of whether we have merged or not so we</span>
<a name="l00521"></a>00521         <span class="comment">// can stop at that point and also avoid enqueueing a new</span>
<a name="l00522"></a>00522         <span class="comment">// request</span>
<a name="l00523"></a>00523         <span class="keywordtype">bool</span> merged = <span class="keyword">false</span>;
<a name="l00524"></a>00524         <span class="keyword">auto</span> <a class="code" href="namespaceMipsISA.html#abbf89a8639f14e61b3b9a72ea14a06a8">w</a> = <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.begin();
<a name="l00525"></a>00525 
<a name="l00526"></a>00526         <span class="keywordflow">while</span>(!merged &amp;&amp; <a class="code" href="namespaceMipsISA.html#abbf89a8639f14e61b3b9a72ea14a06a8">w</a> != <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.end()) {
<a name="l00527"></a>00527             <span class="comment">// either of the two could be first, if they are the same</span>
<a name="l00528"></a>00528             <span class="comment">// it does not matter which way we go</span>
<a name="l00529"></a>00529             <span class="keywordflow">if</span> ((*w)-&gt;addr &gt;= addr) {
<a name="l00530"></a>00530                 <span class="comment">// the existing one starts after the new one, figure</span>
<a name="l00531"></a>00531                 <span class="comment">// out where the new one ends with respect to the</span>
<a name="l00532"></a>00532                 <span class="comment">// existing one</span>
<a name="l00533"></a>00533                 <span class="keywordflow">if</span> ((addr + size) &gt;= ((*w)-&gt;addr + (*w)-&gt;size)) {
<a name="l00534"></a>00534                     <span class="comment">// check if the existing one is completely</span>
<a name="l00535"></a>00535                     <span class="comment">// subsumed in the new one</span>
<a name="l00536"></a>00536                     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Merging write covering existing burst\n&quot;</span>);
<a name="l00537"></a>00537                     merged = <span class="keyword">true</span>;
<a name="l00538"></a>00538                     <span class="comment">// update both the address and the size</span>
<a name="l00539"></a>00539                     (*w)-&gt;addr = addr;
<a name="l00540"></a>00540                     (*w)-&gt;size = size;
<a name="l00541"></a>00541                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((addr + size) &gt;= (*w)-&gt;addr &amp;&amp;
<a name="l00542"></a>00542                            ((*w)-&gt;addr + (*w)-&gt;size - addr) &lt;= <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>) {
<a name="l00543"></a>00543                     <span class="comment">// the new one is just before or partially</span>
<a name="l00544"></a>00544                     <span class="comment">// overlapping with the existing one, and together</span>
<a name="l00545"></a>00545                     <span class="comment">// they fit within a burst</span>
<a name="l00546"></a>00546                     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Merging write before existing burst\n&quot;</span>);
<a name="l00547"></a>00547                     merged = <span class="keyword">true</span>;
<a name="l00548"></a>00548                     <span class="comment">// the existing queue item needs to be adjusted with</span>
<a name="l00549"></a>00549                     <span class="comment">// respect to both address and size</span>
<a name="l00550"></a>00550                     (*w)-&gt;size = (*w)-&gt;addr + (*w)-&gt;size - addr;
<a name="l00551"></a>00551                     (*w)-&gt;addr = addr;
<a name="l00552"></a>00552                 }
<a name="l00553"></a>00553             } <span class="keywordflow">else</span> {
<a name="l00554"></a>00554                 <span class="comment">// the new one starts after the current one, figure</span>
<a name="l00555"></a>00555                 <span class="comment">// out where the existing one ends with respect to the</span>
<a name="l00556"></a>00556                 <span class="comment">// new one</span>
<a name="l00557"></a>00557                 <span class="keywordflow">if</span> (((*w)-&gt;addr + (*w)-&gt;size) &gt;= (addr + size)) {
<a name="l00558"></a>00558                     <span class="comment">// check if the new one is completely subsumed in the</span>
<a name="l00559"></a>00559                     <span class="comment">// existing one</span>
<a name="l00560"></a>00560                     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Merging write into existing burst\n&quot;</span>);
<a name="l00561"></a>00561                     merged = <span class="keyword">true</span>;
<a name="l00562"></a>00562                     <span class="comment">// no adjustments necessary</span>
<a name="l00563"></a>00563                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((*w)-&gt;addr + (*w)-&gt;size) &gt;= addr &amp;&amp;
<a name="l00564"></a>00564                            (addr + size - (*w)-&gt;addr) &lt;= <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>) {
<a name="l00565"></a>00565                     <span class="comment">// the existing one is just before or partially</span>
<a name="l00566"></a>00566                     <span class="comment">// overlapping with the new one, and together</span>
<a name="l00567"></a>00567                     <span class="comment">// they fit within a burst</span>
<a name="l00568"></a>00568                     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Merging write after existing burst\n&quot;</span>);
<a name="l00569"></a>00569                     merged = <span class="keyword">true</span>;
<a name="l00570"></a>00570                     <span class="comment">// the address is right, and only the size has</span>
<a name="l00571"></a>00571                     <span class="comment">// to be adjusted</span>
<a name="l00572"></a>00572                     (*w)-&gt;size = addr + size - (*w)-&gt;addr;
<a name="l00573"></a>00573                 }
<a name="l00574"></a>00574             }
<a name="l00575"></a>00575             ++<a class="code" href="namespaceMipsISA.html#abbf89a8639f14e61b3b9a72ea14a06a8">w</a>;
<a name="l00576"></a>00576         }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         <span class="comment">// if the item was not merged we need to create a new write</span>
<a name="l00579"></a>00579         <span class="comment">// and enqueue it</span>
<a name="l00580"></a>00580         <span class="keywordflow">if</span> (!merged) {
<a name="l00581"></a>00581             <a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMPacket</a>* dram_pkt = <a class="code" href="classDRAMCtrl.html#a2aad4dd7b85f1f0b1ac395e429b819d7" title="Address decoder to figure out physical mapping onto ranks, banks, and rows.">decodeAddr</a>(pkt, addr, size, <span class="keyword">false</span>);
<a name="l00582"></a>00582 
<a name="l00583"></a>00583             assert(<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size() &lt; <a class="code" href="classDRAMCtrl.html#aab40112977e0294a7a000ca34beda431">writeBufferSize</a>);
<a name="l00584"></a>00584             <a class="code" href="classDRAMCtrl.html#aa16e1a3aeaa40ba0dcfa25ea50faec34">wrQLenPdf</a>[<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size()]++;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Adding to write queue\n&quot;</span>);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588             <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.push_back(dram_pkt);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590             <span class="comment">// Update stats</span>
<a name="l00591"></a>00591             <a class="code" href="classDRAMCtrl.html#a83afaa015a549164f698db8ba7ea51b0">avgWrQLen</a> = <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size();
<a name="l00592"></a>00592         } <span class="keywordflow">else</span> {
<a name="l00593"></a>00593             <span class="comment">// keep track of the fact that this burst effectively</span>
<a name="l00594"></a>00594             <span class="comment">// disappeared as it was merged with an existing one</span>
<a name="l00595"></a>00595             <a class="code" href="classDRAMCtrl.html#ae193808abcaef94127dd307cd0fda9a4">mergedWrBursts</a>++;
<a name="l00596"></a>00596         }
<a name="l00597"></a>00597 
<a name="l00598"></a>00598         <span class="comment">// Starting address of next dram pkt (aligend to burstSize boundary)</span>
<a name="l00599"></a>00599         addr = (addr | (<a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a> - 1)) + 1;
<a name="l00600"></a>00600     }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602     <span class="comment">// we do not wait for the writes to be send to the actual memory,</span>
<a name="l00603"></a>00603     <span class="comment">// but instead take responsibility for the consistency here and</span>
<a name="l00604"></a>00604     <span class="comment">// snoop the write queue for any upcoming reads</span>
<a name="l00605"></a>00605     <span class="comment">// @todo, if a pkt size is larger than burst size, we might need a</span>
<a name="l00606"></a>00606     <span class="comment">// different front end latency</span>
<a name="l00607"></a>00607     <a class="code" href="classDRAMCtrl.html#a2d8b5823fa1899c3eb0e3a0aed1663f6" title="When a packet reaches its &amp;quot;readyTime&amp;quot; in the response Q, use the &amp;quot;access()&amp;quot;...">accessAndRespond</a>(pkt, <a class="code" href="classDRAMCtrl.html#a09bfc4deb4906dbc01007b1a4420224d" title="Pipeline latency of the controller frontend.">frontendLatency</a>);
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     <span class="comment">// If we are not already scheduled to get a request out of the</span>
<a name="l00610"></a>00610     <span class="comment">// queue, do so now</span>
<a name="l00611"></a>00611     <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>()) {
<a name="l00612"></a>00612         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Request scheduled immediately\n&quot;</span>);
<a name="l00613"></a>00613         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 <span class="keywordtype">void</span>
<a name="l00618"></a><a class="code" href="classDRAMCtrl.html#a37bab146e4d29158c2d75b0ef6f83880">00618</a> <a class="code" href="classDRAMCtrl.html#a37bab146e4d29158c2d75b0ef6f83880" title="Used for debugging to observe the contents of the queues.">DRAMCtrl::printQs</a>()<span class="keyword"> const </span>{
<a name="l00619"></a>00619     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;===READ QUEUE===\n\n&quot;</span>);
<a name="l00620"></a>00620     <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.begin() ;  <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> != <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.end() ; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l00621"></a>00621         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Read %lu\n&quot;</span>, (*i)-&gt;addr);
<a name="l00622"></a>00622     }
<a name="l00623"></a>00623     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;\n===RESP QUEUE===\n\n&quot;</span>);
<a name="l00624"></a>00624     <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.begin() ;  <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> != <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.end() ; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l00625"></a>00625         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Response %lu\n&quot;</span>, (*i)-&gt;addr);
<a name="l00626"></a>00626     }
<a name="l00627"></a>00627     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;\n===WRITE QUEUE===\n\n&quot;</span>);
<a name="l00628"></a>00628     <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.begin() ;  <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> != <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.end() ; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l00629"></a>00629         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Write %lu\n&quot;</span>, (*i)-&gt;addr);
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631 }
<a name="l00632"></a>00632 
<a name="l00633"></a>00633 <span class="keywordtype">bool</span>
<a name="l00634"></a><a class="code" href="classDRAMCtrl.html#a54cc6c75a9f00865e829d327e68bd528">00634</a> <a class="code" href="classDRAMCtrl.html#a54cc6c75a9f00865e829d327e68bd528">DRAMCtrl::recvTimingReq</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt)
<a name="l00635"></a>00635 {
<a name="l00638"></a>00638     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> = 0; <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> &lt; <a class="code" href="classDRAMCtrl.html#a191c65a436d32961f1e75b219da49349">pendingDelete</a>.size(); <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a>++)
<a name="l00639"></a>00639         <span class="keyword">delete</span> <a class="code" href="classDRAMCtrl.html#a191c65a436d32961f1e75b219da49349">pendingDelete</a>[<a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a>];
<a name="l00640"></a>00640     <a class="code" href="classDRAMCtrl.html#a191c65a436d32961f1e75b219da49349">pendingDelete</a>.clear();
<a name="l00641"></a>00641 
<a name="l00642"></a>00642     <span class="comment">// This is where we enter from the outside world</span>
<a name="l00643"></a>00643     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;recvTimingReq: request %s addr %lld size %d\n&quot;</span>,
<a name="l00644"></a>00644             pkt-&gt;<a class="code" href="classPacket.html#a50fa8e54b8b71b0d6879307680517697" title="Return the string name of the cmd field (for debugging and tracing).">cmdString</a>(), pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>(), pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>());
<a name="l00645"></a>00645 
<a name="l00646"></a>00646     <span class="comment">// simply drop inhibited packets for now</span>
<a name="l00647"></a>00647     <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="classPacket.html#a3e04f59de35e82a50c48e0ca903a64cb">memInhibitAsserted</a>()) {
<a name="l00648"></a>00648         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Inhibited packet -- Dropping it now\n&quot;</span>);
<a name="l00649"></a>00649         <a class="code" href="classDRAMCtrl.html#a191c65a436d32961f1e75b219da49349">pendingDelete</a>.push_back(pkt);
<a name="l00650"></a>00650         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00651"></a>00651     }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     <span class="comment">// Calc avg gap between requests</span>
<a name="l00654"></a>00654     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#ae83ae07b698fa2ed71175f43edc3852f">prevArrival</a> != 0) {
<a name="l00655"></a>00655         <a class="code" href="classDRAMCtrl.html#ab26b0b6d86b24b989cb825d35423d832">totGap</a> += <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() - <a class="code" href="classDRAMCtrl.html#ae83ae07b698fa2ed71175f43edc3852f">prevArrival</a>;
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657     <a class="code" href="classDRAMCtrl.html#ae83ae07b698fa2ed71175f43edc3852f">prevArrival</a> = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>();
<a name="l00658"></a>00658 
<a name="l00659"></a>00659 
<a name="l00660"></a>00660     <span class="comment">// Find out how many dram packets a pkt translates to</span>
<a name="l00661"></a>00661     <span class="comment">// If the burst size is equal or larger than the pkt size, then a pkt</span>
<a name="l00662"></a>00662     <span class="comment">// translates to only one dram packet. Otherwise, a pkt translates to</span>
<a name="l00663"></a>00663     <span class="comment">// multiple dram packets</span>
<a name="l00664"></a>00664     <span class="keywordtype">unsigned</span> size = pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>();
<a name="l00665"></a>00665     <span class="keywordtype">unsigned</span> <a class="code" href="namespaceArmISA.html#a19e4a68ca5c93c6136351d804b432b09">offset</a> = pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>() &amp; (<a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a> - 1);
<a name="l00666"></a>00666     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dram_pkt_count = <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(offset + size, <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>);
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="comment">// check local buffers and do not accept if full</span>
<a name="l00669"></a>00669     <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="classPacket.html#ad7fd7ab0e95007d1c6232b231482c6fa">isRead</a>()) {
<a name="l00670"></a>00670         assert(size != 0);
<a name="l00671"></a>00671         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a665bd267ecb592be30072d227221bc97" title="Check if the read queue has room for more entries.">readQueueFull</a>(dram_pkt_count)) {
<a name="l00672"></a>00672             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Read queue full, not accepting\n&quot;</span>);
<a name="l00673"></a>00673             <span class="comment">// remember that we have to retry this port</span>
<a name="l00674"></a>00674             <a class="code" href="classDRAMCtrl.html#a2129ada5d479943d1a45b4ad01351510" title="Remember if we have to retry a request when available.">retryRdReq</a> = <span class="keyword">true</span>;
<a name="l00675"></a>00675             <a class="code" href="classDRAMCtrl.html#af9226ff3e9ace9736d27fd10fd577f03">numRdRetry</a>++;
<a name="l00676"></a>00676             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00677"></a>00677         } <span class="keywordflow">else</span> {
<a name="l00678"></a>00678             <a class="code" href="classDRAMCtrl.html#a89ace0260a5feca88628aa2bd678642c" title="When a new read comes in, first check if the write q has a pending request to the...">addToReadQueue</a>(pkt, dram_pkt_count);
<a name="l00679"></a>00679             <a class="code" href="classDRAMCtrl.html#ab7f21b330feeb44e38df54e2ba459272">readReqs</a>++;
<a name="l00680"></a>00680             <a class="code" href="classDRAMCtrl.html#afdc8b398ddc7ab7cfd8fb73e0feb95a0">bytesReadSys</a> += size;
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pkt-&gt;<a class="code" href="classPacket.html#a2bfee2cdcdfd22a227f0254b7dd56249">isWrite</a>()) {
<a name="l00683"></a>00683         assert(size != 0);
<a name="l00684"></a>00684         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a692d54b6d5d615a5a691af7b09f60ef0" title="Check if the write queue has room for more entries.">writeQueueFull</a>(dram_pkt_count)) {
<a name="l00685"></a>00685             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Write queue full, not accepting\n&quot;</span>);
<a name="l00686"></a>00686             <span class="comment">// remember that we have to retry this port</span>
<a name="l00687"></a>00687             <a class="code" href="classDRAMCtrl.html#a757620eaaec709daed4fc65621f1c4fa">retryWrReq</a> = <span class="keyword">true</span>;
<a name="l00688"></a>00688             <a class="code" href="classDRAMCtrl.html#ad0b5620e2ea84dd1719ce9ca1d9615a1">numWrRetry</a>++;
<a name="l00689"></a>00689             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00690"></a>00690         } <span class="keywordflow">else</span> {
<a name="l00691"></a>00691             <a class="code" href="classDRAMCtrl.html#a637e6d86494bd6ee839df478a9025427" title="Decode the incoming pkt, create a dram_pkt and push to the back of the write queue...">addToWriteQueue</a>(pkt, dram_pkt_count);
<a name="l00692"></a>00692             <a class="code" href="classDRAMCtrl.html#a7ec9d1bff02a1ee089a6b2e52a25ddf7">writeReqs</a>++;
<a name="l00693"></a>00693             <a class="code" href="classDRAMCtrl.html#a5bc36b3ae809b51a496f8d879c3b41e6">bytesWrittenSys</a> += size;
<a name="l00694"></a>00694         }
<a name="l00695"></a>00695     } <span class="keywordflow">else</span> {
<a name="l00696"></a>00696         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM,<span class="stringliteral">&quot;Neither read nor write, ignore timing\n&quot;</span>);
<a name="l00697"></a>00697         <a class="code" href="classDRAMCtrl.html#a6126d0f178c01a6bac05013216c219e0">neitherReadNorWrite</a>++;
<a name="l00698"></a>00698         <a class="code" href="classDRAMCtrl.html#a2d8b5823fa1899c3eb0e3a0aed1663f6" title="When a packet reaches its &amp;quot;readyTime&amp;quot; in the response Q, use the &amp;quot;access()&amp;quot;...">accessAndRespond</a>(pkt, 1);
<a name="l00699"></a>00699     }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704 <span class="keywordtype">void</span>
<a name="l00705"></a><a class="code" href="classDRAMCtrl.html#a0609a3945562267e6f92748621e835d9">00705</a> <a class="code" href="classDRAMCtrl.html#a0609a3945562267e6f92748621e835d9">DRAMCtrl::processRespondEvent</a>()
<a name="l00706"></a>00706 {
<a name="l00707"></a>00707     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM,
<a name="l00708"></a>00708             <span class="stringliteral">&quot;processRespondEvent(): Some req has reached its readyTime\n&quot;</span>);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMPacket</a>* dram_pkt = <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.front();
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="keywordflow">if</span> (dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a989ec86491b77ec1d1febb9f4eba287b" title="A pointer to the BurstHelper if this DRAMPacket is a split packet If not a split...">burstHelper</a>) {
<a name="l00713"></a>00713         <span class="comment">// it is a split packet</span>
<a name="l00714"></a>00714         dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a989ec86491b77ec1d1febb9f4eba287b" title="A pointer to the BurstHelper if this DRAMPacket is a split packet If not a split...">burstHelper</a>-&gt;<a class="code" href="classDRAMCtrl_1_1BurstHelper.html#ae0815101bc7957f13ce9351e574039c5" title="Number of DRAM bursts serviced so far for a system packet.">burstsServiced</a>++;
<a name="l00715"></a>00715         <span class="keywordflow">if</span> (dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a989ec86491b77ec1d1febb9f4eba287b" title="A pointer to the BurstHelper if this DRAMPacket is a split packet If not a split...">burstHelper</a>-&gt;<a class="code" href="classDRAMCtrl_1_1BurstHelper.html#ae0815101bc7957f13ce9351e574039c5" title="Number of DRAM bursts serviced so far for a system packet.">burstsServiced</a> ==
<a name="l00716"></a>00716             dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a989ec86491b77ec1d1febb9f4eba287b" title="A pointer to the BurstHelper if this DRAMPacket is a split packet If not a split...">burstHelper</a>-&gt;<a class="code" href="classDRAMCtrl_1_1BurstHelper.html#a2a40d96d3fee08b5469243c26e05f9e7" title="Number of DRAM bursts requred for a system packet.">burstCount</a>) {
<a name="l00717"></a>00717             <span class="comment">// we have now serviced all children packets of a system packet</span>
<a name="l00718"></a>00718             <span class="comment">// so we can now respond to the requester</span>
<a name="l00719"></a>00719             <span class="comment">// @todo we probably want to have a different front end and back</span>
<a name="l00720"></a>00720             <span class="comment">// end latency for split packets</span>
<a name="l00721"></a>00721             <a class="code" href="classDRAMCtrl.html#a2d8b5823fa1899c3eb0e3a0aed1663f6" title="When a packet reaches its &amp;quot;readyTime&amp;quot; in the response Q, use the &amp;quot;access()&amp;quot;...">accessAndRespond</a>(dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#ae6bba118f1ee6c4b311cf6c586067acb" title="This comes from the outside world.">pkt</a>, <a class="code" href="classDRAMCtrl.html#a09bfc4deb4906dbc01007b1a4420224d" title="Pipeline latency of the controller frontend.">frontendLatency</a> + <a class="code" href="classDRAMCtrl.html#aa0144008a2be698cd3e1dc05d442cb5e" title="Pipeline latency of the backend and PHY.">backendLatency</a>);
<a name="l00722"></a>00722             <span class="keyword">delete</span> dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a989ec86491b77ec1d1febb9f4eba287b" title="A pointer to the BurstHelper if this DRAMPacket is a split packet If not a split...">burstHelper</a>;
<a name="l00723"></a>00723             dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a989ec86491b77ec1d1febb9f4eba287b" title="A pointer to the BurstHelper if this DRAMPacket is a split packet If not a split...">burstHelper</a> = NULL;
<a name="l00724"></a>00724         }
<a name="l00725"></a>00725     } <span class="keywordflow">else</span> {
<a name="l00726"></a>00726         <span class="comment">// it is not a split packet</span>
<a name="l00727"></a>00727         <a class="code" href="classDRAMCtrl.html#a2d8b5823fa1899c3eb0e3a0aed1663f6" title="When a packet reaches its &amp;quot;readyTime&amp;quot; in the response Q, use the &amp;quot;access()&amp;quot;...">accessAndRespond</a>(dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#ae6bba118f1ee6c4b311cf6c586067acb" title="This comes from the outside world.">pkt</a>, <a class="code" href="classDRAMCtrl.html#a09bfc4deb4906dbc01007b1a4420224d" title="Pipeline latency of the controller frontend.">frontendLatency</a> + <a class="code" href="classDRAMCtrl.html#aa0144008a2be698cd3e1dc05d442cb5e" title="Pipeline latency of the backend and PHY.">backendLatency</a>);
<a name="l00728"></a>00728     }
<a name="l00729"></a>00729 
<a name="l00730"></a>00730     <span class="keyword">delete</span> <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.front();
<a name="l00731"></a>00731     <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.pop_front();
<a name="l00732"></a>00732 
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.empty()) {
<a name="l00734"></a>00734         assert(<a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.front()-&gt;readyTime &gt;= <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l00735"></a>00735         assert(!<a class="code" href="classDRAMCtrl.html#acfd6a4867b7082b4bb7e8e50838a47c7">respondEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>());
<a name="l00736"></a>00736         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl.html#acfd6a4867b7082b4bb7e8e50838a47c7">respondEvent</a>, <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.front()-&gt;readyTime);
<a name="l00737"></a>00737     } <span class="keywordflow">else</span> {
<a name="l00738"></a>00738         <span class="comment">// if there is nothing left in any queue, signal a drain</span>
<a name="l00739"></a>00739         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.empty() &amp;&amp; <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.empty() &amp;&amp;
<a name="l00740"></a>00740             <a class="code" href="classDRAMCtrl.html#abb7acccc1136f56df2290bb7373053ac" title="If we need to drain, keep the drain manager around until we&amp;#39;re done here.">drainManager</a>) {
<a name="l00741"></a>00741             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Drain, <span class="stringliteral">&quot;DRAM controller done draining\n&quot;</span>);
<a name="l00742"></a>00742             <a class="code" href="classDRAMCtrl.html#abb7acccc1136f56df2290bb7373053ac" title="If we need to drain, keep the drain manager around until we&amp;#39;re done here.">drainManager</a>-&gt;<a class="code" href="classDrainManager.html#abd134e8277be09e702b63f36f6ee31d0" title="Notify the DrainManager that a Drainable object has finished draining.">signalDrainDone</a>();
<a name="l00743"></a>00743             <a class="code" href="classDRAMCtrl.html#abb7acccc1136f56df2290bb7373053ac" title="If we need to drain, keep the drain manager around until we&amp;#39;re done here.">drainManager</a> = NULL;
<a name="l00744"></a>00744         }
<a name="l00745"></a>00745     }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747     <span class="comment">// We have made a location in the queue available at this point,</span>
<a name="l00748"></a>00748     <span class="comment">// so if there is a read that was forced to wait, retry now</span>
<a name="l00749"></a>00749     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a2129ada5d479943d1a45b4ad01351510" title="Remember if we have to retry a request when available.">retryRdReq</a>) {
<a name="l00750"></a>00750         <a class="code" href="classDRAMCtrl.html#a2129ada5d479943d1a45b4ad01351510" title="Remember if we have to retry a request when available.">retryRdReq</a> = <span class="keyword">false</span>;
<a name="l00751"></a>00751         <a class="code" href="classDRAMCtrl.html#a87ee1aa46b80d77aea809cf3d00dbc31" title="Our incoming port, for a multi-ported controller add a crossbar in front of it.">port</a>.<a class="code" href="classSlavePort.html#a67844082a8044c21d26a4bc4669ccdc2" title="Send a retry to the master port that previously attempted a sendTimingReq to this...">sendRetryReq</a>();
<a name="l00752"></a>00752     }
<a name="l00753"></a>00753 }
<a name="l00754"></a>00754 
<a name="l00755"></a>00755 <span class="keywordtype">bool</span>
<a name="l00756"></a><a class="code" href="classDRAMCtrl.html#a61739184c84f0dbc76bd970e2c29df12">00756</a> <a class="code" href="classDRAMCtrl.html#a61739184c84f0dbc76bd970e2c29df12" title="The memory schduler/arbiter - picks which request needs to go next, based on the...">DRAMCtrl::chooseNext</a>(<a class="code" href="classstd_1_1deque.html">std::deque&lt;DRAMPacket*&gt;</a>&amp; queue, <span class="keywordtype">bool</span> switched_cmd_type)
<a name="l00757"></a>00757 {
<a name="l00758"></a>00758     <span class="comment">// This method does the arbitration between requests. The chosen</span>
<a name="l00759"></a>00759     <span class="comment">// packet is simply moved to the head of the queue. The other</span>
<a name="l00760"></a>00760     <span class="comment">// methods know that this is the place to look. For example, with</span>
<a name="l00761"></a>00761     <span class="comment">// FCFS, this method does nothing</span>
<a name="l00762"></a>00762     assert(!queue.empty());
<a name="l00763"></a>00763 
<a name="l00764"></a>00764     <span class="comment">// bool to indicate if a packet to an available rank is found</span>
<a name="l00765"></a>00765     <span class="keywordtype">bool</span> found_packet = <span class="keyword">false</span>;
<a name="l00766"></a>00766     <span class="keywordflow">if</span> (queue.size() == 1) {
<a name="l00767"></a>00767         <a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMPacket</a>* dram_pkt = queue.front();
<a name="l00768"></a>00768         <span class="comment">// available rank corresponds to state refresh idle</span>
<a name="l00769"></a>00769         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a6cef5fd4eeb110180f7c4e2e5ac7cc1e" title="Will be populated by address decoder.">rank</a>]-&gt;isAvailable()) {
<a name="l00770"></a>00770             found_packet = <span class="keyword">true</span>;
<a name="l00771"></a>00771             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Single request, going to a free rank\n&quot;</span>);
<a name="l00772"></a>00772         } <span class="keywordflow">else</span> {
<a name="l00773"></a>00773             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Single request, going to a busy rank\n&quot;</span>);
<a name="l00774"></a>00774         }
<a name="l00775"></a>00775         <span class="keywordflow">return</span> found_packet;
<a name="l00776"></a>00776     }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a0190da0af74310a407ffaf1935afe671" title="Memory controller configuration initialized based on parameter values.">memSchedPolicy</a> == Enums::fcfs) {
<a name="l00779"></a>00779         <span class="comment">// check if there is a packet going to a free rank</span>
<a name="l00780"></a>00780         <span class="keywordflow">for</span>(<span class="keyword">auto</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = queue.begin(); <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> != queue.end() ; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l00781"></a>00781             <a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMPacket</a>* dram_pkt = *<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>;
<a name="l00782"></a>00782             <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a6cef5fd4eeb110180f7c4e2e5ac7cc1e" title="Will be populated by address decoder.">rank</a>]-&gt;isAvailable()) {
<a name="l00783"></a>00783                 queue.erase(<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>);
<a name="l00784"></a>00784                 queue.push_front(dram_pkt);
<a name="l00785"></a>00785                 found_packet = <span class="keyword">true</span>;
<a name="l00786"></a>00786                 <span class="keywordflow">break</span>;
<a name="l00787"></a>00787             }
<a name="l00788"></a>00788         }
<a name="l00789"></a>00789     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a0190da0af74310a407ffaf1935afe671" title="Memory controller configuration initialized based on parameter values.">memSchedPolicy</a> == Enums::frfcfs) {
<a name="l00790"></a>00790         found_packet = <a class="code" href="classDRAMCtrl.html#ac67d00dcddc4d8c308a91519853f7a58" title="For FR-FCFS policy reorder the read/write queue depending on row buffer hits and...">reorderQueue</a>(queue, switched_cmd_type);
<a name="l00791"></a>00791     } <span class="keywordflow">else</span>
<a name="l00792"></a>00792         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;No scheduling policy chosen\n&quot;</span>);
<a name="l00793"></a>00793     <span class="keywordflow">return</span> found_packet;
<a name="l00794"></a>00794 }
<a name="l00795"></a>00795 
<a name="l00796"></a>00796 <span class="keywordtype">bool</span>
<a name="l00797"></a><a class="code" href="classDRAMCtrl.html#ac67d00dcddc4d8c308a91519853f7a58">00797</a> <a class="code" href="classDRAMCtrl.html#ac67d00dcddc4d8c308a91519853f7a58" title="For FR-FCFS policy reorder the read/write queue depending on row buffer hits and...">DRAMCtrl::reorderQueue</a>(<a class="code" href="classstd_1_1deque.html">std::deque&lt;DRAMPacket*&gt;</a>&amp; queue, <span class="keywordtype">bool</span> switched_cmd_type)
<a name="l00798"></a>00798 {
<a name="l00799"></a>00799     <span class="comment">// Only determine this when needed</span>
<a name="l00800"></a>00800     uint64_t earliest_banks = 0;
<a name="l00801"></a>00801 
<a name="l00802"></a>00802     <span class="comment">// Search for row hits first, if no row hit is found then schedule the</span>
<a name="l00803"></a>00803     <span class="comment">// packet to one of the earliest banks available</span>
<a name="l00804"></a>00804     <span class="keywordtype">bool</span> found_packet = <span class="keyword">false</span>;
<a name="l00805"></a>00805     <span class="keywordtype">bool</span> found_earliest_pkt = <span class="keyword">false</span>;
<a name="l00806"></a>00806     <span class="keywordtype">bool</span> found_prepped_diff_rank_pkt = <span class="keyword">false</span>;
<a name="l00807"></a>00807     <span class="keyword">auto</span> selected_pkt_it = queue.end();
<a name="l00808"></a>00808 
<a name="l00809"></a>00809     <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = queue.begin(); <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> != queue.end() ; ++<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>) {
<a name="l00810"></a>00810         <a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMPacket</a>* dram_pkt = *<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>;
<a name="l00811"></a>00811         <span class="keyword">const</span> <a class="code" href="classDRAMCtrl_1_1Bank.html" title="A basic class to track the bank state, i.e.">Bank</a>&amp; bank = dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#acd4b59aed508d9d1029aa7c81f40c04f">bankRef</a>;
<a name="l00812"></a>00812         <span class="comment">// check if rank is busy. If this is the case jump to the next packet</span>
<a name="l00813"></a>00813         <span class="comment">// Check if it is a row hit</span>
<a name="l00814"></a>00814         <span class="keywordflow">if</span> (dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a9e83e4bdcabb2cca59db47ea95506538">rankRef</a>.<a class="code" href="classDRAMCtrl_1_1Rank.html#adcf612be05ea3aca8d04fee48e18184c" title="Check if the current rank is available for scheduling.">isAvailable</a>()) {
<a name="l00815"></a>00815             <span class="keywordflow">if</span> (bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a58cb45d82060d94997a5e1bc0ba7bd5a">openRow</a> == dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a78116b4aed3964a0811ba11199f85b3e">row</a>) {
<a name="l00816"></a>00816                 <span class="keywordflow">if</span> (dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a6cef5fd4eeb110180f7c4e2e5ac7cc1e" title="Will be populated by address decoder.">rank</a> == <a class="code" href="classDRAMCtrl.html#ac8f112decf864fe3a7877790f950ebb9">activeRank</a> || switched_cmd_type) {
<a name="l00817"></a>00817                     <span class="comment">// FCFS within the hits, giving priority to commands</span>
<a name="l00818"></a>00818                     <span class="comment">// that access the same rank as the previous burst</span>
<a name="l00819"></a>00819                     <span class="comment">// to minimize bus turnaround delays</span>
<a name="l00820"></a>00820                     <span class="comment">// Only give rank prioity when command type is</span>
<a name="l00821"></a>00821                     <span class="comment">// not changing</span>
<a name="l00822"></a>00822                     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Row buffer hit\n&quot;</span>);
<a name="l00823"></a>00823                     selected_pkt_it = <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>;
<a name="l00824"></a>00824                     <span class="keywordflow">break</span>;
<a name="l00825"></a>00825                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!found_prepped_diff_rank_pkt) {
<a name="l00826"></a>00826                     <span class="comment">// found row hit for command on different rank</span>
<a name="l00827"></a>00827                     <span class="comment">// than prev burst</span>
<a name="l00828"></a>00828                     selected_pkt_it = <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>;
<a name="l00829"></a>00829                     found_prepped_diff_rank_pkt = <span class="keyword">true</span>;
<a name="l00830"></a>00830                 }
<a name="l00831"></a>00831             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!found_earliest_pkt &amp; !found_prepped_diff_rank_pkt) {
<a name="l00832"></a>00832                 <span class="comment">// packet going to a rank which is currently not waiting for a</span>
<a name="l00833"></a>00833                 <span class="comment">// refresh, No row hit and</span>
<a name="l00834"></a>00834                 <span class="comment">// haven&apos;t found an entry with a row hit to a new rank</span>
<a name="l00835"></a>00835                 <span class="keywordflow">if</span> (earliest_banks == 0)
<a name="l00836"></a>00836                     <span class="comment">// Determine entries with earliest bank prep delay</span>
<a name="l00837"></a>00837                     <span class="comment">// Function will give priority to commands that access the</span>
<a name="l00838"></a>00838                     <span class="comment">// same rank as previous burst and can prep</span>
<a name="l00839"></a>00839                     <span class="comment">// the bank seamlessly</span>
<a name="l00840"></a>00840                     earliest_banks = <a class="code" href="classDRAMCtrl.html#a89edb261a10dfa66aaf13cceb88fbb6f" title="Find which are the earliest banks ready to issue an activate for the enqueued requests...">minBankPrep</a>(queue, switched_cmd_type);
<a name="l00841"></a>00841 
<a name="l00842"></a>00842                 <span class="comment">// FCFS - Bank is first available bank</span>
<a name="l00843"></a>00843                 <span class="keywordflow">if</span> (<a class="code" href="bitfield_8hh.html#a4ee0dc0723e11679c52429d5f8e05123" title="Extract the bitfield from position &amp;#39;first&amp;#39; to &amp;#39;last&amp;#39; (inclusive)...">bits</a>(earliest_banks, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a22cd0c3ab4ab2b27631b43ae1246d7c4" title="Bank id is calculated considering banks in all the ranks eg: 2 ranks each with 8...">bankId</a>,
<a name="l00844"></a>00844                     dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a22cd0c3ab4ab2b27631b43ae1246d7c4" title="Bank id is calculated considering banks in all the ranks eg: 2 ranks each with 8...">bankId</a>)) {
<a name="l00845"></a>00845                     <span class="comment">// Remember the packet to be scheduled to one of</span>
<a name="l00846"></a>00846                     <span class="comment">// the earliest banks available, FCFS amongst the</span>
<a name="l00847"></a>00847                     <span class="comment">// earliest banks</span>
<a name="l00848"></a>00848                     selected_pkt_it = <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>;
<a name="l00849"></a>00849                     <span class="comment">//if the packet found is going to a rank that is currently</span>
<a name="l00850"></a>00850                     <span class="comment">//not busy then update the found_packet to true</span>
<a name="l00851"></a>00851                     found_earliest_pkt = <span class="keyword">true</span>;
<a name="l00852"></a>00852                 }
<a name="l00853"></a>00853             }
<a name="l00854"></a>00854         }
<a name="l00855"></a>00855     }
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     <span class="keywordflow">if</span> (selected_pkt_it != queue.end()) {
<a name="l00858"></a>00858         <a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMPacket</a>* selected_pkt = *selected_pkt_it;
<a name="l00859"></a>00859         queue.erase(selected_pkt_it);
<a name="l00860"></a>00860         queue.push_front(selected_pkt);
<a name="l00861"></a>00861         found_packet = <span class="keyword">true</span>;
<a name="l00862"></a>00862     }
<a name="l00863"></a>00863     <span class="keywordflow">return</span> found_packet;
<a name="l00864"></a>00864 }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866 <span class="keywordtype">void</span>
<a name="l00867"></a><a class="code" href="classDRAMCtrl.html#a2d8b5823fa1899c3eb0e3a0aed1663f6">00867</a> <a class="code" href="classDRAMCtrl.html#a2d8b5823fa1899c3eb0e3a0aed1663f6" title="When a packet reaches its &amp;quot;readyTime&amp;quot; in the response Q, use the &amp;quot;access()&amp;quot;...">DRAMCtrl::accessAndRespond</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt, <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> static_latency)
<a name="l00868"></a>00868 {
<a name="l00869"></a>00869     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Responding to Address %lld.. &quot;</span>,pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>());
<a name="l00870"></a>00870 
<a name="l00871"></a>00871     <span class="keywordtype">bool</span> needsResponse = pkt-&gt;<a class="code" href="classPacket.html#a3eafb3dde5f57c16f684862aff8da0b3">needsResponse</a>();
<a name="l00872"></a>00872     <span class="comment">// do the actual memory access which also turns the packet into a</span>
<a name="l00873"></a>00873     <span class="comment">// response</span>
<a name="l00874"></a>00874     <a class="code" href="classAbstractMemory.html#a4f8bf048c846bef573325f47a0603b09" title="Perform an untimed memory access and update all the state (e.g.">access</a>(pkt);
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     <span class="comment">// turn packet around to go back to requester if response expected</span>
<a name="l00877"></a>00877     <span class="keywordflow">if</span> (needsResponse) {
<a name="l00878"></a>00878         <span class="comment">// access already turned the packet into a response</span>
<a name="l00879"></a>00879         assert(pkt-&gt;<a class="code" href="classPacket.html#ae55f4c38bf6367f308c935cb833027ee">isResponse</a>());
<a name="l00880"></a>00880         <span class="comment">// response_time consumes the static latency and is charged also</span>
<a name="l00881"></a>00881         <span class="comment">// with headerDelay that takes into account the delay provided by</span>
<a name="l00882"></a>00882         <span class="comment">// the xbar and also the payloadDelay that takes into account the</span>
<a name="l00883"></a>00883         <span class="comment">// number of data beats.</span>
<a name="l00884"></a>00884         <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> response_time = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() + static_latency + pkt-&gt;<a class="code" href="classPacket.html#ae035c719eee7a7713ab831a11e9e7406" title="The extra delay from seeing the packet until the header is transmitted.">headerDelay</a> +
<a name="l00885"></a>00885                              pkt-&gt;<a class="code" href="classPacket.html#a672f63108880c72376276d9ed01b3fc3" title="The extra pipelining delay from seeing the packet until the end of payload is transmitted...">payloadDelay</a>;
<a name="l00886"></a>00886         <span class="comment">// Here we reset the timing of the packet before sending it out.</span>
<a name="l00887"></a>00887         pkt-&gt;<a class="code" href="classPacket.html#ae035c719eee7a7713ab831a11e9e7406" title="The extra delay from seeing the packet until the header is transmitted.">headerDelay</a> = pkt-&gt;<a class="code" href="classPacket.html#a672f63108880c72376276d9ed01b3fc3" title="The extra pipelining delay from seeing the packet until the end of payload is transmitted...">payloadDelay</a> = 0;
<a name="l00888"></a>00888 
<a name="l00889"></a>00889         <span class="comment">// queue the packet in the response queue to be sent out after</span>
<a name="l00890"></a>00890         <span class="comment">// the static latency has passed</span>
<a name="l00891"></a>00891         <a class="code" href="classDRAMCtrl.html#a87ee1aa46b80d77aea809cf3d00dbc31" title="Our incoming port, for a multi-ported controller add a crossbar in front of it.">port</a>.<a class="code" href="classQueuedSlavePort.html#a99f59dcf30fb949b9c2ff72928e23a97" title="Schedule the sending of a timing response.">schedTimingResp</a>(pkt, response_time);
<a name="l00892"></a>00892     } <span class="keywordflow">else</span> {
<a name="l00893"></a>00893         <span class="comment">// @todo the packet is going to be deleted, and the DRAMPacket</span>
<a name="l00894"></a>00894         <span class="comment">// is still having a pointer to it</span>
<a name="l00895"></a>00895         <a class="code" href="classDRAMCtrl.html#a191c65a436d32961f1e75b219da49349">pendingDelete</a>.push_back(pkt);
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Done\n&quot;</span>);
<a name="l00899"></a>00899 
<a name="l00900"></a>00900     <span class="keywordflow">return</span>;
<a name="l00901"></a>00901 }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903 <span class="keywordtype">void</span>
<a name="l00904"></a><a class="code" href="classDRAMCtrl.html#a6f2918ec23ddd901e763de2ebfe987c2">00904</a> <a class="code" href="classDRAMCtrl.html#a6f2918ec23ddd901e763de2ebfe987c2" title="Keep track of when row activations happen, in order to enforce the maximum number...">DRAMCtrl::activateBank</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html" title="Rank class includes a vector of banks.">Rank</a>&amp; rank_ref, <a class="code" href="classDRAMCtrl_1_1Bank.html" title="A basic class to track the bank state, i.e.">Bank</a>&amp; bank_ref,
<a name="l00905"></a>00905                        <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> act_tick, uint32_t row)
<a name="l00906"></a>00906 {
<a name="l00907"></a>00907     assert(rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.size() == <a class="code" href="classDRAMCtrl.html#a672f14358c685122136d12a52eda5056">activationLimit</a>);
<a name="l00908"></a>00908 
<a name="l00909"></a>00909     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Activate at tick %d\n&quot;</span>, act_tick);
<a name="l00910"></a>00910 
<a name="l00911"></a>00911     <span class="comment">// update the open row</span>
<a name="l00912"></a>00912     assert(bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#a58cb45d82060d94997a5e1bc0ba7bd5a">openRow</a> == <a class="code" href="classDRAMCtrl_1_1Bank.html#a81fa13164d43b203076fcdacde0fb6c8">Bank::NO_ROW</a>);
<a name="l00913"></a>00913     bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#a58cb45d82060d94997a5e1bc0ba7bd5a">openRow</a> = row;
<a name="l00914"></a>00914 
<a name="l00915"></a>00915     <span class="comment">// start counting anew, this covers both the case when we</span>
<a name="l00916"></a>00916     <span class="comment">// auto-precharged, and when this access is forced to</span>
<a name="l00917"></a>00917     <span class="comment">// precharge</span>
<a name="l00918"></a>00918     bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#ae0480ffe9e97759c4687b53716cda8d3">bytesAccessed</a> = 0;
<a name="l00919"></a>00919     bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#a8c9c22bb03ee0ed435725ab2fb38c09a">rowAccesses</a> = 0;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     ++rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#abb35437efe71e911365685b3cfb5cc7b" title="To track number of banks which are currently active for this rank.">numBanksActive</a>;
<a name="l00922"></a>00922     assert(rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#abb35437efe71e911365685b3cfb5cc7b" title="To track number of banks which are currently active for this rank.">numBanksActive</a> &lt;= <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>);
<a name="l00923"></a>00923 
<a name="l00924"></a>00924     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Activate bank %d, rank %d at tick %lld, now got %d active\n&quot;</span>,
<a name="l00925"></a>00925             bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#a1e8c245e79935ec846ec00bd49125062">bank</a>, rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#ac2a0c59264a34d8d6712ac4e763cd915" title="Current Rank index.">rank</a>, act_tick,
<a name="l00926"></a>00926             <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#ac2a0c59264a34d8d6712ac4e763cd915" title="Current Rank index.">rank</a>]-&gt;numBanksActive);
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.doCommand(MemCommand::ACT, bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#a1e8c245e79935ec846ec00bd49125062">bank</a>,
<a name="l00929"></a>00929                                       <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(act_tick, <a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>) -
<a name="l00930"></a>00930                                       <a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a>);
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classDRAMPower.html" title="DRAMPower is a standalone tool which calculates the power consumed by a DRAM in the...">DRAMPower</a>, <span class="stringliteral">&quot;%llu,ACT,%d,%d\n&quot;</span>, <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(act_tick, <a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>) -
<a name="l00933"></a>00933             <a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a>, bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#a1e8c245e79935ec846ec00bd49125062">bank</a>, rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#ac2a0c59264a34d8d6712ac4e763cd915" title="Current Rank index.">rank</a>);
<a name="l00934"></a>00934 
<a name="l00935"></a>00935     <span class="comment">// The next access has to respect tRAS for this bank</span>
<a name="l00936"></a>00936     bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#a159aa76867a077fa1cd4540fc4d92cf6">preAllowedAt</a> = act_tick + <a class="code" href="classDRAMCtrl.html#a2f51efde09e5109c6dabc084ddc688f5">tRAS</a>;
<a name="l00937"></a>00937 
<a name="l00938"></a>00938     <span class="comment">// Respect the row-to-column command delay</span>
<a name="l00939"></a>00939     bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#a460ed4eed04e9ee70e7de2f753580cb3">colAllowedAt</a> = std::max(act_tick + <a class="code" href="classDRAMCtrl.html#a135f02135b5947e4bd4924a73af5f35c">tRCD</a>, bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#a460ed4eed04e9ee70e7de2f753580cb3">colAllowedAt</a>);
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <span class="comment">// start by enforcing tRRD</span>
<a name="l00942"></a>00942     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++) {
<a name="l00943"></a>00943         <span class="comment">// next activate to any bank in this rank must not happen</span>
<a name="l00944"></a>00944         <span class="comment">// before tRRD</span>
<a name="l00945"></a>00945         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a0f8e4a158ae37c8d2925a9fa327691f0">bankGroupArch</a> &amp;&amp; (bank_ref.<a class="code" href="classDRAMCtrl_1_1Bank.html#af6c7d3ce331371125f2b38f3626d7408">bankgr</a> == rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].bankgr)) {
<a name="l00946"></a>00946             <span class="comment">// bank group architecture requires longer delays between</span>
<a name="l00947"></a>00947             <span class="comment">// ACT commands within the same bank group.  Use tRRD_L</span>
<a name="l00948"></a>00948             <span class="comment">// in this case</span>
<a name="l00949"></a>00949             rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].actAllowedAt = std::max(act_tick + <a class="code" href="classDRAMCtrl.html#a45b442edfd5e743e0ab20184e03b6ea2">tRRD_L</a>,
<a name="l00950"></a>00950                                              rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].actAllowedAt);
<a name="l00951"></a>00951         } <span class="keywordflow">else</span> {
<a name="l00952"></a>00952             <span class="comment">// use shorter tRRD value when either</span>
<a name="l00953"></a>00953             <span class="comment">// 1) bank group architecture is not supportted</span>
<a name="l00954"></a>00954             <span class="comment">// 2) bank is in a different bank group</span>
<a name="l00955"></a>00955             rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].actAllowedAt = std::max(act_tick + <a class="code" href="classDRAMCtrl.html#a534e8ffd35d85f2016c2c98d0b50cf2c">tRRD</a>,
<a name="l00956"></a>00956                                              rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].actAllowedAt);
<a name="l00957"></a>00957         }
<a name="l00958"></a>00958     }
<a name="l00959"></a>00959 
<a name="l00960"></a>00960     <span class="comment">// next, we deal with tXAW, if the activation limit is disabled</span>
<a name="l00961"></a>00961     <span class="comment">// then we directly schedule an activate power event</span>
<a name="l00962"></a>00962     <span class="keywordflow">if</span> (!rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.empty()) {
<a name="l00963"></a>00963         <span class="comment">// sanity check</span>
<a name="l00964"></a>00964         <span class="keywordflow">if</span> (rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.back() &amp;&amp;
<a name="l00965"></a>00965            (act_tick - rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.back()) &lt; <a class="code" href="classDRAMCtrl.html#a548a59c51b5f2db7cbdd9848b932912f">tXAW</a>) {
<a name="l00966"></a>00966             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Got %d activates in window %d (%llu - %llu) which &quot;</span>
<a name="l00967"></a>00967                   <span class="stringliteral">&quot;is smaller than %llu\n&quot;</span>, <a class="code" href="classDRAMCtrl.html#a672f14358c685122136d12a52eda5056">activationLimit</a>, act_tick -
<a name="l00968"></a>00968                   rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.back(), act_tick,
<a name="l00969"></a>00969                   rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.back(), <a class="code" href="classDRAMCtrl.html#a548a59c51b5f2db7cbdd9848b932912f">tXAW</a>);
<a name="l00970"></a>00970         }
<a name="l00971"></a>00971 
<a name="l00972"></a>00972         <span class="comment">// shift the times used for the book keeping, the last element</span>
<a name="l00973"></a>00973         <span class="comment">// (highest index) is the oldest one and hence the lowest value</span>
<a name="l00974"></a>00974         rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.pop_back();
<a name="l00975"></a>00975 
<a name="l00976"></a>00976         <span class="comment">// record an new activation (in the future)</span>
<a name="l00977"></a>00977         rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.push_front(act_tick);
<a name="l00978"></a>00978 
<a name="l00979"></a>00979         <span class="comment">// cannot activate more than X times in time window tXAW, push the</span>
<a name="l00980"></a>00980         <span class="comment">// next one (the X + 1&apos;st activate) to be tXAW away from the</span>
<a name="l00981"></a>00981         <span class="comment">// oldest in our window of X</span>
<a name="l00982"></a>00982         <span class="keywordflow">if</span> (rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.back() &amp;&amp;
<a name="l00983"></a>00983            (act_tick - rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.back()) &lt; <a class="code" href="classDRAMCtrl.html#a548a59c51b5f2db7cbdd9848b932912f">tXAW</a>) {
<a name="l00984"></a>00984             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Enforcing tXAW with X = %d, next activate &quot;</span>
<a name="l00985"></a>00985                     <span class="stringliteral">&quot;no earlier than %llu\n&quot;</span>, <a class="code" href="classDRAMCtrl.html#a672f14358c685122136d12a52eda5056">activationLimit</a>,
<a name="l00986"></a>00986                     rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.back() + <a class="code" href="classDRAMCtrl.html#a548a59c51b5f2db7cbdd9848b932912f">tXAW</a>);
<a name="l00987"></a>00987             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a> = 0; <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a> &lt; banksPerRank; <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>++)
<a name="l00988"></a>00988                 <span class="comment">// next activate must not happen before end of window</span>
<a name="l00989"></a>00989                 rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>[<a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>].actAllowedAt =
<a name="l00990"></a>00990                     std::max(rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a3a8b748a94c3123372928564f00a5d57" title="List to keep track of activate ticks.">actTicks</a>.back() + <a class="code" href="classDRAMCtrl.html#a548a59c51b5f2db7cbdd9848b932912f">tXAW</a>,
<a name="l00991"></a>00991                              rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>[<a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>].actAllowedAt);
<a name="l00992"></a>00992         }
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995     <span class="comment">// at the point when this activate takes place, make sure we</span>
<a name="l00996"></a>00996     <span class="comment">// transition to the active power state</span>
<a name="l00997"></a>00997     <span class="keywordflow">if</span> (!rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a4541c80ee79579416104f1e3b28b800b">activateEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>())
<a name="l00998"></a>00998         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a4541c80ee79579416104f1e3b28b800b">activateEvent</a>, act_tick);
<a name="l00999"></a>00999     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a4541c80ee79579416104f1e3b28b800b">activateEvent</a>.<a class="code" href="classEvent.html#a3ff737aa0692f1ea9b8dd232778f2fcb" title="Get the time that the event is scheduled.">when</a>() &gt; act_tick)
<a name="l01000"></a>01000         <span class="comment">// move it sooner in time</span>
<a name="l01001"></a>01001         <a class="code" href="classEventManager.html#a766c5f955dfa1609696955f075492687">reschedule</a>(rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a4541c80ee79579416104f1e3b28b800b">activateEvent</a>, act_tick);
<a name="l01002"></a>01002 }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004 <span class="keywordtype">void</span>
<a name="l01005"></a><a class="code" href="classDRAMCtrl.html#a7004ae8efe3eeb94220b53be3d25ea0e">01005</a> <a class="code" href="classDRAMCtrl.html#a7004ae8efe3eeb94220b53be3d25ea0e" title="Precharge a given bank and also update when the precharge is done.">DRAMCtrl::prechargeBank</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html" title="Rank class includes a vector of banks.">Rank</a>&amp; rank_ref, <a class="code" href="classDRAMCtrl_1_1Bank.html" title="A basic class to track the bank state, i.e.">Bank</a>&amp; bank, <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> pre_at, <span class="keywordtype">bool</span> trace)
<a name="l01006"></a>01006 {
<a name="l01007"></a>01007     <span class="comment">// make sure the bank has an open row</span>
<a name="l01008"></a>01008     assert(bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a58cb45d82060d94997a5e1bc0ba7bd5a">openRow</a> != <a class="code" href="classDRAMCtrl_1_1Bank.html#a81fa13164d43b203076fcdacde0fb6c8">Bank::NO_ROW</a>);
<a name="l01009"></a>01009 
<a name="l01010"></a>01010     <span class="comment">// sample the bytes per activate here since we are closing</span>
<a name="l01011"></a>01011     <span class="comment">// the page</span>
<a name="l01012"></a>01012     <a class="code" href="classDRAMCtrl.html#abdc3b8276837ac7c784edf434d3bfd9d">bytesPerActivate</a>.<a class="code" href="classStats_1_1DistBase.html#a5cb4a9cb9fac72ca7c0a8737c31d11be" title="Add a value to the distribtion n times.">sample</a>(bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#ae0480ffe9e97759c4687b53716cda8d3">bytesAccessed</a>);
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a58cb45d82060d94997a5e1bc0ba7bd5a">openRow</a> = <a class="code" href="classDRAMCtrl_1_1Bank.html#a81fa13164d43b203076fcdacde0fb6c8">Bank::NO_ROW</a>;
<a name="l01015"></a>01015 
<a name="l01016"></a>01016     <span class="comment">// no precharge allowed before this one</span>
<a name="l01017"></a>01017     bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a159aa76867a077fa1cd4540fc4d92cf6">preAllowedAt</a> = pre_at;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> pre_done_at = pre_at + <a class="code" href="classDRAMCtrl.html#a1edd216a091aa2ec675985c16134d626">tRP</a>;
<a name="l01020"></a>01020 
<a name="l01021"></a>01021     bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a1b4486326786655058c8971e3d155d6e">actAllowedAt</a> = std::max(bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a1b4486326786655058c8971e3d155d6e">actAllowedAt</a>, pre_done_at);
<a name="l01022"></a>01022 
<a name="l01023"></a>01023     assert(rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#abb35437efe71e911365685b3cfb5cc7b" title="To track number of banks which are currently active for this rank.">numBanksActive</a> != 0);
<a name="l01024"></a>01024     --rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#abb35437efe71e911365685b3cfb5cc7b" title="To track number of banks which are currently active for this rank.">numBanksActive</a>;
<a name="l01025"></a>01025 
<a name="l01026"></a>01026     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Precharging bank %d, rank %d at tick %lld, now got &quot;</span>
<a name="l01027"></a>01027             <span class="stringliteral">&quot;%d active\n&quot;</span>, bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a1e8c245e79935ec846ec00bd49125062">bank</a>, rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#ac2a0c59264a34d8d6712ac4e763cd915" title="Current Rank index.">rank</a>, pre_at,
<a name="l01028"></a>01028             rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#abb35437efe71e911365685b3cfb5cc7b" title="To track number of banks which are currently active for this rank.">numBanksActive</a>);
<a name="l01029"></a>01029 
<a name="l01030"></a>01030     <span class="keywordflow">if</span> (trace) {
<a name="l01031"></a>01031 
<a name="l01032"></a>01032         rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.doCommand(MemCommand::PRE, bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a1e8c245e79935ec846ec00bd49125062">bank</a>,
<a name="l01033"></a>01033                                                 <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(pre_at, <a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>) -
<a name="l01034"></a>01034                                                 <a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a>);
<a name="l01035"></a>01035         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classDRAMPower.html" title="DRAMPower is a standalone tool which calculates the power consumed by a DRAM in the...">DRAMPower</a>, <span class="stringliteral">&quot;%llu,PRE,%d,%d\n&quot;</span>, <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(pre_at, <a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>) -
<a name="l01036"></a>01036                 <a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a>, bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a1e8c245e79935ec846ec00bd49125062">bank</a>, rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#ac2a0c59264a34d8d6712ac4e763cd915" title="Current Rank index.">rank</a>);
<a name="l01037"></a>01037     }
<a name="l01038"></a>01038     <span class="comment">// if we look at the current number of active banks we might be</span>
<a name="l01039"></a>01039     <span class="comment">// tempted to think the DRAM is now idle, however this can be</span>
<a name="l01040"></a>01040     <span class="comment">// undone by an activate that is scheduled to happen before we</span>
<a name="l01041"></a>01041     <span class="comment">// would have reached the idle state, so schedule an event and</span>
<a name="l01042"></a>01042     <span class="comment">// rather check once we actually make it to the point in time when</span>
<a name="l01043"></a>01043     <span class="comment">// the (last) precharge takes place</span>
<a name="l01044"></a>01044     <span class="keywordflow">if</span> (!rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a6b3cab1007eae53f4a9f436108dc4621">prechargeEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>())
<a name="l01045"></a>01045         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a6b3cab1007eae53f4a9f436108dc4621">prechargeEvent</a>, pre_done_at);
<a name="l01046"></a>01046     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a6b3cab1007eae53f4a9f436108dc4621">prechargeEvent</a>.<a class="code" href="classEvent.html#a3ff737aa0692f1ea9b8dd232778f2fcb" title="Get the time that the event is scheduled.">when</a>() &lt; pre_done_at)
<a name="l01047"></a>01047         <a class="code" href="classEventManager.html#a766c5f955dfa1609696955f075492687">reschedule</a>(rank_ref.<a class="code" href="classDRAMCtrl_1_1Rank.html#a6b3cab1007eae53f4a9f436108dc4621">prechargeEvent</a>, pre_done_at);
<a name="l01048"></a>01048 }
<a name="l01049"></a>01049 
<a name="l01050"></a>01050 <span class="keywordtype">void</span>
<a name="l01051"></a><a class="code" href="classDRAMCtrl.html#a349772bfe111e2019b56c5edcead2c12">01051</a> <a class="code" href="classDRAMCtrl.html#a349772bfe111e2019b56c5edcead2c12" title="Actually do the DRAM access - figure out the latency it will take to service the...">DRAMCtrl::doDRAMAccess</a>(<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMPacket</a>* dram_pkt)
<a name="l01052"></a>01052 {
<a name="l01053"></a>01053     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Timing access to addr %lld, rank/bank/row %d %d %d\n&quot;</span>,
<a name="l01054"></a>01054             dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a7206eb9c464e7d78b313fc7c18d3e033" title="The starting address of the DRAM packet.">addr</a>, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a6cef5fd4eeb110180f7c4e2e5ac7cc1e" title="Will be populated by address decoder.">rank</a>, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a52d6e506cbb321c70721be83d9d4bc55">bank</a>, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a78116b4aed3964a0811ba11199f85b3e">row</a>);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056     <span class="comment">// get the rank</span>
<a name="l01057"></a>01057     <a class="code" href="classDRAMCtrl_1_1Rank.html" title="Rank class includes a vector of banks.">Rank</a>&amp; rank = dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a9e83e4bdcabb2cca59db47ea95506538">rankRef</a>;
<a name="l01058"></a>01058 
<a name="l01059"></a>01059     <span class="comment">// get the bank</span>
<a name="l01060"></a>01060     <a class="code" href="classDRAMCtrl_1_1Bank.html" title="A basic class to track the bank state, i.e.">Bank</a>&amp; bank = dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#acd4b59aed508d9d1029aa7c81f40c04f">bankRef</a>;
<a name="l01061"></a>01061 
<a name="l01062"></a>01062     <span class="comment">// for the state we need to track if it is a row hit or not</span>
<a name="l01063"></a>01063     <span class="keywordtype">bool</span> row_hit = <span class="keyword">true</span>;
<a name="l01064"></a>01064 
<a name="l01065"></a>01065     <span class="comment">// respect any constraints on the command (e.g. tRCD or tCCD)</span>
<a name="l01066"></a>01066     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> cmd_at = std::max(bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a460ed4eed04e9ee70e7de2f753580cb3">colAllowedAt</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01067"></a>01067 
<a name="l01068"></a>01068     <span class="comment">// Determine the access latency and update the bank state</span>
<a name="l01069"></a>01069     <span class="keywordflow">if</span> (bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a58cb45d82060d94997a5e1bc0ba7bd5a">openRow</a> == dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a78116b4aed3964a0811ba11199f85b3e">row</a>) {
<a name="l01070"></a>01070         <span class="comment">// nothing to do</span>
<a name="l01071"></a>01071     } <span class="keywordflow">else</span> {
<a name="l01072"></a>01072         row_hit = <span class="keyword">false</span>;
<a name="l01073"></a>01073 
<a name="l01074"></a>01074         <span class="comment">// If there is a page open, precharge it.</span>
<a name="l01075"></a>01075         <span class="keywordflow">if</span> (bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a58cb45d82060d94997a5e1bc0ba7bd5a">openRow</a> != <a class="code" href="classDRAMCtrl_1_1Bank.html#a81fa13164d43b203076fcdacde0fb6c8">Bank::NO_ROW</a>) {
<a name="l01076"></a>01076             <a class="code" href="classDRAMCtrl.html#a7004ae8efe3eeb94220b53be3d25ea0e" title="Precharge a given bank and also update when the precharge is done.">prechargeBank</a>(rank, bank, std::max(bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a159aa76867a077fa1cd4540fc4d92cf6">preAllowedAt</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>()));
<a name="l01077"></a>01077         }
<a name="l01078"></a>01078 
<a name="l01079"></a>01079         <span class="comment">// next we need to account for the delay in activating the</span>
<a name="l01080"></a>01080         <span class="comment">// page</span>
<a name="l01081"></a>01081         <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> act_tick = std::max(bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a1b4486326786655058c8971e3d155d6e">actAllowedAt</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01082"></a>01082 
<a name="l01083"></a>01083         <span class="comment">// Record the activation and deal with all the global timing</span>
<a name="l01084"></a>01084         <span class="comment">// constraints caused be a new activation (tRRD and tXAW)</span>
<a name="l01085"></a>01085         <a class="code" href="classDRAMCtrl.html#a6f2918ec23ddd901e763de2ebfe987c2" title="Keep track of when row activations happen, in order to enforce the maximum number...">activateBank</a>(rank, bank, act_tick, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a78116b4aed3964a0811ba11199f85b3e">row</a>);
<a name="l01086"></a>01086 
<a name="l01087"></a>01087         <span class="comment">// issue the command as early as possible</span>
<a name="l01088"></a>01088         cmd_at = bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a460ed4eed04e9ee70e7de2f753580cb3">colAllowedAt</a>;
<a name="l01089"></a>01089     }
<a name="l01090"></a>01090 
<a name="l01091"></a>01091     <span class="comment">// we need to wait until the bus is available before we can issue</span>
<a name="l01092"></a>01092     <span class="comment">// the command</span>
<a name="l01093"></a>01093     cmd_at = std::max(cmd_at, <a class="code" href="classDRAMCtrl.html#a14f669b4a31a66dd15e42f02a7f0cb62" title="Till when has the main data bus been spoken for already?">busBusyUntil</a> - <a class="code" href="classDRAMCtrl.html#ae7ebffccab6cd342fddbcba75aee6c3b">tCL</a>);
<a name="l01094"></a>01094 
<a name="l01095"></a>01095     <span class="comment">// update the packet ready time</span>
<a name="l01096"></a>01096     dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a0e877f5f0c8f6742e273914cfc3fe014" title="When will request leave the controller.">readyTime</a> = cmd_at + <a class="code" href="classDRAMCtrl.html#ae7ebffccab6cd342fddbcba75aee6c3b">tCL</a> + <a class="code" href="classDRAMCtrl.html#aab4d9d3128f0373a72c28be6a4d02923">tBURST</a>;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098     <span class="comment">// only one burst can use the bus at any one point in time</span>
<a name="l01099"></a>01099     assert(dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a0e877f5f0c8f6742e273914cfc3fe014" title="When will request leave the controller.">readyTime</a> - <a class="code" href="classDRAMCtrl.html#a14f669b4a31a66dd15e42f02a7f0cb62" title="Till when has the main data bus been spoken for already?">busBusyUntil</a> &gt;= tBURST);
<a name="l01100"></a>01100 
<a name="l01101"></a>01101     <span class="comment">// update the time for the next read/write burst for each</span>
<a name="l01102"></a>01102     <span class="comment">// bank (add a max with tCCD/tCCD_L here)</span>
<a name="l01103"></a>01103     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> cmd_dly;
<a name="l01104"></a>01104     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a> = 0; <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a> &lt; <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>; <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>++) {
<a name="l01105"></a>01105         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++) {
<a name="l01106"></a>01106             <span class="comment">// next burst to same bank group in this rank must not happen</span>
<a name="l01107"></a>01107             <span class="comment">// before tCCD_L.  Different bank group timing requirement is</span>
<a name="l01108"></a>01108             <span class="comment">// tBURST; Add tCS for different ranks</span>
<a name="l01109"></a>01109             <span class="keywordflow">if</span> (dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a6cef5fd4eeb110180f7c4e2e5ac7cc1e" title="Will be populated by address decoder.">rank</a> == <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>) {
<a name="l01110"></a>01110                 <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a0f8e4a158ae37c8d2925a9fa327691f0">bankGroupArch</a> &amp;&amp;
<a name="l01111"></a>01111                    (bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#af6c7d3ce331371125f2b38f3626d7408">bankgr</a> == <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[<a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>]-&gt;banks[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].bankgr)) {
<a name="l01112"></a>01112                     <span class="comment">// bank group architecture requires longer delays between</span>
<a name="l01113"></a>01113                     <span class="comment">// RD/WR burst commands to the same bank group.</span>
<a name="l01114"></a>01114                     <span class="comment">// Use tCCD_L in this case</span>
<a name="l01115"></a>01115                     cmd_dly = <a class="code" href="classDRAMCtrl.html#a5a598180d4af2be89f5f209b40b9d03e">tCCD_L</a>;
<a name="l01116"></a>01116                 } <span class="keywordflow">else</span> {
<a name="l01117"></a>01117                     <span class="comment">// use tBURST (equivalent to tCCD_S), the shorter</span>
<a name="l01118"></a>01118                     <span class="comment">// cas-to-cas delay value, when either:</span>
<a name="l01119"></a>01119                     <span class="comment">// 1) bank group architecture is not supportted</span>
<a name="l01120"></a>01120                     <span class="comment">// 2) bank is in a different bank group</span>
<a name="l01121"></a>01121                     cmd_dly = tBURST;
<a name="l01122"></a>01122                 }
<a name="l01123"></a>01123             } <span class="keywordflow">else</span> {
<a name="l01124"></a>01124                 <span class="comment">// different rank is by default in a different bank group</span>
<a name="l01125"></a>01125                 <span class="comment">// use tBURST (equivalent to tCCD_S), which is the shorter</span>
<a name="l01126"></a>01126                 <span class="comment">// cas-to-cas delay in this case</span>
<a name="l01127"></a>01127                 <span class="comment">// Add tCS to account for rank-to-rank bus delay requirements</span>
<a name="l01128"></a>01128                 cmd_dly = tBURST + <a class="code" href="classDRAMCtrl.html#a7273c4b539ed79e3931eb372656edcf0">tCS</a>;
<a name="l01129"></a>01129             }
<a name="l01130"></a>01130             <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[<a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>]-&gt;banks[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].colAllowedAt = std::max(cmd_at + cmd_dly,
<a name="l01131"></a>01131                                              <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[<a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>]-&gt;banks[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].colAllowedAt);
<a name="l01132"></a>01132         }
<a name="l01133"></a>01133     }
<a name="l01134"></a>01134 
<a name="l01135"></a>01135     <span class="comment">// Save rank of current access</span>
<a name="l01136"></a>01136     <a class="code" href="classDRAMCtrl.html#ac8f112decf864fe3a7877790f950ebb9">activeRank</a> = dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a6cef5fd4eeb110180f7c4e2e5ac7cc1e" title="Will be populated by address decoder.">rank</a>;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138     <span class="comment">// If this is a write, we also need to respect the write recovery</span>
<a name="l01139"></a>01139     <span class="comment">// time before a precharge, in the case of a read, respect the</span>
<a name="l01140"></a>01140     <span class="comment">// read to precharge constraint</span>
<a name="l01141"></a>01141     bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a159aa76867a077fa1cd4540fc4d92cf6">preAllowedAt</a> = std::max(bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a159aa76867a077fa1cd4540fc4d92cf6">preAllowedAt</a>,
<a name="l01142"></a>01142                                  dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#addd21d3a68177e54e3e27ea2c199964f">isRead</a> ? cmd_at + <a class="code" href="classDRAMCtrl.html#a680a2a39548e49ce0f2395710b095567">tRTP</a> :
<a name="l01143"></a>01143                                  dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a0e877f5f0c8f6742e273914cfc3fe014" title="When will request leave the controller.">readyTime</a> + <a class="code" href="classDRAMCtrl.html#a336384539e0cdac4da285d2684684a9e">tWR</a>);
<a name="l01144"></a>01144 
<a name="l01145"></a>01145     <span class="comment">// increment the bytes accessed and the accesses per row</span>
<a name="l01146"></a>01146     bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#ae0480ffe9e97759c4687b53716cda8d3">bytesAccessed</a> += <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>;
<a name="l01147"></a>01147     ++bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a8c9c22bb03ee0ed435725ab2fb38c09a">rowAccesses</a>;
<a name="l01148"></a>01148 
<a name="l01149"></a>01149     <span class="comment">// if we reached the max, then issue with an auto-precharge</span>
<a name="l01150"></a>01150     <span class="keywordtype">bool</span> auto_precharge = <a class="code" href="classDRAMCtrl.html#a93448eecf9f2ec65d70de82b94c2839f">pageMgmt</a> == Enums::close ||
<a name="l01151"></a>01151         bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a8c9c22bb03ee0ed435725ab2fb38c09a">rowAccesses</a> == <a class="code" href="classDRAMCtrl.html#a9b7d1e35f9bf63be72006cb67691d3ef" title="Max column accesses (read and write) per row, before forefully closing it.">maxAccessesPerRow</a>;
<a name="l01152"></a>01152 
<a name="l01153"></a>01153     <span class="comment">// if we did not hit the limit, we might still want to</span>
<a name="l01154"></a>01154     <span class="comment">// auto-precharge</span>
<a name="l01155"></a>01155     <span class="keywordflow">if</span> (!auto_precharge &amp;&amp;
<a name="l01156"></a>01156         (<a class="code" href="classDRAMCtrl.html#a93448eecf9f2ec65d70de82b94c2839f">pageMgmt</a> == Enums::open_adaptive ||
<a name="l01157"></a>01157          <a class="code" href="classDRAMCtrl.html#a93448eecf9f2ec65d70de82b94c2839f">pageMgmt</a> == Enums::close_adaptive)) {
<a name="l01158"></a>01158         <span class="comment">// a twist on the open and close page policies:</span>
<a name="l01159"></a>01159         <span class="comment">// 1) open_adaptive page policy does not blindly keep the</span>
<a name="l01160"></a>01160         <span class="comment">// page open, but close it if there are no row hits, and there</span>
<a name="l01161"></a>01161         <span class="comment">// are bank conflicts in the queue</span>
<a name="l01162"></a>01162         <span class="comment">// 2) close_adaptive page policy does not blindly close the</span>
<a name="l01163"></a>01163         <span class="comment">// page, but closes it only if there are no row hits in the queue.</span>
<a name="l01164"></a>01164         <span class="comment">// In this case, only force an auto precharge when there</span>
<a name="l01165"></a>01165         <span class="comment">// are no same page hits in the queue</span>
<a name="l01166"></a>01166         <span class="keywordtype">bool</span> got_more_hits = <span class="keyword">false</span>;
<a name="l01167"></a>01167         <span class="keywordtype">bool</span> got_bank_conflict = <span class="keyword">false</span>;
<a name="l01168"></a>01168 
<a name="l01169"></a>01169         <span class="comment">// either look at the read queue or write queue</span>
<a name="l01170"></a>01170         <span class="keyword">const</span> <a class="code" href="classstd_1_1deque.html">deque&lt;DRAMPacket*&gt;</a>&amp; queue = dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#addd21d3a68177e54e3e27ea2c199964f">isRead</a> ? <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a> :
<a name="l01171"></a>01171             <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>;
<a name="l01172"></a>01172         <span class="keyword">auto</span> <a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a> = queue.begin();
<a name="l01173"></a>01173         <span class="comment">// make sure we are not considering the packet that we are</span>
<a name="l01174"></a>01174         <span class="comment">// currently dealing with (which is the head of the queue)</span>
<a name="l01175"></a>01175         ++<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>;
<a name="l01176"></a>01176 
<a name="l01177"></a>01177         <span class="comment">// keep on looking until we find a hit or reach the end of the queue</span>
<a name="l01178"></a>01178         <span class="comment">// 1) if a hit is found, then both open and close adaptive policies keep</span>
<a name="l01179"></a>01179         <span class="comment">// the page open</span>
<a name="l01180"></a>01180         <span class="comment">// 2) if no hit is found, got_bank_conflict is set to true if a bank</span>
<a name="l01181"></a>01181         <span class="comment">// conflict request is waiting in the queue</span>
<a name="l01182"></a>01182         <span class="keywordflow">while</span> (!got_more_hits &amp;&amp; <a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a> != queue.end()) {
<a name="l01183"></a>01183             <span class="keywordtype">bool</span> same_rank_bank = (dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a6cef5fd4eeb110180f7c4e2e5ac7cc1e" title="Will be populated by address decoder.">rank</a> == (*p)-&gt;rank) &amp;&amp;
<a name="l01184"></a>01184                 (dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a52d6e506cbb321c70721be83d9d4bc55">bank</a> == (*p)-&gt;bank);
<a name="l01185"></a>01185             <span class="keywordtype">bool</span> same_row = dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a78116b4aed3964a0811ba11199f85b3e">row</a> == (*p)-&gt;row;
<a name="l01186"></a>01186             got_more_hits |= same_rank_bank &amp;&amp; same_row;
<a name="l01187"></a>01187             got_bank_conflict |= same_rank_bank &amp;&amp; !same_row;
<a name="l01188"></a>01188             ++<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>;
<a name="l01189"></a>01189         }
<a name="l01190"></a>01190 
<a name="l01191"></a>01191         <span class="comment">// auto pre-charge when either</span>
<a name="l01192"></a>01192         <span class="comment">// 1) open_adaptive policy, we have not got any more hits, and</span>
<a name="l01193"></a>01193         <span class="comment">//    have a bank conflict</span>
<a name="l01194"></a>01194         <span class="comment">// 2) close_adaptive policy and we have not got any more hits</span>
<a name="l01195"></a>01195         auto_precharge = !got_more_hits &amp;&amp;
<a name="l01196"></a>01196             (got_bank_conflict || <a class="code" href="classDRAMCtrl.html#a93448eecf9f2ec65d70de82b94c2839f">pageMgmt</a> == Enums::close_adaptive);
<a name="l01197"></a>01197     }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     <span class="comment">// DRAMPower trace command to be written</span>
<a name="l01200"></a>01200     std::string mem_cmd = dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#addd21d3a68177e54e3e27ea2c199964f">isRead</a> ? <span class="stringliteral">&quot;RD&quot;</span> : <span class="stringliteral">&quot;WR&quot;</span>;
<a name="l01201"></a>01201 
<a name="l01202"></a>01202     <span class="comment">// MemCommand required for DRAMPower library</span>
<a name="l01203"></a>01203     MemCommand::cmds command = (mem_cmd == <span class="stringliteral">&quot;RD&quot;</span>) ? MemCommand::RD :
<a name="l01204"></a>01204                                                    MemCommand::WR;
<a name="l01205"></a>01205 
<a name="l01206"></a>01206     <span class="comment">// if this access should use auto-precharge, then we are</span>
<a name="l01207"></a>01207     <span class="comment">// closing the row</span>
<a name="l01208"></a>01208     <span class="keywordflow">if</span> (auto_precharge) {
<a name="l01209"></a>01209         <span class="comment">// if auto-precharge push a PRE command at the correct tick to the</span>
<a name="l01210"></a>01210         <span class="comment">// list used by DRAMPower library to calculate power</span>
<a name="l01211"></a>01211         <a class="code" href="classDRAMCtrl.html#a7004ae8efe3eeb94220b53be3d25ea0e" title="Precharge a given bank and also update when the precharge is done.">prechargeBank</a>(rank, bank, std::max(<a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>(), bank.<a class="code" href="classDRAMCtrl_1_1Bank.html#a159aa76867a077fa1cd4540fc4d92cf6">preAllowedAt</a>));
<a name="l01212"></a>01212 
<a name="l01213"></a>01213         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Auto-precharged bank: %d\n&quot;</span>, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a22cd0c3ab4ab2b27631b43ae1246d7c4" title="Bank id is calculated considering banks in all the ranks eg: 2 ranks each with 8...">bankId</a>);
<a name="l01214"></a>01214     }
<a name="l01215"></a>01215 
<a name="l01216"></a>01216     <span class="comment">// Update bus state</span>
<a name="l01217"></a>01217     <a class="code" href="classDRAMCtrl.html#a14f669b4a31a66dd15e42f02a7f0cb62" title="Till when has the main data bus been spoken for already?">busBusyUntil</a> = dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a0e877f5f0c8f6742e273914cfc3fe014" title="When will request leave the controller.">readyTime</a>;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Access to %lld, ready at %lld bus busy until %lld.\n&quot;</span>,
<a name="l01220"></a>01220             dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a7206eb9c464e7d78b313fc7c18d3e033" title="The starting address of the DRAM packet.">addr</a>, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a0e877f5f0c8f6742e273914cfc3fe014" title="When will request leave the controller.">readyTime</a>, <a class="code" href="classDRAMCtrl.html#a14f669b4a31a66dd15e42f02a7f0cb62" title="Till when has the main data bus been spoken for already?">busBusyUntil</a>);
<a name="l01221"></a>01221 
<a name="l01222"></a>01222     dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a9e83e4bdcabb2cca59db47ea95506538">rankRef</a>.<a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.doCommand(command, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a52d6e506cbb321c70721be83d9d4bc55">bank</a>,
<a name="l01223"></a>01223                                                  <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(cmd_at, <a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>) -
<a name="l01224"></a>01224                                                  <a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a>);
<a name="l01225"></a>01225 
<a name="l01226"></a>01226     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classDRAMPower.html" title="DRAMPower is a standalone tool which calculates the power consumed by a DRAM in the...">DRAMPower</a>, <span class="stringliteral">&quot;%llu,%s,%d,%d\n&quot;</span>, <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(cmd_at, <a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>) -
<a name="l01227"></a>01227             <a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a>, mem_cmd, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a52d6e506cbb321c70721be83d9d4bc55">bank</a>, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a6cef5fd4eeb110180f7c4e2e5ac7cc1e" title="Will be populated by address decoder.">rank</a>);
<a name="l01228"></a>01228 
<a name="l01229"></a>01229     <span class="comment">// Update the minimum timing between the requests, this is a</span>
<a name="l01230"></a>01230     <span class="comment">// conservative estimate of when we have to schedule the next</span>
<a name="l01231"></a>01231     <span class="comment">// request to not introduce any unecessary bubbles. In most cases</span>
<a name="l01232"></a>01232     <span class="comment">// we will wake up sooner than we have to.</span>
<a name="l01233"></a>01233     <a class="code" href="classDRAMCtrl.html#adbacf8863a807c97c1a157b085c49d4f" title="The soonest you have to start thinking about the next request is the longest access...">nextReqTime</a> = <a class="code" href="classDRAMCtrl.html#a14f669b4a31a66dd15e42f02a7f0cb62" title="Till when has the main data bus been spoken for already?">busBusyUntil</a> - (<a class="code" href="classDRAMCtrl.html#a1edd216a091aa2ec675985c16134d626">tRP</a> + <a class="code" href="classDRAMCtrl.html#a135f02135b5947e4bd4924a73af5f35c">tRCD</a> + <a class="code" href="classDRAMCtrl.html#ae7ebffccab6cd342fddbcba75aee6c3b">tCL</a>);
<a name="l01234"></a>01234 
<a name="l01235"></a>01235     <span class="comment">// Update the stats and schedule the next request</span>
<a name="l01236"></a>01236     <span class="keywordflow">if</span> (dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#addd21d3a68177e54e3e27ea2c199964f">isRead</a>) {
<a name="l01237"></a>01237         ++<a class="code" href="classDRAMCtrl.html#aac2e9d7261bfe724e35f179152b588b1">readsThisTime</a>;
<a name="l01238"></a>01238         <span class="keywordflow">if</span> (row_hit)
<a name="l01239"></a>01239             <a class="code" href="classDRAMCtrl.html#aa38e66ebc077727f6538d2827bf5f8e0">readRowHits</a>++;
<a name="l01240"></a>01240         <a class="code" href="classDRAMCtrl.html#aa497ed2e8bdabb8a4b24546dc7d84ba8">bytesReadDRAM</a> += <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>;
<a name="l01241"></a>01241         <a class="code" href="classDRAMCtrl.html#aa776c33f88e7b9befd7759a15144173f">perBankRdBursts</a>[dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a22cd0c3ab4ab2b27631b43ae1246d7c4" title="Bank id is calculated considering banks in all the ranks eg: 2 ranks each with 8...">bankId</a>]++;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243         <span class="comment">// Update latency stats</span>
<a name="l01244"></a>01244         <a class="code" href="classDRAMCtrl.html#adccc242d738f69f8a4f8572861195a5a">totMemAccLat</a> += dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a0e877f5f0c8f6742e273914cfc3fe014" title="When will request leave the controller.">readyTime</a> - dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a9fb8f9f72bb1b0d39e964ac7bb088015" title="When did request enter the controller.">entryTime</a>;
<a name="l01245"></a>01245         <a class="code" href="classDRAMCtrl.html#ac924b3fe4ea525e98e8d48799f680edd">totBusLat</a> += tBURST;
<a name="l01246"></a>01246         <a class="code" href="classDRAMCtrl.html#a284c28527546d2d044cb7a2576a8681e">totQLat</a> += cmd_at - dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a9fb8f9f72bb1b0d39e964ac7bb088015" title="When did request enter the controller.">entryTime</a>;
<a name="l01247"></a>01247     } <span class="keywordflow">else</span> {
<a name="l01248"></a>01248         ++<a class="code" href="classDRAMCtrl.html#a7814700d7f197a5693cb7586d3bd6112">writesThisTime</a>;
<a name="l01249"></a>01249         <span class="keywordflow">if</span> (row_hit)
<a name="l01250"></a>01250             <a class="code" href="classDRAMCtrl.html#a2305f05a56ecdd2839ec5c5c4549701d">writeRowHits</a>++;
<a name="l01251"></a>01251         <a class="code" href="classDRAMCtrl.html#a1770ca8069c1b96091dbdc0847812ab8" title="Number of bytes written to this memory.">bytesWritten</a> += <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>;
<a name="l01252"></a>01252         <a class="code" href="classDRAMCtrl.html#aa55805fbfefbec74965d03ae915f5043">perBankWrBursts</a>[dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a22cd0c3ab4ab2b27631b43ae1246d7c4" title="Bank id is calculated considering banks in all the ranks eg: 2 ranks each with 8...">bankId</a>]++;
<a name="l01253"></a>01253     }
<a name="l01254"></a>01254 }
<a name="l01255"></a>01255 
<a name="l01256"></a>01256 <span class="keywordtype">void</span>
<a name="l01257"></a><a class="code" href="classDRAMCtrl.html#ad44eb7aa821b2e88ebaf1a81ff3cb970">01257</a> <a class="code" href="classDRAMCtrl.html#ad44eb7aa821b2e88ebaf1a81ff3cb970" title="Bunch of things requires to setup &amp;quot;events&amp;quot; in gem5 When event &amp;quot;respondEvent&amp;quot;...">DRAMCtrl::processNextReqEvent</a>()
<a name="l01258"></a>01258 {
<a name="l01259"></a>01259     <span class="keywordtype">int</span> busyRanks = 0;
<a name="l01260"></a>01260     <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> : <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>) {
<a name="l01261"></a>01261         <span class="keywordflow">if</span> (!<a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;isAvailable()) {
<a name="l01262"></a>01262             <span class="comment">// rank is busy refreshing</span>
<a name="l01263"></a>01263             busyRanks++;
<a name="l01264"></a>01264 
<a name="l01265"></a>01265             <span class="comment">// let the rank know that if it was waiting to drain, it</span>
<a name="l01266"></a>01266             <span class="comment">// is now done and ready to proceed</span>
<a name="l01267"></a>01267             <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;checkDrainDone();
<a name="l01268"></a>01268         }
<a name="l01269"></a>01269     }
<a name="l01270"></a>01270 
<a name="l01271"></a>01271     <span class="keywordflow">if</span> (busyRanks == <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>) {
<a name="l01272"></a>01272         <span class="comment">// if all ranks are refreshing wait for them to finish</span>
<a name="l01273"></a>01273         <span class="comment">// and stall this state machine without taking any further</span>
<a name="l01274"></a>01274         <span class="comment">// action, and do not schedule a new nextReqEvent</span>
<a name="l01275"></a>01275         <span class="keywordflow">return</span>;
<a name="l01276"></a>01276     }
<a name="l01277"></a>01277 
<a name="l01278"></a>01278     <span class="comment">// pre-emptively set to false.  Overwrite if in READ_TO_WRITE</span>
<a name="l01279"></a>01279     <span class="comment">// or WRITE_TO_READ state</span>
<a name="l01280"></a>01280     <span class="keywordtype">bool</span> switched_cmd_type = <span class="keyword">false</span>;
<a name="l01281"></a>01281     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a7cda39e7b9e7664f1b1e1c3686880310">busState</a> == <a class="code" href="classDRAMCtrl.html#a9fd8e6d41eafaea0e3d8aacc74b6bdf5a1dfa9f95b0a89824a2021d1b4f72ae44">READ_TO_WRITE</a>) {
<a name="l01282"></a>01282         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Switching to writes after %d reads with %d reads &quot;</span>
<a name="l01283"></a>01283                 <span class="stringliteral">&quot;waiting\n&quot;</span>, <a class="code" href="classDRAMCtrl.html#aac2e9d7261bfe724e35f179152b588b1">readsThisTime</a>, <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.size());
<a name="l01284"></a>01284 
<a name="l01285"></a>01285         <span class="comment">// sample and reset the read-related stats as we are now</span>
<a name="l01286"></a>01286         <span class="comment">// transitioning to writes, and all reads are done</span>
<a name="l01287"></a>01287         <a class="code" href="classDRAMCtrl.html#a8d8343a696fce288cc32066bc67747d3">rdPerTurnAround</a>.<a class="code" href="classStats_1_1DistBase.html#a5cb4a9cb9fac72ca7c0a8737c31d11be" title="Add a value to the distribtion n times.">sample</a>(<a class="code" href="classDRAMCtrl.html#aac2e9d7261bfe724e35f179152b588b1">readsThisTime</a>);
<a name="l01288"></a>01288         <a class="code" href="classDRAMCtrl.html#aac2e9d7261bfe724e35f179152b588b1">readsThisTime</a> = 0;
<a name="l01289"></a>01289 
<a name="l01290"></a>01290         <span class="comment">// now proceed to do the actual writes</span>
<a name="l01291"></a>01291         <a class="code" href="classDRAMCtrl.html#a7cda39e7b9e7664f1b1e1c3686880310">busState</a> = <a class="code" href="classDRAMCtrl.html#a9fd8e6d41eafaea0e3d8aacc74b6bdf5aee722b2d7ee5730cb92608a8e5bdaca2">WRITE</a>;
<a name="l01292"></a>01292         switched_cmd_type = <span class="keyword">true</span>;
<a name="l01293"></a>01293     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a7cda39e7b9e7664f1b1e1c3686880310">busState</a> == <a class="code" href="classDRAMCtrl.html#a9fd8e6d41eafaea0e3d8aacc74b6bdf5a04e9fe9c48972d0bb520742836ff92b6">WRITE_TO_READ</a>) {
<a name="l01294"></a>01294         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Switching to reads after %d writes with %d writes &quot;</span>
<a name="l01295"></a>01295                 <span class="stringliteral">&quot;waiting\n&quot;</span>, <a class="code" href="classDRAMCtrl.html#a7814700d7f197a5693cb7586d3bd6112">writesThisTime</a>, <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size());
<a name="l01296"></a>01296 
<a name="l01297"></a>01297         <a class="code" href="classDRAMCtrl.html#a892341d6024351995e693ad6638389ac">wrPerTurnAround</a>.<a class="code" href="classStats_1_1DistBase.html#a5cb4a9cb9fac72ca7c0a8737c31d11be" title="Add a value to the distribtion n times.">sample</a>(<a class="code" href="classDRAMCtrl.html#a7814700d7f197a5693cb7586d3bd6112">writesThisTime</a>);
<a name="l01298"></a>01298         <a class="code" href="classDRAMCtrl.html#a7814700d7f197a5693cb7586d3bd6112">writesThisTime</a> = 0;
<a name="l01299"></a>01299 
<a name="l01300"></a>01300         <a class="code" href="classDRAMCtrl.html#a7cda39e7b9e7664f1b1e1c3686880310">busState</a> = <a class="code" href="classDRAMCtrl.html#a9fd8e6d41eafaea0e3d8aacc74b6bdf5aad09600d62b9e49769bdba2c87e68bd3">READ</a>;
<a name="l01301"></a>01301         switched_cmd_type = <span class="keyword">true</span>;
<a name="l01302"></a>01302     }
<a name="l01303"></a>01303 
<a name="l01304"></a>01304     <span class="comment">// when we get here it is either a read or a write</span>
<a name="l01305"></a>01305     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a7cda39e7b9e7664f1b1e1c3686880310">busState</a> == <a class="code" href="classDRAMCtrl.html#a9fd8e6d41eafaea0e3d8aacc74b6bdf5aad09600d62b9e49769bdba2c87e68bd3">READ</a>) {
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         <span class="comment">// track if we should switch or not</span>
<a name="l01308"></a>01308         <span class="keywordtype">bool</span> switch_to_writes = <span class="keyword">false</span>;
<a name="l01309"></a>01309 
<a name="l01310"></a>01310         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.empty()) {
<a name="l01311"></a>01311             <span class="comment">// In the case there is no read request to go next,</span>
<a name="l01312"></a>01312             <span class="comment">// trigger writes if we have passed the low threshold (or</span>
<a name="l01313"></a>01313             <span class="comment">// if we are draining)</span>
<a name="l01314"></a>01314             <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.empty() &amp;&amp;
<a name="l01315"></a>01315                 (<a class="code" href="classDRAMCtrl.html#abb7acccc1136f56df2290bb7373053ac" title="If we need to drain, keep the drain manager around until we&amp;#39;re done here.">drainManager</a> || <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size() &gt; <a class="code" href="classDRAMCtrl.html#a583a12d49bb3e8aebcdc831435d57d77">writeLowThreshold</a>)) {
<a name="l01316"></a>01316 
<a name="l01317"></a>01317                 switch_to_writes = <span class="keyword">true</span>;
<a name="l01318"></a>01318             } <span class="keywordflow">else</span> {
<a name="l01319"></a>01319                 <span class="comment">// check if we are drained</span>
<a name="l01320"></a>01320                 <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.empty () &amp;&amp; <a class="code" href="classDRAMCtrl.html#abb7acccc1136f56df2290bb7373053ac" title="If we need to drain, keep the drain manager around until we&amp;#39;re done here.">drainManager</a>) {
<a name="l01321"></a>01321                     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Drain, <span class="stringliteral">&quot;DRAM controller done draining\n&quot;</span>);
<a name="l01322"></a>01322                     <a class="code" href="classDRAMCtrl.html#abb7acccc1136f56df2290bb7373053ac" title="If we need to drain, keep the drain manager around until we&amp;#39;re done here.">drainManager</a>-&gt;<a class="code" href="classDrainManager.html#abd134e8277be09e702b63f36f6ee31d0" title="Notify the DrainManager that a Drainable object has finished draining.">signalDrainDone</a>();
<a name="l01323"></a>01323                     <a class="code" href="classDRAMCtrl.html#abb7acccc1136f56df2290bb7373053ac" title="If we need to drain, keep the drain manager around until we&amp;#39;re done here.">drainManager</a> = NULL;
<a name="l01324"></a>01324                 }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326                 <span class="comment">// nothing to do, not even any point in scheduling an</span>
<a name="l01327"></a>01327                 <span class="comment">// event for the next request</span>
<a name="l01328"></a>01328                 <span class="keywordflow">return</span>;
<a name="l01329"></a>01329             }
<a name="l01330"></a>01330         } <span class="keywordflow">else</span> {
<a name="l01331"></a>01331             <span class="comment">// bool to check if there is a read to a free rank</span>
<a name="l01332"></a>01332             <span class="keywordtype">bool</span> found_read = <span class="keyword">false</span>;
<a name="l01333"></a>01333 
<a name="l01334"></a>01334             <span class="comment">// Figure out which read request goes next, and move it to the</span>
<a name="l01335"></a>01335             <span class="comment">// front of the read queue</span>
<a name="l01336"></a>01336             found_read = <a class="code" href="classDRAMCtrl.html#a61739184c84f0dbc76bd970e2c29df12" title="The memory schduler/arbiter - picks which request needs to go next, based on the...">chooseNext</a>(<a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>, switched_cmd_type);
<a name="l01337"></a>01337 
<a name="l01338"></a>01338             <span class="comment">// if no read to an available rank is found then return</span>
<a name="l01339"></a>01339             <span class="comment">// at this point. There could be writes to the available ranks</span>
<a name="l01340"></a>01340             <span class="comment">// which are above the required threshold. However, to</span>
<a name="l01341"></a>01341             <span class="comment">// avoid adding more complexity to the code, return and wait</span>
<a name="l01342"></a>01342             <span class="comment">// for a refresh event to kick things into action again.</span>
<a name="l01343"></a>01343             <span class="keywordflow">if</span> (!found_read)
<a name="l01344"></a>01344                 <span class="keywordflow">return</span>;
<a name="l01345"></a>01345 
<a name="l01346"></a>01346             <a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMPacket</a>* dram_pkt = <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.front();
<a name="l01347"></a>01347             assert(dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a9e83e4bdcabb2cca59db47ea95506538">rankRef</a>.<a class="code" href="classDRAMCtrl_1_1Rank.html#adcf612be05ea3aca8d04fee48e18184c" title="Check if the current rank is available for scheduling.">isAvailable</a>());
<a name="l01348"></a>01348             <span class="comment">// here we get a bit creative and shift the bus busy time not</span>
<a name="l01349"></a>01349             <span class="comment">// just the tWTR, but also a CAS latency to capture the fact</span>
<a name="l01350"></a>01350             <span class="comment">// that we are allowed to prepare a new bank, but not issue a</span>
<a name="l01351"></a>01351             <span class="comment">// read command until after tWTR, in essence we capture a</span>
<a name="l01352"></a>01352             <span class="comment">// bubble on the data bus that is tWTR + tCL</span>
<a name="l01353"></a>01353             <span class="keywordflow">if</span> (switched_cmd_type &amp;&amp; dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a6cef5fd4eeb110180f7c4e2e5ac7cc1e" title="Will be populated by address decoder.">rank</a> == <a class="code" href="classDRAMCtrl.html#ac8f112decf864fe3a7877790f950ebb9">activeRank</a>) {
<a name="l01354"></a>01354                 <a class="code" href="classDRAMCtrl.html#a14f669b4a31a66dd15e42f02a7f0cb62" title="Till when has the main data bus been spoken for already?">busBusyUntil</a> += <a class="code" href="classDRAMCtrl.html#a6d591f133bc578f26c6a75493377b09d">tWTR</a> + <a class="code" href="classDRAMCtrl.html#ae7ebffccab6cd342fddbcba75aee6c3b">tCL</a>;
<a name="l01355"></a>01355             }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357             <a class="code" href="classDRAMCtrl.html#a349772bfe111e2019b56c5edcead2c12" title="Actually do the DRAM access - figure out the latency it will take to service the...">doDRAMAccess</a>(dram_pkt);
<a name="l01358"></a>01358 
<a name="l01359"></a>01359             <span class="comment">// At this point we&apos;re done dealing with the request</span>
<a name="l01360"></a>01360             <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.pop_front();
<a name="l01361"></a>01361 
<a name="l01362"></a>01362             <span class="comment">// sanity check</span>
<a name="l01363"></a>01363             assert(dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a4d186ded748a2484124a5888f9f4db1e" title="The size of this dram packet in bytes It is always equal or smaller than DRAM burst...">size</a> &lt;= <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>);
<a name="l01364"></a>01364             assert(dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a0e877f5f0c8f6742e273914cfc3fe014" title="When will request leave the controller.">readyTime</a> &gt;= <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01365"></a>01365 
<a name="l01366"></a>01366             <span class="comment">// Insert into response queue. It will be sent back to the</span>
<a name="l01367"></a>01367             <span class="comment">// requestor at its readyTime</span>
<a name="l01368"></a>01368             <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.empty()) {
<a name="l01369"></a>01369                 assert(!<a class="code" href="classDRAMCtrl.html#acfd6a4867b7082b4bb7e8e50838a47c7">respondEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>());
<a name="l01370"></a>01370                 <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl.html#acfd6a4867b7082b4bb7e8e50838a47c7">respondEvent</a>, dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a0e877f5f0c8f6742e273914cfc3fe014" title="When will request leave the controller.">readyTime</a>);
<a name="l01371"></a>01371             } <span class="keywordflow">else</span> {
<a name="l01372"></a>01372                 assert(<a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.back()-&gt;readyTime &lt;= dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a0e877f5f0c8f6742e273914cfc3fe014" title="When will request leave the controller.">readyTime</a>);
<a name="l01373"></a>01373                 assert(<a class="code" href="classDRAMCtrl.html#acfd6a4867b7082b4bb7e8e50838a47c7">respondEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>());
<a name="l01374"></a>01374             }
<a name="l01375"></a>01375 
<a name="l01376"></a>01376             <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.push_back(dram_pkt);
<a name="l01377"></a>01377 
<a name="l01378"></a>01378             <span class="comment">// we have so many writes that we have to transition</span>
<a name="l01379"></a>01379             <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size() &gt; <a class="code" href="classDRAMCtrl.html#ac6eef2ce959ef8ca4921f645cc89763d">writeHighThreshold</a>) {
<a name="l01380"></a>01380                 switch_to_writes = <span class="keyword">true</span>;
<a name="l01381"></a>01381             }
<a name="l01382"></a>01382         }
<a name="l01383"></a>01383 
<a name="l01384"></a>01384         <span class="comment">// switching to writes, either because the read queue is empty</span>
<a name="l01385"></a>01385         <span class="comment">// and the writes have passed the low threshold (or we are</span>
<a name="l01386"></a>01386         <span class="comment">// draining), or because the writes hit the hight threshold</span>
<a name="l01387"></a>01387         <span class="keywordflow">if</span> (switch_to_writes) {
<a name="l01388"></a>01388             <span class="comment">// transition to writing</span>
<a name="l01389"></a>01389             <a class="code" href="classDRAMCtrl.html#a7cda39e7b9e7664f1b1e1c3686880310">busState</a> = <a class="code" href="classDRAMCtrl.html#a9fd8e6d41eafaea0e3d8aacc74b6bdf5a1dfa9f95b0a89824a2021d1b4f72ae44">READ_TO_WRITE</a>;
<a name="l01390"></a>01390         }
<a name="l01391"></a>01391     } <span class="keywordflow">else</span> {
<a name="l01392"></a>01392         <span class="comment">// bool to check if write to free rank is found</span>
<a name="l01393"></a>01393         <span class="keywordtype">bool</span> found_write = <span class="keyword">false</span>;
<a name="l01394"></a>01394 
<a name="l01395"></a>01395         found_write = <a class="code" href="classDRAMCtrl.html#a61739184c84f0dbc76bd970e2c29df12" title="The memory schduler/arbiter - picks which request needs to go next, based on the...">chooseNext</a>(<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>, switched_cmd_type);
<a name="l01396"></a>01396 
<a name="l01397"></a>01397         <span class="comment">// if no writes to an available rank are found then return.</span>
<a name="l01398"></a>01398         <span class="comment">// There could be reads to the available ranks. However, to avoid</span>
<a name="l01399"></a>01399         <span class="comment">// adding more complexity to the code, return at this point and wait</span>
<a name="l01400"></a>01400         <span class="comment">// for a refresh event to kick things into action again.</span>
<a name="l01401"></a>01401         <span class="keywordflow">if</span> (!found_write)
<a name="l01402"></a>01402             <span class="keywordflow">return</span>;
<a name="l01403"></a>01403 
<a name="l01404"></a>01404         <a class="code" href="classDRAMCtrl_1_1DRAMPacket.html" title="A DRAM packet stores packets along with the timestamp of when the packet entered...">DRAMPacket</a>* dram_pkt = <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.front();
<a name="l01405"></a>01405         assert(dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a9e83e4bdcabb2cca59db47ea95506538">rankRef</a>.<a class="code" href="classDRAMCtrl_1_1Rank.html#adcf612be05ea3aca8d04fee48e18184c" title="Check if the current rank is available for scheduling.">isAvailable</a>());
<a name="l01406"></a>01406         <span class="comment">// sanity check</span>
<a name="l01407"></a>01407         assert(dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a4d186ded748a2484124a5888f9f4db1e" title="The size of this dram packet in bytes It is always equal or smaller than DRAM burst...">size</a> &lt;= <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>);
<a name="l01408"></a>01408 
<a name="l01409"></a>01409         <span class="comment">// add a bubble to the data bus, as defined by the</span>
<a name="l01410"></a>01410         <span class="comment">// tRTW when access is to the same rank as previous burst</span>
<a name="l01411"></a>01411         <span class="comment">// Different rank timing is handled with tCS, which is</span>
<a name="l01412"></a>01412         <span class="comment">// applied to colAllowedAt</span>
<a name="l01413"></a>01413         <span class="keywordflow">if</span> (switched_cmd_type &amp;&amp; dram_pkt-&gt;<a class="code" href="classDRAMCtrl_1_1DRAMPacket.html#a6cef5fd4eeb110180f7c4e2e5ac7cc1e" title="Will be populated by address decoder.">rank</a> == <a class="code" href="classDRAMCtrl.html#ac8f112decf864fe3a7877790f950ebb9">activeRank</a>) {
<a name="l01414"></a>01414             <a class="code" href="classDRAMCtrl.html#a14f669b4a31a66dd15e42f02a7f0cb62" title="Till when has the main data bus been spoken for already?">busBusyUntil</a> += <a class="code" href="classDRAMCtrl.html#ac39aa285ac9e493331132691102d1c90">tRTW</a>;
<a name="l01415"></a>01415         }
<a name="l01416"></a>01416 
<a name="l01417"></a>01417         <a class="code" href="classDRAMCtrl.html#a349772bfe111e2019b56c5edcead2c12" title="Actually do the DRAM access - figure out the latency it will take to service the...">doDRAMAccess</a>(dram_pkt);
<a name="l01418"></a>01418 
<a name="l01419"></a>01419         <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.pop_front();
<a name="l01420"></a>01420         <span class="keyword">delete</span> dram_pkt;
<a name="l01421"></a>01421 
<a name="l01422"></a>01422         <span class="comment">// If we emptied the write queue, or got sufficiently below the</span>
<a name="l01423"></a>01423         <span class="comment">// threshold (using the minWritesPerSwitch as the hysteresis) and</span>
<a name="l01424"></a>01424         <span class="comment">// are not draining, or we have reads waiting and have done enough</span>
<a name="l01425"></a>01425         <span class="comment">// writes, then switch to reads.</span>
<a name="l01426"></a>01426         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.empty() ||
<a name="l01427"></a>01427             (<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size() + <a class="code" href="classDRAMCtrl.html#a0afdc6290b613e9d1fc3154c5158cb02">minWritesPerSwitch</a> &lt; <a class="code" href="classDRAMCtrl.html#a583a12d49bb3e8aebcdc831435d57d77">writeLowThreshold</a> &amp;&amp;
<a name="l01428"></a>01428              !<a class="code" href="classDRAMCtrl.html#abb7acccc1136f56df2290bb7373053ac" title="If we need to drain, keep the drain manager around until we&amp;#39;re done here.">drainManager</a>) ||
<a name="l01429"></a>01429             (!<a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.empty() &amp;&amp; <a class="code" href="classDRAMCtrl.html#a7814700d7f197a5693cb7586d3bd6112">writesThisTime</a> &gt;= <a class="code" href="classDRAMCtrl.html#a0afdc6290b613e9d1fc3154c5158cb02">minWritesPerSwitch</a>)) {
<a name="l01430"></a>01430             <span class="comment">// turn the bus back around for reads again</span>
<a name="l01431"></a>01431             <a class="code" href="classDRAMCtrl.html#a7cda39e7b9e7664f1b1e1c3686880310">busState</a> = <a class="code" href="classDRAMCtrl.html#a9fd8e6d41eafaea0e3d8aacc74b6bdf5a04e9fe9c48972d0bb520742836ff92b6">WRITE_TO_READ</a>;
<a name="l01432"></a>01432 
<a name="l01433"></a>01433             <span class="comment">// note that the we switch back to reads also in the idle</span>
<a name="l01434"></a>01434             <span class="comment">// case, which eventually will check for any draining and</span>
<a name="l01435"></a>01435             <span class="comment">// also pause any further scheduling if there is really</span>
<a name="l01436"></a>01436             <span class="comment">// nothing to do</span>
<a name="l01437"></a>01437         }
<a name="l01438"></a>01438     }
<a name="l01439"></a>01439     <span class="comment">// It is possible that a refresh to another rank kicks things back into</span>
<a name="l01440"></a>01440     <span class="comment">// action before reaching this point.</span>
<a name="l01441"></a>01441     <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>())
<a name="l01442"></a>01442         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>, std::max(<a class="code" href="classDRAMCtrl.html#adbacf8863a807c97c1a157b085c49d4f" title="The soonest you have to start thinking about the next request is the longest access...">nextReqTime</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>()));
<a name="l01443"></a>01443 
<a name="l01444"></a>01444     <span class="comment">// If there is space available and we have writes waiting then let</span>
<a name="l01445"></a>01445     <span class="comment">// them retry. This is done here to ensure that the retry does not</span>
<a name="l01446"></a>01446     <span class="comment">// cause a nextReqEvent to be scheduled before we do so as part of</span>
<a name="l01447"></a>01447     <span class="comment">// the next request processing</span>
<a name="l01448"></a>01448     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a757620eaaec709daed4fc65621f1c4fa">retryWrReq</a> &amp;&amp; <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size() &lt; <a class="code" href="classDRAMCtrl.html#aab40112977e0294a7a000ca34beda431">writeBufferSize</a>) {
<a name="l01449"></a>01449         <a class="code" href="classDRAMCtrl.html#a757620eaaec709daed4fc65621f1c4fa">retryWrReq</a> = <span class="keyword">false</span>;
<a name="l01450"></a>01450         <a class="code" href="classDRAMCtrl.html#a87ee1aa46b80d77aea809cf3d00dbc31" title="Our incoming port, for a multi-ported controller add a crossbar in front of it.">port</a>.<a class="code" href="classSlavePort.html#a67844082a8044c21d26a4bc4669ccdc2" title="Send a retry to the master port that previously attempted a sendTimingReq to this...">sendRetryReq</a>();
<a name="l01451"></a>01451     }
<a name="l01452"></a>01452 }
<a name="l01453"></a>01453 
<a name="l01454"></a>01454 uint64_t
<a name="l01455"></a><a class="code" href="classDRAMCtrl.html#a89edb261a10dfa66aaf13cceb88fbb6f">01455</a> <a class="code" href="classDRAMCtrl.html#a89edb261a10dfa66aaf13cceb88fbb6f" title="Find which are the earliest banks ready to issue an activate for the enqueued requests...">DRAMCtrl::minBankPrep</a>(<span class="keyword">const</span> <a class="code" href="classstd_1_1deque.html">deque&lt;DRAMPacket*&gt;</a>&amp; queue,
<a name="l01456"></a>01456                       <span class="keywordtype">bool</span> switched_cmd_type)<span class="keyword"> const</span>
<a name="l01457"></a>01457 <span class="keyword"></span>{
<a name="l01458"></a>01458     uint64_t bank_mask = 0;
<a name="l01459"></a>01459     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> min_act_at = <a class="code" href="base_2types_8hh.html#abe940b1b328825e234da719447e15ca5">MaxTick</a>;
<a name="l01460"></a>01460 
<a name="l01461"></a>01461     uint64_t bank_mask_same_rank = 0;
<a name="l01462"></a>01462     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> min_act_at_same_rank = <a class="code" href="base_2types_8hh.html#abe940b1b328825e234da719447e15ca5">MaxTick</a>;
<a name="l01463"></a>01463 
<a name="l01464"></a>01464     <span class="comment">// Give precedence to commands that access same rank as previous command</span>
<a name="l01465"></a>01465     <span class="keywordtype">bool</span> same_rank_match = <span class="keyword">false</span>;
<a name="l01466"></a>01466 
<a name="l01467"></a>01467     <span class="comment">// determine if we have queued transactions targetting the</span>
<a name="l01468"></a>01468     <span class="comment">// bank in question</span>
<a name="l01469"></a>01469     <a class="code" href="classstd_1_1vector.html">vector&lt;bool&gt;</a> got_waiting(<a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a> * <a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a>, <span class="keyword">false</span>);
<a name="l01470"></a>01470     <span class="keywordflow">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; <a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a> : queue) {
<a name="l01471"></a>01471         <span class="keywordflow">if</span>(<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>-&gt;rankRef.isAvailable())
<a name="l01472"></a>01472             got_waiting[<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>-&gt;bankId] = <span class="keyword">true</span>;
<a name="l01473"></a>01473     }
<a name="l01474"></a>01474 
<a name="l01475"></a>01475     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++) {
<a name="l01476"></a>01476         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a> = 0; <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a> &lt; banksPerRank; <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>++) {
<a name="l01477"></a>01477             uint16_t bank_id = <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> * banksPerRank + <a class="code" href="namespaceArmISA.html#ac843bf7761bca8cf5315375942a0c25b">j</a>;
<a name="l01478"></a>01478 
<a name="l01479"></a>01479             <span class="comment">// if we have waiting requests for the bank, and it is</span>
<a name="l01480"></a>01480             <span class="comment">// amongst the first available, update the mask</span>
<a name="l01481"></a>01481             <span class="keywordflow">if</span> (got_waiting[bank_id]) {
<a name="l01482"></a>01482                 <span class="comment">// make sure this rank is not currently refreshing.</span>
<a name="l01483"></a>01483                 assert(<a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>]-&gt;isAvailable());
<a name="l01484"></a>01484                 <span class="comment">// simplistic approximation of when the bank can issue</span>
<a name="l01485"></a>01485                 <span class="comment">// an activate, ignoring any rank-to-rank switching</span>
<a name="l01486"></a>01486                 <span class="comment">// cost in this calculation</span>
<a name="l01487"></a>01487                 <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> act_at = <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>]-&gt;banks[j].openRow == <a class="code" href="classDRAMCtrl_1_1Bank.html#a81fa13164d43b203076fcdacde0fb6c8">Bank::NO_ROW</a> ?
<a name="l01488"></a>01488                     <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>]-&gt;banks[j].actAllowedAt :
<a name="l01489"></a>01489                     std::max(<a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>]-&gt;banks[j].preAllowedAt, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>()) + <a class="code" href="classDRAMCtrl.html#a1edd216a091aa2ec675985c16134d626">tRP</a>;
<a name="l01490"></a>01490 
<a name="l01491"></a>01491                 <span class="comment">// prioritize commands that access the</span>
<a name="l01492"></a>01492                 <span class="comment">// same rank as previous burst</span>
<a name="l01493"></a>01493                 <span class="comment">// Calculate bank mask separately for the case and</span>
<a name="l01494"></a>01494                 <span class="comment">// evaluate after loop iterations complete</span>
<a name="l01495"></a>01495                 <span class="keywordflow">if</span> (<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> == <a class="code" href="classDRAMCtrl.html#ac8f112decf864fe3a7877790f950ebb9">activeRank</a> &amp;&amp; ranksPerChannel &gt; 1) {
<a name="l01496"></a>01496                     <span class="keywordflow">if</span> (act_at &lt;= min_act_at_same_rank) {
<a name="l01497"></a>01497                         <span class="comment">// reset same rank bank mask if new minimum is found</span>
<a name="l01498"></a>01498                         <span class="comment">// and previous minimum could not immediately send ACT</span>
<a name="l01499"></a>01499                         <span class="keywordflow">if</span> (act_at &lt; min_act_at_same_rank &amp;&amp;
<a name="l01500"></a>01500                             min_act_at_same_rank &gt; <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>())
<a name="l01501"></a>01501                             bank_mask_same_rank = 0;
<a name="l01502"></a>01502 
<a name="l01503"></a>01503                         <span class="comment">// Set flag indicating that a same rank</span>
<a name="l01504"></a>01504                         <span class="comment">// opportunity was found</span>
<a name="l01505"></a>01505                         same_rank_match = <span class="keyword">true</span>;
<a name="l01506"></a>01506 
<a name="l01507"></a>01507                         <span class="comment">// set the bit corresponding to the available bank</span>
<a name="l01508"></a>01508                         <a class="code" href="bitfield_8hh.html#a00870999cf02f3961e51279ceb09d1bc" title="A convenience function to replace bits first to last of val with bit_val in place...">replaceBits</a>(bank_mask_same_rank, bank_id, bank_id, 1);
<a name="l01509"></a>01509                         min_act_at_same_rank = act_at;
<a name="l01510"></a>01510                     }
<a name="l01511"></a>01511                 } <span class="keywordflow">else</span> {
<a name="l01512"></a>01512                     <span class="keywordflow">if</span> (act_at &lt;= min_act_at) {
<a name="l01513"></a>01513                         <span class="comment">// reset bank mask if new minimum is found</span>
<a name="l01514"></a>01514                         <span class="comment">// and either previous minimum could not immediately send ACT</span>
<a name="l01515"></a>01515                         <span class="keywordflow">if</span> (act_at &lt; min_act_at &amp;&amp; min_act_at &gt; <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>())
<a name="l01516"></a>01516                             bank_mask = 0;
<a name="l01517"></a>01517                         <span class="comment">// set the bit corresponding to the available bank</span>
<a name="l01518"></a>01518                         <a class="code" href="bitfield_8hh.html#a00870999cf02f3961e51279ceb09d1bc" title="A convenience function to replace bits first to last of val with bit_val in place...">replaceBits</a>(bank_mask, bank_id, bank_id, 1);
<a name="l01519"></a>01519                         min_act_at = act_at;
<a name="l01520"></a>01520                     }
<a name="l01521"></a>01521                 }
<a name="l01522"></a>01522             }
<a name="l01523"></a>01523         }
<a name="l01524"></a>01524     }
<a name="l01525"></a>01525 
<a name="l01526"></a>01526     <span class="comment">// Determine the earliest time when the next burst can issue based</span>
<a name="l01527"></a>01527     <span class="comment">// on the current busBusyUntil delay.</span>
<a name="l01528"></a>01528     <span class="comment">// Offset by tRCD to correlate with ACT timing variables</span>
<a name="l01529"></a>01529     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> min_cmd_at = <a class="code" href="classDRAMCtrl.html#a14f669b4a31a66dd15e42f02a7f0cb62" title="Till when has the main data bus been spoken for already?">busBusyUntil</a> - <a class="code" href="classDRAMCtrl.html#ae7ebffccab6cd342fddbcba75aee6c3b">tCL</a> - <a class="code" href="classDRAMCtrl.html#a135f02135b5947e4bd4924a73af5f35c">tRCD</a>;
<a name="l01530"></a>01530 
<a name="l01531"></a>01531     <span class="comment">// if we have multiple ranks and all</span>
<a name="l01532"></a>01532     <span class="comment">// waiting packets are accessing a rank which was previously active</span>
<a name="l01533"></a>01533     <span class="comment">// then bank_mask_same_rank will be set to a value while bank_mask will</span>
<a name="l01534"></a>01534     <span class="comment">// remain 0. In this case, the function should return the value of</span>
<a name="l01535"></a>01535     <span class="comment">// bank_mask_same_rank.</span>
<a name="l01536"></a>01536     <span class="comment">// else if waiting packets access a rank which was previously active and</span>
<a name="l01537"></a>01537     <span class="comment">// other ranks, prioritize same rank accesses that can issue B2B</span>
<a name="l01538"></a>01538     <span class="comment">// Only optimize for same ranks when the command type</span>
<a name="l01539"></a>01539     <span class="comment">// does not change; do not want to unnecessarily incur tWTR</span>
<a name="l01540"></a>01540     <span class="comment">//</span>
<a name="l01541"></a>01541     <span class="comment">// Resulting FCFS prioritization Order is:</span>
<a name="l01542"></a>01542     <span class="comment">// 1) Commands that access the same rank as previous burst</span>
<a name="l01543"></a>01543     <span class="comment">//    and can prep the bank seamlessly.</span>
<a name="l01544"></a>01544     <span class="comment">// 2) Commands (any rank) with earliest bank prep</span>
<a name="l01545"></a>01545     <span class="keywordflow">if</span> ((bank_mask == 0) || (!switched_cmd_type &amp;&amp; same_rank_match &amp;&amp;
<a name="l01546"></a>01546         min_act_at_same_rank &lt;= min_cmd_at)) {
<a name="l01547"></a>01547         bank_mask = bank_mask_same_rank;
<a name="l01548"></a>01548     }
<a name="l01549"></a>01549 
<a name="l01550"></a>01550     <span class="keywordflow">return</span> bank_mask;
<a name="l01551"></a>01551 }
<a name="l01552"></a>01552 
<a name="l01553"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#a6c9a0b07717c00dd0a1b4be405b6d28e">01553</a> <a class="code" href="classDRAMCtrl_1_1Rank.html#a6c9a0b07717c00dd0a1b4be405b6d28e">DRAMCtrl::Rank::Rank</a>(<a class="code" href="classDRAMCtrl.html" title="The DRAM controller is a single-channel memory controller capturing the most important...">DRAMCtrl</a>&amp; _memory, <span class="keyword">const</span> DRAMCtrlParams* _p)
<a name="l01554"></a>01554     : <a class="code" href="classEventManager.html">EventManager</a>(&amp;_memory), memory(_memory),
<a name="l01555"></a>01555       pwrStateTrans(PWR_IDLE), pwrState(PWR_IDLE), pwrStateTick(0),
<a name="l01556"></a>01556       refreshState(REF_IDLE), refreshDueAt(0),
<a name="l01557"></a>01557       <a class="code" href="intmath_8hh.html#a4e6a30fd4eed8d942ab7fa676da00e69">power</a>(_p, false), numBanksActive(0),
<a name="l01558"></a>01558       activateEvent(*this), prechargeEvent(*this),
<a name="l01559"></a>01559       refreshEvent(*this), powerEvent(*this)
<a name="l01560"></a>01560 { }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562 <span class="keywordtype">void</span>
<a name="l01563"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#a4946d3adbcb3a634da71ec03a391fb5a">01563</a> <a class="code" href="classDRAMCtrl.html#ab9e388cee37d7256a9d60dd0ff527a66" title="startup() is the final initialization call before simulation.">DRAMCtrl::Rank::startup</a>(<a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> ref_tick)
<a name="l01564"></a>01564 {
<a name="l01565"></a>01565     assert(ref_tick &gt; <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01566"></a>01566 
<a name="l01567"></a>01567     <a class="code" href="classDRAMCtrl_1_1Rank.html#af895f26ee9ce9f7f781dbe054d6484f9" title="Track when we transitioned to the current power state.">pwrStateTick</a> = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>();
<a name="l01568"></a>01568 
<a name="l01569"></a>01569     <span class="comment">// kick off the refresh, and give ourselves enough time to</span>
<a name="l01570"></a>01570     <span class="comment">// precharge</span>
<a name="l01571"></a>01571     <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a45426fbf62f12e8ace06a9e817d0474d">refreshEvent</a>, ref_tick);
<a name="l01572"></a>01572 }
<a name="l01573"></a>01573 
<a name="l01574"></a>01574 <span class="keywordtype">void</span>
<a name="l01575"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#a822578836ca1b0cc4220323975414aa3">01575</a> <a class="code" href="classDRAMCtrl_1_1Rank.html#a822578836ca1b0cc4220323975414aa3" title="Stop the refresh events.">DRAMCtrl::Rank::suspend</a>()
<a name="l01576"></a>01576 {
<a name="l01577"></a>01577     <a class="code" href="classEventManager.html#a92b58a82b7a2bb4935f41bc4d46897b6">deschedule</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a45426fbf62f12e8ace06a9e817d0474d">refreshEvent</a>);
<a name="l01578"></a>01578 }
<a name="l01579"></a>01579 
<a name="l01580"></a>01580 <span class="keywordtype">void</span>
<a name="l01581"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#ab4979bc1fc1405816aefe658af9e1da2">01581</a> <a class="code" href="classDRAMCtrl_1_1Rank.html#ab4979bc1fc1405816aefe658af9e1da2" title="Let the rank check if it was waiting for requests to drain to allow it to transition...">DRAMCtrl::Rank::checkDrainDone</a>()
<a name="l01582"></a>01582 {
<a name="l01583"></a>01583     <span class="comment">// if this rank was waiting to drain it is now able to proceed to</span>
<a name="l01584"></a>01584     <span class="comment">// precharge</span>
<a name="l01585"></a>01585     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87abeb47de6eb5f7d9aead19f793279e961">REF_DRAIN</a>) {
<a name="l01586"></a>01586         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Refresh drain done, now precharging\n&quot;</span>);
<a name="l01587"></a>01587 
<a name="l01588"></a>01588         <a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> = <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87acdb75c5a5c4071041a18e1344df050f7">REF_PRE</a>;
<a name="l01589"></a>01589 
<a name="l01590"></a>01590         <span class="comment">// hand control back to the refresh event loop</span>
<a name="l01591"></a>01591         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a45426fbf62f12e8ace06a9e817d0474d">refreshEvent</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01592"></a>01592     }
<a name="l01593"></a>01593 }
<a name="l01594"></a>01594 
<a name="l01595"></a>01595 <span class="keywordtype">void</span>
<a name="l01596"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#a99c79d1cc4e1f102070e3ee3e228fa6f">01596</a> <a class="code" href="classDRAMCtrl_1_1Rank.html#a99c79d1cc4e1f102070e3ee3e228fa6f">DRAMCtrl::Rank::processActivateEvent</a>()
<a name="l01597"></a>01597 {
<a name="l01598"></a>01598     <span class="comment">// we should transition to the active state as soon as any bank is active</span>
<a name="l01599"></a>01599     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#aabe86e89ac0bc14e74cedf4adde85038" title="Current power state.">pwrState</a> != <a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5a3454fa85063ead55941c5d8e58404402">PWR_ACT</a>)
<a name="l01600"></a>01600         <span class="comment">// note that at this point numBanksActive could be back at</span>
<a name="l01601"></a>01601         <span class="comment">// zero again due to a precharge scheduled in the future</span>
<a name="l01602"></a>01602         <a class="code" href="classDRAMCtrl_1_1Rank.html#aaa93024068493c8856d1875bcec2bc20" title="Schedule a power state transition in the future, and potentially override an already...">schedulePowerEvent</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5a3454fa85063ead55941c5d8e58404402">PWR_ACT</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01603"></a>01603 }
<a name="l01604"></a>01604 
<a name="l01605"></a>01605 <span class="keywordtype">void</span>
<a name="l01606"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#a0f96ce871df4cd5981c5e1503b3173fd">01606</a> <a class="code" href="classDRAMCtrl_1_1Rank.html#a0f96ce871df4cd5981c5e1503b3173fd">DRAMCtrl::Rank::processPrechargeEvent</a>()
<a name="l01607"></a>01607 {
<a name="l01608"></a>01608     <span class="comment">// if we reached zero, then special conditions apply as we track</span>
<a name="l01609"></a>01609     <span class="comment">// if all banks are precharged for the power models</span>
<a name="l01610"></a>01610     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#abb35437efe71e911365685b3cfb5cc7b" title="To track number of banks which are currently active for this rank.">numBanksActive</a> == 0) {
<a name="l01611"></a>01611         <span class="comment">// we should transition to the idle state when the last bank</span>
<a name="l01612"></a>01612         <span class="comment">// is precharged</span>
<a name="l01613"></a>01613         <a class="code" href="classDRAMCtrl_1_1Rank.html#aaa93024068493c8856d1875bcec2bc20" title="Schedule a power state transition in the future, and potentially override an already...">schedulePowerEvent</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5ad79cd3d1d143ec78afd1f4774921adcf">PWR_IDLE</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01614"></a>01614     }
<a name="l01615"></a>01615 }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617 <span class="keywordtype">void</span>
<a name="l01618"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#a09e5bd352964c6bf73b92e4c7805f1f8">01618</a> <a class="code" href="classDRAMCtrl_1_1Rank.html#a09e5bd352964c6bf73b92e4c7805f1f8">DRAMCtrl::Rank::processRefreshEvent</a>()
<a name="l01619"></a>01619 {
<a name="l01620"></a>01620     <span class="comment">// when first preparing the refresh, remember when it was due</span>
<a name="l01621"></a>01621     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87a37947d392c28827536fd44a7a7592deb">REF_IDLE</a>) {
<a name="l01622"></a>01622         <span class="comment">// remember when the refresh is due</span>
<a name="l01623"></a>01623         <a class="code" href="classDRAMCtrl_1_1Rank.html#aa6b9bb1b76bee949071d1210e0c31397" title="Keep track of when a refresh is due.">refreshDueAt</a> = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>();
<a name="l01624"></a>01624 
<a name="l01625"></a>01625         <span class="comment">// proceed to drain</span>
<a name="l01626"></a>01626         <a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> = <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87abeb47de6eb5f7d9aead19f793279e961">REF_DRAIN</a>;
<a name="l01627"></a>01627 
<a name="l01628"></a>01628         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Refresh due\n&quot;</span>);
<a name="l01629"></a>01629     }
<a name="l01630"></a>01630 
<a name="l01631"></a>01631     <span class="comment">// let any scheduled read or write to the same rank go ahead,</span>
<a name="l01632"></a>01632     <span class="comment">// after which it will</span>
<a name="l01633"></a>01633     <span class="comment">// hand control back to this event loop</span>
<a name="l01634"></a>01634     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87abeb47de6eb5f7d9aead19f793279e961">REF_DRAIN</a>) {
<a name="l01635"></a>01635         <span class="comment">// if a request is at the moment being handled and this request is</span>
<a name="l01636"></a>01636         <span class="comment">// accessing the current rank then wait for it to finish</span>
<a name="l01637"></a>01637         <span class="keywordflow">if</span> ((rank == <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#ac8f112decf864fe3a7877790f950ebb9">activeRank</a>)
<a name="l01638"></a>01638             &amp;&amp; (<a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>())) {
<a name="l01639"></a>01639             <span class="comment">// hand control over to the request loop until it is</span>
<a name="l01640"></a>01640             <span class="comment">// evaluated next</span>
<a name="l01641"></a>01641             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Refresh awaiting draining\n&quot;</span>);
<a name="l01642"></a>01642 
<a name="l01643"></a>01643             <span class="keywordflow">return</span>;
<a name="l01644"></a>01644         } <span class="keywordflow">else</span> {
<a name="l01645"></a>01645             <a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> = <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87acdb75c5a5c4071041a18e1344df050f7">REF_PRE</a>;
<a name="l01646"></a>01646         }
<a name="l01647"></a>01647     }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649     <span class="comment">// at this point, ensure that all banks are precharged</span>
<a name="l01650"></a>01650     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87acdb75c5a5c4071041a18e1344df050f7">REF_PRE</a>) {
<a name="l01651"></a>01651         <span class="comment">// precharge any active bank if we are not already in the idle</span>
<a name="l01652"></a>01652         <span class="comment">// state</span>
<a name="l01653"></a>01653         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#aabe86e89ac0bc14e74cedf4adde85038" title="Current power state.">pwrState</a> != <a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5ad79cd3d1d143ec78afd1f4774921adcf">PWR_IDLE</a>) {
<a name="l01654"></a>01654             <span class="comment">// at the moment, we use a precharge all even if there is</span>
<a name="l01655"></a>01655             <span class="comment">// only a single bank open</span>
<a name="l01656"></a>01656             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;Precharging all\n&quot;</span>);
<a name="l01657"></a>01657 
<a name="l01658"></a>01658             <span class="comment">// first determine when we can precharge</span>
<a name="l01659"></a>01659             <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> pre_at = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>();
<a name="l01660"></a>01660 
<a name="l01661"></a>01661             <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a> : <a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>) {
<a name="l01662"></a>01662                 <span class="comment">// respect both causality and any existing bank</span>
<a name="l01663"></a>01663                 <span class="comment">// constraints, some banks could already have a</span>
<a name="l01664"></a>01664                 <span class="comment">// (auto) precharge scheduled</span>
<a name="l01665"></a>01665                 pre_at = std::max(<a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>.preAllowedAt, pre_at);
<a name="l01666"></a>01666             }
<a name="l01667"></a>01667 
<a name="l01668"></a>01668             <span class="comment">// make sure all banks per rank are precharged, and for those that</span>
<a name="l01669"></a>01669             <span class="comment">// already are, update their availability</span>
<a name="l01670"></a>01670             <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> act_allowed_at = pre_at + <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a1edd216a091aa2ec675985c16134d626">tRP</a>;
<a name="l01671"></a>01671 
<a name="l01672"></a>01672             <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a> : banks) {
<a name="l01673"></a>01673                 <span class="keywordflow">if</span> (<a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>.openRow != <a class="code" href="classDRAMCtrl_1_1Bank.html#a81fa13164d43b203076fcdacde0fb6c8">Bank::NO_ROW</a>) {
<a name="l01674"></a>01674                     <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a7004ae8efe3eeb94220b53be3d25ea0e" title="Precharge a given bank and also update when the precharge is done.">prechargeBank</a>(*<span class="keyword">this</span>, <a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>, pre_at, <span class="keyword">false</span>);
<a name="l01675"></a>01675                 } <span class="keywordflow">else</span> {
<a name="l01676"></a>01676                     <a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>.actAllowedAt = std::max(<a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>.actAllowedAt, act_allowed_at);
<a name="l01677"></a>01677                     <a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>.preAllowedAt = std::max(<a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>.preAllowedAt, pre_at);
<a name="l01678"></a>01678                 }
<a name="l01679"></a>01679             }
<a name="l01680"></a>01680 
<a name="l01681"></a>01681             <span class="comment">// precharge all banks in rank</span>
<a name="l01682"></a>01682             <a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.doCommand(MemCommand::PREA, 0,
<a name="l01683"></a>01683                                      <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(pre_at, <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>) -
<a name="l01684"></a>01684                                      <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a>);
<a name="l01685"></a>01685 
<a name="l01686"></a>01686             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classDRAMPower.html" title="DRAMPower is a standalone tool which calculates the power consumed by a DRAM in the...">DRAMPower</a>, <span class="stringliteral">&quot;%llu,PREA,0,%d\n&quot;</span>,
<a name="l01687"></a>01687                     <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(pre_at, <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>) -
<a name="l01688"></a>01688                             <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a>, rank);
<a name="l01689"></a>01689         } <span class="keywordflow">else</span> {
<a name="l01690"></a>01690             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAM, <span class="stringliteral">&quot;All banks already precharged, starting refresh\n&quot;</span>);
<a name="l01691"></a>01691 
<a name="l01692"></a>01692             <span class="comment">// go ahead and kick the power state machine into gear if</span>
<a name="l01693"></a>01693             <span class="comment">// we are already idle</span>
<a name="l01694"></a>01694             <a class="code" href="classDRAMCtrl_1_1Rank.html#aaa93024068493c8856d1875bcec2bc20" title="Schedule a power state transition in the future, and potentially override an already...">schedulePowerEvent</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5ab1b37230952a216dd02660b8e22cfb25">PWR_REF</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01695"></a>01695         }
<a name="l01696"></a>01696 
<a name="l01697"></a>01697         <a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> = <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87a9f2274a78101e0e728db44558f655807">REF_RUN</a>;
<a name="l01698"></a>01698         assert(<a class="code" href="classDRAMCtrl_1_1Rank.html#abb35437efe71e911365685b3cfb5cc7b" title="To track number of banks which are currently active for this rank.">numBanksActive</a> == 0);
<a name="l01699"></a>01699 
<a name="l01700"></a>01700         <span class="comment">// wait for all banks to be precharged, at which point the</span>
<a name="l01701"></a>01701         <span class="comment">// power state machine will transition to the idle state, and</span>
<a name="l01702"></a>01702         <span class="comment">// automatically move to a refresh, at that point it will also</span>
<a name="l01703"></a>01703         <span class="comment">// call this method to get the refresh event loop going again</span>
<a name="l01704"></a>01704         <span class="keywordflow">return</span>;
<a name="l01705"></a>01705     }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707     <span class="comment">// last but not least we perform the actual refresh</span>
<a name="l01708"></a>01708     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87a9f2274a78101e0e728db44558f655807">REF_RUN</a>) {
<a name="l01709"></a>01709         <span class="comment">// should never get here with any banks active</span>
<a name="l01710"></a>01710         assert(<a class="code" href="classDRAMCtrl_1_1Rank.html#abb35437efe71e911365685b3cfb5cc7b" title="To track number of banks which are currently active for this rank.">numBanksActive</a> == 0);
<a name="l01711"></a>01711         assert(<a class="code" href="classDRAMCtrl_1_1Rank.html#aabe86e89ac0bc14e74cedf4adde85038" title="Current power state.">pwrState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5ab1b37230952a216dd02660b8e22cfb25">PWR_REF</a>);
<a name="l01712"></a>01712 
<a name="l01713"></a>01713         <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> ref_done_at = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() + <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#aad8f72c5b11730c9346de00a53d108fe">tRFC</a>;
<a name="l01714"></a>01714 
<a name="l01715"></a>01715         <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;<a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a> : <a class="code" href="classDRAMCtrl_1_1Rank.html#a0fec8a93057d0a3fc2096fe4e6cba9bb" title="Vector of Banks.">banks</a>) {
<a name="l01716"></a>01716             <a class="code" href="namespaceArmISA.html#a29719d011b23c89180048e7a7d13542e">b</a>.actAllowedAt = ref_done_at;
<a name="l01717"></a>01717         }
<a name="l01718"></a>01718 
<a name="l01719"></a>01719         <span class="comment">// at the moment this affects all ranks</span>
<a name="l01720"></a>01720         <a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.doCommand(MemCommand::REF, 0,
<a name="l01721"></a>01721                                  <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(<a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>(), <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>) -
<a name="l01722"></a>01722                                  <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a>);
<a name="l01723"></a>01723 
<a name="l01724"></a>01724         <span class="comment">// at the moment sort the list of commands and update the counters</span>
<a name="l01725"></a>01725         <span class="comment">// for DRAMPower libray when doing a refresh</span>
<a name="l01726"></a>01726         sort(<a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.cmdList.begin(),
<a name="l01727"></a>01727              <a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.cmdList.end(), <a class="code" href="classDRAMCtrl.html#a2d7bd480bef4100bbd0933a60899f33d" title="Function for sorting commands in the command list of DRAMPower.">DRAMCtrl::sortTime</a>);
<a name="l01728"></a>01728 
<a name="l01729"></a>01729         <span class="comment">// update the counters for DRAMPower, passing false to</span>
<a name="l01730"></a>01730         <span class="comment">// indicate that this is not the last command in the</span>
<a name="l01731"></a>01731         <span class="comment">// list. DRAMPower requires this information for the</span>
<a name="l01732"></a>01732         <span class="comment">// correct calculation of the background energy at the end</span>
<a name="l01733"></a>01733         <span class="comment">// of the simulation. Ideally we would want to call this</span>
<a name="l01734"></a>01734         <span class="comment">// function with true once at the end of the</span>
<a name="l01735"></a>01735         <span class="comment">// simulation. However, the discarded energy is extremly</span>
<a name="l01736"></a>01736         <span class="comment">// small and does not effect the final results.</span>
<a name="l01737"></a>01737         <a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.updateCounters(<span class="keyword">false</span>);
<a name="l01738"></a>01738 
<a name="l01739"></a>01739         <span class="comment">// call the energy function</span>
<a name="l01740"></a>01740         <a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.calcEnergy();
<a name="l01741"></a>01741 
<a name="l01742"></a>01742         <span class="comment">// Update the stats</span>
<a name="l01743"></a>01743         <a class="code" href="classDRAMCtrl_1_1Rank.html#addbf0460fd32dd1854d9839eae5fc229" title="Function to update Power Stats.">updatePowerStats</a>();
<a name="l01744"></a>01744 
<a name="l01745"></a>01745         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classDRAMPower.html" title="DRAMPower is a standalone tool which calculates the power consumed by a DRAM in the...">DRAMPower</a>, <span class="stringliteral">&quot;%llu,REF,0,%d\n&quot;</span>, <a class="code" href="intmath_8hh.html#ae842b412d3570df97a944085b8f85850">divCeil</a>(<a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>(), <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a84edadf633285a26a1ff5ae6e6987cbd" title="Basic memory timing parameters initialized based on parameter values.">tCK</a>) -
<a name="l01746"></a>01746                 <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a814fd74ac86e22454d2d9eeb27020212">timeStampOffset</a>, rank);
<a name="l01747"></a>01747 
<a name="l01748"></a>01748         <span class="comment">// make sure we did not wait so long that we cannot make up</span>
<a name="l01749"></a>01749         <span class="comment">// for it</span>
<a name="l01750"></a>01750         <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#aa6b9bb1b76bee949071d1210e0c31397" title="Keep track of when a refresh is due.">refreshDueAt</a> + <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a845143aad659120f25f1d26c06574660">tREFI</a> &lt; ref_done_at) {
<a name="l01751"></a>01751             <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Refresh was delayed so long we cannot catch up\n&quot;</span>);
<a name="l01752"></a>01752         }
<a name="l01753"></a>01753 
<a name="l01754"></a>01754         <span class="comment">// compensate for the delay in actually performing the refresh</span>
<a name="l01755"></a>01755         <span class="comment">// when scheduling the next one</span>
<a name="l01756"></a>01756         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a45426fbf62f12e8ace06a9e817d0474d">refreshEvent</a>, <a class="code" href="classDRAMCtrl_1_1Rank.html#aa6b9bb1b76bee949071d1210e0c31397" title="Keep track of when a refresh is due.">refreshDueAt</a> + <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a845143aad659120f25f1d26c06574660">tREFI</a> - <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a1edd216a091aa2ec675985c16134d626">tRP</a>);
<a name="l01757"></a>01757 
<a name="l01758"></a>01758         assert(!<a class="code" href="classDRAMCtrl_1_1Rank.html#a0bf48b504138b86b12d98cfabf419642">powerEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>());
<a name="l01759"></a>01759 
<a name="l01760"></a>01760         <span class="comment">// move to the idle power state once the refresh is done, this</span>
<a name="l01761"></a>01761         <span class="comment">// will also move the refresh state machine to the refresh</span>
<a name="l01762"></a>01762         <span class="comment">// idle state</span>
<a name="l01763"></a>01763         <a class="code" href="classDRAMCtrl_1_1Rank.html#aaa93024068493c8856d1875bcec2bc20" title="Schedule a power state transition in the future, and potentially override an already...">schedulePowerEvent</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5ad79cd3d1d143ec78afd1f4774921adcf">PWR_IDLE</a>, ref_done_at);
<a name="l01764"></a>01764 
<a name="l01765"></a>01765         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAMState, <span class="stringliteral">&quot;Refresh done at %llu and next refresh at %llu\n&quot;</span>,
<a name="l01766"></a>01766                 ref_done_at, <a class="code" href="classDRAMCtrl_1_1Rank.html#aa6b9bb1b76bee949071d1210e0c31397" title="Keep track of when a refresh is due.">refreshDueAt</a> + <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a845143aad659120f25f1d26c06574660">tREFI</a>);
<a name="l01767"></a>01767     }
<a name="l01768"></a>01768 }
<a name="l01769"></a>01769 
<a name="l01770"></a>01770 <span class="keywordtype">void</span>
<a name="l01771"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#aaa93024068493c8856d1875bcec2bc20">01771</a> <a class="code" href="classDRAMCtrl_1_1Rank.html#aaa93024068493c8856d1875bcec2bc20" title="Schedule a power state transition in the future, and potentially override an already...">DRAMCtrl::Rank::schedulePowerEvent</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5" title="The power state captures the different operational states of the DRAM and interacts...">PowerState</a> pwr_state, <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> <a class="code" href="classClockedObject.html#a8668201564515e2292f264d3fa2abfaa">tick</a>)
<a name="l01772"></a>01772 {
<a name="l01773"></a>01773     <span class="comment">// respect causality</span>
<a name="l01774"></a>01774     assert(tick &gt;= <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01775"></a>01775 
<a name="l01776"></a>01776     <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl_1_1Rank.html#a0bf48b504138b86b12d98cfabf419642">powerEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>()) {
<a name="l01777"></a>01777         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAMState, <span class="stringliteral">&quot;Scheduling power event at %llu to state %d\n&quot;</span>,
<a name="l01778"></a>01778                 tick, pwr_state);
<a name="l01779"></a>01779 
<a name="l01780"></a>01780         <span class="comment">// insert the new transition</span>
<a name="l01781"></a>01781         <a class="code" href="classDRAMCtrl_1_1Rank.html#a64786ca5d8dc142b2aeaff9c8d4ddf45" title="Since we are taking decisions out of order, we need to keep track of what power transition...">pwrStateTrans</a> = pwr_state;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783         <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a0bf48b504138b86b12d98cfabf419642">powerEvent</a>, tick);
<a name="l01784"></a>01784     } <span class="keywordflow">else</span> {
<a name="l01785"></a>01785         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Scheduled power event at %llu to state %d, &quot;</span>
<a name="l01786"></a>01786               <span class="stringliteral">&quot;with scheduled event at %llu to %d\n&quot;</span>, tick, pwr_state,
<a name="l01787"></a>01787               <a class="code" href="classDRAMCtrl_1_1Rank.html#a0bf48b504138b86b12d98cfabf419642">powerEvent</a>.<a class="code" href="classEvent.html#a3ff737aa0692f1ea9b8dd232778f2fcb" title="Get the time that the event is scheduled.">when</a>(), <a class="code" href="classDRAMCtrl_1_1Rank.html#a64786ca5d8dc142b2aeaff9c8d4ddf45" title="Since we are taking decisions out of order, we need to keep track of what power transition...">pwrStateTrans</a>);
<a name="l01788"></a>01788     }
<a name="l01789"></a>01789 }
<a name="l01790"></a>01790 
<a name="l01791"></a>01791 <span class="keywordtype">void</span>
<a name="l01792"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#a883322fd74ea67847ce9e9f71629cc41">01792</a> <a class="code" href="classDRAMCtrl_1_1Rank.html#a883322fd74ea67847ce9e9f71629cc41">DRAMCtrl::Rank::processPowerEvent</a>()
<a name="l01793"></a>01793 {
<a name="l01794"></a>01794     <span class="comment">// remember where we were, and for how long</span>
<a name="l01795"></a>01795     <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a> duration = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() - <a class="code" href="classDRAMCtrl_1_1Rank.html#af895f26ee9ce9f7f781dbe054d6484f9" title="Track when we transitioned to the current power state.">pwrStateTick</a>;
<a name="l01796"></a>01796     <a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5" title="The power state captures the different operational states of the DRAM and interacts...">PowerState</a> prev_state = <a class="code" href="classDRAMCtrl_1_1Rank.html#aabe86e89ac0bc14e74cedf4adde85038" title="Current power state.">pwrState</a>;
<a name="l01797"></a>01797 
<a name="l01798"></a>01798     <span class="comment">// update the accounting</span>
<a name="l01799"></a>01799     <a class="code" href="classDRAMCtrl_1_1Rank.html#a52400a09b976e81604d843c7d8097284" title="Track time spent in each power state.">pwrStateTime</a>[prev_state] += duration;
<a name="l01800"></a>01800 
<a name="l01801"></a>01801     <a class="code" href="classDRAMCtrl_1_1Rank.html#aabe86e89ac0bc14e74cedf4adde85038" title="Current power state.">pwrState</a> = <a class="code" href="classDRAMCtrl_1_1Rank.html#a64786ca5d8dc142b2aeaff9c8d4ddf45" title="Since we are taking decisions out of order, we need to keep track of what power transition...">pwrStateTrans</a>;
<a name="l01802"></a>01802     <a class="code" href="classDRAMCtrl_1_1Rank.html#af895f26ee9ce9f7f781dbe054d6484f9" title="Track when we transitioned to the current power state.">pwrStateTick</a> = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>();
<a name="l01803"></a>01803 
<a name="l01804"></a>01804     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#aabe86e89ac0bc14e74cedf4adde85038" title="Current power state.">pwrState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5ad79cd3d1d143ec78afd1f4774921adcf">PWR_IDLE</a>) {
<a name="l01805"></a>01805         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAMState, <span class="stringliteral">&quot;All banks precharged\n&quot;</span>);
<a name="l01806"></a>01806 
<a name="l01807"></a>01807         <span class="comment">// if we were refreshing, make sure we start scheduling requests again</span>
<a name="l01808"></a>01808         <span class="keywordflow">if</span> (prev_state == <a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5ab1b37230952a216dd02660b8e22cfb25">PWR_REF</a>) {
<a name="l01809"></a>01809             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAMState, <span class="stringliteral">&quot;Was refreshing for %llu ticks\n&quot;</span>, duration);
<a name="l01810"></a>01810             assert(<a class="code" href="classDRAMCtrl_1_1Rank.html#aabe86e89ac0bc14e74cedf4adde85038" title="Current power state.">pwrState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5ad79cd3d1d143ec78afd1f4774921adcf">PWR_IDLE</a>);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812             <span class="comment">// kick things into action again</span>
<a name="l01813"></a>01813             <a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> = <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87a37947d392c28827536fd44a7a7592deb">REF_IDLE</a>;
<a name="l01814"></a>01814             <span class="comment">// a request event could be already scheduled by the state</span>
<a name="l01815"></a>01815             <span class="comment">// machine of the other rank</span>
<a name="l01816"></a>01816             <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>())
<a name="l01817"></a>01817                 <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01818"></a>01818         } <span class="keywordflow">else</span> {
<a name="l01819"></a>01819             assert(prev_state == <a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5a3454fa85063ead55941c5d8e58404402">PWR_ACT</a>);
<a name="l01820"></a>01820 
<a name="l01821"></a>01821             <span class="comment">// if we have a pending refresh, and are now moving to</span>
<a name="l01822"></a>01822             <span class="comment">// the idle state, direclty transition to a refresh</span>
<a name="l01823"></a>01823             <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87a9f2274a78101e0e728db44558f655807">REF_RUN</a>) {
<a name="l01824"></a>01824                 <span class="comment">// there should be nothing waiting at this point</span>
<a name="l01825"></a>01825                 assert(!<a class="code" href="classDRAMCtrl_1_1Rank.html#a0bf48b504138b86b12d98cfabf419642">powerEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>());
<a name="l01826"></a>01826 
<a name="l01827"></a>01827                 <span class="comment">// update the state in zero time and proceed below</span>
<a name="l01828"></a>01828                 <a class="code" href="classDRAMCtrl_1_1Rank.html#aabe86e89ac0bc14e74cedf4adde85038" title="Current power state.">pwrState</a> = <a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5ab1b37230952a216dd02660b8e22cfb25">PWR_REF</a>;
<a name="l01829"></a>01829             }
<a name="l01830"></a>01830         }
<a name="l01831"></a>01831     }
<a name="l01832"></a>01832 
<a name="l01833"></a>01833     <span class="comment">// we transition to the refresh state, let the refresh state</span>
<a name="l01834"></a>01834     <span class="comment">// machine know of this state update and let it deal with the</span>
<a name="l01835"></a>01835     <span class="comment">// scheduling of the next power state transition as well as the</span>
<a name="l01836"></a>01836     <span class="comment">// following refresh</span>
<a name="l01837"></a>01837     <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl_1_1Rank.html#aabe86e89ac0bc14e74cedf4adde85038" title="Current power state.">pwrState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#a6a7be86f7d81a30ff1ddcb8bd9df80c5ab1b37230952a216dd02660b8e22cfb25">PWR_REF</a>) {
<a name="l01838"></a>01838         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(DRAMState, <span class="stringliteral">&quot;Refreshing\n&quot;</span>);
<a name="l01839"></a>01839         <span class="comment">// kick the refresh event loop into action again, and that</span>
<a name="l01840"></a>01840         <span class="comment">// in turn will schedule a transition to the idle power</span>
<a name="l01841"></a>01841         <span class="comment">// state once the refresh is done</span>
<a name="l01842"></a>01842         assert(<a class="code" href="classDRAMCtrl_1_1Rank.html#a8fcfa19c9c66e830da40b7c34036f58b" title="current refresh state">refreshState</a> == <a class="code" href="classDRAMCtrl_1_1Rank.html#abb68f88673ae58cacbb38f47de3ecc87a9f2274a78101e0e728db44558f655807">REF_RUN</a>);
<a name="l01843"></a>01843         <a class="code" href="classDRAMCtrl_1_1Rank.html#a09e5bd352964c6bf73b92e4c7805f1f8">processRefreshEvent</a>();
<a name="l01844"></a>01844     }
<a name="l01845"></a>01845 }
<a name="l01846"></a>01846 
<a name="l01847"></a>01847 <span class="keywordtype">void</span>
<a name="l01848"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#addbf0460fd32dd1854d9839eae5fc229">01848</a> <a class="code" href="classDRAMCtrl.html#ad7dbb6e5660961b4b83bfca751a10930" title="This function increments the energy when called.">DRAMCtrl::Rank::updatePowerStats</a>()
<a name="l01849"></a>01849 {
<a name="l01850"></a>01850     <span class="comment">// Get the energy and power from DRAMPower</span>
<a name="l01851"></a>01851     Data::MemoryPowerModel::Energy energy =
<a name="l01852"></a>01852         <a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.getEnergy();
<a name="l01853"></a>01853     Data::MemoryPowerModel::Power rank_power =
<a name="l01854"></a>01854         <a class="code" href="classDRAMCtrl_1_1Rank.html#a5dadc766e862bdda629646cea3aa8d96" title="One DRAMPower instance per rank.">power</a>.<a class="code" href="classDRAMPower.html#a183c619d03d630fa64b31d0ee57803ed">powerlib</a>.getPower();
<a name="l01855"></a>01855 
<a name="l01856"></a>01856     <a class="code" href="classDRAMCtrl_1_1Rank.html#aeecb1f1be50e775dca3e6243148ee571">actEnergy</a> = energy.act_energy * <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a72d0aec53605ee36ff410dd8970a0eaa">devicesPerRank</a>;
<a name="l01857"></a>01857     <a class="code" href="classDRAMCtrl_1_1Rank.html#a9d3738a8077059f09b659df183ddafdb">preEnergy</a> = energy.pre_energy * <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a72d0aec53605ee36ff410dd8970a0eaa">devicesPerRank</a>;
<a name="l01858"></a>01858     <a class="code" href="classDRAMCtrl_1_1Rank.html#a3983a9709ba1cd8497fe3e399240e5bd">readEnergy</a> = energy.read_energy * <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a72d0aec53605ee36ff410dd8970a0eaa">devicesPerRank</a>;
<a name="l01859"></a>01859     <a class="code" href="classDRAMCtrl_1_1Rank.html#a141a0d4818739827da8ddab4e30126a4">writeEnergy</a> = energy.write_energy * <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a72d0aec53605ee36ff410dd8970a0eaa">devicesPerRank</a>;
<a name="l01860"></a>01860     <a class="code" href="classDRAMCtrl_1_1Rank.html#a441303428e5a9d544f22396e62461b6c">refreshEnergy</a> = energy.ref_energy * <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a72d0aec53605ee36ff410dd8970a0eaa">devicesPerRank</a>;
<a name="l01861"></a>01861     <a class="code" href="classDRAMCtrl_1_1Rank.html#ad45dbfbfc0ca791b5d8741e96f110b14">actBackEnergy</a> = energy.act_stdby_energy * <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a72d0aec53605ee36ff410dd8970a0eaa">devicesPerRank</a>;
<a name="l01862"></a>01862     <a class="code" href="classDRAMCtrl_1_1Rank.html#a5c6ad88726c99e65a2aef51af47fdeb1">preBackEnergy</a> = energy.pre_stdby_energy * <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a72d0aec53605ee36ff410dd8970a0eaa">devicesPerRank</a>;
<a name="l01863"></a>01863     <a class="code" href="classDRAMCtrl_1_1Rank.html#af7c2c7cdf0a0f3de0b870aa6f000d605">totalEnergy</a> = energy.total_energy * <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a72d0aec53605ee36ff410dd8970a0eaa">devicesPerRank</a>;
<a name="l01864"></a>01864     <a class="code" href="classDRAMCtrl_1_1Rank.html#a7e400eb4419e4cfb76712a8db6d59ad0">averagePower</a> = rank_power.average_power * <a class="code" href="classDRAMCtrl_1_1Rank.html#a158f4d7c0d97017fe301e4ae257488bf" title="A reference to the parent DRAMCtrl instance.">memory</a>.<a class="code" href="classDRAMCtrl.html#a72d0aec53605ee36ff410dd8970a0eaa">devicesPerRank</a>;
<a name="l01865"></a>01865 }
<a name="l01866"></a>01866 
<a name="l01867"></a>01867 <span class="keywordtype">void</span>
<a name="l01868"></a><a class="code" href="classDRAMCtrl_1_1Rank.html#a8741e82fe4cef525b183534c3fbb6318">01868</a> <a class="code" href="classDRAMCtrl.html#aba1a68e804c3a30b4add00e87f462842" title="Register Statistics.">DRAMCtrl::Rank::regStats</a>()
<a name="l01869"></a>01869 {
<a name="l01870"></a>01870     <span class="keyword">using namespace </span>Stats;
<a name="l01871"></a>01871 
<a name="l01872"></a>01872     <a class="code" href="classDRAMCtrl_1_1Rank.html#a52400a09b976e81604d843c7d8097284" title="Track time spent in each power state.">pwrStateTime</a>
<a name="l01873"></a>01873         .<a class="code" href="classStats_1_1VectorBase.html#ada7b4d1605ccdfba6975aa1025b861a2" title="Set this vector to have the given size.">init</a>(5)
<a name="l01874"></a>01874         .name(<a class="code" href="classDRAMCtrl_1_1Rank.html#a60ae2ccaadc12799f1a61df5f15ab764">name</a>() + <span class="stringliteral">&quot;.memoryStateTime&quot;</span>)
<a name="l01875"></a>01875         .desc(<span class="stringliteral">&quot;Time in different power states&quot;</span>);
<a name="l01876"></a>01876     <a class="code" href="classDRAMCtrl_1_1Rank.html#a52400a09b976e81604d843c7d8097284" title="Track time spent in each power state.">pwrStateTime</a>.<a class="code" href="classStats_1_1DataWrapVec.html#aae2edca50c84852ff492b98721662d3e" title="Set the subfield name for the given index, and marks this stat to print at the end...">subname</a>(0, <span class="stringliteral">&quot;IDLE&quot;</span>);
<a name="l01877"></a>01877     <a class="code" href="classDRAMCtrl_1_1Rank.html#a52400a09b976e81604d843c7d8097284" title="Track time spent in each power state.">pwrStateTime</a>.<a class="code" href="classStats_1_1DataWrapVec.html#aae2edca50c84852ff492b98721662d3e" title="Set the subfield name for the given index, and marks this stat to print at the end...">subname</a>(1, <span class="stringliteral">&quot;REF&quot;</span>);
<a name="l01878"></a>01878     <a class="code" href="classDRAMCtrl_1_1Rank.html#a52400a09b976e81604d843c7d8097284" title="Track time spent in each power state.">pwrStateTime</a>.<a class="code" href="classStats_1_1DataWrapVec.html#aae2edca50c84852ff492b98721662d3e" title="Set the subfield name for the given index, and marks this stat to print at the end...">subname</a>(2, <span class="stringliteral">&quot;PRE_PDN&quot;</span>);
<a name="l01879"></a>01879     <a class="code" href="classDRAMCtrl_1_1Rank.html#a52400a09b976e81604d843c7d8097284" title="Track time spent in each power state.">pwrStateTime</a>.<a class="code" href="classStats_1_1DataWrapVec.html#aae2edca50c84852ff492b98721662d3e" title="Set the subfield name for the given index, and marks this stat to print at the end...">subname</a>(3, <span class="stringliteral">&quot;ACT&quot;</span>);
<a name="l01880"></a>01880     <a class="code" href="classDRAMCtrl_1_1Rank.html#a52400a09b976e81604d843c7d8097284" title="Track time spent in each power state.">pwrStateTime</a>.<a class="code" href="classStats_1_1DataWrapVec.html#aae2edca50c84852ff492b98721662d3e" title="Set the subfield name for the given index, and marks this stat to print at the end...">subname</a>(4, <span class="stringliteral">&quot;ACT_PDN&quot;</span>);
<a name="l01881"></a>01881 
<a name="l01882"></a>01882     <a class="code" href="classDRAMCtrl_1_1Rank.html#aeecb1f1be50e775dca3e6243148ee571">actEnergy</a>
<a name="l01883"></a>01883         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a60ae2ccaadc12799f1a61df5f15ab764">name</a>() + <span class="stringliteral">&quot;.actEnergy&quot;</span>)
<a name="l01884"></a>01884         .desc(<span class="stringliteral">&quot;Energy for activate commands per rank (pJ)&quot;</span>);
<a name="l01885"></a>01885 
<a name="l01886"></a>01886     <a class="code" href="classDRAMCtrl_1_1Rank.html#a9d3738a8077059f09b659df183ddafdb">preEnergy</a>
<a name="l01887"></a>01887         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a60ae2ccaadc12799f1a61df5f15ab764">name</a>() + <span class="stringliteral">&quot;.preEnergy&quot;</span>)
<a name="l01888"></a>01888         .desc(<span class="stringliteral">&quot;Energy for precharge commands per rank (pJ)&quot;</span>);
<a name="l01889"></a>01889 
<a name="l01890"></a>01890     <a class="code" href="classDRAMCtrl_1_1Rank.html#a3983a9709ba1cd8497fe3e399240e5bd">readEnergy</a>
<a name="l01891"></a>01891         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a60ae2ccaadc12799f1a61df5f15ab764">name</a>() + <span class="stringliteral">&quot;.readEnergy&quot;</span>)
<a name="l01892"></a>01892         .desc(<span class="stringliteral">&quot;Energy for read commands per rank (pJ)&quot;</span>);
<a name="l01893"></a>01893 
<a name="l01894"></a>01894     <a class="code" href="classDRAMCtrl_1_1Rank.html#a141a0d4818739827da8ddab4e30126a4">writeEnergy</a>
<a name="l01895"></a>01895         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a60ae2ccaadc12799f1a61df5f15ab764">name</a>() + <span class="stringliteral">&quot;.writeEnergy&quot;</span>)
<a name="l01896"></a>01896         .desc(<span class="stringliteral">&quot;Energy for write commands per rank (pJ)&quot;</span>);
<a name="l01897"></a>01897 
<a name="l01898"></a>01898     <a class="code" href="classDRAMCtrl_1_1Rank.html#a441303428e5a9d544f22396e62461b6c">refreshEnergy</a>
<a name="l01899"></a>01899         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a60ae2ccaadc12799f1a61df5f15ab764">name</a>() + <span class="stringliteral">&quot;.refreshEnergy&quot;</span>)
<a name="l01900"></a>01900         .desc(<span class="stringliteral">&quot;Energy for refresh commands per rank (pJ)&quot;</span>);
<a name="l01901"></a>01901 
<a name="l01902"></a>01902     <a class="code" href="classDRAMCtrl_1_1Rank.html#ad45dbfbfc0ca791b5d8741e96f110b14">actBackEnergy</a>
<a name="l01903"></a>01903         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a60ae2ccaadc12799f1a61df5f15ab764">name</a>() + <span class="stringliteral">&quot;.actBackEnergy&quot;</span>)
<a name="l01904"></a>01904         .desc(<span class="stringliteral">&quot;Energy for active background per rank (pJ)&quot;</span>);
<a name="l01905"></a>01905 
<a name="l01906"></a>01906     <a class="code" href="classDRAMCtrl_1_1Rank.html#a5c6ad88726c99e65a2aef51af47fdeb1">preBackEnergy</a>
<a name="l01907"></a>01907         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a60ae2ccaadc12799f1a61df5f15ab764">name</a>() + <span class="stringliteral">&quot;.preBackEnergy&quot;</span>)
<a name="l01908"></a>01908         .desc(<span class="stringliteral">&quot;Energy for precharge background per rank (pJ)&quot;</span>);
<a name="l01909"></a>01909 
<a name="l01910"></a>01910     <a class="code" href="classDRAMCtrl_1_1Rank.html#af7c2c7cdf0a0f3de0b870aa6f000d605">totalEnergy</a>
<a name="l01911"></a>01911         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a60ae2ccaadc12799f1a61df5f15ab764">name</a>() + <span class="stringliteral">&quot;.totalEnergy&quot;</span>)
<a name="l01912"></a>01912         .desc(<span class="stringliteral">&quot;Total energy per rank (pJ)&quot;</span>);
<a name="l01913"></a>01913 
<a name="l01914"></a>01914     <a class="code" href="classDRAMCtrl_1_1Rank.html#a7e400eb4419e4cfb76712a8db6d59ad0">averagePower</a>
<a name="l01915"></a>01915         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classDRAMCtrl_1_1Rank.html#a60ae2ccaadc12799f1a61df5f15ab764">name</a>() + <span class="stringliteral">&quot;.averagePower&quot;</span>)
<a name="l01916"></a>01916         .desc(<span class="stringliteral">&quot;Core power per rank (mW)&quot;</span>);
<a name="l01917"></a>01917 }
<a name="l01918"></a>01918 <span class="keywordtype">void</span>
<a name="l01919"></a><a class="code" href="classDRAMCtrl.html#aba1a68e804c3a30b4add00e87f462842">01919</a> <a class="code" href="classDRAMCtrl.html#aba1a68e804c3a30b4add00e87f462842" title="Register Statistics.">DRAMCtrl::regStats</a>()
<a name="l01920"></a>01920 {
<a name="l01921"></a>01921     <span class="keyword">using namespace </span>Stats;
<a name="l01922"></a>01922 
<a name="l01923"></a>01923     <a class="code" href="classDRAMCtrl.html#aba1a68e804c3a30b4add00e87f462842" title="Register Statistics.">AbstractMemory::regStats</a>();
<a name="l01924"></a>01924 
<a name="l01925"></a>01925     <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> : <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>) {
<a name="l01926"></a>01926         <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;regStats();
<a name="l01927"></a>01927     }
<a name="l01928"></a>01928 
<a name="l01929"></a>01929     <a class="code" href="classDRAMCtrl.html#ab7f21b330feeb44e38df54e2ba459272">readReqs</a>
<a name="l01930"></a>01930         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.readReqs&quot;</span>)
<a name="l01931"></a>01931         .desc(<span class="stringliteral">&quot;Number of read requests accepted&quot;</span>);
<a name="l01932"></a>01932 
<a name="l01933"></a>01933     <a class="code" href="classDRAMCtrl.html#a7ec9d1bff02a1ee089a6b2e52a25ddf7">writeReqs</a>
<a name="l01934"></a>01934         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.writeReqs&quot;</span>)
<a name="l01935"></a>01935         .desc(<span class="stringliteral">&quot;Number of write requests accepted&quot;</span>);
<a name="l01936"></a>01936 
<a name="l01937"></a>01937     <a class="code" href="classDRAMCtrl.html#a9f29a99e44a63f7c54f396d42ec29c4a">readBursts</a>
<a name="l01938"></a>01938         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.readBursts&quot;</span>)
<a name="l01939"></a>01939         .desc(<span class="stringliteral">&quot;Number of DRAM read bursts, &quot;</span>
<a name="l01940"></a>01940               <span class="stringliteral">&quot;including those serviced by the write queue&quot;</span>);
<a name="l01941"></a>01941 
<a name="l01942"></a>01942     <a class="code" href="classDRAMCtrl.html#a62d593c9cf45e7c36be919ce2b8a7673">writeBursts</a>
<a name="l01943"></a>01943         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.writeBursts&quot;</span>)
<a name="l01944"></a>01944         .desc(<span class="stringliteral">&quot;Number of DRAM write bursts, &quot;</span>
<a name="l01945"></a>01945               <span class="stringliteral">&quot;including those merged in the write queue&quot;</span>);
<a name="l01946"></a>01946 
<a name="l01947"></a>01947     <a class="code" href="classDRAMCtrl.html#aef20a1d281cf709372d7764085099517">servicedByWrQ</a>
<a name="l01948"></a>01948         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.servicedByWrQ&quot;</span>)
<a name="l01949"></a>01949         .desc(<span class="stringliteral">&quot;Number of DRAM read bursts serviced by the write queue&quot;</span>);
<a name="l01950"></a>01950 
<a name="l01951"></a>01951     <a class="code" href="classDRAMCtrl.html#ae193808abcaef94127dd307cd0fda9a4">mergedWrBursts</a>
<a name="l01952"></a>01952         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.mergedWrBursts&quot;</span>)
<a name="l01953"></a>01953         .desc(<span class="stringliteral">&quot;Number of DRAM write bursts merged with an existing one&quot;</span>);
<a name="l01954"></a>01954 
<a name="l01955"></a>01955     <a class="code" href="classDRAMCtrl.html#a6126d0f178c01a6bac05013216c219e0">neitherReadNorWrite</a>
<a name="l01956"></a>01956         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.neitherReadNorWriteReqs&quot;</span>)
<a name="l01957"></a>01957         .desc(<span class="stringliteral">&quot;Number of requests that are neither read nor write&quot;</span>);
<a name="l01958"></a>01958 
<a name="l01959"></a>01959     <a class="code" href="classDRAMCtrl.html#aa776c33f88e7b9befd7759a15144173f">perBankRdBursts</a>
<a name="l01960"></a>01960         .<a class="code" href="classStats_1_1VectorBase.html#ada7b4d1605ccdfba6975aa1025b861a2" title="Set this vector to have the given size.">init</a>(<a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a> * <a class="code" href="classDRAMCtrl.html#acd04cf88f749553586be796a0527ba35">ranksPerChannel</a>)
<a name="l01961"></a>01961         .name(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.perBankRdBursts&quot;</span>)
<a name="l01962"></a>01962         .desc(<span class="stringliteral">&quot;Per bank write bursts&quot;</span>);
<a name="l01963"></a>01963 
<a name="l01964"></a>01964     <a class="code" href="classDRAMCtrl.html#aa55805fbfefbec74965d03ae915f5043">perBankWrBursts</a>
<a name="l01965"></a>01965         .<a class="code" href="classStats_1_1VectorBase.html#ada7b4d1605ccdfba6975aa1025b861a2" title="Set this vector to have the given size.">init</a>(<a class="code" href="classDRAMCtrl.html#ab0f57be4e4ae5504efb9cea61676367b">banksPerRank</a> * ranksPerChannel)
<a name="l01966"></a>01966         .name(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.perBankWrBursts&quot;</span>)
<a name="l01967"></a>01967         .desc(<span class="stringliteral">&quot;Per bank write bursts&quot;</span>);
<a name="l01968"></a>01968 
<a name="l01969"></a>01969     <a class="code" href="classDRAMCtrl.html#aee32fb42bdd298319a24f82878398487">avgRdQLen</a>
<a name="l01970"></a>01970         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgRdQLen&quot;</span>)
<a name="l01971"></a>01971         .desc(<span class="stringliteral">&quot;Average read queue length when enqueuing&quot;</span>)
<a name="l01972"></a>01972         .precision(2);
<a name="l01973"></a>01973 
<a name="l01974"></a>01974     <a class="code" href="classDRAMCtrl.html#a83afaa015a549164f698db8ba7ea51b0">avgWrQLen</a>
<a name="l01975"></a>01975         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgWrQLen&quot;</span>)
<a name="l01976"></a>01976         .desc(<span class="stringliteral">&quot;Average write queue length when enqueuing&quot;</span>)
<a name="l01977"></a>01977         .precision(2);
<a name="l01978"></a>01978 
<a name="l01979"></a>01979     <a class="code" href="classDRAMCtrl.html#a284c28527546d2d044cb7a2576a8681e">totQLat</a>
<a name="l01980"></a>01980         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.totQLat&quot;</span>)
<a name="l01981"></a>01981         .desc(<span class="stringliteral">&quot;Total ticks spent queuing&quot;</span>);
<a name="l01982"></a>01982 
<a name="l01983"></a>01983     <a class="code" href="classDRAMCtrl.html#ac924b3fe4ea525e98e8d48799f680edd">totBusLat</a>
<a name="l01984"></a>01984         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.totBusLat&quot;</span>)
<a name="l01985"></a>01985         .desc(<span class="stringliteral">&quot;Total ticks spent in databus transfers&quot;</span>);
<a name="l01986"></a>01986 
<a name="l01987"></a>01987     <a class="code" href="classDRAMCtrl.html#adccc242d738f69f8a4f8572861195a5a">totMemAccLat</a>
<a name="l01988"></a>01988         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.totMemAccLat&quot;</span>)
<a name="l01989"></a>01989         .desc(<span class="stringliteral">&quot;Total ticks spent from burst creation until serviced &quot;</span>
<a name="l01990"></a>01990               <span class="stringliteral">&quot;by the DRAM&quot;</span>);
<a name="l01991"></a>01991 
<a name="l01992"></a>01992     <a class="code" href="classDRAMCtrl.html#ac5245e7513a0b0b0c8948e0934d5e829">avgQLat</a>
<a name="l01993"></a>01993         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgQLat&quot;</span>)
<a name="l01994"></a>01994         .desc(<span class="stringliteral">&quot;Average queueing delay per DRAM burst&quot;</span>)
<a name="l01995"></a>01995         .precision(2);
<a name="l01996"></a>01996 
<a name="l01997"></a>01997     <a class="code" href="classDRAMCtrl.html#ac5245e7513a0b0b0c8948e0934d5e829">avgQLat</a> = <a class="code" href="classDRAMCtrl.html#a284c28527546d2d044cb7a2576a8681e">totQLat</a> / (<a class="code" href="classDRAMCtrl.html#a9f29a99e44a63f7c54f396d42ec29c4a">readBursts</a> - <a class="code" href="classDRAMCtrl.html#aef20a1d281cf709372d7764085099517">servicedByWrQ</a>);
<a name="l01998"></a>01998 
<a name="l01999"></a>01999     <a class="code" href="classDRAMCtrl.html#a35f378691d6953216c38e33efe0680ad">avgBusLat</a>
<a name="l02000"></a>02000         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgBusLat&quot;</span>)
<a name="l02001"></a>02001         .desc(<span class="stringliteral">&quot;Average bus latency per DRAM burst&quot;</span>)
<a name="l02002"></a>02002         .precision(2);
<a name="l02003"></a>02003 
<a name="l02004"></a>02004     <a class="code" href="classDRAMCtrl.html#a35f378691d6953216c38e33efe0680ad">avgBusLat</a> = <a class="code" href="classDRAMCtrl.html#ac924b3fe4ea525e98e8d48799f680edd">totBusLat</a> / (<a class="code" href="classDRAMCtrl.html#a9f29a99e44a63f7c54f396d42ec29c4a">readBursts</a> - <a class="code" href="classDRAMCtrl.html#aef20a1d281cf709372d7764085099517">servicedByWrQ</a>);
<a name="l02005"></a>02005 
<a name="l02006"></a>02006     <a class="code" href="classDRAMCtrl.html#a650e985dfc9a45d11f6f77da2ef46315">avgMemAccLat</a>
<a name="l02007"></a>02007         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgMemAccLat&quot;</span>)
<a name="l02008"></a>02008         .desc(<span class="stringliteral">&quot;Average memory access latency per DRAM burst&quot;</span>)
<a name="l02009"></a>02009         .precision(2);
<a name="l02010"></a>02010 
<a name="l02011"></a>02011     <a class="code" href="classDRAMCtrl.html#a650e985dfc9a45d11f6f77da2ef46315">avgMemAccLat</a> = <a class="code" href="classDRAMCtrl.html#adccc242d738f69f8a4f8572861195a5a">totMemAccLat</a> / (<a class="code" href="classDRAMCtrl.html#a9f29a99e44a63f7c54f396d42ec29c4a">readBursts</a> - <a class="code" href="classDRAMCtrl.html#aef20a1d281cf709372d7764085099517">servicedByWrQ</a>);
<a name="l02012"></a>02012 
<a name="l02013"></a>02013     <a class="code" href="classDRAMCtrl.html#af9226ff3e9ace9736d27fd10fd577f03">numRdRetry</a>
<a name="l02014"></a>02014         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.numRdRetry&quot;</span>)
<a name="l02015"></a>02015         .desc(<span class="stringliteral">&quot;Number of times read queue was full causing retry&quot;</span>);
<a name="l02016"></a>02016 
<a name="l02017"></a>02017     <a class="code" href="classDRAMCtrl.html#ad0b5620e2ea84dd1719ce9ca1d9615a1">numWrRetry</a>
<a name="l02018"></a>02018         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.numWrRetry&quot;</span>)
<a name="l02019"></a>02019         .desc(<span class="stringliteral">&quot;Number of times write queue was full causing retry&quot;</span>);
<a name="l02020"></a>02020 
<a name="l02021"></a>02021     <a class="code" href="classDRAMCtrl.html#aa38e66ebc077727f6538d2827bf5f8e0">readRowHits</a>
<a name="l02022"></a>02022         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.readRowHits&quot;</span>)
<a name="l02023"></a>02023         .desc(<span class="stringliteral">&quot;Number of row buffer hits during reads&quot;</span>);
<a name="l02024"></a>02024 
<a name="l02025"></a>02025     <a class="code" href="classDRAMCtrl.html#a2305f05a56ecdd2839ec5c5c4549701d">writeRowHits</a>
<a name="l02026"></a>02026         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.writeRowHits&quot;</span>)
<a name="l02027"></a>02027         .desc(<span class="stringliteral">&quot;Number of row buffer hits during writes&quot;</span>);
<a name="l02028"></a>02028 
<a name="l02029"></a>02029     <a class="code" href="classDRAMCtrl.html#aa61bbbb8931c75eeb15945c0d065305e">readRowHitRate</a>
<a name="l02030"></a>02030         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.readRowHitRate&quot;</span>)
<a name="l02031"></a>02031         .desc(<span class="stringliteral">&quot;Row buffer hit rate for reads&quot;</span>)
<a name="l02032"></a>02032         .precision(2);
<a name="l02033"></a>02033 
<a name="l02034"></a>02034     <a class="code" href="classDRAMCtrl.html#aa61bbbb8931c75eeb15945c0d065305e">readRowHitRate</a> = (<a class="code" href="classDRAMCtrl.html#aa38e66ebc077727f6538d2827bf5f8e0">readRowHits</a> / (<a class="code" href="classDRAMCtrl.html#a9f29a99e44a63f7c54f396d42ec29c4a">readBursts</a> - <a class="code" href="classDRAMCtrl.html#aef20a1d281cf709372d7764085099517">servicedByWrQ</a>)) * 100;
<a name="l02035"></a>02035 
<a name="l02036"></a>02036     <a class="code" href="classDRAMCtrl.html#adbae4dc75ee9cd8ff040eb39819387b1">writeRowHitRate</a>
<a name="l02037"></a>02037         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.writeRowHitRate&quot;</span>)
<a name="l02038"></a>02038         .desc(<span class="stringliteral">&quot;Row buffer hit rate for writes&quot;</span>)
<a name="l02039"></a>02039         .precision(2);
<a name="l02040"></a>02040 
<a name="l02041"></a>02041     <a class="code" href="classDRAMCtrl.html#adbae4dc75ee9cd8ff040eb39819387b1">writeRowHitRate</a> = (<a class="code" href="classDRAMCtrl.html#a2305f05a56ecdd2839ec5c5c4549701d">writeRowHits</a> / (<a class="code" href="classDRAMCtrl.html#a62d593c9cf45e7c36be919ce2b8a7673">writeBursts</a> - <a class="code" href="classDRAMCtrl.html#ae193808abcaef94127dd307cd0fda9a4">mergedWrBursts</a>)) * 100;
<a name="l02042"></a>02042 
<a name="l02043"></a>02043     <a class="code" href="classDRAMCtrl.html#a3a77806d4ec83769799fd9cbc3024027">readPktSize</a>
<a name="l02044"></a>02044         .<a class="code" href="classStats_1_1VectorBase.html#ada7b4d1605ccdfba6975aa1025b861a2" title="Set this vector to have the given size.">init</a>(<a class="code" href="intmath_8hh.html#a85317359c479b5019fc3608810682fb0">ceilLog2</a>(<a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>) + 1)
<a name="l02045"></a>02045         .name(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.readPktSize&quot;</span>)
<a name="l02046"></a>02046         .desc(<span class="stringliteral">&quot;Read request sizes (log2)&quot;</span>);
<a name="l02047"></a>02047 
<a name="l02048"></a>02048      <a class="code" href="classDRAMCtrl.html#a3df581e1ab71e7895d3894e700beac79">writePktSize</a>
<a name="l02049"></a>02049         .<a class="code" href="classStats_1_1VectorBase.html#ada7b4d1605ccdfba6975aa1025b861a2" title="Set this vector to have the given size.">init</a>(<a class="code" href="intmath_8hh.html#a85317359c479b5019fc3608810682fb0">ceilLog2</a>(<a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a>) + 1)
<a name="l02050"></a>02050         .name(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.writePktSize&quot;</span>)
<a name="l02051"></a>02051         .desc(<span class="stringliteral">&quot;Write request sizes (log2)&quot;</span>);
<a name="l02052"></a>02052 
<a name="l02053"></a>02053      <a class="code" href="classDRAMCtrl.html#a69579ae38ad58ab0a4f2a045026c078f">rdQLenPdf</a>
<a name="l02054"></a>02054         .<a class="code" href="classStats_1_1VectorBase.html#ada7b4d1605ccdfba6975aa1025b861a2" title="Set this vector to have the given size.">init</a>(<a class="code" href="classDRAMCtrl.html#ab4f3dbe59b69329fe8d70a8951771f74">readBufferSize</a>)
<a name="l02055"></a>02055         .name(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.rdQLenPdf&quot;</span>)
<a name="l02056"></a>02056         .desc(<span class="stringliteral">&quot;What read queue length does an incoming req see&quot;</span>);
<a name="l02057"></a>02057 
<a name="l02058"></a>02058      <a class="code" href="classDRAMCtrl.html#aa16e1a3aeaa40ba0dcfa25ea50faec34">wrQLenPdf</a>
<a name="l02059"></a>02059         .<a class="code" href="classStats_1_1VectorBase.html#ada7b4d1605ccdfba6975aa1025b861a2" title="Set this vector to have the given size.">init</a>(<a class="code" href="classDRAMCtrl.html#aab40112977e0294a7a000ca34beda431">writeBufferSize</a>)
<a name="l02060"></a>02060         .name(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.wrQLenPdf&quot;</span>)
<a name="l02061"></a>02061         .desc(<span class="stringliteral">&quot;What write queue length does an incoming req see&quot;</span>);
<a name="l02062"></a>02062 
<a name="l02063"></a>02063      <a class="code" href="classDRAMCtrl.html#abdc3b8276837ac7c784edf434d3bfd9d">bytesPerActivate</a>
<a name="l02064"></a>02064          .<a class="code" href="classStats_1_1Histogram.html#a838a65c82a6d558a2f8cdcb927c1662a" title="Set the parameters of this histogram.">init</a>(<a class="code" href="classDRAMCtrl.html#a9b7d1e35f9bf63be72006cb67691d3ef" title="Max column accesses (read and write) per row, before forefully closing it.">maxAccessesPerRow</a>)
<a name="l02065"></a>02065          .name(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.bytesPerActivate&quot;</span>)
<a name="l02066"></a>02066          .desc(<span class="stringliteral">&quot;Bytes accessed per row activation&quot;</span>)
<a name="l02067"></a>02067          .flags(<a class="code" href="namespaceStats.html#a00451440f3857f3f127f9493cfe6eede" title="Don&amp;#39;t print if this is zero.">nozero</a>);
<a name="l02068"></a>02068 
<a name="l02069"></a>02069      <a class="code" href="classDRAMCtrl.html#a8d8343a696fce288cc32066bc67747d3">rdPerTurnAround</a>
<a name="l02070"></a>02070          .<a class="code" href="classStats_1_1Histogram.html#a838a65c82a6d558a2f8cdcb927c1662a" title="Set the parameters of this histogram.">init</a>(<a class="code" href="classDRAMCtrl.html#ab4f3dbe59b69329fe8d70a8951771f74">readBufferSize</a>)
<a name="l02071"></a>02071          .name(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.rdPerTurnAround&quot;</span>)
<a name="l02072"></a>02072          .desc(<span class="stringliteral">&quot;Reads before turning the bus around for writes&quot;</span>)
<a name="l02073"></a>02073          .flags(<a class="code" href="namespaceStats.html#a00451440f3857f3f127f9493cfe6eede" title="Don&amp;#39;t print if this is zero.">nozero</a>);
<a name="l02074"></a>02074 
<a name="l02075"></a>02075      <a class="code" href="classDRAMCtrl.html#a892341d6024351995e693ad6638389ac">wrPerTurnAround</a>
<a name="l02076"></a>02076          .<a class="code" href="classStats_1_1Histogram.html#a838a65c82a6d558a2f8cdcb927c1662a" title="Set the parameters of this histogram.">init</a>(<a class="code" href="classDRAMCtrl.html#aab40112977e0294a7a000ca34beda431">writeBufferSize</a>)
<a name="l02077"></a>02077          .name(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.wrPerTurnAround&quot;</span>)
<a name="l02078"></a>02078          .desc(<span class="stringliteral">&quot;Writes before turning the bus around for reads&quot;</span>)
<a name="l02079"></a>02079          .flags(<a class="code" href="namespaceStats.html#a00451440f3857f3f127f9493cfe6eede" title="Don&amp;#39;t print if this is zero.">nozero</a>);
<a name="l02080"></a>02080 
<a name="l02081"></a>02081     <a class="code" href="classDRAMCtrl.html#aa497ed2e8bdabb8a4b24546dc7d84ba8">bytesReadDRAM</a>
<a name="l02082"></a>02082         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.bytesReadDRAM&quot;</span>)
<a name="l02083"></a>02083         .desc(<span class="stringliteral">&quot;Total number of bytes read from DRAM&quot;</span>);
<a name="l02084"></a>02084 
<a name="l02085"></a>02085     <a class="code" href="classDRAMCtrl.html#a5dde296a293f780e9aba9c7e55bc2f02">bytesReadWrQ</a>
<a name="l02086"></a>02086         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.bytesReadWrQ&quot;</span>)
<a name="l02087"></a>02087         .desc(<span class="stringliteral">&quot;Total number of bytes read from write queue&quot;</span>);
<a name="l02088"></a>02088 
<a name="l02089"></a>02089     <a class="code" href="classDRAMCtrl.html#a1770ca8069c1b96091dbdc0847812ab8" title="Number of bytes written to this memory.">bytesWritten</a>
<a name="l02090"></a>02090         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.bytesWritten&quot;</span>)
<a name="l02091"></a>02091         .desc(<span class="stringliteral">&quot;Total number of bytes written to DRAM&quot;</span>);
<a name="l02092"></a>02092 
<a name="l02093"></a>02093     <a class="code" href="classDRAMCtrl.html#afdc8b398ddc7ab7cfd8fb73e0feb95a0">bytesReadSys</a>
<a name="l02094"></a>02094         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.bytesReadSys&quot;</span>)
<a name="l02095"></a>02095         .desc(<span class="stringliteral">&quot;Total read bytes from the system interface side&quot;</span>);
<a name="l02096"></a>02096 
<a name="l02097"></a>02097     <a class="code" href="classDRAMCtrl.html#a5bc36b3ae809b51a496f8d879c3b41e6">bytesWrittenSys</a>
<a name="l02098"></a>02098         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.bytesWrittenSys&quot;</span>)
<a name="l02099"></a>02099         .desc(<span class="stringliteral">&quot;Total written bytes from the system interface side&quot;</span>);
<a name="l02100"></a>02100 
<a name="l02101"></a>02101     <a class="code" href="classDRAMCtrl.html#ab1ef098e90fdeca755dd198cfcca24ec">avgRdBW</a>
<a name="l02102"></a>02102         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgRdBW&quot;</span>)
<a name="l02103"></a>02103         .desc(<span class="stringliteral">&quot;Average DRAM read bandwidth in MiByte/s&quot;</span>)
<a name="l02104"></a>02104         .precision(2);
<a name="l02105"></a>02105 
<a name="l02106"></a>02106     <a class="code" href="classDRAMCtrl.html#ab1ef098e90fdeca755dd198cfcca24ec">avgRdBW</a> = (<a class="code" href="classDRAMCtrl.html#aa497ed2e8bdabb8a4b24546dc7d84ba8">bytesReadDRAM</a> / 1000000) / <a class="code" href="stat__control_8cc.html#aaad77dbb4162ef5a66c24dcd1ce256d0">simSeconds</a>;
<a name="l02107"></a>02107 
<a name="l02108"></a>02108     <a class="code" href="classDRAMCtrl.html#a7f7cd6d22e13ab1dded95f9f939eae66">avgWrBW</a>
<a name="l02109"></a>02109         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgWrBW&quot;</span>)
<a name="l02110"></a>02110         .desc(<span class="stringliteral">&quot;Average achieved write bandwidth in MiByte/s&quot;</span>)
<a name="l02111"></a>02111         .precision(2);
<a name="l02112"></a>02112 
<a name="l02113"></a>02113     <a class="code" href="classDRAMCtrl.html#a7f7cd6d22e13ab1dded95f9f939eae66">avgWrBW</a> = (<a class="code" href="classDRAMCtrl.html#a1770ca8069c1b96091dbdc0847812ab8" title="Number of bytes written to this memory.">bytesWritten</a> / 1000000) / <a class="code" href="stat__control_8cc.html#aaad77dbb4162ef5a66c24dcd1ce256d0">simSeconds</a>;
<a name="l02114"></a>02114 
<a name="l02115"></a>02115     <a class="code" href="classDRAMCtrl.html#a09b547e3843c17550c790fa12fea9901">avgRdBWSys</a>
<a name="l02116"></a>02116         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgRdBWSys&quot;</span>)
<a name="l02117"></a>02117         .desc(<span class="stringliteral">&quot;Average system read bandwidth in MiByte/s&quot;</span>)
<a name="l02118"></a>02118         .precision(2);
<a name="l02119"></a>02119 
<a name="l02120"></a>02120     <a class="code" href="classDRAMCtrl.html#a09b547e3843c17550c790fa12fea9901">avgRdBWSys</a> = (<a class="code" href="classDRAMCtrl.html#afdc8b398ddc7ab7cfd8fb73e0feb95a0">bytesReadSys</a> / 1000000) / <a class="code" href="stat__control_8cc.html#aaad77dbb4162ef5a66c24dcd1ce256d0">simSeconds</a>;
<a name="l02121"></a>02121 
<a name="l02122"></a>02122     <a class="code" href="classDRAMCtrl.html#a6d91bc5d683e30ae765b79b5a3a08f3d">avgWrBWSys</a>
<a name="l02123"></a>02123         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgWrBWSys&quot;</span>)
<a name="l02124"></a>02124         .desc(<span class="stringliteral">&quot;Average system write bandwidth in MiByte/s&quot;</span>)
<a name="l02125"></a>02125         .precision(2);
<a name="l02126"></a>02126 
<a name="l02127"></a>02127     <a class="code" href="classDRAMCtrl.html#a6d91bc5d683e30ae765b79b5a3a08f3d">avgWrBWSys</a> = (<a class="code" href="classDRAMCtrl.html#a5bc36b3ae809b51a496f8d879c3b41e6">bytesWrittenSys</a> / 1000000) / <a class="code" href="stat__control_8cc.html#aaad77dbb4162ef5a66c24dcd1ce256d0">simSeconds</a>;
<a name="l02128"></a>02128 
<a name="l02129"></a>02129     <a class="code" href="classDRAMCtrl.html#aeb884b23095ddc79aee2afc5fe2b144a">peakBW</a>
<a name="l02130"></a>02130         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.peakBW&quot;</span>)
<a name="l02131"></a>02131         .desc(<span class="stringliteral">&quot;Theoretical peak bandwidth in MiByte/s&quot;</span>)
<a name="l02132"></a>02132         .precision(2);
<a name="l02133"></a>02133 
<a name="l02134"></a>02134     <a class="code" href="classDRAMCtrl.html#aeb884b23095ddc79aee2afc5fe2b144a">peakBW</a> = (<a class="code" href="namespaceSimClock.html#a3e914c4cb1e00a7287962713e374d17a" title="The simulated frequency of curTick(). (In ticks per second).">SimClock::Frequency</a> / <a class="code" href="classDRAMCtrl.html#aab4d9d3128f0373a72c28be6a4d02923">tBURST</a>) * <a class="code" href="classDRAMCtrl.html#aea223ae7e8fb2b419dbac03552af660d">burstSize</a> / 1000000;
<a name="l02135"></a>02135 
<a name="l02136"></a>02136     <a class="code" href="classDRAMCtrl.html#a3f753165126c1c7c03e5447ab14e00b7">busUtil</a>
<a name="l02137"></a>02137         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.busUtil&quot;</span>)
<a name="l02138"></a>02138         .desc(<span class="stringliteral">&quot;Data bus utilization in percentage&quot;</span>)
<a name="l02139"></a>02139         .precision(2);
<a name="l02140"></a>02140     <a class="code" href="classDRAMCtrl.html#a3f753165126c1c7c03e5447ab14e00b7">busUtil</a> = (<a class="code" href="classDRAMCtrl.html#ab1ef098e90fdeca755dd198cfcca24ec">avgRdBW</a> + <a class="code" href="classDRAMCtrl.html#a7f7cd6d22e13ab1dded95f9f939eae66">avgWrBW</a>) / <a class="code" href="classDRAMCtrl.html#aeb884b23095ddc79aee2afc5fe2b144a">peakBW</a> * 100;
<a name="l02141"></a>02141 
<a name="l02142"></a>02142     <a class="code" href="classDRAMCtrl.html#ab26b0b6d86b24b989cb825d35423d832">totGap</a>
<a name="l02143"></a>02143         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.totGap&quot;</span>)
<a name="l02144"></a>02144         .desc(<span class="stringliteral">&quot;Total gap between requests&quot;</span>);
<a name="l02145"></a>02145 
<a name="l02146"></a>02146     <a class="code" href="classDRAMCtrl.html#ab613d4f5c78ce9f3335099d8405012b2">avgGap</a>
<a name="l02147"></a>02147         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.avgGap&quot;</span>)
<a name="l02148"></a>02148         .desc(<span class="stringliteral">&quot;Average gap between requests&quot;</span>)
<a name="l02149"></a>02149         .precision(2);
<a name="l02150"></a>02150 
<a name="l02151"></a>02151     <a class="code" href="classDRAMCtrl.html#ab613d4f5c78ce9f3335099d8405012b2">avgGap</a> = <a class="code" href="classDRAMCtrl.html#ab26b0b6d86b24b989cb825d35423d832">totGap</a> / (<a class="code" href="classDRAMCtrl.html#ab7f21b330feeb44e38df54e2ba459272">readReqs</a> + <a class="code" href="classDRAMCtrl.html#a7ec9d1bff02a1ee089a6b2e52a25ddf7">writeReqs</a>);
<a name="l02152"></a>02152 
<a name="l02153"></a>02153     <span class="comment">// Stats for DRAM Power calculation based on Micron datasheet</span>
<a name="l02154"></a>02154     <a class="code" href="classDRAMCtrl.html#a7ae0be304cca28887e7f16dc057f3e17">busUtilRead</a>
<a name="l02155"></a>02155         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.busUtilRead&quot;</span>)
<a name="l02156"></a>02156         .desc(<span class="stringliteral">&quot;Data bus utilization in percentage for reads&quot;</span>)
<a name="l02157"></a>02157         .precision(2);
<a name="l02158"></a>02158 
<a name="l02159"></a>02159     <a class="code" href="classDRAMCtrl.html#a7ae0be304cca28887e7f16dc057f3e17">busUtilRead</a> = <a class="code" href="classDRAMCtrl.html#ab1ef098e90fdeca755dd198cfcca24ec">avgRdBW</a> / <a class="code" href="classDRAMCtrl.html#aeb884b23095ddc79aee2afc5fe2b144a">peakBW</a> * 100;
<a name="l02160"></a>02160 
<a name="l02161"></a>02161     <a class="code" href="classDRAMCtrl.html#a150f564c22cdf5601fe268013699c9f5">busUtilWrite</a>
<a name="l02162"></a>02162         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.busUtilWrite&quot;</span>)
<a name="l02163"></a>02163         .desc(<span class="stringliteral">&quot;Data bus utilization in percentage for writes&quot;</span>)
<a name="l02164"></a>02164         .precision(2);
<a name="l02165"></a>02165 
<a name="l02166"></a>02166     <a class="code" href="classDRAMCtrl.html#a150f564c22cdf5601fe268013699c9f5">busUtilWrite</a> = <a class="code" href="classDRAMCtrl.html#a7f7cd6d22e13ab1dded95f9f939eae66">avgWrBW</a> / <a class="code" href="classDRAMCtrl.html#aeb884b23095ddc79aee2afc5fe2b144a">peakBW</a> * 100;
<a name="l02167"></a>02167 
<a name="l02168"></a>02168     <a class="code" href="classDRAMCtrl.html#ad2f76a22dc53e1acf57d18ac7f900ec8">pageHitRate</a>
<a name="l02169"></a>02169         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.pageHitRate&quot;</span>)
<a name="l02170"></a>02170         .desc(<span class="stringliteral">&quot;Row buffer hit rate, read and write combined&quot;</span>)
<a name="l02171"></a>02171         .precision(2);
<a name="l02172"></a>02172 
<a name="l02173"></a>02173     <a class="code" href="classDRAMCtrl.html#ad2f76a22dc53e1acf57d18ac7f900ec8">pageHitRate</a> = (<a class="code" href="classDRAMCtrl.html#a2305f05a56ecdd2839ec5c5c4549701d">writeRowHits</a> + <a class="code" href="classDRAMCtrl.html#aa38e66ebc077727f6538d2827bf5f8e0">readRowHits</a>) /
<a name="l02174"></a>02174         (<a class="code" href="classDRAMCtrl.html#a62d593c9cf45e7c36be919ce2b8a7673">writeBursts</a> - <a class="code" href="classDRAMCtrl.html#ae193808abcaef94127dd307cd0fda9a4">mergedWrBursts</a> + <a class="code" href="classDRAMCtrl.html#a9f29a99e44a63f7c54f396d42ec29c4a">readBursts</a> - <a class="code" href="classDRAMCtrl.html#aef20a1d281cf709372d7764085099517">servicedByWrQ</a>) * 100;
<a name="l02175"></a>02175 }
<a name="l02176"></a>02176 
<a name="l02177"></a>02177 <span class="keywordtype">void</span>
<a name="l02178"></a><a class="code" href="classDRAMCtrl.html#a34fd9e9861ef8b240d80ea18f7bc2707">02178</a> <a class="code" href="classDRAMCtrl.html#a34fd9e9861ef8b240d80ea18f7bc2707">DRAMCtrl::recvFunctional</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt)
<a name="l02179"></a>02179 {
<a name="l02180"></a>02180     <span class="comment">// rely on the abstract memory</span>
<a name="l02181"></a>02181     <a class="code" href="classAbstractMemory.html#acb2ca48dbe8f541907b3827feeb292d5" title="Perform an untimed memory read or write without changing anything but the memory...">functionalAccess</a>(pkt);
<a name="l02182"></a>02182 }
<a name="l02183"></a>02183 
<a name="l02184"></a>02184 <a class="code" href="classBaseSlavePort.html" title="A BaseSlavePort is a protocol-agnostic slave port, responsible only for the structural...">BaseSlavePort</a>&amp;
<a name="l02185"></a>02185 <a class="code" href="classDRAMCtrl.html#a7b5a2aeeb5ca1d61585c08ab11779078" title="Get a slave port with a given name and index.">DRAMCtrl::getSlavePort</a>(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;if_name, <a class="code" href="base_2types_8hh.html#acef4d7d41cb21fdc252e20c04cd7bb8e" title="Port index/ID type, and a symbolic name for an invalid port id.">PortID</a> idx)
<a name="l02186"></a>02186 {
<a name="l02187"></a>02187     <span class="keywordflow">if</span> (if_name != <span class="stringliteral">&quot;port&quot;</span>) {
<a name="l02188"></a>02188         <span class="keywordflow">return</span> <a class="code" href="classDRAMCtrl.html#a7b5a2aeeb5ca1d61585c08ab11779078" title="Get a slave port with a given name and index.">MemObject::getSlavePort</a>(if_name, idx);
<a name="l02189"></a>02189     } <span class="keywordflow">else</span> {
<a name="l02190"></a>02190         <span class="keywordflow">return</span> <a class="code" href="classDRAMCtrl.html#a87ee1aa46b80d77aea809cf3d00dbc31" title="Our incoming port, for a multi-ported controller add a crossbar in front of it.">port</a>;
<a name="l02191"></a>02191     }
<a name="l02192"></a>02192 }
<a name="l02193"></a>02193 
<a name="l02194"></a>02194 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l02195"></a><a class="code" href="classDRAMCtrl.html#aa0beabe573e2af900736ec24bbc33bf4">02195</a> <a class="code" href="classDRAMCtrl.html#aa0beabe573e2af900736ec24bbc33bf4" title="Provide a default implementation of the drain interface that simply returns 0 (draining...">DRAMCtrl::drain</a>(<a class="code" href="classDrainManager.html" title="This class coordinates draining of a System.">DrainManager</a> *<a class="code" href="namespaceMipsISA.html#afed89bf85db8c823833a4921f0b24ac8">dm</a>)
<a name="l02196"></a>02196 {
<a name="l02197"></a>02197     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = <a class="code" href="classDRAMCtrl.html#a87ee1aa46b80d77aea809cf3d00dbc31" title="Our incoming port, for a multi-ported controller add a crossbar in front of it.">port</a>.<a class="code" href="classQueuedSlavePort.html#a86b3526181124e25a7f42c1c2027d1ec">drain</a>(dm);
<a name="l02198"></a>02198 
<a name="l02199"></a>02199     <span class="comment">// if there is anything in any of our internal queues, keep track</span>
<a name="l02200"></a>02200     <span class="comment">// of that as well</span>
<a name="l02201"></a>02201     <span class="keywordflow">if</span> (!(<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.empty() &amp;&amp; <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.empty() &amp;&amp;
<a name="l02202"></a>02202           <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.empty())) {
<a name="l02203"></a>02203         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(Drain, <span class="stringliteral">&quot;DRAM controller not drained, write: %d, read: %d,&quot;</span>
<a name="l02204"></a>02204                 <span class="stringliteral">&quot; resp: %d\n&quot;</span>, <a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.size(), <a class="code" href="classDRAMCtrl.html#a1ac46f1cd13d3969e50d235afa51227a" title="The controller&amp;#39;s main read and write queues.">readQueue</a>.size(),
<a name="l02205"></a>02205                 <a class="code" href="classDRAMCtrl.html#a13805258612037f8e9fb94a370948342" title="Response queue where read packets wait after we&amp;#39;re done working with them, but...">respQueue</a>.size());
<a name="l02206"></a>02206         ++count;
<a name="l02207"></a>02207         <a class="code" href="classDRAMCtrl.html#abb7acccc1136f56df2290bb7373053ac" title="If we need to drain, keep the drain manager around until we&amp;#39;re done here.">drainManager</a> = dm;
<a name="l02208"></a>02208 
<a name="l02209"></a>02209         <span class="comment">// the only part that is not drained automatically over time</span>
<a name="l02210"></a>02210         <span class="comment">// is the write queue, thus kick things into action if needed</span>
<a name="l02211"></a>02211         <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl.html#aa1e1b4ddf9fdb5152b8c0f2eb4bec56f">writeQueue</a>.empty() &amp;&amp; !<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>()) {
<a name="l02212"></a>02212             <a class="code" href="classEventManager.html#a749a10828b2dd5017a2582960d04e400">schedule</a>(<a class="code" href="classDRAMCtrl.html#a5fa82583b2b6829d9a445ba16d7f54d4">nextReqEvent</a>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l02213"></a>02213         }
<a name="l02214"></a>02214     }
<a name="l02215"></a>02215 
<a name="l02216"></a>02216     <span class="keywordflow">if</span> (count)
<a name="l02217"></a>02217         <a class="code" href="classDrainable.html#afce7a34e1fcacc71267a947a3feb941b">setDrainState</a>(<a class="code" href="classDrainable.html#a6173416423af6af1bfe17262be40b5ffabd11bb9d2e9941029e08925c2a151162" title="Running normally.">Drainable::Draining</a>);
<a name="l02218"></a>02218     <span class="keywordflow">else</span>
<a name="l02219"></a>02219         <a class="code" href="classDrainable.html#afce7a34e1fcacc71267a947a3feb941b">setDrainState</a>(<a class="code" href="classDrainable.html#a6173416423af6af1bfe17262be40b5ffad08d746efca2f68aeb28f73f94237603" title="Draining buffers pending serialization/handover.">Drainable::Drained</a>);
<a name="l02220"></a>02220     <span class="keywordflow">return</span> count;
<a name="l02221"></a>02221 }
<a name="l02222"></a>02222 
<a name="l02223"></a>02223 <span class="keywordtype">void</span>
<a name="l02224"></a><a class="code" href="classDRAMCtrl.html#a23076dc0bfa8851eca587d148fcefe06">02224</a> <a class="code" href="classDRAMCtrl.html#a23076dc0bfa8851eca587d148fcefe06" title="Resume execution after a successful drain.">DRAMCtrl::drainResume</a>()
<a name="l02225"></a>02225 {
<a name="l02226"></a>02226     <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl.html#a8a67548a130229c2a7be4383f9082c85" title="Remeber if the memory system is in timing mode.">isTimingMode</a> &amp;&amp; <a class="code" href="classAbstractMemory.html#a3982da9ac617ec2f310f4d4740615804" title="read the system pointer Implemented for completeness with the setter">system</a>()-&gt;<a class="code" href="classDRAMCtrl.html#a8a67548a130229c2a7be4383f9082c85" title="Remeber if the memory system is in timing mode.">isTimingMode</a>()) {
<a name="l02227"></a>02227         <span class="comment">// if we switched to timing mode, kick things into action,</span>
<a name="l02228"></a>02228         <span class="comment">// and behave as if we restored from a checkpoint</span>
<a name="l02229"></a>02229         <a class="code" href="classDRAMCtrl.html#ab9e388cee37d7256a9d60dd0ff527a66" title="startup() is the final initialization call before simulation.">startup</a>();
<a name="l02230"></a>02230     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classDRAMCtrl.html#a8a67548a130229c2a7be4383f9082c85" title="Remeber if the memory system is in timing mode.">isTimingMode</a> &amp;&amp; !<a class="code" href="classAbstractMemory.html#a3982da9ac617ec2f310f4d4740615804" title="read the system pointer Implemented for completeness with the setter">system</a>()-&gt;<a class="code" href="classDRAMCtrl.html#a8a67548a130229c2a7be4383f9082c85" title="Remeber if the memory system is in timing mode.">isTimingMode</a>()) {
<a name="l02231"></a>02231         <span class="comment">// if we switch from timing mode, stop the refresh events to</span>
<a name="l02232"></a>02232         <span class="comment">// not cause issues with KVM</span>
<a name="l02233"></a>02233         <span class="keywordflow">for</span> (<span class="keyword">auto</span> <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> : <a class="code" href="classDRAMCtrl.html#af8ffca69b1f93102e8b157f21628c64d" title="Vector of ranks.">ranks</a>) {
<a name="l02234"></a>02234             <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a>-&gt;suspend();
<a name="l02235"></a>02235         }
<a name="l02236"></a>02236     }
<a name="l02237"></a>02237 
<a name="l02238"></a>02238     <span class="comment">// update the mode</span>
<a name="l02239"></a>02239     <a class="code" href="classDRAMCtrl.html#a8a67548a130229c2a7be4383f9082c85" title="Remeber if the memory system is in timing mode.">isTimingMode</a> = <a class="code" href="classAbstractMemory.html#a3982da9ac617ec2f310f4d4740615804" title="read the system pointer Implemented for completeness with the setter">system</a>()-&gt;<a class="code" href="classSystem.html#a38e4aae7c6118a9a03c2a2b1b83d56fd" title="Is the system in timing mode?">isTimingMode</a>();
<a name="l02240"></a>02240 }
<a name="l02241"></a>02241 
<a name="l02242"></a><a class="code" href="classDRAMCtrl_1_1MemoryPort.html#a6cdb03e84cdf7e940731300204fb02b1">02242</a> <a class="code" href="classDRAMCtrl_1_1MemoryPort.html#a6cdb03e84cdf7e940731300204fb02b1">DRAMCtrl::MemoryPort::MemoryPort</a>(<span class="keyword">const</span> std::string&amp; <a class="code" href="trace_8cc.html#a166fa10b86d8faa127fb7c78191e3e60">name</a>, <a class="code" href="classDRAMCtrl.html" title="The DRAM controller is a single-channel memory controller capturing the most important...">DRAMCtrl</a>&amp; _memory)
<a name="l02243"></a>02243     : <a class="code" href="classQueuedSlavePort.html" title="A queued port is a port that has an infinite queue for outgoing packets and thus...">QueuedSlavePort</a>(name, &amp;_memory, queue), queue(_memory, *this),
<a name="l02244"></a>02244       memory(_memory)
<a name="l02245"></a>02245 { }
<a name="l02246"></a>02246 
<a name="l02247"></a>02247 <a class="code" href="classstd_1_1list.html">AddrRangeList</a>
<a name="l02248"></a><a class="code" href="classDRAMCtrl_1_1MemoryPort.html#adbcb0d9d6e966c57645de4cdb96228e2">02248</a> <a class="code" href="classDRAMCtrl_1_1MemoryPort.html#adbcb0d9d6e966c57645de4cdb96228e2" title="Get a list of the non-overlapping address ranges the owner is responsible for.">DRAMCtrl::MemoryPort::getAddrRanges</a>()<span class="keyword"> const</span>
<a name="l02249"></a>02249 <span class="keyword"></span>{
<a name="l02250"></a>02250     <a class="code" href="classstd_1_1list.html">AddrRangeList</a> ranges;
<a name="l02251"></a>02251     ranges.push_back(<a class="code" href="classDRAMCtrl_1_1MemoryPort.html#a5de2b2717a5e63c10158fc605a4aa7fd">memory</a>.<a class="code" href="classAbstractMemory.html#a8cc7718cf94a14b1bad6ae24d7859cd8" title="Get the address range.">getAddrRange</a>());
<a name="l02252"></a>02252     <span class="keywordflow">return</span> ranges;
<a name="l02253"></a>02253 }
<a name="l02254"></a>02254 
<a name="l02255"></a>02255 <span class="keywordtype">void</span>
<a name="l02256"></a><a class="code" href="classDRAMCtrl_1_1MemoryPort.html#abdcd64989c345d9ac773cedb52965565">02256</a> <a class="code" href="classDRAMCtrl.html#a34fd9e9861ef8b240d80ea18f7bc2707">DRAMCtrl::MemoryPort::recvFunctional</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt)
<a name="l02257"></a>02257 {
<a name="l02258"></a>02258     pkt-&gt;<a class="code" href="classPacket.html#abf1a177ee6ddce59da49869cfeecc7bc" title="Push label for PrintReq (safe to call unconditionally).">pushLabel</a>(<a class="code" href="classDRAMCtrl_1_1MemoryPort.html#a5de2b2717a5e63c10158fc605a4aa7fd">memory</a>.<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l02259"></a>02259 
<a name="l02260"></a>02260     <span class="keywordflow">if</span> (!<a class="code" href="classDRAMCtrl_1_1MemoryPort.html#a695943604b988bd8923569ce22a2adad">queue</a>.<a class="code" href="classPacketQueue.html#a231440b37742d6f80eef490016020c5d" title="Check the list of buffered packets against the supplied functional request.">checkFunctional</a>(pkt)) {
<a name="l02261"></a>02261         <span class="comment">// Default implementation of SimpleTimingPort::recvFunctional()</span>
<a name="l02262"></a>02262         <span class="comment">// calls recvAtomic() and throws away the latency; we can save a</span>
<a name="l02263"></a>02263         <span class="comment">// little here by just not calculating the latency.</span>
<a name="l02264"></a>02264         <a class="code" href="classDRAMCtrl_1_1MemoryPort.html#a5de2b2717a5e63c10158fc605a4aa7fd">memory</a>.<a class="code" href="classDRAMCtrl.html#a34fd9e9861ef8b240d80ea18f7bc2707">recvFunctional</a>(pkt);
<a name="l02265"></a>02265     }
<a name="l02266"></a>02266 
<a name="l02267"></a>02267     pkt-&gt;<a class="code" href="classPacket.html#ad28d4bd566aee12a370dc9180e064bea" title="Pop label for PrintReq (safe to call unconditionally).">popLabel</a>();
<a name="l02268"></a>02268 }
<a name="l02269"></a>02269 
<a name="l02270"></a>02270 <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a>
<a name="l02271"></a><a class="code" href="classDRAMCtrl_1_1MemoryPort.html#a7a20196c9f7f031ceef14ccf38c03b33">02271</a> <a class="code" href="classDRAMCtrl.html#a3ddb47f5fb5188a2f7c63ae3b6fb6adb">DRAMCtrl::MemoryPort::recvAtomic</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt)
<a name="l02272"></a>02272 {
<a name="l02273"></a>02273     <span class="keywordflow">return</span> <a class="code" href="classDRAMCtrl_1_1MemoryPort.html#a5de2b2717a5e63c10158fc605a4aa7fd">memory</a>.<a class="code" href="classDRAMCtrl.html#a3ddb47f5fb5188a2f7c63ae3b6fb6adb">recvAtomic</a>(pkt);
<a name="l02274"></a>02274 }
<a name="l02275"></a>02275 
<a name="l02276"></a>02276 <span class="keywordtype">bool</span>
<a name="l02277"></a><a class="code" href="classDRAMCtrl_1_1MemoryPort.html#a543418bc71badde8a2d0140b3418a9f1">02277</a> <a class="code" href="classDRAMCtrl.html#a54cc6c75a9f00865e829d327e68bd528">DRAMCtrl::MemoryPort::recvTimingReq</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt)
<a name="l02278"></a>02278 {
<a name="l02279"></a>02279     <span class="comment">// pass it to the memory controller</span>
<a name="l02280"></a>02280     <span class="keywordflow">return</span> <a class="code" href="classDRAMCtrl_1_1MemoryPort.html#a5de2b2717a5e63c10158fc605a4aa7fd">memory</a>.<a class="code" href="classDRAMCtrl.html#a54cc6c75a9f00865e829d327e68bd528">recvTimingReq</a>(pkt);
<a name="l02281"></a>02281 }
<a name="l02282"></a>02282 
<a name="l02283"></a>02283 <a class="code" href="classDRAMCtrl.html" title="The DRAM controller is a single-channel memory controller capturing the most important...">DRAMCtrl</a>*
<a name="l02284"></a>02284 <a class="code" href="classSerializable.html#a68726f5d7b8d0ed986338a2d09cdf720">DRAMCtrlParams::create</a>()
<a name="l02285"></a>02285 {
<a name="l02286"></a>02286     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classDRAMCtrl.html#a2e87a3a11f35da670f669bc771a11679">DRAMCtrl</a>(<span class="keyword">this</span>);
<a name="l02287"></a>02287 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"><address style="align: right;"><small>
Generated on Mon Dec 7 02:33:12 2015 for gem5 by <a href="http://www.doxygen.org/index.html"> doxygen</a> 1.6.1</small></address>

</body>
</html>
