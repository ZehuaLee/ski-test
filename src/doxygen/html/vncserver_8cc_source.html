<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>gem5: base/vnc/vncserver.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>base/vnc/vncserver.cc</h1><a href="vncserver_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2010, 2015 ARM Limited</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * The license below extends only to copyright in the software and shall</span>
<a name="l00006"></a>00006 <span class="comment"> * not be construed as granting a license to any other intellectual</span>
<a name="l00007"></a>00007 <span class="comment"> * property including but not limited to intellectual property relating</span>
<a name="l00008"></a>00008 <span class="comment"> * to a hardware implementation of the functionality of the software</span>
<a name="l00009"></a>00009 <span class="comment"> * licensed hereunder.  You may use the software subject to the license</span>
<a name="l00010"></a>00010 <span class="comment"> * terms below provided that you ensure that this notice is replicated</span>
<a name="l00011"></a>00011 <span class="comment"> * unmodified and in its entirety in all distributions of the software,</span>
<a name="l00012"></a>00012 <span class="comment"> * modified or unmodified, in source code or in binary form.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00015"></a>00015 <span class="comment"> * modification, are permitted provided that the following conditions are</span>
<a name="l00016"></a>00016 <span class="comment"> * met: redistributions of source code must retain the above copyright</span>
<a name="l00017"></a>00017 <span class="comment"> * notice, this list of conditions and the following disclaimer;</span>
<a name="l00018"></a>00018 <span class="comment"> * redistributions in binary form must reproduce the above copyright</span>
<a name="l00019"></a>00019 <span class="comment"> * notice, this list of conditions and the following disclaimer in the</span>
<a name="l00020"></a>00020 <span class="comment"> * documentation and/or other materials provided with the distribution;</span>
<a name="l00021"></a>00021 <span class="comment"> * neither the name of the copyright holders nor the names of its</span>
<a name="l00022"></a>00022 <span class="comment"> * contributors may be used to endorse or promote products derived from</span>
<a name="l00023"></a>00023 <span class="comment"> * this software without specific prior written permission.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00026"></a>00026 <span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00027"></a>00027 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00028"></a>00028 <span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="l00029"></a>00029 <span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00030"></a>00030 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="l00031"></a>00031 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00032"></a>00032 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00033"></a>00033 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00034"></a>00034 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00035"></a>00035 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> * Authors: Ali Saidi</span>
<a name="l00038"></a>00038 <span class="comment"> *          William Wang</span>
<a name="l00039"></a>00039 <span class="comment"> */</span>
<a name="l00040"></a>00040 
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="preprocessor">#if defined(__FreeBSD__)</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#include &lt;termios.h&gt;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#else</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/termios.h&gt;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#endif</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="vncserver_8hh.html" title="Declaration of a VNC server.">base/vnc/vncserver.hh</a>&quot;</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;poll.h&gt;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="preprocessor">#include &lt;cerrno&gt;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &lt;cstdio&gt;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &lt;cstddef&gt;</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="atomicio_8hh.html">base/atomicio.hh</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="bitmap_8hh.html">base/bitmap.hh</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="base_2misc_8hh.html">base/misc.hh</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="output_8hh.html">base/output.hh</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="socket_8hh.html">base/socket.hh</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="base_2trace_8hh.html">base/trace.hh</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;debug/VNC.hh&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="byteswap_8hh.html">sim/byteswap.hh</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="core_8hh.html">sim/core.hh</a>&quot;</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="keyword">using namespace </span>std;
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="keyword">const</span> <a class="code" href="classPixelConverter.html" title="Configurable RGB pixel converter.">PixelConverter</a> <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">VncServer::pixelConverter</a>(
<a name="l00079"></a>00079     4,        <span class="comment">// 4 bytes / pixel</span>
<a name="l00080"></a>00080     16, 8, 0, <span class="comment">// R in [23, 16], G in [15, 8], B in [7, 0]</span>
<a name="l00081"></a>00081     8, 8, 8,  <span class="comment">// 8 bits / channel</span>
<a name="l00082"></a>00082     <a class="code" href="base_2types_8hh.html#aaeb92d42f5a6e27b8ba19f18d69d142ba27cb938a9a54fedfe5c69b927994bbef">LittleEndianByteOrder</a>);
<a name="l00083"></a>00083 
<a name="l00091"></a><a class="code" href="classVncServer_1_1ListenEvent.html#a088a38761a3366f6a60207504a218e19">00091</a> <a class="code" href="classVncServer_1_1ListenEvent.html#a088a38761a3366f6a60207504a218e19" title="Poll event for the listen socket.">VncServer::ListenEvent::ListenEvent</a>(<a class="code" href="classVncServer.html">VncServer</a> *<a class="code" href="namespaceMipsISA.html#a8923294d45fab657ec52b88b8ecd8a18">vs</a>, <span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a6bb1dd177dcfe2a8a54a396f8942a098">fd</a>, <span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a300e2be8a75f735b68e3d6c321c28cd2">e</a>)
<a name="l00092"></a>00092     : <a class="code" href="classPollEvent.html">PollEvent</a>(fd, e), vncserver(vs)
<a name="l00093"></a>00093 {
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="keywordtype">void</span>
<a name="l00097"></a><a class="code" href="classVncServer_1_1ListenEvent.html#ab494237d700f7fcc74852a05d6748dd4">00097</a> <a class="code" href="classVncServer_1_1ListenEvent.html#ab494237d700f7fcc74852a05d6748dd4">VncServer::ListenEvent::process</a>(<span class="keywordtype">int</span> revent)
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099     <a class="code" href="classVncServer_1_1ListenEvent.html#a14a3e62944905eb17264cad11b7f1137">vncserver</a>-&gt;<a class="code" href="classVncServer.html#aaa62728ca901f1a1046b4ae6b60c595b">accept</a>();
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 
<a name="l00105"></a><a class="code" href="classVncServer_1_1DataEvent.html#aaf5e23e33d8cb8b66f3d549694e0e23f">00105</a> <a class="code" href="classVncServer.html#a8a93830b802d4fc8562fa54ead43b1f9">VncServer::DataEvent::DataEvent</a>(<a class="code" href="classVncServer.html">VncServer</a> *<a class="code" href="namespaceMipsISA.html#a8923294d45fab657ec52b88b8ecd8a18">vs</a>, <span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a6bb1dd177dcfe2a8a54a396f8942a098">fd</a>, <span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a300e2be8a75f735b68e3d6c321c28cd2">e</a>)
<a name="l00106"></a>00106     : <a class="code" href="classPollEvent.html">PollEvent</a>(fd, e), vncserver(vs)
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108 }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 <span class="keywordtype">void</span>
<a name="l00111"></a><a class="code" href="classVncServer_1_1DataEvent.html#a033dc70d6d15635b92fa82ae4dc566cb">00111</a> <a class="code" href="classVncServer_1_1DataEvent.html#a033dc70d6d15635b92fa82ae4dc566cb">VncServer::DataEvent::process</a>(<span class="keywordtype">int</span> revent)
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113     <span class="keywordflow">if</span> (revent &amp; POLLIN)
<a name="l00114"></a>00114         <a class="code" href="classVncServer_1_1DataEvent.html#a400f09123957c4676c0dd3cb623cf4fa">vncserver</a>-&gt;<a class="code" href="classVncServer.html#a399ecdb2dc9284c2137516f5a6a8ee50">data</a>();
<a name="l00115"></a>00115     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (revent &amp; POLLNVAL)
<a name="l00116"></a>00116         <a class="code" href="classVncServer_1_1DataEvent.html#a400f09123957c4676c0dd3cb623cf4fa">vncserver</a>-&gt;<a class="code" href="classVncServer.html#a0f216d620baac19364b796cb64e6d398">detach</a>();
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00122"></a><a class="code" href="classVncServer.html#af33bb287e0380d4456c43542f195e1b2">00122</a> <a class="code" href="classVncServer.html#af33bb287e0380d4456c43542f195e1b2" title="VncServer.">VncServer::VncServer</a>(<span class="keyword">const</span> <a class="code" href="classVncServer.html#a54d0aa52c59d4cb11fe40f57d9b783a4">Params</a> *<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>)
<a name="l00123"></a>00123     : <a class="code" href="classVncInput.html">VncInput</a>(p), <a class="code" href="classVncServer.html#a7f320b042d969e4ebecbb936e1b7d527">listenEvent</a>(NULL), <a class="code" href="classVncServer.html#a00fd4c016dce90f10f2d1d1de5b0bc2e">dataEvent</a>(NULL), <a class="code" href="classVncServer.html#a34686ea063187966e51e5512074e8017">number</a>(p-&gt;<a class="code" href="classVncServer.html#a34686ea063187966e51e5512074e8017">number</a>),
<a name="l00124"></a>00124       <a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a>(-1), <a class="code" href="classVncServer.html#a780da49a2c1ca54746dcf2036f29f514" title="An update needs to be sent to the client.">sendUpdate</a>(false),
<a name="l00125"></a>00125       <a class="code" href="classVncServer.html#ac1725b64c8a1f83c2dfffc086700f226" title="If the vnc client supports receiving raw data.">supportsRawEnc</a>(false), <a class="code" href="classVncServer.html#a68f3455adec923af59d8e5725cc2d9ce" title="If the vnc client supports the desktop resize command.">supportsResizeEnc</a>(false)
<a name="l00126"></a>00126 {
<a name="l00127"></a>00127     <span class="keywordflow">if</span> (p-&gt;port)
<a name="l00128"></a>00128         <a class="code" href="classVncServer.html#a4ba45f1279827aa132e04f550c27c550">listen</a>(p-&gt;port);
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     <a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a> = <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48baaaf9309e61bfd1d934afd03bed957d08">WaitForProtocolVersion</a>;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="comment">// We currently only support one pixel format. Extract the pixel</span>
<a name="l00133"></a>00133     <span class="comment">// representation from our PixelConverter instance and keep it</span>
<a name="l00134"></a>00134     <span class="comment">// around for telling the client and making sure it cooperates</span>
<a name="l00135"></a>00135     <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#aa3feeb1f67607d22edf7f15034f8ef68">bpp</a> = 8 * <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#aa836e9f9f3a906bd83acf1086b57d7be" title="Bytes per pixel when stored in memory (including padding).">length</a>;
<a name="l00136"></a>00136     <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a07ea04bcb9b239cf2e7fed49bb0d7bca">depth</a> = <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#ab02c962841dc8a7ac02f1e519766f034" title="Number of bits used to represent one pixel value (excluding padding).">depth</a>;
<a name="l00137"></a>00137     <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a8cb85ecac4677cfe3fdc8e20c54d6444">bigendian</a> = <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#a3f1f17985bc37692cec271904209d25c" title="Byte order when stored to memory.">byte_order</a> == <a class="code" href="base_2types_8hh.html#aaeb92d42f5a6e27b8ba19f18d69d142baeb5880acff621b284760d4ed418de2ba">BigEndianByteOrder</a>;
<a name="l00138"></a>00138     <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#abe5571b936ce0da0db7a6336d625f213">truecolor</a> = 1;
<a name="l00139"></a>00139     <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a40ff9e80e0652fb39b283fc578e94025">redmax</a> = <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#a908acf9e8316e6e3665086027d8470a9" title="Red channel conversion helper.">ch_r</a>.mask;
<a name="l00140"></a>00140     <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#ac34cf3e1c9756987bd25af5e57ef8a48">greenmax</a> = <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#a15bfc2749b21cf6d1c15651369d753d7" title="Green channel conversion helper.">ch_g</a>.mask;
<a name="l00141"></a>00141     <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a0e278d5960ce0ece6cd4ea26617f96ed">bluemax</a> = <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#a3f467035578f2f9bb19f9a2d48723045" title="Blue channel conversion helper.">ch_b</a>.mask;
<a name="l00142"></a>00142     <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#ac8f7a0310e88b32ba6e3fbbbe5315e45">redshift</a> = <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#a908acf9e8316e6e3665086027d8470a9" title="Red channel conversion helper.">ch_r</a>.offset;
<a name="l00143"></a>00143     <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#adf9f1c6bcd4d79563426511ff07bb2cf">greenshift</a> = <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#a15bfc2749b21cf6d1c15651369d753d7" title="Green channel conversion helper.">ch_g</a>.offset;
<a name="l00144"></a>00144     <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a197fc4e93801b040607276cc870df29d">blueshift</a> = <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#a3f467035578f2f9bb19f9a2d48723045" title="Blue channel conversion helper.">ch_b</a>.offset;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Vnc server created at port %d\n&quot;</span>, p-&gt;port);
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="classVncServer.html#a23275b3e84cb47a9650ece7cafc9c28e">00149</a> <a class="code" href="classVncServer.html#a23275b3e84cb47a9650ece7cafc9c28e">VncServer::~VncServer</a>()
<a name="l00150"></a>00150 {
<a name="l00151"></a>00151     <span class="keywordflow">if</span> (<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a> != -1)
<a name="l00152"></a>00152         ::close(<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a>);
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <span class="keywordflow">if</span> (<a class="code" href="classVncServer.html#a7f320b042d969e4ebecbb936e1b7d527">listenEvent</a>)
<a name="l00155"></a>00155         <span class="keyword">delete</span> <a class="code" href="classVncServer.html#a7f320b042d969e4ebecbb936e1b7d527">listenEvent</a>;
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     <span class="keywordflow">if</span> (<a class="code" href="classVncServer.html#a00fd4c016dce90f10f2d1d1de5b0bc2e">dataEvent</a>)
<a name="l00158"></a>00158         <span class="keyword">delete</span> <a class="code" href="classVncServer.html#a00fd4c016dce90f10f2d1d1de5b0bc2e">dataEvent</a>;
<a name="l00159"></a>00159 }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="comment">//socket creation and vnc client attach</span>
<a name="l00163"></a>00163 <span class="keywordtype">void</span>
<a name="l00164"></a><a class="code" href="classVncServer.html#a4ba45f1279827aa132e04f550c27c550">00164</a> <a class="code" href="classVncServer.html#a4ba45f1279827aa132e04f550c27c550">VncServer::listen</a>(<span class="keywordtype">int</span> port)
<a name="l00165"></a>00165 {
<a name="l00166"></a>00166     <span class="keywordflow">if</span> (<a class="code" href="classListenSocket.html#aa2eb564cfa7ce959dcf4d89a3495c0fc">ListenSocket::allDisabled</a>()) {
<a name="l00167"></a>00167         <a class="code" href="base_2misc_8hh.html#abb243c15dfbeedf4ae64aa213f4f18c7">warn_once</a>(<span class="stringliteral">&quot;Sockets disabled, not accepting vnc client connections&quot;</span>);
<a name="l00168"></a>00168         <span class="keywordflow">return</span>;
<a name="l00169"></a>00169     }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <span class="keywordflow">while</span> (!<a class="code" href="classVncServer.html#ab291d42ce715f9cceb4780a6331af0df">listener</a>.<a class="code" href="classListenSocket.html#aec4601e2f8f6e7a54b08f38e1e23e433">listen</a>(port, <span class="keyword">true</span>)) {
<a name="l00172"></a>00172         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC,
<a name="l00173"></a>00173                 <span class="stringliteral">&quot;can&apos;t bind address vnc server port %d in use PID %d\n&quot;</span>,
<a name="l00174"></a>00174                 port, getpid());
<a name="l00175"></a>00175         port++;
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178     <span class="keywordtype">int</span> p1, p2;
<a name="l00179"></a>00179     p2 = <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>().rfind(<span class="charliteral">&apos;.&apos;</span>) - 1;
<a name="l00180"></a>00180     p1 = <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>().rfind(<span class="charliteral">&apos;.&apos;</span>, p2);
<a name="l00181"></a>00181     <a class="code" href="cprintf_8hh.html#a7f1c26b4a52f0946577f75295bb2488f">ccprintf</a>(cerr, <span class="stringliteral">&quot;Listening for %s connection on port %d\n&quot;</span>,
<a name="l00182"></a>00182              <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>().substr(p1 + 1, p2 - p1), port);
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <a class="code" href="classVncServer.html#a7f320b042d969e4ebecbb936e1b7d527">listenEvent</a> = <span class="keyword">new</span> <a class="code" href="classVncServer.html#a9465cdda0008b0e7b7f9ac919cd9cca6">ListenEvent</a>(<span class="keyword">this</span>, <a class="code" href="classVncServer.html#ab291d42ce715f9cceb4780a6331af0df">listener</a>.<a class="code" href="classListenSocket.html#a3d1147f82e253db6c3b00d7e1fe1c24f">getfd</a>(), POLLIN);
<a name="l00185"></a>00185     <a class="code" href="pollevent_8cc.html#a6d9704e1e32950ea3b587e96e8873739">pollQueue</a>.<a class="code" href="classPollQueue.html#a24b16ccafa28aa0cf261bd922ddf0113">schedule</a>(<a class="code" href="classVncServer.html#a7f320b042d969e4ebecbb936e1b7d527">listenEvent</a>);
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 <span class="comment">// attach a vnc client</span>
<a name="l00189"></a>00189 <span class="keywordtype">void</span>
<a name="l00190"></a><a class="code" href="classVncServer.html#aaa62728ca901f1a1046b4ae6b60c595b">00190</a> <a class="code" href="classVncServer.html#aaa62728ca901f1a1046b4ae6b60c595b">VncServer::accept</a>()
<a name="l00191"></a>00191 {
<a name="l00192"></a>00192     <span class="comment">// As a consequence of being called from the PollQueue, we might</span>
<a name="l00193"></a>00193     <span class="comment">// have been called from a different thread. Migrate to &quot;our&quot;</span>
<a name="l00194"></a>00194     <span class="comment">// thread.</span>
<a name="l00195"></a>00195     <a class="code" href="classEventQueue_1_1ScopedMigration.html" title="Temporarily migrate execution to a different event queue.">EventQueue::ScopedMigration</a> migrate(<a class="code" href="classEventManager.html#a35b83dad6cd0af3227f99d67445d1527">eventQueue</a>());
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     <span class="keywordflow">if</span> (!<a class="code" href="classVncServer.html#ab291d42ce715f9cceb4780a6331af0df">listener</a>.<a class="code" href="classListenSocket.html#acc070e6d38c4be86803676b0347d1303">islistening</a>())
<a name="l00198"></a>00198         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;%s: cannot accept a connection if not listening!&quot;</span>, <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a6bb1dd177dcfe2a8a54a396f8942a098">fd</a> = <a class="code" href="classVncServer.html#ab291d42ce715f9cceb4780a6331af0df">listener</a>.<a class="code" href="classListenSocket.html#a327b2acafff256476e63bd5cbca09d1e">accept</a>(<span class="keyword">true</span>);
<a name="l00201"></a>00201     <a class="code" href="base_2misc_8hh.html#a2127c4f5f05a25aea5ffc00677fc3ffe" title="Conditional fatal macro that checks the supplied condition and only causes a fatal...">fatal_if</a>(fd &lt; 0, <span class="stringliteral">&quot;%s: failed to accept VNC connection!&quot;</span>, <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>());
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <span class="keywordflow">if</span> (<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a> != -1) {
<a name="l00204"></a>00204         <span class="keywordtype">char</span> message[] = <span class="stringliteral">&quot;vnc server already attached!\n&quot;</span>;
<a name="l00205"></a>00205         <a class="code" href="atomicio_8cc.html#a301f476c6c8d75d54f43aea6ad1ff740">atomic_write</a>(fd, message, <span class="keyword">sizeof</span>(message));
<a name="l00206"></a>00206         ::close(fd);
<a name="l00207"></a>00207         <span class="keywordflow">return</span>;
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a> = fd;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="comment">// Send our version number to the client</span>
<a name="l00213"></a>00213     <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>((uint8_t*)<a class="code" href="group__VncConstants.html#gae2c876240ba22503c82ebd04475591f8">vncVersion</a>(), strlen(<a class="code" href="group__VncConstants.html#gae2c876240ba22503c82ebd04475591f8">vncVersion</a>()));
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="comment">// read the client response</span>
<a name="l00216"></a>00216     <a class="code" href="classVncServer.html#a00fd4c016dce90f10f2d1d1de5b0bc2e">dataEvent</a> = <span class="keyword">new</span> <a class="code" href="classVncServer.html#a8a93830b802d4fc8562fa54ead43b1f9">DataEvent</a>(<span class="keyword">this</span>, <a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a>, POLLIN);
<a name="l00217"></a>00217     <a class="code" href="pollevent_8cc.html#a6d9704e1e32950ea3b587e96e8873739">pollQueue</a>.<a class="code" href="classPollQueue.html#a24b16ccafa28aa0cf261bd922ddf0113">schedule</a>(<a class="code" href="classVncServer.html#a00fd4c016dce90f10f2d1d1de5b0bc2e">dataEvent</a>);
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;VNC client attached\n&quot;</span>);
<a name="l00220"></a>00220 }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <span class="comment">// data called by data event</span>
<a name="l00223"></a>00223 <span class="keywordtype">void</span>
<a name="l00224"></a><a class="code" href="classVncServer.html#a399ecdb2dc9284c2137516f5a6a8ee50">00224</a> <a class="code" href="classVncServer.html#a399ecdb2dc9284c2137516f5a6a8ee50">VncServer::data</a>()
<a name="l00225"></a>00225 {
<a name="l00226"></a>00226     <span class="comment">// We have new data, see if we can handle it</span>
<a name="l00227"></a>00227     <span class="keywordtype">size_t</span> <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a>;
<a name="l00228"></a>00228     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Vnc client message recieved\n&quot;</span>);
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="keywordflow">switch</span> (<a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a>) {
<a name="l00231"></a>00231       <span class="keywordflow">case</span> <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48baaaf9309e61bfd1d934afd03bed957d08">WaitForProtocolVersion</a>:
<a name="l00232"></a>00232         <a class="code" href="classVncServer.html#ad16179f2d2745bb59dc14a8913a9efe4" title="Check the client&amp;#39;s protocol verion for compatibility and send the security types...">checkProtocolVersion</a>();
<a name="l00233"></a>00233         <span class="keywordflow">break</span>;
<a name="l00234"></a>00234       <span class="keywordflow">case</span> <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48ba75a9d10608f6dde868235d19b2c673d8">WaitForSecurityResponse</a>:
<a name="l00235"></a>00235         <a class="code" href="classVncServer.html#a46169dab9f33cbd68d799022b4bbfdee" title="Check that the security exchange was successful.">checkSecurity</a>();
<a name="l00236"></a>00236         <span class="keywordflow">break</span>;
<a name="l00237"></a>00237       <span class="keywordflow">case</span> <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48bae1d27c58da484ab9a32925cd3cb5dee8">WaitForClientInit</a>:
<a name="l00238"></a>00238         <span class="comment">// Don&apos;t care about shared, just need to read it out of the socket</span>
<a name="l00239"></a>00239         uint8_t shared;
<a name="l00240"></a>00240         len = <a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client.">read</a>(&amp;shared);
<a name="l00241"></a>00241         assert(len == 1);
<a name="l00242"></a>00242 
<a name="l00243"></a>00243         <span class="comment">// Send our idea of the frame buffer</span>
<a name="l00244"></a>00244         <a class="code" href="classVncServer.html#a47bf6f1f628b5d99a6be2279283b24a1" title="Send client our idea about what the frame buffer looks like.">sendServerInit</a>();
<a name="l00245"></a>00245 
<a name="l00246"></a>00246         <span class="keywordflow">break</span>;
<a name="l00247"></a>00247       <span class="keywordflow">case</span> <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48bac56ddc35b07ffe7fe9bf209ce6d6d0da">NormalPhase</a>:
<a name="l00248"></a>00248         uint8_t message_type;
<a name="l00249"></a>00249         len = <a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client.">read</a>(&amp;message_type);
<a name="l00250"></a>00250         <span class="keywordflow">if</span> (!len) {
<a name="l00251"></a>00251             <a class="code" href="classVncServer.html#a0f216d620baac19364b796cb64e6d398">detach</a>();
<a name="l00252"></a>00252             <span class="keywordflow">return</span>;
<a name="l00253"></a>00253         }
<a name="l00254"></a>00254         assert(len == 1);
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="keywordflow">switch</span> (message_type) {
<a name="l00257"></a>00257           <span class="keywordflow">case</span> <a class="code" href="classVncInput.html#ac38ac189b797558b74cf945e4f145e71a697bba6c9d4691b7f94a58c21e49d845">ClientSetPixelFormat</a>:
<a name="l00258"></a>00258             <a class="code" href="classVncServer.html#ab65743c48d80245bde24471369c01a73" title="Receive pixel foramt message from client and process it.">setPixelFormat</a>();
<a name="l00259"></a>00259             <span class="keywordflow">break</span>;
<a name="l00260"></a>00260           <span class="keywordflow">case</span> <a class="code" href="classVncInput.html#ac38ac189b797558b74cf945e4f145e71ae83b4486b2837afff0364f57d301a965">ClientSetEncodings</a>:
<a name="l00261"></a>00261             <a class="code" href="classVncServer.html#aebd5a4ca7014f94d4f8a2cda28e2f574" title="Receive encodings message from client and process it.">setEncodings</a>();
<a name="l00262"></a>00262             <span class="keywordflow">break</span>;
<a name="l00263"></a>00263           <span class="keywordflow">case</span> <a class="code" href="classVncInput.html#ac38ac189b797558b74cf945e4f145e71a1f62ee56795090d47a0b5d5902ac327b">ClientFrameBufferUpdate</a>:
<a name="l00264"></a>00264             <a class="code" href="classVncServer.html#a0a0df1bd2f4bb8f12e9860bb8e51f731" title="Receive message from client asking for updated frame buffer.">requestFbUpdate</a>();
<a name="l00265"></a>00265             <span class="keywordflow">break</span>;
<a name="l00266"></a>00266           <span class="keywordflow">case</span> <a class="code" href="classVncInput.html#ac38ac189b797558b74cf945e4f145e71af431fb839e2e525df6ea63bef5b540e2">ClientKeyEvent</a>:
<a name="l00267"></a>00267             <a class="code" href="classVncServer.html#a41d8502edc3a2aaea2ce0255e40d93bd" title="Receive message from client providing new keyboard input.">recvKeyboardInput</a>();
<a name="l00268"></a>00268             <span class="keywordflow">break</span>;
<a name="l00269"></a>00269           <span class="keywordflow">case</span> <a class="code" href="classVncInput.html#ac38ac189b797558b74cf945e4f145e71a6c8d3ec3869372d1f39de0c8651f46a7">ClientPointerEvent</a>:
<a name="l00270"></a>00270             <a class="code" href="classVncServer.html#aa8b6d7d106d2e8ab9015d1bcb7a0d7ee" title="Recv message from client providing new mouse movement or button click.">recvPointerInput</a>();
<a name="l00271"></a>00271             <span class="keywordflow">break</span>;
<a name="l00272"></a>00272           <span class="keywordflow">case</span> <a class="code" href="classVncInput.html#ac38ac189b797558b74cf945e4f145e71a8e28bdf06897a5f2e1c49aadd03aa17f">ClientCutText</a>:
<a name="l00273"></a>00273             <a class="code" href="classVncServer.html#ab65cf6f13c32d021e072942f65be57e6" title="Receive message from client that there is text in it&amp;#39;s paste buffer.">recvCutText</a>();
<a name="l00274"></a>00274             <span class="keywordflow">break</span>;
<a name="l00275"></a>00275           <span class="keywordflow">default</span>:
<a name="l00276"></a>00276             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Unimplemented message type recv from client: %d\n&quot;</span>,
<a name="l00277"></a>00277                   message_type);
<a name="l00278"></a>00278             <span class="keywordflow">break</span>;
<a name="l00279"></a>00279         }
<a name="l00280"></a>00280         <span class="keywordflow">break</span>;
<a name="l00281"></a>00281       <span class="keywordflow">default</span>:
<a name="l00282"></a>00282         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Unknown vnc server state\n&quot;</span>);
<a name="l00283"></a>00283     }
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="comment">// read from socket</span>
<a name="l00288"></a>00288 <span class="keywordtype">size_t</span>
<a name="l00289"></a><a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498">00289</a> <a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client.">VncServer::read</a>(uint8_t *buf, <span class="keywordtype">size_t</span> <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a>)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a> &lt; 0)
<a name="l00292"></a>00292         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;vnc not properly attached.\n&quot;</span>);
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     <span class="keywordtype">size_t</span> ret;
<a name="l00295"></a>00295     <span class="keywordflow">do</span> {
<a name="l00296"></a>00296         ret =<a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client."> ::read</a>(<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a>, buf, len);
<a name="l00297"></a>00297     } <span class="keywordflow">while</span> (ret == -1 &amp;&amp; errno == EINTR);
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <span class="keywordflow">if</span> (ret &lt;= 0){
<a name="l00301"></a>00301         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Read failed.\n&quot;</span>);
<a name="l00302"></a>00302         <a class="code" href="classVncServer.html#a0f216d620baac19364b796cb64e6d398">detach</a>();
<a name="l00303"></a>00303         <span class="keywordflow">return</span> 0;
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="keywordflow">return</span> ret;
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 <span class="keywordtype">size_t</span>
<a name="l00310"></a><a class="code" href="classVncServer.html#acf12371863c1654c02f731dcbd6347e3">00310</a> <a class="code" href="classVncServer.html#acf12371863c1654c02f731dcbd6347e3" title="Read len -1 bytes from the client into the buffer provided + 1 assert that we read...">VncServer::read1</a>(uint8_t *buf, <span class="keywordtype">size_t</span> <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a>)
<a name="l00311"></a>00311 {
<a name="l00312"></a>00312     <span class="keywordtype">size_t</span> read_len <a class="code" href="namespaceArmISA.html#a7bca404a37e7db0156c4b14dad12c18f">M5_VAR_USED</a>;
<a name="l00313"></a>00313     read_len = <a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client.">read</a>(buf + 1, len - 1);
<a name="l00314"></a>00314     assert(read_len == len - 1);
<a name="l00315"></a>00315     <span class="keywordflow">return</span> read_len;
<a name="l00316"></a>00316 }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00320"></a>00320 <span class="keywordtype">size_t</span>
<a name="l00321"></a><a class="code" href="classVncServer.html#a27442561d08363a6a0dec62b95c46bc7">00321</a> <a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client.">VncServer::read</a>(T* <a class="code" href="namespaceX86ISA.html#ab4e00e23f8f36386f97d8abcccb17180">val</a>)
<a name="l00322"></a>00322 {
<a name="l00323"></a>00323     <span class="keywordflow">return</span> <a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client.">read</a>((uint8_t*)val, <span class="keyword">sizeof</span>(T));
<a name="l00324"></a>00324 }
<a name="l00325"></a>00325 
<a name="l00326"></a>00326 <span class="comment">// write to socket</span>
<a name="l00327"></a>00327 <span class="keywordtype">size_t</span>
<a name="l00328"></a><a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6">00328</a> <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">VncServer::write</a>(<span class="keyword">const</span> uint8_t *buf, <span class="keywordtype">size_t</span> <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a>)
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330     <span class="keywordflow">if</span> (<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a> &lt; 0)
<a name="l00331"></a>00331         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Vnc client not properly attached.\n&quot;</span>);
<a name="l00332"></a>00332 
<a name="l00333"></a>00333     ssize_t ret;
<a name="l00334"></a>00334     ret = <a class="code" href="atomicio_8cc.html#a301f476c6c8d75d54f43aea6ad1ff740">atomic_write</a>(<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a>, buf, len);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <span class="keywordflow">if</span> (ret &lt; len)
<a name="l00337"></a>00337         <a class="code" href="classVncServer.html#a0f216d620baac19364b796cb64e6d398">detach</a>();
<a name="l00338"></a>00338 
<a name="l00339"></a>00339     <span class="keywordflow">return</span> ret;
<a name="l00340"></a>00340 }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342 <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00343"></a>00343 <span class="keywordtype">size_t</span>
<a name="l00344"></a><a class="code" href="classVncServer.html#a4855363f67a8536d94ba5793ae42a89c">00344</a> <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">VncServer::write</a>(T* <a class="code" href="namespaceX86ISA.html#ab4e00e23f8f36386f97d8abcccb17180">val</a>)
<a name="l00345"></a>00345 {
<a name="l00346"></a>00346     <span class="keywordflow">return</span> <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>((uint8_t*)val, <span class="keyword">sizeof</span>(T));
<a name="l00347"></a>00347 }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349 <span class="keywordtype">size_t</span>
<a name="l00350"></a><a class="code" href="classVncServer.html#aad3fcc20a0e07ac61e6eb61516165c26">00350</a> <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">VncServer::write</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* str)
<a name="l00351"></a>00351 {
<a name="l00352"></a>00352     <span class="keywordflow">return</span> <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>((uint8_t*)str, strlen(str));
<a name="l00353"></a>00353 }
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 <span class="comment">// detach a vnc client</span>
<a name="l00356"></a>00356 <span class="keywordtype">void</span>
<a name="l00357"></a><a class="code" href="classVncServer.html#a0f216d620baac19364b796cb64e6d398">00357</a> <a class="code" href="classVncServer.html#a0f216d620baac19364b796cb64e6d398">VncServer::detach</a>()
<a name="l00358"></a>00358 {
<a name="l00359"></a>00359     <span class="keywordflow">if</span> (<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a> != -1) {
<a name="l00360"></a>00360         ::close(<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a>);
<a name="l00361"></a>00361         <a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a> = -1;
<a name="l00362"></a>00362     }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364     <span class="keywordflow">if</span> (!<a class="code" href="classVncServer.html#a00fd4c016dce90f10f2d1d1de5b0bc2e">dataEvent</a> || !<a class="code" href="classVncServer.html#a00fd4c016dce90f10f2d1d1de5b0bc2e">dataEvent</a>-&gt;<a class="code" href="classPollEvent.html#a09bd6f35ed564497cea4721ecb01d707">queued</a>())
<a name="l00365"></a>00365         <span class="keywordflow">return</span>;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     <a class="code" href="pollevent_8cc.html#a6d9704e1e32950ea3b587e96e8873739">pollQueue</a>.<a class="code" href="classPollQueue.html#a0e602486323041f2918a7467324bd5bf">remove</a>(<a class="code" href="classVncServer.html#a00fd4c016dce90f10f2d1d1de5b0bc2e">dataEvent</a>);
<a name="l00368"></a>00368     <span class="keyword">delete</span> <a class="code" href="classVncServer.html#a00fd4c016dce90f10f2d1d1de5b0bc2e">dataEvent</a>;
<a name="l00369"></a>00369     <a class="code" href="classVncServer.html#a00fd4c016dce90f10f2d1d1de5b0bc2e">dataEvent</a> = NULL;
<a name="l00370"></a>00370     <a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a> = <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48baaaf9309e61bfd1d934afd03bed957d08">WaitForProtocolVersion</a>;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;VNC client detached\n&quot;</span>);
<a name="l00373"></a>00373     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;detach vnc client %d\n&quot;</span>, <a class="code" href="classVncServer.html#a34686ea063187966e51e5512074e8017">number</a>);
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 <span class="keywordtype">void</span>
<a name="l00377"></a><a class="code" href="classVncServer.html#a5e3a194e8fe10e9a5587549fdf208ec5">00377</a> <a class="code" href="classVncServer.html#a5e3a194e8fe10e9a5587549fdf208ec5" title="vnc client Interface">VncServer::sendError</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* error_msg)
<a name="l00378"></a>00378 {
<a name="l00379"></a>00379    uint32_t <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a> = strlen(error_msg);
<a name="l00380"></a>00380    <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;len);
<a name="l00381"></a>00381    <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(error_msg);
<a name="l00382"></a>00382 }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 <span class="keywordtype">void</span>
<a name="l00385"></a><a class="code" href="classVncServer.html#ad16179f2d2745bb59dc14a8913a9efe4">00385</a> <a class="code" href="classVncServer.html#ad16179f2d2745bb59dc14a8913a9efe4" title="Check the client&amp;#39;s protocol verion for compatibility and send the security types...">VncServer::checkProtocolVersion</a>()
<a name="l00386"></a>00386 {
<a name="l00387"></a>00387     assert(<a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a> == <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48baaaf9309e61bfd1d934afd03bed957d08">WaitForProtocolVersion</a>);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="keywordtype">size_t</span> <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a> <a class="code" href="namespaceArmISA.html#a7bca404a37e7db0156c4b14dad12c18f">M5_VAR_USED</a>;
<a name="l00390"></a>00390     <span class="keywordtype">char</span> version_string[13];
<a name="l00391"></a>00391 
<a name="l00392"></a>00392     <span class="comment">// Null terminate the message so it&apos;s easier to work with</span>
<a name="l00393"></a>00393     version_string[12] = 0;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a> = <a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client.">read</a>((uint8_t*)version_string, 12);
<a name="l00396"></a>00396     assert(<a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a> == 12);
<a name="l00397"></a>00397 
<a name="l00398"></a>00398     uint32_t major, minor;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="comment">// Figure out the major/minor numbers</span>
<a name="l00401"></a>00401     <span class="keywordflow">if</span> (sscanf(version_string, <span class="stringliteral">&quot;RFB %03d.%03d\n&quot;</span>, &amp;major, &amp;minor) != 2) {
<a name="l00402"></a>00402         <a class="code" href="base_2misc_8hh.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot; Malformed protocol version %s\n&quot;</span>, version_string);
<a name="l00403"></a>00403         <a class="code" href="classVncServer.html#a5e3a194e8fe10e9a5587549fdf208ec5" title="vnc client Interface">sendError</a>(<span class="stringliteral">&quot;Malformed protocol version\n&quot;</span>);
<a name="l00404"></a>00404         <a class="code" href="classVncServer.html#a0f216d620baac19364b796cb64e6d398">detach</a>();
<a name="l00405"></a>00405     }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Client request protocol version %d.%d\n&quot;</span>, major, minor);
<a name="l00408"></a>00408 
<a name="l00409"></a>00409     <span class="comment">// If it&apos;s not 3.X we don&apos;t support it</span>
<a name="l00410"></a>00410     <span class="keywordflow">if</span> (major != 3 || minor &lt; 2) {
<a name="l00411"></a>00411         <a class="code" href="base_2misc_8hh.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;Unsupported VNC client version... disconnecting\n&quot;</span>);
<a name="l00412"></a>00412         uint8_t err = <a class="code" href="group__VncConstants.html#ga9892a5d28473807286de22a30a8ad58c" title="Authentication modes.">AuthInvalid</a>;
<a name="l00413"></a>00413         <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;err);
<a name="l00414"></a>00414         <a class="code" href="classVncServer.html#a0f216d620baac19364b796cb64e6d398">detach</a>();
<a name="l00415"></a>00415     }
<a name="l00416"></a>00416     <span class="comment">// Auth is different based on version number</span>
<a name="l00417"></a>00417     <span class="keywordflow">if</span> (minor &lt; 7) {
<a name="l00418"></a>00418         uint32_t sec_type = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>((uint32_t)<a class="code" href="group__VncConstants.html#gaceb7b2deffadd8925fe5901de91d2179">AuthNone</a>);
<a name="l00419"></a>00419         <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;sec_type);
<a name="l00420"></a>00420     } <span class="keywordflow">else</span> {
<a name="l00421"></a>00421         uint8_t sec_cnt = 1;
<a name="l00422"></a>00422         uint8_t sec_type = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>((uint8_t)<a class="code" href="group__VncConstants.html#gaceb7b2deffadd8925fe5901de91d2179">AuthNone</a>);
<a name="l00423"></a>00423         <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;sec_cnt);
<a name="l00424"></a>00424         <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;sec_type);
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427     <span class="comment">// Wait for client to respond</span>
<a name="l00428"></a>00428     <a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a> = <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48ba75a9d10608f6dde868235d19b2c673d8">WaitForSecurityResponse</a>;
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 <span class="keywordtype">void</span>
<a name="l00432"></a><a class="code" href="classVncServer.html#a46169dab9f33cbd68d799022b4bbfdee">00432</a> <a class="code" href="classVncServer.html#a46169dab9f33cbd68d799022b4bbfdee" title="Check that the security exchange was successful.">VncServer::checkSecurity</a>()
<a name="l00433"></a>00433 {
<a name="l00434"></a>00434     assert(<a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a> == <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48ba75a9d10608f6dde868235d19b2c673d8">WaitForSecurityResponse</a>);
<a name="l00435"></a>00435 
<a name="l00436"></a>00436     uint8_t security_type;
<a name="l00437"></a>00437     <span class="keywordtype">size_t</span> <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a> <a class="code" href="namespaceArmISA.html#a7bca404a37e7db0156c4b14dad12c18f">M5_VAR_USED</a> = <a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client.">read</a>(&amp;security_type);
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     assert(<a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a> == 1);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     <span class="keywordflow">if</span> (security_type != <a class="code" href="group__VncConstants.html#gaceb7b2deffadd8925fe5901de91d2179">AuthNone</a>) {
<a name="l00442"></a>00442         <a class="code" href="base_2misc_8hh.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;Unknown VNC security type\n&quot;</span>);
<a name="l00443"></a>00443         <a class="code" href="classVncServer.html#a5e3a194e8fe10e9a5587549fdf208ec5" title="vnc client Interface">sendError</a>(<span class="stringliteral">&quot;Unknown security type\n&quot;</span>);
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Sending security auth OK\n&quot;</span>);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     uint32_t success = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="group__VncConstants.html#gadae91fe6a992a62346ebac50735821c7" title="Error conditions.">VncOK</a>);
<a name="l00449"></a>00449     <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;success);
<a name="l00450"></a>00450     <a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a> = <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48bae1d27c58da484ab9a32925cd3cb5dee8">WaitForClientInit</a>;
<a name="l00451"></a>00451 }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 <span class="keywordtype">void</span>
<a name="l00454"></a><a class="code" href="classVncServer.html#a47bf6f1f628b5d99a6be2279283b24a1">00454</a> <a class="code" href="classVncServer.html#a47bf6f1f628b5d99a6be2279283b24a1" title="Send client our idea about what the frame buffer looks like.">VncServer::sendServerInit</a>()
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456     <a class="code" href="structVncServer_1_1ServerInitMsg.html">ServerInitMsg</a> msg;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Sending server init message to client\n&quot;</span>);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#ab289a944e2ca99ae75f17d33bfa9aacb">fbWidth</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncInput.html#a9aaafa4bc016017a7caefbfb49dc47fe" title="What is the width of the screen we&amp;#39;re displaying.">videoWidth</a>());
<a name="l00461"></a>00461     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#acb24fd54de8a220287d01a3a4df0b6e3">fbHeight</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncInput.html#afa4b0b5ed40e158beb56c52c0fe344d8" title="What is the height of the screen we&amp;#39;re displaying.">videoHeight</a>());
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#aa3feeb1f67607d22edf7f15034f8ef68">bpp</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#aa3feeb1f67607d22edf7f15034f8ef68">bpp</a>);
<a name="l00464"></a>00464     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a07ea04bcb9b239cf2e7fed49bb0d7bca">depth</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a07ea04bcb9b239cf2e7fed49bb0d7bca">depth</a>);
<a name="l00465"></a>00465     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a8cb85ecac4677cfe3fdc8e20c54d6444">bigendian</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a8cb85ecac4677cfe3fdc8e20c54d6444">bigendian</a>);
<a name="l00466"></a>00466     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#abe5571b936ce0da0db7a6336d625f213">truecolor</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#abe5571b936ce0da0db7a6336d625f213">truecolor</a>);
<a name="l00467"></a>00467     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a40ff9e80e0652fb39b283fc578e94025">redmax</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a40ff9e80e0652fb39b283fc578e94025">redmax</a>);
<a name="l00468"></a>00468     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#ac34cf3e1c9756987bd25af5e57ef8a48">greenmax</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#ac34cf3e1c9756987bd25af5e57ef8a48">greenmax</a>);
<a name="l00469"></a>00469     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a0e278d5960ce0ece6cd4ea26617f96ed">bluemax</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a0e278d5960ce0ece6cd4ea26617f96ed">bluemax</a>);
<a name="l00470"></a>00470     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#ac8f7a0310e88b32ba6e3fbbbe5315e45">redshift</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#ac8f7a0310e88b32ba6e3fbbbe5315e45">redshift</a>);
<a name="l00471"></a>00471     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#adf9f1c6bcd4d79563426511ff07bb2cf">greenshift</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#adf9f1c6bcd4d79563426511ff07bb2cf">greenshift</a>);
<a name="l00472"></a>00472     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a197fc4e93801b040607276cc870df29d">blueshift</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(<a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a197fc4e93801b040607276cc870df29d">blueshift</a>);
<a name="l00473"></a>00473     memset(msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a35587c567b0346014a99bb0612dcb045">px</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#adbb602d416f59d5d4c7390338b9123a6">padding</a>, 0, 3);
<a name="l00474"></a>00474     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a85427570eb394ef573b685f3f1f49b73">namelen</a> = 2;
<a name="l00475"></a>00475     msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a85427570eb394ef573b685f3f1f49b73">namelen</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a85427570eb394ef573b685f3f1f49b73">namelen</a>);
<a name="l00476"></a>00476     memcpy(msg.<a class="code" href="structVncServer_1_1ServerInitMsg.html#a6eae06d81c2978c59247c84669d7a1db">name</a>, <span class="stringliteral">&quot;M5&quot;</span>, 2);
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;msg);
<a name="l00479"></a>00479     <a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a> = <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48bac56ddc35b07ffe7fe9bf209ce6d6d0da">NormalPhase</a>;
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <span class="keywordtype">void</span>
<a name="l00483"></a><a class="code" href="classVncServer.html#ab65743c48d80245bde24471369c01a73">00483</a> <a class="code" href="classVncServer.html#ab65743c48d80245bde24471369c01a73" title="Receive pixel foramt message from client and process it.">VncServer::setPixelFormat</a>()
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Received pixel format from client message\n&quot;</span>);
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <a class="code" href="structVncInput_1_1PixelFormatMessage.html">PixelFormatMessage</a> pfm;
<a name="l00488"></a>00488     <a class="code" href="classVncServer.html#acf12371863c1654c02f731dcbd6347e3" title="Read len -1 bytes from the client into the buffer provided + 1 assert that we read...">read1</a>((uint8_t*)&amp;pfm, <span class="keyword">sizeof</span>(<a class="code" href="structVncInput_1_1PixelFormatMessage.html">PixelFormatMessage</a>));
<a name="l00489"></a>00489 
<a name="l00490"></a>00490     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot; -- bpp = %d; depth = %d; be = %d\n&quot;</span>, pfm.px.bpp,
<a name="l00491"></a>00491             pfm.px.depth, pfm.px.bigendian);
<a name="l00492"></a>00492     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot; -- true color = %d red,green,blue max = %d,%d,%d\n&quot;</span>,
<a name="l00493"></a>00493             pfm.px.truecolor, <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.redmax), <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.greenmax),
<a name="l00494"></a>00494                 <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.bluemax));
<a name="l00495"></a>00495     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot; -- red,green,blue shift = %d,%d,%d\n&quot;</span>, pfm.px.redshift,
<a name="l00496"></a>00496             pfm.px.greenshift, pfm.px.blueshift);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="keywordflow">if</span> (<a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.bpp) != <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#aa3feeb1f67607d22edf7f15034f8ef68">bpp</a> ||
<a name="l00499"></a>00499         <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.depth) != <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a07ea04bcb9b239cf2e7fed49bb0d7bca">depth</a> ||
<a name="l00500"></a>00500         <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.bigendian) != <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a8cb85ecac4677cfe3fdc8e20c54d6444">bigendian</a> ||
<a name="l00501"></a>00501         <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.truecolor) != <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#abe5571b936ce0da0db7a6336d625f213">truecolor</a> ||
<a name="l00502"></a>00502         <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.redmax) != <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a40ff9e80e0652fb39b283fc578e94025">redmax</a> ||
<a name="l00503"></a>00503         <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.greenmax) != <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#ac34cf3e1c9756987bd25af5e57ef8a48">greenmax</a> ||
<a name="l00504"></a>00504         <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.bluemax) != <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a0e278d5960ce0ece6cd4ea26617f96ed">bluemax</a> ||
<a name="l00505"></a>00505         <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.redshift) != <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#ac8f7a0310e88b32ba6e3fbbbe5315e45">redshift</a> ||
<a name="l00506"></a>00506         <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.greenshift) != <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#adf9f1c6bcd4d79563426511ff07bb2cf">greenshift</a> ||
<a name="l00507"></a>00507         <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pfm.px.blueshift) != <a class="code" href="classVncServer.html#abbe93902e089fd4b2743856104e47040" title="The one and only pixel format we support.">pixelFormat</a>.<a class="code" href="structVncInput_1_1PixelFormat.html#a197fc4e93801b040607276cc870df29d">blueshift</a>)
<a name="l00508"></a>00508         <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;VNC client doesn&apos;t support true color raw encoding\n&quot;</span>);
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 
<a name="l00511"></a>00511 <span class="keywordtype">void</span>
<a name="l00512"></a><a class="code" href="classVncServer.html#aebd5a4ca7014f94d4f8a2cda28e2f574">00512</a> <a class="code" href="classVncServer.html#aebd5a4ca7014f94d4f8a2cda28e2f574" title="Receive encodings message from client and process it.">VncServer::setEncodings</a>()
<a name="l00513"></a>00513 {
<a name="l00514"></a>00514     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Received supported encodings from client\n&quot;</span>);
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     <a class="code" href="structVncInput_1_1PixelEncodingsMessage.html">PixelEncodingsMessage</a> pem;
<a name="l00517"></a>00517     <a class="code" href="classVncServer.html#acf12371863c1654c02f731dcbd6347e3" title="Read len -1 bytes from the client into the buffer provided + 1 assert that we read...">read1</a>((uint8_t*)&amp;pem, <span class="keyword">sizeof</span>(<a class="code" href="structVncInput_1_1PixelEncodingsMessage.html">PixelEncodingsMessage</a>));
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     pem.num_encodings = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pem.num_encodings);
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot; -- %d encoding present\n&quot;</span>, pem.num_encodings);
<a name="l00522"></a>00522     <a class="code" href="classVncServer.html#ac1725b64c8a1f83c2dfffc086700f226" title="If the vnc client supports receiving raw data.">supportsRawEnc</a> = <a class="code" href="classVncServer.html#a68f3455adec923af59d8e5725cc2d9ce" title="If the vnc client supports the desktop resize command.">supportsResizeEnc</a> = <span class="keyword">false</span>;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> = 0; <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> &lt; pem.num_encodings; <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a>++) {
<a name="l00525"></a>00525         int32_t <a class="code" href="namespaceArmISA.html#ace5471290648d600af8f1bad2c3990bf">encoding</a>;
<a name="l00526"></a>00526         <span class="keywordtype">size_t</span> <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a> <a class="code" href="namespaceArmISA.html#a7bca404a37e7db0156c4b14dad12c18f">M5_VAR_USED</a>;
<a name="l00527"></a>00527         <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a> = <a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client.">read</a>(&amp;encoding);
<a name="l00528"></a>00528         assert(<a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a> == <span class="keyword">sizeof</span>(encoding));
<a name="l00529"></a>00529         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot; -- supports %d\n&quot;</span>, <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(encoding));
<a name="l00530"></a>00530 
<a name="l00531"></a>00531         <span class="keywordflow">switch</span> (<a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(encoding)) {
<a name="l00532"></a>00532           <span class="keywordflow">case</span> <a class="code" href="group__VncConstants.html#ggaf2ec2d36ca464f7b420fd9435eb1ec79a7c8c7847952878a9db49c3bb1209200e">EncodingRaw</a>:
<a name="l00533"></a>00533             <a class="code" href="classVncServer.html#ac1725b64c8a1f83c2dfffc086700f226" title="If the vnc client supports receiving raw data.">supportsRawEnc</a> = <span class="keyword">true</span>;
<a name="l00534"></a>00534             <span class="keywordflow">break</span>;
<a name="l00535"></a>00535           <span class="keywordflow">case</span> <a class="code" href="group__VncConstants.html#ggaf2ec2d36ca464f7b420fd9435eb1ec79a7f90caa3af5acf5d644bcb23945e6802">EncodingDesktopSize</a>:
<a name="l00536"></a>00536             <a class="code" href="classVncServer.html#a68f3455adec923af59d8e5725cc2d9ce" title="If the vnc client supports the desktop resize command.">supportsResizeEnc</a> = <span class="keyword">true</span>;
<a name="l00537"></a>00537             <span class="keywordflow">break</span>;
<a name="l00538"></a>00538         }
<a name="l00539"></a>00539     }
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     <span class="keywordflow">if</span> (!<a class="code" href="classVncServer.html#ac1725b64c8a1f83c2dfffc086700f226" title="If the vnc client supports receiving raw data.">supportsRawEnc</a>)
<a name="l00542"></a>00542         <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;VNC clients must always support raw encoding\n&quot;</span>);
<a name="l00543"></a>00543 }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 <span class="keywordtype">void</span>
<a name="l00546"></a><a class="code" href="classVncServer.html#a0a0df1bd2f4bb8f12e9860bb8e51f731">00546</a> <a class="code" href="classVncServer.html#a0a0df1bd2f4bb8f12e9860bb8e51f731" title="Receive message from client asking for updated frame buffer.">VncServer::requestFbUpdate</a>()
<a name="l00547"></a>00547 {
<a name="l00548"></a>00548     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Received frame buffer update request from client\n&quot;</span>);
<a name="l00549"></a>00549 
<a name="l00550"></a>00550     <a class="code" href="structVncInput_1_1FrameBufferUpdateReq.html">FrameBufferUpdateReq</a> fbr;
<a name="l00551"></a>00551     <a class="code" href="classVncServer.html#acf12371863c1654c02f731dcbd6347e3" title="Read len -1 bytes from the client into the buffer provided + 1 assert that we read...">read1</a>((uint8_t*)&amp;fbr, <span class="keyword">sizeof</span>(<a class="code" href="structVncInput_1_1FrameBufferUpdateReq.html">FrameBufferUpdateReq</a>));
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     fbr.x = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(fbr.x);
<a name="l00554"></a>00554     fbr.y = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(fbr.y);
<a name="l00555"></a>00555     fbr.width = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(fbr.width);
<a name="l00556"></a>00556     fbr.height = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(fbr.height);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot; -- x = %d y = %d w = %d h = %d\n&quot;</span>, fbr.x, fbr.y, fbr.width,
<a name="l00559"></a>00559             fbr.height);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     <a class="code" href="classVncServer.html#a5f88128dc2185a16b86d7e5476cab793" title="Send a updated frame buffer to the client.">sendFrameBufferUpdate</a>();
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 <span class="keywordtype">void</span>
<a name="l00565"></a><a class="code" href="classVncServer.html#a41d8502edc3a2aaea2ce0255e40d93bd">00565</a> <a class="code" href="classVncServer.html#a41d8502edc3a2aaea2ce0255e40d93bd" title="Receive message from client providing new keyboard input.">VncServer::recvKeyboardInput</a>()
<a name="l00566"></a>00566 {
<a name="l00567"></a>00567     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Received keyboard input from client\n&quot;</span>);
<a name="l00568"></a>00568     <a class="code" href="structVncInput_1_1KeyEventMessage.html">KeyEventMessage</a> kem;
<a name="l00569"></a>00569     <a class="code" href="classVncServer.html#acf12371863c1654c02f731dcbd6347e3" title="Read len -1 bytes from the client into the buffer provided + 1 assert that we read...">read1</a>((uint8_t*)&amp;kem, <span class="keyword">sizeof</span>(<a class="code" href="structVncInput_1_1KeyEventMessage.html">KeyEventMessage</a>));
<a name="l00570"></a>00570 
<a name="l00571"></a>00571     kem.key = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(kem.key);
<a name="l00572"></a>00572     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot; -- received key code %d (%s)\n&quot;</span>, kem.key, kem.down_flag ?
<a name="l00573"></a>00573             <span class="stringliteral">&quot;down&quot;</span> : <span class="stringliteral">&quot;up&quot;</span>);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <span class="keywordflow">if</span> (<a class="code" href="classVncInput.html#a7d7513b80940940f0b7daf941d774e7f" title="The device to notify when we get key events.">keyboard</a>)
<a name="l00576"></a>00576         <a class="code" href="classVncInput.html#a7d7513b80940940f0b7daf941d774e7f" title="The device to notify when we get key events.">keyboard</a>-&gt;<a class="code" href="classVncKeyboard.html#a48c20c58cb6efaff54c207c2e7e4393e" title="Called when the vnc server receives a key press event from the client.">keyPress</a>(kem.key, kem.down_flag);
<a name="l00577"></a>00577 }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579 <span class="keywordtype">void</span>
<a name="l00580"></a><a class="code" href="classVncServer.html#aa8b6d7d106d2e8ab9015d1bcb7a0d7ee">00580</a> <a class="code" href="classVncServer.html#aa8b6d7d106d2e8ab9015d1bcb7a0d7ee" title="Recv message from client providing new mouse movement or button click.">VncServer::recvPointerInput</a>()
<a name="l00581"></a>00581 {
<a name="l00582"></a>00582     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Received pointer input from client\n&quot;</span>);
<a name="l00583"></a>00583     <a class="code" href="structVncInput_1_1PointerEventMessage.html">PointerEventMessage</a> pem;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <a class="code" href="classVncServer.html#acf12371863c1654c02f731dcbd6347e3" title="Read len -1 bytes from the client into the buffer provided + 1 assert that we read...">read1</a>((uint8_t*)&amp;pem, <span class="keyword">sizeof</span>(<a class="code" href="structVncInput_1_1PointerEventMessage.html">PointerEventMessage</a>));;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     pem.x = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pem.x);
<a name="l00588"></a>00588     pem.y = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(pem.y);
<a name="l00589"></a>00589     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot; -- pointer at x = %d y = %d buttons = %#x\n&quot;</span>, pem.x, pem.y,
<a name="l00590"></a>00590             pem.button_mask);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (<a class="code" href="classVncInput.html#a8847357449ef58083f563889cf883120" title="The device to notify when we get mouse events.">mouse</a>)
<a name="l00593"></a>00593         <a class="code" href="classVncInput.html#a8847357449ef58083f563889cf883120" title="The device to notify when we get mouse events.">mouse</a>-&gt;<a class="code" href="classVncMouse.html#aaf4e9277a1c1cd44beeee1a72baa88c0" title="called whenever the mouse moves or it&amp;#39;s button state changes buttons is a simple...">mouseAt</a>(pem.x, pem.y, pem.button_mask);
<a name="l00594"></a>00594 }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596 <span class="keywordtype">void</span>
<a name="l00597"></a><a class="code" href="classVncServer.html#ab65cf6f13c32d021e072942f65be57e6">00597</a> <a class="code" href="classVncServer.html#ab65cf6f13c32d021e072942f65be57e6" title="Receive message from client that there is text in it&amp;#39;s paste buffer.">VncServer::recvCutText</a>()
<a name="l00598"></a>00598 {
<a name="l00599"></a>00599     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Received client copy buffer message\n&quot;</span>);
<a name="l00600"></a>00600 
<a name="l00601"></a>00601     <a class="code" href="structVncInput_1_1ClientCutTextMessage.html">ClientCutTextMessage</a> cct;
<a name="l00602"></a>00602     <a class="code" href="classVncServer.html#acf12371863c1654c02f731dcbd6347e3" title="Read len -1 bytes from the client into the buffer provided + 1 assert that we read...">read1</a>((uint8_t*)&amp;cct, <span class="keyword">sizeof</span>(<a class="code" href="structVncInput_1_1ClientCutTextMessage.html">ClientCutTextMessage</a>));
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="keywordtype">char</span> str[1025];
<a name="l00605"></a>00605     <span class="keywordtype">size_t</span> data_len = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(cct.length);
<a name="l00606"></a>00606     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;String length %d\n&quot;</span>, data_len);
<a name="l00607"></a>00607     <span class="keywordflow">while</span> (data_len &gt; 0) {
<a name="l00608"></a>00608         <span class="keywordtype">size_t</span> <a class="code" href="namespaceArmISA.html#a66ba49a199b7663294cb7eaba4654127">len</a>;
<a name="l00609"></a>00609         <span class="keywordtype">size_t</span> bytes_to_read = data_len &gt; 1024 ? 1024 : data_len;
<a name="l00610"></a>00610         len = <a class="code" href="classVncServer.html#ae3feffb2200f0774caeaf087786de498" title="Read some data from the client.">read</a>((uint8_t*)&amp;str, bytes_to_read);
<a name="l00611"></a>00611         str[bytes_to_read] = 0;
<a name="l00612"></a>00612         assert(len &gt;= data_len);
<a name="l00613"></a>00613         data_len -= len;
<a name="l00614"></a>00614         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Buffer: %s\n&quot;</span>, str);
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 <span class="keywordtype">void</span>
<a name="l00621"></a><a class="code" href="classVncServer.html#a5f88128dc2185a16b86d7e5476cab793">00621</a> <a class="code" href="classVncServer.html#a5f88128dc2185a16b86d7e5476cab793" title="Send a updated frame buffer to the client.">VncServer::sendFrameBufferUpdate</a>()
<a name="l00622"></a>00622 {
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a> &lt;= 0 || <a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a> != <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48bac56ddc35b07ffe7fe9bf209ce6d6d0da">NormalPhase</a> || !<a class="code" href="classVncServer.html#a780da49a2c1ca54746dcf2036f29f514" title="An update needs to be sent to the client.">sendUpdate</a>) {
<a name="l00625"></a>00625         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;NOT sending framebuffer update\n&quot;</span>);
<a name="l00626"></a>00626         <span class="keywordflow">return</span>;
<a name="l00627"></a>00627     }
<a name="l00628"></a>00628 
<a name="l00629"></a>00629     <span class="comment">// The client will request data constantly, unless we throttle it</span>
<a name="l00630"></a>00630     <a class="code" href="classVncServer.html#a780da49a2c1ca54746dcf2036f29f514" title="An update needs to be sent to the client.">sendUpdate</a> = <span class="keyword">false</span>;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Sending framebuffer update\n&quot;</span>);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <a class="code" href="structVncServer_1_1FrameBufferUpdate.html">FrameBufferUpdate</a> fbu;
<a name="l00635"></a>00635     <a class="code" href="structVncServer_1_1FrameBufferRect.html">FrameBufferRect</a> fbr;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     fbu.<a class="code" href="structVncServer_1_1FrameBufferUpdate.html#ab727bea119f8a43f89a77db6910e5e63">type</a> = <a class="code" href="group__VncConstants.html#gga39e65b5e3d0a50fbeb236ab76585ef1fa1c26295104061cc595484d5fd26e116d">ServerFrameBufferUpdate</a>;
<a name="l00638"></a>00638     fbu.<a class="code" href="structVncServer_1_1FrameBufferUpdate.html#aec02a5d2cf73f218111f751d7b884a7b">num_rects</a> = 1;
<a name="l00639"></a>00639     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a931a9a0d0283540bac273604c9c71125">x</a> = 0;
<a name="l00640"></a>00640     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a23da8bdc88a4ed0c0ef4f66a56bdc246">y</a> = 0;
<a name="l00641"></a>00641     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#ab8895f40b17c8c4710b7d7e76016e0a7">width</a> = <a class="code" href="classVncInput.html#a9aaafa4bc016017a7caefbfb49dc47fe" title="What is the width of the screen we&amp;#39;re displaying.">videoWidth</a>();
<a name="l00642"></a>00642     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#af64cb3558e963763bdb6755f68ff7b53">height</a> = <a class="code" href="classVncInput.html#afa4b0b5ed40e158beb56c52c0fe344d8" title="What is the height of the screen we&amp;#39;re displaying.">videoHeight</a>();
<a name="l00643"></a>00643     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#aa032f3889fd2fc8979d4eb0caf7b6100">encoding</a> = <a class="code" href="group__VncConstants.html#ggaf2ec2d36ca464f7b420fd9435eb1ec79a7c8c7847952878a9db49c3bb1209200e">EncodingRaw</a>;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     <span class="comment">// fix up endian</span>
<a name="l00646"></a>00646     fbu.<a class="code" href="structVncServer_1_1FrameBufferUpdate.html#aec02a5d2cf73f218111f751d7b884a7b">num_rects</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbu.<a class="code" href="structVncServer_1_1FrameBufferUpdate.html#aec02a5d2cf73f218111f751d7b884a7b">num_rects</a>);
<a name="l00647"></a>00647     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a931a9a0d0283540bac273604c9c71125">x</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a931a9a0d0283540bac273604c9c71125">x</a>);
<a name="l00648"></a>00648     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a23da8bdc88a4ed0c0ef4f66a56bdc246">y</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a23da8bdc88a4ed0c0ef4f66a56bdc246">y</a>);
<a name="l00649"></a>00649     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#ab8895f40b17c8c4710b7d7e76016e0a7">width</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#ab8895f40b17c8c4710b7d7e76016e0a7">width</a>);
<a name="l00650"></a>00650     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#af64cb3558e963763bdb6755f68ff7b53">height</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#af64cb3558e963763bdb6755f68ff7b53">height</a>);
<a name="l00651"></a>00651     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#aa032f3889fd2fc8979d4eb0caf7b6100">encoding</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#aa032f3889fd2fc8979d4eb0caf7b6100">encoding</a>);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     <span class="comment">// send headers to client</span>
<a name="l00654"></a>00654     <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;fbu);
<a name="l00655"></a>00655     <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;fbr);
<a name="l00656"></a>00656 
<a name="l00657"></a>00657     assert(<a class="code" href="classVncInput.html#ac08e16522180a86a754257c09bf108e4" title="pointer to the actual data that is stored in the frame buffer device">fb</a>);
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     <a class="code" href="classstd_1_1vector.html">std::vector&lt;uint8_t&gt;</a> line_buffer(<a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#aa836e9f9f3a906bd83acf1086b57d7be" title="Bytes per pixel when stored in memory (including padding).">length</a> * <a class="code" href="classVncInput.html#ac08e16522180a86a754257c09bf108e4" title="pointer to the actual data that is stored in the frame buffer device">fb</a>-&gt;<a class="code" href="classFrameBuffer.html#a8b2bf3db9e6cd82897889d5e12cdb258" title="Frame buffer width in pixels.">width</a>());
<a name="l00660"></a>00660     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> y = 0; y &lt; <a class="code" href="classVncInput.html#ac08e16522180a86a754257c09bf108e4" title="pointer to the actual data that is stored in the frame buffer device">fb</a>-&gt;<a class="code" href="classFrameBuffer.html#a5570a882b91d72f42035f75761bf458f" title="Frame buffer height in pixels.">height</a>(); ++y) {
<a name="l00661"></a>00661         <span class="comment">// Convert and send a line at a time</span>
<a name="l00662"></a>00662         uint8_t *raw_pixel(line_buffer.data());
<a name="l00663"></a>00663         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> = 0; <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> &lt; <a class="code" href="classVncInput.html#ac08e16522180a86a754257c09bf108e4" title="pointer to the actual data that is stored in the frame buffer device">fb</a>-&gt;<a class="code" href="classFrameBuffer.html#a8b2bf3db9e6cd82897889d5e12cdb258" title="Frame buffer width in pixels.">width</a>(); ++<a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a>) {
<a name="l00664"></a>00664             <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#a786e16ef5b59a62281a541b496ffaaf3" title="Convert a Pixel into a color word.">fromPixel</a>(raw_pixel, <a class="code" href="classVncInput.html#ac08e16522180a86a754257c09bf108e4" title="pointer to the actual data that is stored in the frame buffer device">fb</a>-&gt;<a class="code" href="classFrameBuffer.html#adc71f98bff7dd104a706dcbd5a66d74e" title="Get a pixel from an (x, y) coordinate.">pixel</a>(<a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a>, y));
<a name="l00665"></a>00665             raw_pixel += <a class="code" href="classVncServer.html#af6a17d40368ed96831137f860e5aca33">pixelConverter</a>.<a class="code" href="classPixelConverter.html#aa836e9f9f3a906bd83acf1086b57d7be" title="Bytes per pixel when stored in memory (including padding).">length</a>;
<a name="l00666"></a>00666         }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668         <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(line_buffer.data(), line_buffer.size());
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 <span class="keywordtype">void</span>
<a name="l00673"></a><a class="code" href="classVncServer.html#ad5551c5f7c21a433825ca20ff6ebd7f5">00673</a> <a class="code" href="classVncServer.html#ad5551c5f7c21a433825ca20ff6ebd7f5" title="Tell the client that the frame buffer resized.">VncServer::sendFrameBufferResized</a>()
<a name="l00674"></a>00674 {
<a name="l00675"></a>00675     assert(<a class="code" href="classVncInput.html#ac08e16522180a86a754257c09bf108e4" title="pointer to the actual data that is stored in the frame buffer device">fb</a> &amp;&amp; <a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a> &gt; 0 &amp;&amp; <a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a> == <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48bac56ddc35b07ffe7fe9bf209ce6d6d0da">NormalPhase</a>);
<a name="l00676"></a>00676     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(VNC, <span class="stringliteral">&quot;Sending framebuffer resize\n&quot;</span>);
<a name="l00677"></a>00677 
<a name="l00678"></a>00678     <a class="code" href="structVncServer_1_1FrameBufferUpdate.html">FrameBufferUpdate</a> fbu;
<a name="l00679"></a>00679     <a class="code" href="structVncServer_1_1FrameBufferRect.html">FrameBufferRect</a> fbr;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     fbu.<a class="code" href="structVncServer_1_1FrameBufferUpdate.html#ab727bea119f8a43f89a77db6910e5e63">type</a> = <a class="code" href="group__VncConstants.html#gga39e65b5e3d0a50fbeb236ab76585ef1fa1c26295104061cc595484d5fd26e116d">ServerFrameBufferUpdate</a>;
<a name="l00682"></a>00682     fbu.<a class="code" href="structVncServer_1_1FrameBufferUpdate.html#aec02a5d2cf73f218111f751d7b884a7b">num_rects</a> = 1;
<a name="l00683"></a>00683     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a931a9a0d0283540bac273604c9c71125">x</a> = 0;
<a name="l00684"></a>00684     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a23da8bdc88a4ed0c0ef4f66a56bdc246">y</a> = 0;
<a name="l00685"></a>00685     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#ab8895f40b17c8c4710b7d7e76016e0a7">width</a> = <a class="code" href="classVncInput.html#a9aaafa4bc016017a7caefbfb49dc47fe" title="What is the width of the screen we&amp;#39;re displaying.">videoWidth</a>();
<a name="l00686"></a>00686     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#af64cb3558e963763bdb6755f68ff7b53">height</a> = <a class="code" href="classVncInput.html#afa4b0b5ed40e158beb56c52c0fe344d8" title="What is the height of the screen we&amp;#39;re displaying.">videoHeight</a>();
<a name="l00687"></a>00687     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#aa032f3889fd2fc8979d4eb0caf7b6100">encoding</a> = <a class="code" href="group__VncConstants.html#ggaf2ec2d36ca464f7b420fd9435eb1ec79a7f90caa3af5acf5d644bcb23945e6802">EncodingDesktopSize</a>;
<a name="l00688"></a>00688 
<a name="l00689"></a>00689     <span class="comment">// fix up endian</span>
<a name="l00690"></a>00690     fbu.<a class="code" href="structVncServer_1_1FrameBufferUpdate.html#aec02a5d2cf73f218111f751d7b884a7b">num_rects</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbu.<a class="code" href="structVncServer_1_1FrameBufferUpdate.html#aec02a5d2cf73f218111f751d7b884a7b">num_rects</a>);
<a name="l00691"></a>00691     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a931a9a0d0283540bac273604c9c71125">x</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a931a9a0d0283540bac273604c9c71125">x</a>);
<a name="l00692"></a>00692     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a23da8bdc88a4ed0c0ef4f66a56bdc246">y</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#a23da8bdc88a4ed0c0ef4f66a56bdc246">y</a>);
<a name="l00693"></a>00693     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#ab8895f40b17c8c4710b7d7e76016e0a7">width</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#ab8895f40b17c8c4710b7d7e76016e0a7">width</a>);
<a name="l00694"></a>00694     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#af64cb3558e963763bdb6755f68ff7b53">height</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#af64cb3558e963763bdb6755f68ff7b53">height</a>);
<a name="l00695"></a>00695     fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#aa032f3889fd2fc8979d4eb0caf7b6100">encoding</a> = <a class="code" href="byteswap_8hh.html#a0ec9bd801b3cff46ad2537234f1f1a67">htobe</a>(fbr.<a class="code" href="structVncServer_1_1FrameBufferRect.html#aa032f3889fd2fc8979d4eb0caf7b6100">encoding</a>);
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     <span class="comment">// send headers to client</span>
<a name="l00698"></a>00698     <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;fbu);
<a name="l00699"></a>00699     <a class="code" href="classVncServer.html#a6e201558a77a6da3ef9a1568c4ea6bb6" title="Write a buffer to the client.">write</a>(&amp;fbr);
<a name="l00700"></a>00700 
<a name="l00701"></a>00701     <span class="comment">// No actual data is sent in this message</span>
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704 <span class="keywordtype">void</span>
<a name="l00705"></a><a class="code" href="classVncServer.html#a47649ffe97f2a93fed319cb4f8dee785">00705</a> <a class="code" href="classVncServer.html#a47649ffe97f2a93fed319cb4f8dee785" title="The frame buffer uses this call to notify the vnc server that the frame buffer has...">VncServer::setDirty</a>()
<a name="l00706"></a>00706 {
<a name="l00707"></a>00707     <a class="code" href="classVncServer.html#a47649ffe97f2a93fed319cb4f8dee785" title="The frame buffer uses this call to notify the vnc server that the frame buffer has...">VncInput::setDirty</a>();
<a name="l00708"></a>00708 
<a name="l00709"></a>00709     <a class="code" href="classVncServer.html#a780da49a2c1ca54746dcf2036f29f514" title="An update needs to be sent to the client.">sendUpdate</a> = <span class="keyword">true</span>;
<a name="l00710"></a>00710     <a class="code" href="classVncServer.html#a5f88128dc2185a16b86d7e5476cab793" title="Send a updated frame buffer to the client.">sendFrameBufferUpdate</a>();
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713 <span class="keywordtype">void</span>
<a name="l00714"></a><a class="code" href="classVncServer.html#ab2900d4d2958834d5410a31b1ad1496c">00714</a> <a class="code" href="classVncServer.html#ab2900d4d2958834d5410a31b1ad1496c">VncServer::frameBufferResized</a>()
<a name="l00715"></a>00715 {
<a name="l00716"></a>00716     <span class="keywordflow">if</span> (<a class="code" href="classVncServer.html#a32dd22794cf1940fc8a56dbf9c3da80f">dataFd</a> &gt; 0 &amp;&amp; <a class="code" href="classVncServer.html#acd2368dc88c095bff0d7e634f5970a72" title="The rfb prototol state the connection is in.">curState</a> == <a class="code" href="group__VncConstants.html#gga7681da281b4f880f16a098088473b48bac56ddc35b07ffe7fe9bf209ce6d6d0da">NormalPhase</a>) {
<a name="l00717"></a>00717         <span class="keywordflow">if</span> (<a class="code" href="classVncServer.html#a68f3455adec923af59d8e5725cc2d9ce" title="If the vnc client supports the desktop resize command.">supportsResizeEnc</a>)
<a name="l00718"></a>00718             <a class="code" href="classVncServer.html#ad5551c5f7c21a433825ca20ff6ebd7f5" title="Tell the client that the frame buffer resized.">sendFrameBufferResized</a>();
<a name="l00719"></a>00719         <span class="keywordflow">else</span>
<a name="l00720"></a>00720             <span class="comment">// The frame buffer changed size and we can&apos;t update the client</span>
<a name="l00721"></a>00721             <a class="code" href="classVncServer.html#a0f216d620baac19364b796cb64e6d398">detach</a>();
<a name="l00722"></a>00722     }
<a name="l00723"></a>00723 }
<a name="l00724"></a>00724 
<a name="l00725"></a>00725 <span class="comment">// create the VNC server object</span>
<a name="l00726"></a>00726 <a class="code" href="classVncServer.html">VncServer</a> *
<a name="l00727"></a>00727 VncServerParams::create()
<a name="l00728"></a>00728 {
<a name="l00729"></a>00729     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classVncServer.html#af33bb287e0380d4456c43542f195e1b2" title="VncServer.">VncServer</a>(<span class="keyword">this</span>);
<a name="l00730"></a>00730 }
<a name="l00731"></a>00731 
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"><address style="align: right;"><small>
Generated on Mon Dec 7 02:33:08 2015 for gem5 by <a href="http://www.doxygen.org/index.html"> doxygen</a> 1.6.1</small></address>

</body>
</html>
