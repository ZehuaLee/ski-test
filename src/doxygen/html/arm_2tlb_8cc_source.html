<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>gem5: arch/arm/tlb.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>arch/arm/tlb.cc</h1><a href="arm_2tlb_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2010-2013 ARM Limited</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * The license below extends only to copyright in the software and shall</span>
<a name="l00006"></a>00006 <span class="comment"> * not be construed as granting a license to any other intellectual</span>
<a name="l00007"></a>00007 <span class="comment"> * property including but not limited to intellectual property relating</span>
<a name="l00008"></a>00008 <span class="comment"> * to a hardware implementation of the functionality of the software</span>
<a name="l00009"></a>00009 <span class="comment"> * licensed hereunder.  You may use the software subject to the license</span>
<a name="l00010"></a>00010 <span class="comment"> * terms below provided that you ensure that this notice is replicated</span>
<a name="l00011"></a>00011 <span class="comment"> * unmodified and in its entirety in all distributions of the software,</span>
<a name="l00012"></a>00012 <span class="comment"> * modified or unmodified, in source code or in binary form.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * Copyright (c) 2001-2005 The Regents of The University of Michigan</span>
<a name="l00015"></a>00015 <span class="comment"> * All rights reserved.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00018"></a>00018 <span class="comment"> * modification, are permitted provided that the following conditions are</span>
<a name="l00019"></a>00019 <span class="comment"> * met: redistributions of source code must retain the above copyright</span>
<a name="l00020"></a>00020 <span class="comment"> * notice, this list of conditions and the following disclaimer;</span>
<a name="l00021"></a>00021 <span class="comment"> * redistributions in binary form must reproduce the above copyright</span>
<a name="l00022"></a>00022 <span class="comment"> * notice, this list of conditions and the following disclaimer in the</span>
<a name="l00023"></a>00023 <span class="comment"> * documentation and/or other materials provided with the distribution;</span>
<a name="l00024"></a>00024 <span class="comment"> * neither the name of the copyright holders nor the names of its</span>
<a name="l00025"></a>00025 <span class="comment"> * contributors may be used to endorse or promote products derived from</span>
<a name="l00026"></a>00026 <span class="comment"> * this software without specific prior written permission.</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00029"></a>00029 <span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00030"></a>00030 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00031"></a>00031 <span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="l00032"></a>00032 <span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00033"></a>00033 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="l00034"></a>00034 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00035"></a>00035 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00036"></a>00036 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00037"></a>00037 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00038"></a>00038 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00039"></a>00039 <span class="comment"> *</span>
<a name="l00040"></a>00040 <span class="comment"> * Authors: Ali Saidi</span>
<a name="l00041"></a>00041 <span class="comment"> *          Nathan Binkert</span>
<a name="l00042"></a>00042 <span class="comment"> *          Steve Reinhardt</span>
<a name="l00043"></a>00043 <span class="comment"> */</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="arm_2tlb_8hh.html">arch/arm/tlb.hh</a>&quot;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;memory&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="arch_2arm_2faults_8hh.html">arch/arm/faults.hh</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="arm_2pagetable_8hh.html">arch/arm/pagetable.hh</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="arch_2arm_2system_8hh.html">arch/arm/system.hh</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="table__walker_8hh.html">arch/arm/table_walker.hh</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="stage2__lookup_8hh.html">arch/arm/stage2_lookup.hh</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="stage2__mmu_8hh.html">arch/arm/stage2_mmu.hh</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="arm_2utility_8hh.html">arch/arm/utility.hh</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="inifile_8hh.html" title="Declaration of IniFile object.">base/inifile.hh</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="str_8hh.html">base/str.hh</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="base_2trace_8hh.html">base/trace.hh</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="cpu_2base_8hh.html">cpu/base.hh</a>&quot;</span>
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="thread__context_8hh.html">cpu/thread_context.hh</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;debug/Checkpoint.hh&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;debug/TLB.hh&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;debug/TLBVerbose.hh&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="page__table_8hh.html" title="Declarations of a non-full system Page Table.">mem/page_table.hh</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;params/ArmTLB.hh&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="full__system_8hh.html">sim/full_system.hh</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="sim_2process_8hh.html">sim/process.hh</a>&quot;</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="keyword">using namespace </span>std;
<a name="l00072"></a>00072 <span class="keyword">using namespace </span>ArmISA;
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="classArmISA_1_1TLB.html#ae58edb2d376d7408e0191f42c6bba423">00074</a> TLB::TLB(<span class="keyword">const</span> ArmTLBParams *<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>)
<a name="l00075"></a>00075     : <a class="code" href="classBaseTLB.html">BaseTLB</a>(p), table(new <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a>[p-&gt;size]), size(p-&gt;size),
<a name="l00076"></a>00076       isStage2(p-&gt;is_stage2), stage2Req(false), _attr(0),
<a name="l00077"></a>00077       directToStage2(false), tableWalker(p-&gt;walker), stage2Tlb(NULL),
<a name="l00078"></a>00078       stage2Mmu(NULL), rangeMRU(1),
<a name="l00079"></a>00079       <a class="code" href="namespaceArmISA.html#a79293aabe9972f917d751c5072e55a48">aarch64</a>(false), aarch64EL(<a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98daec94daab9638b134b5dcc5b226c7c9c8">EL0</a>), isPriv(false), isSecure(false),
<a name="l00080"></a>00080       isHyp(false), <a class="code" href="namespaceArmISA.html#aaff4c7c57057268242cad9e94c8ff5d7">asid</a>(0), vmid(0), dacr(0),
<a name="l00081"></a>00081       miscRegValid(false), curTranType(NormalTran)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083     <a class="code" href="classArmISA_1_1TLB.html#ac2662183f0b2a9126911b2a57e632c42">tableWalker</a>-&gt;<a class="code" href="classArmISA_1_1TableWalker.html#af69a12f3372cc5b478e33f135c744bae">setTlb</a>(<span class="keyword">this</span>);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="comment">// Cache system-level properties</span>
<a name="l00086"></a>00086     <a class="code" href="classArmISA_1_1TLB.html#ac124897414ac526a624ea559da1ae7e4">haveLPAE</a> = <a class="code" href="classArmISA_1_1TLB.html#ac2662183f0b2a9126911b2a57e632c42">tableWalker</a>-&gt;<a class="code" href="classArmISA_1_1TableWalker.html#a0918955972c39e2c92995b38ab1bd72d">haveLPAE</a>();
<a name="l00087"></a>00087     <a class="code" href="classArmISA_1_1TLB.html#a1c4d7213d405a0b53006ea48ba800d0b">haveVirtualization</a> = <a class="code" href="classArmISA_1_1TLB.html#ac2662183f0b2a9126911b2a57e632c42">tableWalker</a>-&gt;<a class="code" href="classArmISA_1_1TableWalker.html#aec5b6c8fac1ceac2854891cbae34a79c">haveVirtualization</a>();
<a name="l00088"></a>00088     <a class="code" href="classArmISA_1_1TLB.html#a5ff7c41974308118cb7dcd6376d2a4d0">haveLargeAsid64</a> = <a class="code" href="classArmISA_1_1TLB.html#ac2662183f0b2a9126911b2a57e632c42">tableWalker</a>-&gt;<a class="code" href="classArmISA_1_1TableWalker.html#ad06aa1dd2480d5b43e1e73b7adb4d5ce">haveLargeAsid64</a>();
<a name="l00089"></a>00089 }
<a name="l00090"></a>00090 
<a name="l00091"></a><a class="code" href="classArmISA_1_1TLB.html#a9d8f87cca781927c8e02f95ea719a799">00091</a> <a class="code" href="classArmISA_1_1TLB.html#a9d8f87cca781927c8e02f95ea719a799">TLB::~TLB</a>()
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093     <span class="keyword">delete</span>[] <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>;
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="keywordtype">void</span>
<a name="l00097"></a><a class="code" href="classArmISA_1_1TLB.html#a76cd278cd95d40ece41d649819ebdbd0">00097</a> <a class="code" href="classArmISA_1_1TLB.html#a76cd278cd95d40ece41d649819ebdbd0" title="setup all the back pointers">TLB::init</a>()
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#ace3820ca2b565f0f7201ddad09327be9">stage2Mmu</a> &amp;&amp; !<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>)
<a name="l00100"></a>00100         <a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a> = <a class="code" href="classArmISA_1_1TLB.html#ace3820ca2b565f0f7201ddad09327be9">stage2Mmu</a>-&gt;<a class="code" href="classArmISA_1_1Stage2MMU.html#a2ce6f49e4c94667051eb1508dda5211f">stage2Tlb</a>();
<a name="l00101"></a>00101 }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="keywordtype">void</span>
<a name="l00104"></a><a class="code" href="classArmISA_1_1TLB.html#a8b1b779e7ad9164503afa65f537b67d6">00104</a> <a class="code" href="classArmISA_1_1TLB.html#a8b1b779e7ad9164503afa65f537b67d6">TLB::setMMU</a>(<a class="code" href="classArmISA_1_1Stage2MMU.html">Stage2MMU</a> *<a class="code" href="namespaceArmISA.html#ab3b9e641a2a1f7851dbd51bd3af42069">m</a>, <a class="code" href="request_8hh.html#ac366b729262fd8e7cbd3283da6f775cf">MasterID</a> master_id)
<a name="l00105"></a>00105 {
<a name="l00106"></a>00106     <a class="code" href="classArmISA_1_1TLB.html#ace3820ca2b565f0f7201ddad09327be9">stage2Mmu</a> = m;
<a name="l00107"></a>00107     <a class="code" href="classArmISA_1_1TLB.html#ac2662183f0b2a9126911b2a57e632c42">tableWalker</a>-&gt;<a class="code" href="classArmISA_1_1TableWalker.html#aed73caf7e44f5e37c524ae37624fb26d">setMMU</a>(m, master_id);
<a name="l00108"></a>00108 }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 <span class="keywordtype">bool</span>
<a name="l00111"></a><a class="code" href="classArmISA_1_1TLB.html#a693297f6f1f044fdbfa0a2eca885c215">00111</a> <a class="code" href="classArmISA_1_1TLB.html#a693297f6f1f044fdbfa0a2eca885c215" title="Do a functional lookup on the TLB (for debugging) and don&amp;#39;t modify any internal...">TLB::translateFunctional</a>(<a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceArmISA.html#aa9331aab1c34d5babc25ea53e521b708">va</a>, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> &amp;<a class="code" href="namespaceArmISA.html#a669a5d9343209851e234d5f2f7c573d5">pa</a>)
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113     <a class="code" href="classArmISA_1_1TLB.html#a55ca28e8f7ad5d1230db775656384008">updateMiscReg</a>(tc);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a>) {
<a name="l00116"></a>00116         assert(<a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>);
<a name="l00117"></a>00117         <span class="keywordflow">return</span> <a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>-&gt;<a class="code" href="classArmISA_1_1TLB.html#a693297f6f1f044fdbfa0a2eca885c215" title="Do a functional lookup on the TLB (for debugging) and don&amp;#39;t modify any internal...">translateFunctional</a>(tc, va, pa);
<a name="l00118"></a>00118     }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *<a class="code" href="namespaceArmISA.html#a300e2be8a75f735b68e3d6c321c28cd2">e</a> = <a class="code" href="classArmISA_1_1TLB.html#a7f267aa3f82802f19128f2cc0fa01766" title="Lookup an entry in the TLB.">lookup</a>(va, <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a>, <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>, <a class="code" href="classArmISA_1_1TLB.html#a37fb7444e14a925f74644836fe01bb8d">isHyp</a>, <a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>, <span class="keyword">true</span>, <span class="keyword">false</span>,
<a name="l00121"></a>00121                          <a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a> ? <a class="code" href="classArmISA_1_1TLB.html#a988fddb2d918607d96728869aa647c88">aarch64EL</a> : <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98dad1b4a69ba239877df9def4576845dfe5">EL1</a>);
<a name="l00122"></a>00122     <span class="keywordflow">if</span> (!e)
<a name="l00123"></a>00123         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00124"></a>00124     pa = e-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff7322ca730e3ca004347226176edb55">pAddr</a>(va);
<a name="l00125"></a>00125     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00126"></a>00126 }
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l00129"></a><a class="code" href="classArmISA_1_1TLB.html#a94a8c332610622e5cf6e070b7a525a8e">00129</a> <a class="code" href="classArmISA_1_1TLB.html#a94a8c332610622e5cf6e070b7a525a8e">TLB::finalizePhysical</a>(<a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>)<span class="keyword"> const</span>
<a name="l00130"></a>00130 <span class="keyword"></span>{
<a name="l00131"></a>00131     <span class="keywordflow">return</span> NoFault;
<a name="l00132"></a>00132 }
<a name="l00133"></a>00133 
<a name="l00134"></a>00134 <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a>*
<a name="l00135"></a><a class="code" href="classArmISA_1_1TLB.html#a7f267aa3f82802f19128f2cc0fa01766">00135</a> <a class="code" href="classArmISA_1_1TLB.html#a7f267aa3f82802f19128f2cc0fa01766" title="Lookup an entry in the TLB.">TLB::lookup</a>(<a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceArmISA.html#aa9331aab1c34d5babc25ea53e521b708">va</a>, uint16_t asn, uint8_t vmid, <span class="keywordtype">bool</span> hyp, <span class="keywordtype">bool</span> secure,
<a name="l00136"></a>00136             <span class="keywordtype">bool</span> functional, <span class="keywordtype">bool</span> ignore_asn, uint8_t target_el)
<a name="l00137"></a>00137 {
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *retval = NULL;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="comment">// Maintaining LRU array</span>
<a name="l00142"></a>00142     <span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> = 0;
<a name="l00143"></a>00143     <span class="keywordflow">while</span> (retval == NULL &amp;&amp; x &lt; <a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>) {
<a name="l00144"></a>00144         <span class="keywordflow">if</span> ((!ignore_asn &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[x].match(va, asn, vmid, hyp, secure, <span class="keyword">false</span>,
<a name="l00145"></a>00145              target_el)) ||
<a name="l00146"></a>00146             (ignore_asn &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[x].match(va, vmid, hyp, secure, target_el))) {
<a name="l00147"></a>00147             <span class="comment">// We only move the hit entry ahead when the position is higher</span>
<a name="l00148"></a>00148             <span class="comment">// than rangeMRU</span>
<a name="l00149"></a>00149             <span class="keywordflow">if</span> (x &gt; <a class="code" href="classArmISA_1_1TLB.html#ab9c80953ba1c13b5952117b5c8d38c3a">rangeMRU</a> &amp;&amp; !functional) {
<a name="l00150"></a>00150                 <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> tmp_entry = <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[x];
<a name="l00151"></a>00151                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = x; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &gt; 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>--)
<a name="l00152"></a>00152                     <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>] = <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> - 1];
<a name="l00153"></a>00153                 <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[0] = tmp_entry;
<a name="l00154"></a>00154                 retval = &amp;<a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[0];
<a name="l00155"></a>00155             } <span class="keywordflow">else</span> {
<a name="l00156"></a>00156                 retval = &amp;<a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[x];
<a name="l00157"></a>00157             }
<a name="l00158"></a>00158             <span class="keywordflow">break</span>;
<a name="l00159"></a>00159         }
<a name="l00160"></a>00160         ++x;
<a name="l00161"></a>00161     }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(TLBVerbose, <span class="stringliteral">&quot;Lookup %#x, asn %#x -&gt; %s vmn 0x%x hyp %d secure %d &quot;</span>
<a name="l00164"></a>00164             <span class="stringliteral">&quot;ppn %#x size: %#x pa: %#x ap:%d ns:%d nstid:%d g:%d asid: %d &quot;</span>
<a name="l00165"></a>00165             <span class="stringliteral">&quot;el: %d\n&quot;</span>,
<a name="l00166"></a>00166             va, asn, retval ? <span class="stringliteral">&quot;hit&quot;</span> : <span class="stringliteral">&quot;miss&quot;</span>, vmid, hyp, secure,
<a name="l00167"></a>00167             retval ? retval-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a4afe677a2787de7618c9ae0c7ac52d55">pfn</a>       : 0, retval ? retval-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a868dd527cef0bd3922b729e8662dbef5">size</a>  : 0,
<a name="l00168"></a>00168             retval ? retval-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff7322ca730e3ca004347226176edb55">pAddr</a>(va) : 0, retval ? retval-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a7e7354fa4ecc350cd54e8f61d6dd2395">ap</a>    : 0,
<a name="l00169"></a>00169             retval ? retval-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#ab3f1550285f0f8622abfd6fadfe6aa39">ns</a>        : 0, retval ? retval-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a3912aad9279d0750e45c3cb6d062cf4b">nstid</a> : 0,
<a name="l00170"></a>00170             retval ? retval-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a1025b4849b1a01fa997a2e90c9a51ac8">global</a>    : 0, retval ? retval-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a9607ccefc09fb169e27a383368f2bfa2">asid</a>  : 0,
<a name="l00171"></a>00171             retval ? retval-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a2b53dfb754819894560186ba985d21b2">el</a>        : 0);
<a name="l00172"></a>00172 
<a name="l00173"></a>00173     <span class="keywordflow">return</span> retval;
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="comment">// insert a new TLB entry</span>
<a name="l00177"></a>00177 <span class="keywordtype">void</span>
<a name="l00178"></a><a class="code" href="classArmISA_1_1TLB.html#a32a7397627c69aa473125fb40ea7beac">00178</a> <a class="code" href="classArmISA_1_1TLB.html#a32a7397627c69aa473125fb40ea7beac">TLB::insert</a>(<a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceX86ISA.html#a79b5c08c190167d17c9b9b3fd40112f6">addr</a>, <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> &amp;entry)
<a name="l00179"></a>00179 {
<a name="l00180"></a>00180     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;Inserting entry into TLB with pfn:%#x size:%#x vpn: %#x&quot;</span>
<a name="l00181"></a>00181             <span class="stringliteral">&quot; asid:%d vmid:%d N:%d global:%d valid:%d nc:%d xn:%d&quot;</span>
<a name="l00182"></a>00182             <span class="stringliteral">&quot; ap:%#x domain:%#x ns:%d nstid:%d isHyp:%d\n&quot;</span>, entry.<a class="code" href="structArmISA_1_1TlbEntry.html#a4afe677a2787de7618c9ae0c7ac52d55">pfn</a>,
<a name="l00183"></a>00183             entry.<a class="code" href="structArmISA_1_1TlbEntry.html#a868dd527cef0bd3922b729e8662dbef5">size</a>, entry.<a class="code" href="structArmISA_1_1TlbEntry.html#a975082bed51810d0cb2953d4e4361ccb">vpn</a>, entry.<a class="code" href="structArmISA_1_1TlbEntry.html#a9607ccefc09fb169e27a383368f2bfa2">asid</a>, entry.<a class="code" href="structArmISA_1_1TlbEntry.html#ae6eada7f8887095fa1e3c6198175814c">vmid</a>, entry.<a class="code" href="structArmISA_1_1TlbEntry.html#afb996c55e70b44cd2d69669a4281037c">N</a>,
<a name="l00184"></a>00184             entry.<a class="code" href="structArmISA_1_1TlbEntry.html#a1025b4849b1a01fa997a2e90c9a51ac8">global</a>, entry.<a class="code" href="structArmISA_1_1TlbEntry.html#aff27599d4e6fb38eedadb1180d78dd09">valid</a>, entry.<a class="code" href="structArmISA_1_1TlbEntry.html#aa48086307b7c0138fd5523586b237ce1">nonCacheable</a>, entry.<a class="code" href="structArmISA_1_1TlbEntry.html#a63c7605dfb1cbdc03f2d2ba6d39c6488">xn</a>,
<a name="l00185"></a>00185             entry.<a class="code" href="structArmISA_1_1TlbEntry.html#a7e7354fa4ecc350cd54e8f61d6dd2395">ap</a>, static_cast&lt;uint8_t&gt;(entry.<a class="code" href="structArmISA_1_1TlbEntry.html#a94f98aa8eec65aacfcfccd40a4aea72e">domain</a>), entry.<a class="code" href="structArmISA_1_1TlbEntry.html#ab3f1550285f0f8622abfd6fadfe6aa39">ns</a>, entry.<a class="code" href="structArmISA_1_1TlbEntry.html#a3912aad9279d0750e45c3cb6d062cf4b">nstid</a>,
<a name="l00186"></a>00186             entry.<a class="code" href="structArmISA_1_1TlbEntry.html#a67cbc74fa97bcec0c50db8a986400a57">isHyp</a>);
<a name="l00187"></a>00187 
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a> - 1].valid)
<a name="l00189"></a>00189         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot; - Replacing Valid entry %#x, asn %d vmn %d ppn %#x &quot;</span>
<a name="l00190"></a>00190                 <span class="stringliteral">&quot;size: %#x ap:%d ns:%d nstid:%d g:%d isHyp:%d el: %d\n&quot;</span>,
<a name="l00191"></a>00191                 <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].vpn &lt;&lt; <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].N, <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].<a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a>,
<a name="l00192"></a>00192                 <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].<a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>, <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].<a class="code" href="namespaceMipsISA.html#ad087a0d09df82734e1a2ac73150696de">pfn</a> &lt;&lt; <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].N,
<a name="l00193"></a>00193                 <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>, <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].ap, <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].<a class="code" href="namespaceArmISA.html#a0929e6a0471942ee7968c26aa92d15ff">ns</a>,
<a name="l00194"></a>00194                 <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].nstid, <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].global, <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].<a class="code" href="classArmISA_1_1TLB.html#a37fb7444e14a925f74644836fe01bb8d">isHyp</a>,
<a name="l00195"></a>00195                 <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>-1].<a class="code" href="namespaceArmISA.html#a536bb38d0b4534415c908e6796c9685b">el</a>);
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     <span class="comment">//inserting to MRU position and evicting the LRU one</span>
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = <a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a> - 1; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &gt; 0; --<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>)
<a name="l00200"></a>00200         <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>] = <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>-1];
<a name="l00201"></a>00201     <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[0] = entry;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <a class="code" href="classArmISA_1_1TLB.html#a0588d04a47d488e874e7034d5878c51b">inserts</a>++;
<a name="l00204"></a>00204     <a class="code" href="classArmISA_1_1TLB.html#a9641876348adabd4a106afbe35c10456" title="PMU probe for TLB refills.">ppRefills</a>-&gt;notify(1);
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="keywordtype">void</span>
<a name="l00208"></a><a class="code" href="classArmISA_1_1TLB.html#a7acbeba474b4ae0ea99866ecb894941a">00208</a> <a class="code" href="classArmISA_1_1TLB.html#a7acbeba474b4ae0ea99866ecb894941a">TLB::printTlb</a>()<span class="keyword"> const</span>
<a name="l00209"></a>00209 <span class="keyword"></span>{
<a name="l00210"></a>00210     <span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> = 0;
<a name="l00211"></a>00211     <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *<a class="code" href="namespaceMipsISA.html#a96bd0a55377fd83938867fd4d63d664d">te</a>;
<a name="l00212"></a>00212     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;Current TLB contents:\n&quot;</span>);
<a name="l00213"></a>00213     <span class="keywordflow">while</span> (x &lt; <a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>) {
<a name="l00214"></a>00214         te = &amp;<a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[x];
<a name="l00215"></a>00215         <span class="keywordflow">if</span> (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff27599d4e6fb38eedadb1180d78dd09">valid</a>)
<a name="l00216"></a>00216             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot; *  %s\n&quot;</span>, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff3b45f2031f160f17310eeeb0088267">print</a>());
<a name="l00217"></a>00217         ++x;
<a name="l00218"></a>00218     }
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 <span class="keywordtype">void</span>
<a name="l00222"></a><a class="code" href="classArmISA_1_1TLB.html#aa0f5c3738d8c785687a6a14a1d9a969f">00222</a> <a class="code" href="classArmISA_1_1TLB.html#aa0f5c3738d8c785687a6a14a1d9a969f" title="Reset the entire TLB.">TLB::flushAllSecurity</a>(<span class="keywordtype">bool</span> secure_lookup, uint8_t target_el, <span class="keywordtype">bool</span> ignore_el)
<a name="l00223"></a>00223 {
<a name="l00224"></a>00224     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;Flushing all TLB entries (%s lookup)\n&quot;</span>,
<a name="l00225"></a>00225             (secure_lookup ? <span class="stringliteral">&quot;secure&quot;</span> : <span class="stringliteral">&quot;non-secure&quot;</span>));
<a name="l00226"></a>00226     <span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> = 0;
<a name="l00227"></a>00227     <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *<a class="code" href="namespaceMipsISA.html#a96bd0a55377fd83938867fd4d63d664d">te</a>;
<a name="l00228"></a>00228     <span class="keywordflow">while</span> (x &lt; <a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>) {
<a name="l00229"></a>00229         te = &amp;<a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[x];
<a name="l00230"></a>00230         <span class="keywordflow">if</span> (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff27599d4e6fb38eedadb1180d78dd09">valid</a> &amp;&amp; secure_lookup == !te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a3912aad9279d0750e45c3cb6d062cf4b">nstid</a> &amp;&amp;
<a name="l00231"></a>00231             (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#ae6eada7f8887095fa1e3c6198175814c">vmid</a> == <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a> || secure_lookup) &amp;&amp;
<a name="l00232"></a>00232             <a class="code" href="classArmISA_1_1TLB.html#a125bdfc91830baae5cdea2e78b1d5740">checkELMatch</a>(target_el, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a2b53dfb754819894560186ba985d21b2">el</a>, ignore_el)) {
<a name="l00233"></a>00233 
<a name="l00234"></a>00234             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot; -  %s\n&quot;</span>, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff3b45f2031f160f17310eeeb0088267">print</a>());
<a name="l00235"></a>00235             te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff27599d4e6fb38eedadb1180d78dd09">valid</a> = <span class="keyword">false</span>;
<a name="l00236"></a>00236             <a class="code" href="classArmISA_1_1TLB.html#a3cf686a27a5c5424834fc9e1de4ff870">flushedEntries</a>++;
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238         ++x;
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     <a class="code" href="classArmISA_1_1TLB.html#ad2a3ec67a52ee644564143b7ca918516">flushTlb</a>++;
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="comment">// If there&apos;s a second stage TLB (and we&apos;re not it) then flush it as well</span>
<a name="l00244"></a>00244     <span class="comment">// if we&apos;re currently in hyp mode</span>
<a name="l00245"></a>00245     <span class="keywordflow">if</span> (!<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#a37fb7444e14a925f74644836fe01bb8d">isHyp</a>) {
<a name="l00246"></a>00246         <a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>-&gt;<a class="code" href="classArmISA_1_1TLB.html#aa0f5c3738d8c785687a6a14a1d9a969f" title="Reset the entire TLB.">flushAllSecurity</a>(secure_lookup, <span class="keyword">true</span>);
<a name="l00247"></a>00247     }
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="keywordtype">void</span>
<a name="l00251"></a><a class="code" href="classArmISA_1_1TLB.html#ab8bd95b9f14f2818851da8807af3a836">00251</a> <a class="code" href="classArmISA_1_1TLB.html#ab8bd95b9f14f2818851da8807af3a836" title="Remove all entries in the non secure world, depending on whether they were allocated...">TLB::flushAllNs</a>(<span class="keywordtype">bool</span> hyp, uint8_t target_el, <span class="keywordtype">bool</span> ignore_el)
<a name="l00252"></a>00252 {
<a name="l00253"></a>00253     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;Flushing all NS TLB entries (%s lookup)\n&quot;</span>,
<a name="l00254"></a>00254             (hyp ? <span class="stringliteral">&quot;hyp&quot;</span> : <span class="stringliteral">&quot;non-hyp&quot;</span>));
<a name="l00255"></a>00255     <span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> = 0;
<a name="l00256"></a>00256     <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *<a class="code" href="namespaceMipsISA.html#a96bd0a55377fd83938867fd4d63d664d">te</a>;
<a name="l00257"></a>00257     <span class="keywordflow">while</span> (x &lt; <a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>) {
<a name="l00258"></a>00258         te = &amp;<a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[x];
<a name="l00259"></a>00259         <span class="keywordflow">if</span> (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff27599d4e6fb38eedadb1180d78dd09">valid</a> &amp;&amp; te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a3912aad9279d0750e45c3cb6d062cf4b">nstid</a> &amp;&amp; te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a67cbc74fa97bcec0c50db8a986400a57">isHyp</a> == hyp &amp;&amp;
<a name="l00260"></a>00260             <a class="code" href="classArmISA_1_1TLB.html#a125bdfc91830baae5cdea2e78b1d5740">checkELMatch</a>(target_el, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a2b53dfb754819894560186ba985d21b2">el</a>, ignore_el)) {
<a name="l00261"></a>00261 
<a name="l00262"></a>00262             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot; -  %s\n&quot;</span>, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff3b45f2031f160f17310eeeb0088267">print</a>());
<a name="l00263"></a>00263             <a class="code" href="classArmISA_1_1TLB.html#a3cf686a27a5c5424834fc9e1de4ff870">flushedEntries</a>++;
<a name="l00264"></a>00264             te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff27599d4e6fb38eedadb1180d78dd09">valid</a> = <span class="keyword">false</span>;
<a name="l00265"></a>00265         }
<a name="l00266"></a>00266         ++x;
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <a class="code" href="classArmISA_1_1TLB.html#ad2a3ec67a52ee644564143b7ca918516">flushTlb</a>++;
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     <span class="comment">// If there&apos;s a second stage TLB (and we&apos;re not it) then flush it as well</span>
<a name="l00272"></a>00272     <span class="keywordflow">if</span> (!<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> &amp;&amp; !hyp) {
<a name="l00273"></a>00273         <a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>-&gt;<a class="code" href="classArmISA_1_1TLB.html#ab8bd95b9f14f2818851da8807af3a836" title="Remove all entries in the non secure world, depending on whether they were allocated...">flushAllNs</a>(<span class="keyword">false</span>, <span class="keyword">true</span>);
<a name="l00274"></a>00274     }
<a name="l00275"></a>00275 }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="keywordtype">void</span>
<a name="l00278"></a><a class="code" href="classArmISA_1_1TLB.html#a29738676b3d101fe9e2beb93a7bc45f6">00278</a> <a class="code" href="classArmISA_1_1TLB.html#a29738676b3d101fe9e2beb93a7bc45f6" title="Remove any entries that match both a va and asn.">TLB::flushMvaAsid</a>(<a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> mva, uint64_t asn, <span class="keywordtype">bool</span> secure_lookup, uint8_t target_el)
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;Flushing TLB entries with mva: %#x, asid: %#x &quot;</span>
<a name="l00281"></a>00281             <span class="stringliteral">&quot;(%s lookup)\n&quot;</span>, mva, asn, (secure_lookup ?
<a name="l00282"></a>00282             <span class="stringliteral">&quot;secure&quot;</span> : <span class="stringliteral">&quot;non-secure&quot;</span>));
<a name="l00283"></a>00283     <a class="code" href="classArmISA_1_1TLB.html#a98e4ddfe8fa17aa49ff3cdc3db73a5ef" title="Remove any entries that match both a va and asn.">_flushMva</a>(mva, asn, secure_lookup, <span class="keyword">false</span>, <span class="keyword">false</span>, target_el);
<a name="l00284"></a>00284     <a class="code" href="classArmISA_1_1TLB.html#a35b6a93ff8375b07eede7bc89d888cbe">flushTlbMvaAsid</a>++;
<a name="l00285"></a>00285 }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="keywordtype">void</span>
<a name="l00288"></a><a class="code" href="classArmISA_1_1TLB.html#aaefc0fdfbb2df9d0121fc125d753d997">00288</a> <a class="code" href="classArmISA_1_1TLB.html#aaefc0fdfbb2df9d0121fc125d753d997" title="Remove any entries that match the asn.">TLB::flushAsid</a>(uint64_t asn, <span class="keywordtype">bool</span> secure_lookup, uint8_t target_el)
<a name="l00289"></a>00289 {
<a name="l00290"></a>00290     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;Flushing TLB entries with asid: %#x (%s lookup)\n&quot;</span>, asn,
<a name="l00291"></a>00291             (secure_lookup ? <span class="stringliteral">&quot;secure&quot;</span> : <span class="stringliteral">&quot;non-secure&quot;</span>));
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> = 0 ;
<a name="l00294"></a>00294     <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *<a class="code" href="namespaceMipsISA.html#a96bd0a55377fd83938867fd4d63d664d">te</a>;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <span class="keywordflow">while</span> (x &lt; <a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>) {
<a name="l00297"></a>00297         te = &amp;<a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[x];
<a name="l00298"></a>00298         <span class="keywordflow">if</span> (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff27599d4e6fb38eedadb1180d78dd09">valid</a> &amp;&amp; te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a9607ccefc09fb169e27a383368f2bfa2">asid</a> == asn &amp;&amp; secure_lookup == !te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a3912aad9279d0750e45c3cb6d062cf4b">nstid</a> &amp;&amp;
<a name="l00299"></a>00299             (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#ae6eada7f8887095fa1e3c6198175814c">vmid</a> == <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a> || secure_lookup) &amp;&amp;
<a name="l00300"></a>00300             <a class="code" href="classArmISA_1_1TLB.html#a125bdfc91830baae5cdea2e78b1d5740">checkELMatch</a>(target_el, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a2b53dfb754819894560186ba985d21b2">el</a>, <span class="keyword">false</span>)) {
<a name="l00301"></a>00301 
<a name="l00302"></a>00302             te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff27599d4e6fb38eedadb1180d78dd09">valid</a> = <span class="keyword">false</span>;
<a name="l00303"></a>00303             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot; -  %s\n&quot;</span>, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff3b45f2031f160f17310eeeb0088267">print</a>());
<a name="l00304"></a>00304             <a class="code" href="classArmISA_1_1TLB.html#a3cf686a27a5c5424834fc9e1de4ff870">flushedEntries</a>++;
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306         ++x;
<a name="l00307"></a>00307     }
<a name="l00308"></a>00308     <a class="code" href="classArmISA_1_1TLB.html#a28d619726ce2410f006a43af332ca8e1">flushTlbAsid</a>++;
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 <span class="keywordtype">void</span>
<a name="l00312"></a><a class="code" href="classArmISA_1_1TLB.html#a30b72fb4fd7e38ac6db82374a2ed4749">00312</a> <a class="code" href="classArmISA_1_1TLB.html#a30b72fb4fd7e38ac6db82374a2ed4749" title="Remove all entries that match the va regardless of asn.">TLB::flushMva</a>(<a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> mva, <span class="keywordtype">bool</span> secure_lookup, <span class="keywordtype">bool</span> hyp, uint8_t target_el)
<a name="l00313"></a>00313 {
<a name="l00314"></a>00314     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;Flushing TLB entries with mva: %#x (%s lookup)\n&quot;</span>, mva,
<a name="l00315"></a>00315             (secure_lookup ? <span class="stringliteral">&quot;secure&quot;</span> : <span class="stringliteral">&quot;non-secure&quot;</span>));
<a name="l00316"></a>00316     <a class="code" href="classArmISA_1_1TLB.html#a98e4ddfe8fa17aa49ff3cdc3db73a5ef" title="Remove any entries that match both a va and asn.">_flushMva</a>(mva, 0xbeef, secure_lookup, hyp, <span class="keyword">true</span>, target_el);
<a name="l00317"></a>00317     <a class="code" href="classArmISA_1_1TLB.html#a410e54735bc35f30c89980cbb28570e1">flushTlbMva</a>++;
<a name="l00318"></a>00318 }
<a name="l00319"></a>00319 
<a name="l00320"></a>00320 <span class="keywordtype">void</span>
<a name="l00321"></a><a class="code" href="classArmISA_1_1TLB.html#a98e4ddfe8fa17aa49ff3cdc3db73a5ef">00321</a> <a class="code" href="classArmISA_1_1TLB.html#a98e4ddfe8fa17aa49ff3cdc3db73a5ef" title="Remove any entries that match both a va and asn.">TLB::_flushMva</a>(<a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> mva, uint64_t asn, <span class="keywordtype">bool</span> secure_lookup, <span class="keywordtype">bool</span> hyp,
<a name="l00322"></a>00322                <span class="keywordtype">bool</span> ignore_asn, uint8_t target_el)
<a name="l00323"></a>00323 {
<a name="l00324"></a>00324     <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *<a class="code" href="namespaceMipsISA.html#a96bd0a55377fd83938867fd4d63d664d">te</a>;
<a name="l00325"></a>00325     <span class="comment">// D5.7.2: Sign-extend address to 64 bits</span>
<a name="l00326"></a>00326     mva = sext&lt;56&gt;(mva);
<a name="l00327"></a>00327     te = <a class="code" href="classArmISA_1_1TLB.html#a7f267aa3f82802f19128f2cc0fa01766" title="Lookup an entry in the TLB.">lookup</a>(mva, asn, <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>, hyp, secure_lookup, <span class="keyword">false</span>, ignore_asn,
<a name="l00328"></a>00328                 target_el);
<a name="l00329"></a>00329     <span class="keywordflow">while</span> (te != NULL) {
<a name="l00330"></a>00330         <span class="keywordflow">if</span> (secure_lookup == !te-&gt;nstid) {
<a name="l00331"></a>00331             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot; -  %s\n&quot;</span>, te-&gt;print());
<a name="l00332"></a>00332             te-&gt;valid = <span class="keyword">false</span>;
<a name="l00333"></a>00333             <a class="code" href="classArmISA_1_1TLB.html#a3cf686a27a5c5424834fc9e1de4ff870">flushedEntries</a>++;
<a name="l00334"></a>00334         }
<a name="l00335"></a>00335         te = <a class="code" href="classArmISA_1_1TLB.html#a7f267aa3f82802f19128f2cc0fa01766" title="Lookup an entry in the TLB.">lookup</a>(mva, asn, <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>, hyp, secure_lookup, <span class="keyword">false</span>, ignore_asn,
<a name="l00336"></a>00336                     target_el);
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338 }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 <span class="keywordtype">bool</span>
<a name="l00341"></a><a class="code" href="classArmISA_1_1TLB.html#a125bdfc91830baae5cdea2e78b1d5740">00341</a> <a class="code" href="classArmISA_1_1TLB.html#a125bdfc91830baae5cdea2e78b1d5740">TLB::checkELMatch</a>(uint8_t target_el, uint8_t tentry_el, <span class="keywordtype">bool</span> ignore_el)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343     <span class="keywordtype">bool</span> elMatch = <span class="keyword">true</span>;
<a name="l00344"></a>00344     <span class="keywordflow">if</span> (!ignore_el) {
<a name="l00345"></a>00345         <span class="keywordflow">if</span> (target_el == 2 || target_el == 3) {
<a name="l00346"></a>00346             elMatch = (tentry_el  == target_el);
<a name="l00347"></a>00347         } <span class="keywordflow">else</span> {
<a name="l00348"></a>00348             elMatch = (tentry_el == 0) || (tentry_el  == 1);
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351     <span class="keywordflow">return</span> elMatch;
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 <span class="keywordtype">void</span>
<a name="l00355"></a><a class="code" href="classArmISA_1_1TLB.html#a376793db82a8d4070f96059e0f41bce2">00355</a> <a class="code" href="classArmISA_1_1TLB.html#a376793db82a8d4070f96059e0f41bce2" title="Resume execution after a successful drain.">TLB::drainResume</a>()
<a name="l00356"></a>00356 {
<a name="l00357"></a>00357     <span class="comment">// We might have unserialized something or switched CPUs, so make</span>
<a name="l00358"></a>00358     <span class="comment">// sure to re-read the misc regs.</span>
<a name="l00359"></a>00359     <a class="code" href="classArmISA_1_1TLB.html#a65b5c9f8eeb6f23d434738badc2e8603">miscRegValid</a> = <span class="keyword">false</span>;
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 <span class="keywordtype">void</span>
<a name="l00363"></a><a class="code" href="classArmISA_1_1TLB.html#adb473611718628232702447d9f70ba0f">00363</a> <a class="code" href="classArmISA_1_1TLB.html#adb473611718628232702447d9f70ba0f">TLB::takeOverFrom</a>(<a class="code" href="classBaseTLB.html">BaseTLB</a> *_otlb)
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365     <a class="code" href="classArmISA_1_1TLB.html">TLB</a> *otlb = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="classArmISA_1_1TLB.html">TLB</a>*<span class="keyword">&gt;</span>(_otlb);
<a name="l00366"></a>00366     <span class="comment">/* Make sure we actually have a valid type */</span>
<a name="l00367"></a>00367     <span class="keywordflow">if</span> (otlb) {
<a name="l00368"></a>00368         <a class="code" href="classArmISA_1_1TLB.html#a6ec1ce85d329fbd19234e06640582237">_attr</a> = otlb-&gt;<a class="code" href="classArmISA_1_1TLB.html#a6ec1ce85d329fbd19234e06640582237">_attr</a>;
<a name="l00369"></a>00369         <a class="code" href="classArmISA_1_1TLB.html#ac124897414ac526a624ea559da1ae7e4">haveLPAE</a> = otlb-&gt;<a class="code" href="classArmISA_1_1TLB.html#ac124897414ac526a624ea559da1ae7e4">haveLPAE</a>;
<a name="l00370"></a>00370         <a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a> = otlb-&gt;<a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a>;
<a name="l00371"></a>00371         <a class="code" href="classArmISA_1_1TLB.html#a0a0d2a49b44f3e54bd986e6c7f0049dc">stage2Req</a> = otlb-&gt;<a class="code" href="classArmISA_1_1TLB.html#a0a0d2a49b44f3e54bd986e6c7f0049dc">stage2Req</a>;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373         <span class="comment">/* Sync the stage2 MMU if they exist in both</span>
<a name="l00374"></a>00374 <span class="comment">         * the old CPU and the new</span>
<a name="l00375"></a>00375 <span class="comment">         */</span>
<a name="l00376"></a>00376         <span class="keywordflow">if</span> (!<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> &amp;&amp;
<a name="l00377"></a>00377             <a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a> &amp;&amp; otlb-&gt;<a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>) {
<a name="l00378"></a>00378             <a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>-&gt;<a class="code" href="classArmISA_1_1TLB.html#adb473611718628232702447d9f70ba0f">takeOverFrom</a>(otlb-&gt;<a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>);
<a name="l00379"></a>00379         }
<a name="l00380"></a>00380     } <span class="keywordflow">else</span> {
<a name="l00381"></a>00381         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Incompatible TLB type!&quot;</span>);
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383 }
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 <span class="keywordtype">void</span>
<a name="l00386"></a>00386 <a class="code" href="classArmISA_1_1TLB.html#a0077ab05a75ce2d9bcddcd8e75871c3f">TLB::serialize</a>(ostream &amp;<a class="code" href="namespaceX86ISA.html#aea9fbab71662ba06cf536e05edfaaad1">os</a>)
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classCheckpoint.html">Checkpoint</a>, <span class="stringliteral">&quot;Serializing Arm TLB\n&quot;</span>);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classArmISA_1_1TLB.html#a6ec1ce85d329fbd19234e06640582237">_attr</a>);
<a name="l00391"></a>00391     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classArmISA_1_1TLB.html#ac124897414ac526a624ea559da1ae7e4">haveLPAE</a>);
<a name="l00392"></a>00392     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a>);
<a name="l00393"></a>00393     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(<a class="code" href="classArmISA_1_1TLB.html#a0a0d2a49b44f3e54bd986e6c7f0049dc">stage2Req</a>);
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="keywordtype">int</span> num_entries = <a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>;
<a name="l00396"></a>00396     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(num_entries);
<a name="l00397"></a>00397     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; <a class="code" href="classArmISA_1_1TLB.html#a8e9e733b717dfca9a1d040f419c2897c">size</a>; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++){
<a name="l00398"></a>00398         <a class="code" href="classSerializable.html#a23ac872f198ad03a95312016697de6b8">nameOut</a>(os, <a class="code" href="cprintf_8hh.html#a6d479f953c49f7538f6b4fac54cbf201">csprintf</a>(<span class="stringliteral">&quot;%s.TlbEntry%d&quot;</span>, <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>(), <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>));
<a name="l00399"></a>00399         <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].<a class="code" href="structArmISA_1_1TlbEntry.html#ab6b1e805cfb333fc80ba43b1cc38e8d9">serialize</a>(os);
<a name="l00400"></a>00400     }
<a name="l00401"></a>00401 }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 <span class="keywordtype">void</span>
<a name="l00404"></a>00404 <a class="code" href="classArmISA_1_1TLB.html#a078e74cc6bb9e13bb314df424c4d8b54">TLB::unserialize</a>(<a class="code" href="classCheckpoint.html">Checkpoint</a> *cp, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;section)
<a name="l00405"></a>00405 {
<a name="l00406"></a>00406     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classCheckpoint.html">Checkpoint</a>, <span class="stringliteral">&quot;Unserializing Arm TLB\n&quot;</span>);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classArmISA_1_1TLB.html#a6ec1ce85d329fbd19234e06640582237">_attr</a>);
<a name="l00409"></a>00409     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classArmISA_1_1TLB.html#ac124897414ac526a624ea559da1ae7e4">haveLPAE</a>);
<a name="l00410"></a>00410     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a>);
<a name="l00411"></a>00411     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(<a class="code" href="classArmISA_1_1TLB.html#a0a0d2a49b44f3e54bd986e6c7f0049dc">stage2Req</a>);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     <span class="keywordtype">int</span> num_entries;
<a name="l00414"></a>00414     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(num_entries);
<a name="l00415"></a>00415     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> = 0; <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a> &lt; min(size, num_entries); <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>++){
<a name="l00416"></a>00416         <a class="code" href="classArmISA_1_1TLB.html#afabd3b92b2b5d6eeda1749cb593e90fc">table</a>[<a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>].<a class="code" href="structArmISA_1_1TlbEntry.html#abfecedce0466539d8a037ba3e91b8f93">unserialize</a>(cp, <a class="code" href="cprintf_8hh.html#a6d479f953c49f7538f6b4fac54cbf201">csprintf</a>(<span class="stringliteral">&quot;%s.TlbEntry%d&quot;</span>, section, <a class="code" href="namespaceArmISA.html#a07402644ed55c19e1a116116c548c2ac">i</a>));
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 
<a name="l00420"></a>00420 <span class="keywordtype">void</span>
<a name="l00421"></a><a class="code" href="classArmISA_1_1TLB.html#ad0ff8cdde62a02faee3cf367c43875ab">00421</a> <a class="code" href="classArmISA_1_1TLB.html#ad0ff8cdde62a02faee3cf367c43875ab" title="Register statistics for this object.">TLB::regStats</a>()
<a name="l00422"></a>00422 {
<a name="l00423"></a>00423     <a class="code" href="classArmISA_1_1TLB.html#a644c4144f756547ac4a633f639472c9f">instHits</a>
<a name="l00424"></a>00424         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.inst_hits&quot;</span>)
<a name="l00425"></a>00425         .desc(<span class="stringliteral">&quot;ITB inst hits&quot;</span>)
<a name="l00426"></a>00426         ;
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <a class="code" href="classArmISA_1_1TLB.html#a4238723b9727e30dbf6adf684ccb6042">instMisses</a>
<a name="l00429"></a>00429         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.inst_misses&quot;</span>)
<a name="l00430"></a>00430         .desc(<span class="stringliteral">&quot;ITB inst misses&quot;</span>)
<a name="l00431"></a>00431         ;
<a name="l00432"></a>00432 
<a name="l00433"></a>00433     <a class="code" href="classArmISA_1_1TLB.html#a6906bf5d24cb0bb244cdd49d9cb0a2e0">instAccesses</a>
<a name="l00434"></a>00434         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.inst_accesses&quot;</span>)
<a name="l00435"></a>00435         .desc(<span class="stringliteral">&quot;ITB inst accesses&quot;</span>)
<a name="l00436"></a>00436         ;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <a class="code" href="classArmISA_1_1TLB.html#a687ceb21f05a04e8e9939529d680da8e">readHits</a>
<a name="l00439"></a>00439         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.read_hits&quot;</span>)
<a name="l00440"></a>00440         .desc(<span class="stringliteral">&quot;DTB read hits&quot;</span>)
<a name="l00441"></a>00441         ;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <a class="code" href="classArmISA_1_1TLB.html#a664a30b4686cbd47b32c2f3f40b122a7">readMisses</a>
<a name="l00444"></a>00444         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.read_misses&quot;</span>)
<a name="l00445"></a>00445         .desc(<span class="stringliteral">&quot;DTB read misses&quot;</span>)
<a name="l00446"></a>00446         ;
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     <a class="code" href="classArmISA_1_1TLB.html#a9fbd9eee78e1b023b096b9ca893d1aa7">readAccesses</a>
<a name="l00449"></a>00449         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.read_accesses&quot;</span>)
<a name="l00450"></a>00450         .desc(<span class="stringliteral">&quot;DTB read accesses&quot;</span>)
<a name="l00451"></a>00451         ;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     <a class="code" href="classArmISA_1_1TLB.html#a77f188052be9dc8b73d5f57f13c925ad">writeHits</a>
<a name="l00454"></a>00454         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.write_hits&quot;</span>)
<a name="l00455"></a>00455         .desc(<span class="stringliteral">&quot;DTB write hits&quot;</span>)
<a name="l00456"></a>00456         ;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     <a class="code" href="classArmISA_1_1TLB.html#ac5943c197a782c01a72a16a9921fac3c">writeMisses</a>
<a name="l00459"></a>00459         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.write_misses&quot;</span>)
<a name="l00460"></a>00460         .desc(<span class="stringliteral">&quot;DTB write misses&quot;</span>)
<a name="l00461"></a>00461         ;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <a class="code" href="classArmISA_1_1TLB.html#a6ef4e4a8d02c9d26a84f8a5d63b9f15b">writeAccesses</a>
<a name="l00464"></a>00464         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.write_accesses&quot;</span>)
<a name="l00465"></a>00465         .desc(<span class="stringliteral">&quot;DTB write accesses&quot;</span>)
<a name="l00466"></a>00466         ;
<a name="l00467"></a>00467 
<a name="l00468"></a>00468     <a class="code" href="classArmISA_1_1TLB.html#a9b0a4d17adecac5e2646491e78bacd39">hits</a>
<a name="l00469"></a>00469         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.hits&quot;</span>)
<a name="l00470"></a>00470         .desc(<span class="stringliteral">&quot;DTB hits&quot;</span>)
<a name="l00471"></a>00471         ;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <a class="code" href="classArmISA_1_1TLB.html#afcfd0ae1561036ec2e915c57cc4130e6">misses</a>
<a name="l00474"></a>00474         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.misses&quot;</span>)
<a name="l00475"></a>00475         .desc(<span class="stringliteral">&quot;DTB misses&quot;</span>)
<a name="l00476"></a>00476         ;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <a class="code" href="classArmISA_1_1TLB.html#aa74953c7b78eb906dc1631733682eb82">accesses</a>
<a name="l00479"></a>00479         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.accesses&quot;</span>)
<a name="l00480"></a>00480         .desc(<span class="stringliteral">&quot;DTB accesses&quot;</span>)
<a name="l00481"></a>00481         ;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <a class="code" href="classArmISA_1_1TLB.html#ad2a3ec67a52ee644564143b7ca918516">flushTlb</a>
<a name="l00484"></a>00484         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.flush_tlb&quot;</span>)
<a name="l00485"></a>00485         .desc(<span class="stringliteral">&quot;Number of times complete TLB was flushed&quot;</span>)
<a name="l00486"></a>00486         ;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <a class="code" href="classArmISA_1_1TLB.html#a410e54735bc35f30c89980cbb28570e1">flushTlbMva</a>
<a name="l00489"></a>00489         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.flush_tlb_mva&quot;</span>)
<a name="l00490"></a>00490         .desc(<span class="stringliteral">&quot;Number of times TLB was flushed by MVA&quot;</span>)
<a name="l00491"></a>00491         ;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <a class="code" href="classArmISA_1_1TLB.html#a35b6a93ff8375b07eede7bc89d888cbe">flushTlbMvaAsid</a>
<a name="l00494"></a>00494         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.flush_tlb_mva_asid&quot;</span>)
<a name="l00495"></a>00495         .desc(<span class="stringliteral">&quot;Number of times TLB was flushed by MVA &amp; ASID&quot;</span>)
<a name="l00496"></a>00496         ;
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <a class="code" href="classArmISA_1_1TLB.html#a28d619726ce2410f006a43af332ca8e1">flushTlbAsid</a>
<a name="l00499"></a>00499         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.flush_tlb_asid&quot;</span>)
<a name="l00500"></a>00500         .desc(<span class="stringliteral">&quot;Number of times TLB was flushed by ASID&quot;</span>)
<a name="l00501"></a>00501         ;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <a class="code" href="classArmISA_1_1TLB.html#a3cf686a27a5c5424834fc9e1de4ff870">flushedEntries</a>
<a name="l00504"></a>00504         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.flush_entries&quot;</span>)
<a name="l00505"></a>00505         .desc(<span class="stringliteral">&quot;Number of entries that have been flushed from TLB&quot;</span>)
<a name="l00506"></a>00506         ;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508     <a class="code" href="classArmISA_1_1TLB.html#a655dd5813d52b551be565206abb14b41">alignFaults</a>
<a name="l00509"></a>00509         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.align_faults&quot;</span>)
<a name="l00510"></a>00510         .desc(<span class="stringliteral">&quot;Number of TLB faults due to alignment restrictions&quot;</span>)
<a name="l00511"></a>00511         ;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     <a class="code" href="classArmISA_1_1TLB.html#a6c80b0d2f2e71322dff7ac83e82d5bc1">prefetchFaults</a>
<a name="l00514"></a>00514         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.prefetch_faults&quot;</span>)
<a name="l00515"></a>00515         .desc(<span class="stringliteral">&quot;Number of TLB faults due to prefetch&quot;</span>)
<a name="l00516"></a>00516         ;
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     <a class="code" href="classArmISA_1_1TLB.html#ab2b9dac041d03c3526507570622785f8">domainFaults</a>
<a name="l00519"></a>00519         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.domain_faults&quot;</span>)
<a name="l00520"></a>00520         .desc(<span class="stringliteral">&quot;Number of TLB faults due to domain restrictions&quot;</span>)
<a name="l00521"></a>00521         ;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <a class="code" href="classArmISA_1_1TLB.html#aa96037381db38a7f5f9f4cf72b73a999">permsFaults</a>
<a name="l00524"></a>00524         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(<a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.perms_faults&quot;</span>)
<a name="l00525"></a>00525         .desc(<span class="stringliteral">&quot;Number of TLB faults due to permissions restrictions&quot;</span>)
<a name="l00526"></a>00526         ;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528     <a class="code" href="classArmISA_1_1TLB.html#a6906bf5d24cb0bb244cdd49d9cb0a2e0">instAccesses</a> = <a class="code" href="classArmISA_1_1TLB.html#a644c4144f756547ac4a633f639472c9f">instHits</a> + <a class="code" href="classArmISA_1_1TLB.html#a4238723b9727e30dbf6adf684ccb6042">instMisses</a>;
<a name="l00529"></a>00529     <a class="code" href="classArmISA_1_1TLB.html#a9fbd9eee78e1b023b096b9ca893d1aa7">readAccesses</a> = <a class="code" href="classArmISA_1_1TLB.html#a687ceb21f05a04e8e9939529d680da8e">readHits</a> + <a class="code" href="classArmISA_1_1TLB.html#a664a30b4686cbd47b32c2f3f40b122a7">readMisses</a>;
<a name="l00530"></a>00530     <a class="code" href="classArmISA_1_1TLB.html#a6ef4e4a8d02c9d26a84f8a5d63b9f15b">writeAccesses</a> = <a class="code" href="classArmISA_1_1TLB.html#a77f188052be9dc8b73d5f57f13c925ad">writeHits</a> + <a class="code" href="classArmISA_1_1TLB.html#ac5943c197a782c01a72a16a9921fac3c">writeMisses</a>;
<a name="l00531"></a>00531     <a class="code" href="classArmISA_1_1TLB.html#a9b0a4d17adecac5e2646491e78bacd39">hits</a> = <a class="code" href="classArmISA_1_1TLB.html#a687ceb21f05a04e8e9939529d680da8e">readHits</a> + <a class="code" href="classArmISA_1_1TLB.html#a77f188052be9dc8b73d5f57f13c925ad">writeHits</a> + <a class="code" href="classArmISA_1_1TLB.html#a644c4144f756547ac4a633f639472c9f">instHits</a>;
<a name="l00532"></a>00532     <a class="code" href="classArmISA_1_1TLB.html#afcfd0ae1561036ec2e915c57cc4130e6">misses</a> = readMisses + writeMisses + instMisses;
<a name="l00533"></a>00533     <a class="code" href="classArmISA_1_1TLB.html#aa74953c7b78eb906dc1631733682eb82">accesses</a> = <a class="code" href="classArmISA_1_1TLB.html#a9fbd9eee78e1b023b096b9ca893d1aa7">readAccesses</a> + <a class="code" href="classArmISA_1_1TLB.html#a6ef4e4a8d02c9d26a84f8a5d63b9f15b">writeAccesses</a> + <a class="code" href="classArmISA_1_1TLB.html#a6906bf5d24cb0bb244cdd49d9cb0a2e0">instAccesses</a>;
<a name="l00534"></a>00534 }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 <span class="keywordtype">void</span>
<a name="l00537"></a><a class="code" href="classArmISA_1_1TLB.html#a63e8662225f30bb49e66dad1fa3502c7">00537</a> <a class="code" href="classArmISA_1_1TLB.html#a63e8662225f30bb49e66dad1fa3502c7" title="Register probe points for this object.">TLB::regProbePoints</a>()
<a name="l00538"></a>00538 {
<a name="l00539"></a>00539     <a class="code" href="classArmISA_1_1TLB.html#a9641876348adabd4a106afbe35c10456" title="PMU probe for TLB refills.">ppRefills</a>.reset(<span class="keyword">new</span> <a class="code" href="classProbePointArg.html" title="ProbePointArg generates a point for the class of Arg.">ProbePoints::PMU</a>(<a class="code" href="classSimObject.html#ab6f8b1c9e7c8239917c9b27254c5fe82" title="Get the probe manager for this object.">getProbeManager</a>(), <span class="stringliteral">&quot;Refills&quot;</span>));
<a name="l00540"></a>00540 }
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l00543"></a><a class="code" href="classArmISA_1_1TLB.html#a80e334b22c1757f9785af4c74e40e4eb">00543</a> <a class="code" href="classArmISA_1_1TLB.html#a80e334b22c1757f9785af4c74e40e4eb">TLB::translateSe</a>(<a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>,
<a name="l00544"></a>00544                  <a class="code" href="classBaseTLB_1_1Translation.html">Translation</a> *translation, <span class="keywordtype">bool</span> &amp;delay, <span class="keywordtype">bool</span> timing)
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546     <a class="code" href="classArmISA_1_1TLB.html#a55ca28e8f7ad5d1230db775656384008">updateMiscReg</a>(tc);
<a name="l00547"></a>00547     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> vaddr_tainted = req-&gt;<a class="code" href="classRequest.html#afd69006362aca38468eb15ad06c3f79b">getVaddr</a>();
<a name="l00548"></a>00548     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceMipsISA.html#a9bab751e4fa25d88bf84ee970a01a641">vaddr</a> = 0;
<a name="l00549"></a>00549     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a>)
<a name="l00550"></a>00550         vaddr = <a class="code" href="namespaceArmISA.html#a17830702f2a3c01ca77252e146d45bba" title="Removes the tag from tagged addresses if that mode is enabled.">purifyTaggedAddr</a>(vaddr_tainted, tc, <a class="code" href="classArmISA_1_1TLB.html#a988fddb2d918607d96728869aa647c88">aarch64EL</a>, <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a>);
<a name="l00551"></a>00551     <span class="keywordflow">else</span>
<a name="l00552"></a>00552         vaddr = vaddr_tainted;
<a name="l00553"></a>00553     uint32_t flags = req-&gt;<a class="code" href="classRequest.html#ab5c7328019f59c101363cfb6b0cb51f2" title="Accessor for flags.">getFlags</a>();
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     <span class="keywordtype">bool</span> is_fetch = (mode == <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585ea63234010c6a55c971617a58bd577566b">Execute</a>);
<a name="l00556"></a>00556     <span class="keywordtype">bool</span> is_write = (mode == <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585ea19df812c62f939e92e6d395572c900b5">Write</a>);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     <span class="keywordflow">if</span> (!is_fetch) {
<a name="l00559"></a>00559         assert(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbba8f0bd8656496d2a811b655f4eb6804ab">MustBeOne</a>);
<a name="l00560"></a>00560         <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.a || !(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbbad5c5b8facc5c439d3a76a30e9437a063">AllowUnaligned</a>)) {
<a name="l00561"></a>00561             <span class="keywordflow">if</span> (vaddr &amp; <a class="code" href="namespaceArmISA.html#aedf8742bbf65a60cf102a4b3f9ba3d68">mask</a>(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbbaeba3c1af8a692106738171078a0c9415">AlignmentMask</a>)) {
<a name="l00562"></a>00562                 <span class="comment">// LPAE is always disabled in SE mode</span>
<a name="l00563"></a>00563                 <span class="keywordflow">return</span> std::make_shared&lt;DataAbort&gt;(
<a name="l00564"></a>00564                     vaddr_tainted,
<a name="l00565"></a>00565                     TlbEntry::DomainType::NoAccess, is_write,
<a name="l00566"></a>00566                     <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba6d768f0e624f74c08959bf971eb97589">ArmFault::AlignmentFault</a>, <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>,
<a name="l00567"></a>00567                     <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7a0cafd1f4e2d0ba7ab9f0dbb0a16d16f9">ArmFault::VmsaTran</a>);
<a name="l00568"></a>00568             }
<a name="l00569"></a>00569         }
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> paddr;
<a name="l00573"></a>00573     <a class="code" href="classProcess.html">Process</a> *<a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a> = tc-&gt;<a class="code" href="classThreadContext.html#a578034e4f174170011007e9908ca666d">getProcessPtr</a>();
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="classProcess.html#a7552fa628a7b15b63970a983f42891a4">pTable</a>-&gt;<a class="code" href="classPageTableBase.html#ab5bf10037aa58cf34d1d5254e40e5c96" title="Translate function.">translate</a>(vaddr, paddr))
<a name="l00576"></a>00576         <span class="keywordflow">return</span> std::make_shared&lt;GenericPageTableFault&gt;(vaddr_tainted);
<a name="l00577"></a>00577     req-&gt;<a class="code" href="classRequest.html#ae2e4cad1ec45a1cb2a31215f7af9f4af" title="Set just the physical address.">setPaddr</a>(paddr);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="keywordflow">return</span> NoFault;
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l00583"></a><a class="code" href="classArmISA_1_1TLB.html#a9e1da0b92f4da89bf4c34f9b51529ed1">00583</a> <a class="code" href="classArmISA_1_1TLB.html#a9e1da0b92f4da89bf4c34f9b51529ed1">TLB::trickBoxCheck</a>(<a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>, <a class="code" href="structArmISA_1_1TlbEntry.html#a31010741ac437b50594310ecec826f60">TlbEntry::DomainType</a> <a class="code" href="namespaceArmISA.html#a08ca08e977abd83ab95c7c4251ddf90d">domain</a>)
<a name="l00584"></a>00584 {
<a name="l00585"></a>00585     <span class="keywordflow">return</span> NoFault;
<a name="l00586"></a>00586 }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l00589"></a><a class="code" href="classArmISA_1_1TLB.html#a58812ef7433ba936aa2f98adfe5aa39c">00589</a> <a class="code" href="classArmISA_1_1TLB.html#a58812ef7433ba936aa2f98adfe5aa39c">TLB::walkTrickBoxCheck</a>(<a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceArmISA.html#a669a5d9343209851e234d5f2f7c573d5">pa</a>, <span class="keywordtype">bool</span> is_secure, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceArmISA.html#aa9331aab1c34d5babc25ea53e521b708">va</a>, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> sz, <span class="keywordtype">bool</span> is_exec,
<a name="l00590"></a>00590         <span class="keywordtype">bool</span> is_write, <a class="code" href="structArmISA_1_1TlbEntry.html#a31010741ac437b50594310ecec826f60">TlbEntry::DomainType</a> <a class="code" href="namespaceArmISA.html#a08ca08e977abd83ab95c7c4251ddf90d">domain</a>, <a class="code" href="namespaceArmISA.html#a61e59682673124232fb275589cac9136">LookupLevel</a> lookup_level)
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592     <span class="keywordflow">return</span> NoFault;
<a name="l00593"></a>00593 }
<a name="l00594"></a>00594 
<a name="l00595"></a>00595 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l00596"></a><a class="code" href="classArmISA_1_1TLB.html#a64041a89039c259e806abc967f5fbdb1">00596</a> <a class="code" href="classArmISA_1_1TLB.html#a64041a89039c259e806abc967f5fbdb1">TLB::checkPermissions</a>(<a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *<a class="code" href="namespaceMipsISA.html#a96bd0a55377fd83938867fd4d63d664d">te</a>, <a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>)
<a name="l00597"></a>00597 {
<a name="l00598"></a>00598     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceMipsISA.html#a9bab751e4fa25d88bf84ee970a01a641">vaddr</a> = req-&gt;<a class="code" href="classRequest.html#afd69006362aca38468eb15ad06c3f79b">getVaddr</a>(); <span class="comment">// 32-bit don&apos;t have to purify</span>
<a name="l00599"></a>00599     uint32_t flags = req-&gt;<a class="code" href="classRequest.html#ab5c7328019f59c101363cfb6b0cb51f2" title="Accessor for flags.">getFlags</a>();
<a name="l00600"></a>00600     <span class="keywordtype">bool</span> is_fetch  = (mode == <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585ea63234010c6a55c971617a58bd577566b">Execute</a>);
<a name="l00601"></a>00601     <span class="keywordtype">bool</span> is_write  = (mode == <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585ea19df812c62f939e92e6d395572c900b5">Write</a>);
<a name="l00602"></a>00602     <span class="keywordtype">bool</span> is_priv   = <a class="code" href="classArmISA_1_1TLB.html#ad56114d8c8c01ecac6cfcef19cab341a">isPriv</a> &amp;&amp; !(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbba3b6e86a4a2b30349df260f325e251c35">UserMode</a>);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="comment">// Get the translation type from the actuall table entry</span>
<a name="l00605"></a>00605     <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7">ArmFault::TranMethod</a> tranMethod = te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a9613e3bef8f31852c9d632313686495d">longDescFormat</a> ? <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7acb08e0463457bb8896b2d4f021e071f5">ArmFault::LpaeTran</a>
<a name="l00606"></a>00606                                                          : <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7a0cafd1f4e2d0ba7ab9f0dbb0a16d16f9">ArmFault::VmsaTran</a>;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608     <span class="comment">// If this is the second stage of translation and the request is for a</span>
<a name="l00609"></a>00609     <span class="comment">// stage 1 page table walk then we need to check the HCR.PTW bit. This</span>
<a name="l00610"></a>00610     <span class="comment">// allows us to generate a fault if the request targets an area marked</span>
<a name="l00611"></a>00611     <span class="comment">// as a device or strongly ordered.</span>
<a name="l00612"></a>00612     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> &amp;&amp; req-&gt;<a class="code" href="classRequest.html#aa8bab43324659ced592522d5ee367128">isPTWalk</a>() &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#acbee2238dee7b765078cf6a7db1e5f94">hcr</a>.ptw &amp;&amp;
<a name="l00613"></a>00613         (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af18922b22f7a395bfdfd8c5a56aa2efa">mtype</a> != TlbEntry::MemoryType::Normal)) {
<a name="l00614"></a>00614         <span class="keywordflow">return</span> std::make_shared&lt;DataAbort&gt;(
<a name="l00615"></a>00615             vaddr, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a94f98aa8eec65aacfcfccd40a4aea72e">domain</a>, is_write,
<a name="l00616"></a>00616             <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba67e178d678012b0951bfea90f70e7090">ArmFault::PermissionLL</a> + te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af71162bb150f89b360b71f0f4c4bc6cb">lookupLevel</a>,
<a name="l00617"></a>00617             <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>, tranMethod);
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620     <span class="comment">// Generate an alignment fault for unaligned data accesses to device or</span>
<a name="l00621"></a>00621     <span class="comment">// strongly ordered memory</span>
<a name="l00622"></a>00622     <span class="keywordflow">if</span> (!is_fetch) {
<a name="l00623"></a>00623         <span class="keywordflow">if</span> (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af18922b22f7a395bfdfd8c5a56aa2efa">mtype</a> != TlbEntry::MemoryType::Normal) {
<a name="l00624"></a>00624             <span class="keywordflow">if</span> (vaddr &amp; <a class="code" href="namespaceArmISA.html#aedf8742bbf65a60cf102a4b3f9ba3d68">mask</a>(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbbaeba3c1af8a692106738171078a0c9415">AlignmentMask</a>)) {
<a name="l00625"></a>00625                 <a class="code" href="classArmISA_1_1TLB.html#a655dd5813d52b551be565206abb14b41">alignFaults</a>++;
<a name="l00626"></a>00626                 <span class="keywordflow">return</span> std::make_shared&lt;DataAbort&gt;(
<a name="l00627"></a>00627                     vaddr, TlbEntry::DomainType::NoAccess, is_write,
<a name="l00628"></a>00628                     <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba6d768f0e624f74c08959bf971eb97589">ArmFault::AlignmentFault</a>, <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>,
<a name="l00629"></a>00629                     tranMethod);
<a name="l00630"></a>00630             }
<a name="l00631"></a>00631         }
<a name="l00632"></a>00632     }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="keywordflow">if</span> (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aa48086307b7c0138fd5523586b237ce1">nonCacheable</a>) {
<a name="l00635"></a>00635         <span class="comment">// Prevent prefetching from I/O devices.</span>
<a name="l00636"></a>00636         <span class="keywordflow">if</span> (req-&gt;<a class="code" href="classRequest.html#a2ce7bb6276d358e2b49abd30aae0431a">isPrefetch</a>()) {
<a name="l00637"></a>00637             <span class="comment">// Here we can safely use the fault status for the short</span>
<a name="l00638"></a>00638             <span class="comment">// desc. format in all cases</span>
<a name="l00639"></a>00639             <span class="keywordflow">return</span> std::make_shared&lt;PrefetchAbort&gt;(
<a name="l00640"></a>00640                 vaddr, <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba704b8418e7ba5995513a2412f32ddf2e">ArmFault::PrefetchUncacheable</a>,
<a name="l00641"></a>00641                 <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>, tranMethod);
<a name="l00642"></a>00642         }
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     <span class="keywordflow">if</span> (!te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a9613e3bef8f31852c9d632313686495d">longDescFormat</a>) {
<a name="l00646"></a>00646         <span class="keywordflow">switch</span> ((<a class="code" href="classArmISA_1_1TLB.html#ad955d3c1c52d9b45bc86a77f6d145441">dacr</a> &gt;&gt; (static_cast&lt;uint8_t&gt;(te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a94f98aa8eec65aacfcfccd40a4aea72e">domain</a>) * 2)) &amp; 0x3) {
<a name="l00647"></a>00647           <span class="keywordflow">case</span> 0:
<a name="l00648"></a>00648             <a class="code" href="classArmISA_1_1TLB.html#ab2b9dac041d03c3526507570622785f8">domainFaults</a>++;
<a name="l00649"></a>00649             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;TLB Fault: Data abort on domain. DACR: %#x&quot;</span>
<a name="l00650"></a>00650                     <span class="stringliteral">&quot; domain: %#x write:%d\n&quot;</span>, <a class="code" href="classArmISA_1_1TLB.html#ad955d3c1c52d9b45bc86a77f6d145441">dacr</a>,
<a name="l00651"></a>00651                     static_cast&lt;uint8_t&gt;(te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a94f98aa8eec65aacfcfccd40a4aea72e">domain</a>), is_write);
<a name="l00652"></a>00652             <span class="keywordflow">if</span> (is_fetch)
<a name="l00653"></a>00653                 <span class="keywordflow">return</span> std::make_shared&lt;PrefetchAbort&gt;(
<a name="l00654"></a>00654                     vaddr,
<a name="l00655"></a>00655                     <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba3d1db89a45ca3fb55f537b6409d3c4bd">ArmFault::DomainLL</a> + te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af71162bb150f89b360b71f0f4c4bc6cb">lookupLevel</a>,
<a name="l00656"></a>00656                     <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>, tranMethod);
<a name="l00657"></a>00657             <span class="keywordflow">else</span>
<a name="l00658"></a>00658                 <span class="keywordflow">return</span> std::make_shared&lt;DataAbort&gt;(
<a name="l00659"></a>00659                     vaddr, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a94f98aa8eec65aacfcfccd40a4aea72e">domain</a>, is_write,
<a name="l00660"></a>00660                     <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba3d1db89a45ca3fb55f537b6409d3c4bd">ArmFault::DomainLL</a> + te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af71162bb150f89b360b71f0f4c4bc6cb">lookupLevel</a>,
<a name="l00661"></a>00661                     <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>, tranMethod);
<a name="l00662"></a>00662           <span class="keywordflow">case</span> 1:
<a name="l00663"></a>00663             <span class="comment">// Continue with permissions check</span>
<a name="l00664"></a>00664             <span class="keywordflow">break</span>;
<a name="l00665"></a>00665           <span class="keywordflow">case</span> 2:
<a name="l00666"></a>00666             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;UNPRED domain\n&quot;</span>);
<a name="l00667"></a>00667           <span class="keywordflow">case</span> 3:
<a name="l00668"></a>00668             <span class="keywordflow">return</span> NoFault;
<a name="l00669"></a>00669         }
<a name="l00670"></a>00670     }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="comment">// The &apos;ap&apos; variable is AP[2:0] or {AP[2,1],1b&apos;0}, i.e. always three bits</span>
<a name="l00673"></a>00673     uint8_t ap  = te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a9613e3bef8f31852c9d632313686495d">longDescFormat</a> ? te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a7e7354fa4ecc350cd54e8f61d6dd2395">ap</a> &lt;&lt; 1 : te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a7e7354fa4ecc350cd54e8f61d6dd2395">ap</a>;
<a name="l00674"></a>00674     uint8_t hap = te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a5154283ada4bfe1ba2db4a2087cd3ea9">hap</a>;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.afe == 1 || te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a9613e3bef8f31852c9d632313686495d">longDescFormat</a>)
<a name="l00677"></a>00677         ap |= 1;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679     <span class="keywordtype">bool</span> abt;
<a name="l00680"></a>00680     <span class="keywordtype">bool</span> isWritable = <span class="keyword">true</span>;
<a name="l00681"></a>00681     <span class="comment">// If this is a stage 2 access (eg for reading stage 1 page table entries)</span>
<a name="l00682"></a>00682     <span class="comment">// then don&apos;t perform the AP permissions check, we stil do the HAP check</span>
<a name="l00683"></a>00683     <span class="comment">// below.</span>
<a name="l00684"></a>00684     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>) {
<a name="l00685"></a>00685         abt = <span class="keyword">false</span>;
<a name="l00686"></a>00686     } <span class="keywordflow">else</span> {
<a name="l00687"></a>00687         <span class="keywordflow">switch</span> (ap) {
<a name="l00688"></a>00688           <span class="keywordflow">case</span> 0:
<a name="l00689"></a>00689             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;Access permissions 0, checking rs:%#x\n&quot;</span>,
<a name="l00690"></a>00690                     (<span class="keywordtype">int</span>)<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.rs);
<a name="l00691"></a>00691             <span class="keywordflow">if</span> (!<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.xp) {
<a name="l00692"></a>00692                 <span class="keywordflow">switch</span> ((<span class="keywordtype">int</span>)<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.rs) {
<a name="l00693"></a>00693                   <span class="keywordflow">case</span> 2:
<a name="l00694"></a>00694                     abt = is_write;
<a name="l00695"></a>00695                     <span class="keywordflow">break</span>;
<a name="l00696"></a>00696                   <span class="keywordflow">case</span> 1:
<a name="l00697"></a>00697                     abt = is_write || !is_priv;
<a name="l00698"></a>00698                     <span class="keywordflow">break</span>;
<a name="l00699"></a>00699                   <span class="keywordflow">case</span> 0:
<a name="l00700"></a>00700                   <span class="keywordflow">case</span> 3:
<a name="l00701"></a>00701                   <span class="keywordflow">default</span>:
<a name="l00702"></a>00702                     abt = <span class="keyword">true</span>;
<a name="l00703"></a>00703                     <span class="keywordflow">break</span>;
<a name="l00704"></a>00704                 }
<a name="l00705"></a>00705             } <span class="keywordflow">else</span> {
<a name="l00706"></a>00706                 abt = <span class="keyword">true</span>;
<a name="l00707"></a>00707             }
<a name="l00708"></a>00708             <span class="keywordflow">break</span>;
<a name="l00709"></a>00709           <span class="keywordflow">case</span> 1:
<a name="l00710"></a>00710             abt = !is_priv;
<a name="l00711"></a>00711             <span class="keywordflow">break</span>;
<a name="l00712"></a>00712           <span class="keywordflow">case</span> 2:
<a name="l00713"></a>00713             abt = !is_priv &amp;&amp; is_write;
<a name="l00714"></a>00714             isWritable = is_priv;
<a name="l00715"></a>00715             <span class="keywordflow">break</span>;
<a name="l00716"></a>00716           <span class="keywordflow">case</span> 3:
<a name="l00717"></a>00717             abt = <span class="keyword">false</span>;
<a name="l00718"></a>00718             <span class="keywordflow">break</span>;
<a name="l00719"></a>00719           <span class="keywordflow">case</span> 4:
<a name="l00720"></a>00720             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;UNPRED premissions\n&quot;</span>);
<a name="l00721"></a>00721           <span class="keywordflow">case</span> 5:
<a name="l00722"></a>00722             abt = !is_priv || is_write;
<a name="l00723"></a>00723             isWritable = <span class="keyword">false</span>;
<a name="l00724"></a>00724             <span class="keywordflow">break</span>;
<a name="l00725"></a>00725           <span class="keywordflow">case</span> 6:
<a name="l00726"></a>00726           <span class="keywordflow">case</span> 7:
<a name="l00727"></a>00727             abt        = is_write;
<a name="l00728"></a>00728             isWritable = <span class="keyword">false</span>;
<a name="l00729"></a>00729             <span class="keywordflow">break</span>;
<a name="l00730"></a>00730           <span class="keywordflow">default</span>:
<a name="l00731"></a>00731             <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Unknown permissions %#x\n&quot;</span>, ap);
<a name="l00732"></a>00732         }
<a name="l00733"></a>00733     }
<a name="l00734"></a>00734 
<a name="l00735"></a>00735     <span class="keywordtype">bool</span> hapAbt = is_write ? !(hap &amp; 2) : !(hap &amp; 1);
<a name="l00736"></a>00736     <span class="keywordtype">bool</span> xn     = te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a63c7605dfb1cbdc03f2d2ba6d39c6488">xn</a> || (isWritable &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.wxn) ||
<a name="l00737"></a>00737                             (ap == 3    &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.uwxn &amp;&amp; is_priv);
<a name="l00738"></a>00738     <span class="keywordflow">if</span> (is_fetch &amp;&amp; (abt || xn ||
<a name="l00739"></a>00739                      (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a9613e3bef8f31852c9d632313686495d">longDescFormat</a> &amp;&amp; te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a09583a9463eba49352440586a1b84d2f">pxn</a> &amp;&amp; !is_priv) ||
<a name="l00740"></a>00740                      (<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a> &amp;&amp; te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#ab3f1550285f0f8622abfd6fadfe6aa39">ns</a> &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#aef45b64be1c099cf9c7d4d8c3b7193fb">scr</a>.sif))) {
<a name="l00741"></a>00741         <a class="code" href="classArmISA_1_1TLB.html#aa96037381db38a7f5f9f4cf72b73a999">permsFaults</a>++;
<a name="l00742"></a>00742         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;TLB Fault: Prefetch abort on permission check. AP:%d &quot;</span>
<a name="l00743"></a>00743                      <span class="stringliteral">&quot;priv:%d write:%d ns:%d sif:%d sctlr.afe: %d \n&quot;</span>,
<a name="l00744"></a>00744                      ap, is_priv, is_write, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#ab3f1550285f0f8622abfd6fadfe6aa39">ns</a>, <a class="code" href="classArmISA_1_1TLB.html#aef45b64be1c099cf9c7d4d8c3b7193fb">scr</a>.sif,<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.afe);
<a name="l00745"></a>00745         <span class="keywordflow">return</span> std::make_shared&lt;PrefetchAbort&gt;(
<a name="l00746"></a>00746             vaddr,
<a name="l00747"></a>00747             <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba67e178d678012b0951bfea90f70e7090">ArmFault::PermissionLL</a> + te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af71162bb150f89b360b71f0f4c4bc6cb">lookupLevel</a>,
<a name="l00748"></a>00748             <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>, tranMethod);
<a name="l00749"></a>00749     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (abt | hapAbt) {
<a name="l00750"></a>00750         <a class="code" href="classArmISA_1_1TLB.html#aa96037381db38a7f5f9f4cf72b73a999">permsFaults</a>++;
<a name="l00751"></a>00751         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;TLB Fault: Data abort on permission check. AP:%d priv:%d&quot;</span>
<a name="l00752"></a>00752                <span class="stringliteral">&quot; write:%d\n&quot;</span>, ap, is_priv, is_write);
<a name="l00753"></a>00753         <span class="keywordflow">return</span> std::make_shared&lt;DataAbort&gt;(
<a name="l00754"></a>00754             vaddr, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a94f98aa8eec65aacfcfccd40a4aea72e">domain</a>, is_write,
<a name="l00755"></a>00755             <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba67e178d678012b0951bfea90f70e7090">ArmFault::PermissionLL</a> + te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af71162bb150f89b360b71f0f4c4bc6cb">lookupLevel</a>,
<a name="l00756"></a>00756             <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> | !abt, tranMethod);
<a name="l00757"></a>00757     }
<a name="l00758"></a>00758     <span class="keywordflow">return</span> NoFault;
<a name="l00759"></a>00759 }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 
<a name="l00762"></a>00762 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l00763"></a><a class="code" href="classArmISA_1_1TLB.html#a58349edfa91a94e5f65fd15230c0c0d1">00763</a> <a class="code" href="classArmISA_1_1TLB.html#a58349edfa91a94e5f65fd15230c0c0d1">TLB::checkPermissions64</a>(<a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *<a class="code" href="namespaceMipsISA.html#a96bd0a55377fd83938867fd4d63d664d">te</a>, <a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>,
<a name="l00764"></a>00764                         <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>)
<a name="l00765"></a>00765 {
<a name="l00766"></a>00766     assert(<a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a>);
<a name="l00767"></a>00767 
<a name="l00768"></a>00768     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> vaddr_tainted = req-&gt;<a class="code" href="classRequest.html#afd69006362aca38468eb15ad06c3f79b">getVaddr</a>();
<a name="l00769"></a>00769     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceMipsISA.html#a9bab751e4fa25d88bf84ee970a01a641">vaddr</a> = <a class="code" href="namespaceArmISA.html#a17830702f2a3c01ca77252e146d45bba" title="Removes the tag from tagged addresses if that mode is enabled.">purifyTaggedAddr</a>(vaddr_tainted, tc, <a class="code" href="classArmISA_1_1TLB.html#a988fddb2d918607d96728869aa647c88">aarch64EL</a>, <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a>);
<a name="l00770"></a>00770 
<a name="l00771"></a>00771     uint32_t flags = req-&gt;<a class="code" href="classRequest.html#ab5c7328019f59c101363cfb6b0cb51f2" title="Accessor for flags.">getFlags</a>();
<a name="l00772"></a>00772     <span class="keywordtype">bool</span> is_fetch  = (mode == <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585ea63234010c6a55c971617a58bd577566b">Execute</a>);
<a name="l00773"></a>00773     <span class="keywordtype">bool</span> is_write  = (mode == <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585ea19df812c62f939e92e6d395572c900b5">Write</a>);
<a name="l00774"></a>00774     <span class="keywordtype">bool</span> is_priv <a class="code" href="namespaceArmISA.html#a7bca404a37e7db0156c4b14dad12c18f">M5_VAR_USED</a>  = <a class="code" href="classArmISA_1_1TLB.html#ad56114d8c8c01ecac6cfcef19cab341a">isPriv</a> &amp;&amp; !(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbba3b6e86a4a2b30349df260f325e251c35">UserMode</a>);
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     <a class="code" href="classArmISA_1_1TLB.html#a55ca28e8f7ad5d1230db775656384008">updateMiscReg</a>(tc, <a class="code" href="classArmISA_1_1TLB.html#a5bd475185224b35c02e03006736e87ec">curTranType</a>);
<a name="l00777"></a>00777 
<a name="l00778"></a>00778     <span class="comment">// If this is the second stage of translation and the request is for a</span>
<a name="l00779"></a>00779     <span class="comment">// stage 1 page table walk then we need to check the HCR.PTW bit. This</span>
<a name="l00780"></a>00780     <span class="comment">// allows us to generate a fault if the request targets an area marked</span>
<a name="l00781"></a>00781     <span class="comment">// as a device or strongly ordered.</span>
<a name="l00782"></a>00782     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> &amp;&amp; req-&gt;<a class="code" href="classRequest.html#aa8bab43324659ced592522d5ee367128">isPTWalk</a>() &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#acbee2238dee7b765078cf6a7db1e5f94">hcr</a>.ptw &amp;&amp;
<a name="l00783"></a>00783         (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af18922b22f7a395bfdfd8c5a56aa2efa">mtype</a> != TlbEntry::MemoryType::Normal)) {
<a name="l00784"></a>00784         <span class="keywordflow">return</span> std::make_shared&lt;DataAbort&gt;(
<a name="l00785"></a>00785             vaddr_tainted, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a94f98aa8eec65aacfcfccd40a4aea72e">domain</a>, is_write,
<a name="l00786"></a>00786             <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba67e178d678012b0951bfea90f70e7090">ArmFault::PermissionLL</a> + te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af71162bb150f89b360b71f0f4c4bc6cb">lookupLevel</a>,
<a name="l00787"></a>00787             <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>, <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7acb08e0463457bb8896b2d4f021e071f5">ArmFault::LpaeTran</a>);
<a name="l00788"></a>00788     }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     <span class="comment">// Generate an alignment fault for unaligned accesses to device or</span>
<a name="l00791"></a>00791     <span class="comment">// strongly ordered memory</span>
<a name="l00792"></a>00792     <span class="keywordflow">if</span> (!is_fetch) {
<a name="l00793"></a>00793         <span class="keywordflow">if</span> (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af18922b22f7a395bfdfd8c5a56aa2efa">mtype</a> != TlbEntry::MemoryType::Normal) {
<a name="l00794"></a>00794             <span class="keywordflow">if</span> (vaddr &amp; <a class="code" href="namespaceArmISA.html#aedf8742bbf65a60cf102a4b3f9ba3d68">mask</a>(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbbaeba3c1af8a692106738171078a0c9415">AlignmentMask</a>)) {
<a name="l00795"></a>00795                 <a class="code" href="classArmISA_1_1TLB.html#a655dd5813d52b551be565206abb14b41">alignFaults</a>++;
<a name="l00796"></a>00796                 <span class="keywordflow">return</span> std::make_shared&lt;DataAbort&gt;(
<a name="l00797"></a>00797                     vaddr_tainted,
<a name="l00798"></a>00798                     TlbEntry::DomainType::NoAccess, is_write,
<a name="l00799"></a>00799                     <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba6d768f0e624f74c08959bf971eb97589">ArmFault::AlignmentFault</a>, <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>,
<a name="l00800"></a>00800                     <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7acb08e0463457bb8896b2d4f021e071f5">ArmFault::LpaeTran</a>);
<a name="l00801"></a>00801             }
<a name="l00802"></a>00802         }
<a name="l00803"></a>00803     }
<a name="l00804"></a>00804 
<a name="l00805"></a>00805     <span class="keywordflow">if</span> (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aa48086307b7c0138fd5523586b237ce1">nonCacheable</a>) {
<a name="l00806"></a>00806         <span class="comment">// Prevent prefetching from I/O devices.</span>
<a name="l00807"></a>00807         <span class="keywordflow">if</span> (req-&gt;<a class="code" href="classRequest.html#a2ce7bb6276d358e2b49abd30aae0431a">isPrefetch</a>()) {
<a name="l00808"></a>00808             <span class="comment">// Here we can safely use the fault status for the short</span>
<a name="l00809"></a>00809             <span class="comment">// desc. format in all cases</span>
<a name="l00810"></a>00810             <span class="keywordflow">return</span> std::make_shared&lt;PrefetchAbort&gt;(
<a name="l00811"></a>00811                 vaddr_tainted,
<a name="l00812"></a>00812                 <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba704b8418e7ba5995513a2412f32ddf2e">ArmFault::PrefetchUncacheable</a>,
<a name="l00813"></a>00813                 <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>, <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7acb08e0463457bb8896b2d4f021e071f5">ArmFault::LpaeTran</a>);
<a name="l00814"></a>00814         }
<a name="l00815"></a>00815     }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817     uint8_t ap  = 0x3 &amp; (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a7e7354fa4ecc350cd54e8f61d6dd2395">ap</a>);  <span class="comment">// 2-bit access protection field</span>
<a name="l00818"></a>00818     <span class="keywordtype">bool</span> grant = <span class="keyword">false</span>;
<a name="l00819"></a>00819 
<a name="l00820"></a>00820     uint8_t xn =  te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a63c7605dfb1cbdc03f2d2ba6d39c6488">xn</a>;
<a name="l00821"></a>00821     uint8_t pxn = te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a09583a9463eba49352440586a1b84d2f">pxn</a>;
<a name="l00822"></a>00822     <span class="keywordtype">bool</span> <a class="code" href="namespaceMipsISA.html#a3c3acc97fbea659dbde9afcf8ecd1380">r</a> = !is_write &amp;&amp; !is_fetch;
<a name="l00823"></a>00823     <span class="keywordtype">bool</span> <a class="code" href="namespaceMipsISA.html#abbf89a8639f14e61b3b9a72ea14a06a8">w</a> = is_write;
<a name="l00824"></a>00824     <span class="keywordtype">bool</span> <a class="code" href="namespaceX86ISA.html#a7329cbd3da39e27c5b311899bac95a04">x</a> = is_fetch;
<a name="l00825"></a>00825     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(TLBVerbose, <span class="stringliteral">&quot;Checking permissions: ap:%d, xn:%d, pxn:%d, r:%d, &quot;</span>
<a name="l00826"></a>00826                         <span class="stringliteral">&quot;w:%d, x:%d\n&quot;</span>, ap, xn, pxn, r, w, x);
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>) {
<a name="l00829"></a>00829         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Virtualization in AArch64 state is not supported yet&quot;</span>);
<a name="l00830"></a>00830     } <span class="keywordflow">else</span> {
<a name="l00831"></a>00831         <span class="keywordflow">switch</span> (<a class="code" href="classArmISA_1_1TLB.html#a988fddb2d918607d96728869aa647c88">aarch64EL</a>) {
<a name="l00832"></a>00832           <span class="keywordflow">case</span> <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98daec94daab9638b134b5dcc5b226c7c9c8">EL0</a>:
<a name="l00833"></a>00833             {
<a name="l00834"></a>00834                 uint8_t perm = (ap &lt;&lt; 2)  | (xn &lt;&lt; 1) | pxn;
<a name="l00835"></a>00835                 <span class="keywordflow">switch</span> (perm) {
<a name="l00836"></a>00836                   <span class="keywordflow">case</span> 0:
<a name="l00837"></a>00837                   <span class="keywordflow">case</span> 1:
<a name="l00838"></a>00838                   <span class="keywordflow">case</span> 8:
<a name="l00839"></a>00839                   <span class="keywordflow">case</span> 9:
<a name="l00840"></a>00840                     grant = x;
<a name="l00841"></a>00841                     <span class="keywordflow">break</span>;
<a name="l00842"></a>00842                   <span class="keywordflow">case</span> 4:
<a name="l00843"></a>00843                   <span class="keywordflow">case</span> 5:
<a name="l00844"></a>00844                     grant = r || w || (x &amp;&amp; !<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.wxn);
<a name="l00845"></a>00845                     <span class="keywordflow">break</span>;
<a name="l00846"></a>00846                   <span class="keywordflow">case</span> 6:
<a name="l00847"></a>00847                   <span class="keywordflow">case</span> 7:
<a name="l00848"></a>00848                     grant = r || w;
<a name="l00849"></a>00849                     <span class="keywordflow">break</span>;
<a name="l00850"></a>00850                   <span class="keywordflow">case</span> 12:
<a name="l00851"></a>00851                   <span class="keywordflow">case</span> 13:
<a name="l00852"></a>00852                     grant = r || x;
<a name="l00853"></a>00853                     <span class="keywordflow">break</span>;
<a name="l00854"></a>00854                   <span class="keywordflow">case</span> 14:
<a name="l00855"></a>00855                   <span class="keywordflow">case</span> 15:
<a name="l00856"></a>00856                     grant = r;
<a name="l00857"></a>00857                     <span class="keywordflow">break</span>;
<a name="l00858"></a>00858                   <span class="keywordflow">default</span>:
<a name="l00859"></a>00859                     grant = <span class="keyword">false</span>;
<a name="l00860"></a>00860                 }
<a name="l00861"></a>00861             }
<a name="l00862"></a>00862             <span class="keywordflow">break</span>;
<a name="l00863"></a>00863           <span class="keywordflow">case</span> <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98dad1b4a69ba239877df9def4576845dfe5">EL1</a>:
<a name="l00864"></a>00864             {
<a name="l00865"></a>00865                 uint8_t perm = (ap &lt;&lt; 2)  | (xn &lt;&lt; 1) | pxn;
<a name="l00866"></a>00866                 <span class="keywordflow">switch</span> (perm) {
<a name="l00867"></a>00867                   <span class="keywordflow">case</span> 0:
<a name="l00868"></a>00868                   <span class="keywordflow">case</span> 2:
<a name="l00869"></a>00869                     grant = r || w || (x &amp;&amp; !<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.wxn);
<a name="l00870"></a>00870                     <span class="keywordflow">break</span>;
<a name="l00871"></a>00871                   <span class="keywordflow">case</span> 1:
<a name="l00872"></a>00872                   <span class="keywordflow">case</span> 3:
<a name="l00873"></a>00873                   <span class="keywordflow">case</span> 4:
<a name="l00874"></a>00874                   <span class="keywordflow">case</span> 5:
<a name="l00875"></a>00875                   <span class="keywordflow">case</span> 6:
<a name="l00876"></a>00876                   <span class="keywordflow">case</span> 7:
<a name="l00877"></a>00877                     <span class="comment">// regions that are writeable at EL0 should not be</span>
<a name="l00878"></a>00878                     <span class="comment">// executable at EL1</span>
<a name="l00879"></a>00879                     grant = r || w;
<a name="l00880"></a>00880                     <span class="keywordflow">break</span>;
<a name="l00881"></a>00881                   <span class="keywordflow">case</span> 8:
<a name="l00882"></a>00882                   <span class="keywordflow">case</span> 10:
<a name="l00883"></a>00883                   <span class="keywordflow">case</span> 12:
<a name="l00884"></a>00884                   <span class="keywordflow">case</span> 14:
<a name="l00885"></a>00885                     grant = r || x;
<a name="l00886"></a>00886                     <span class="keywordflow">break</span>;
<a name="l00887"></a>00887                   <span class="keywordflow">case</span> 9:
<a name="l00888"></a>00888                   <span class="keywordflow">case</span> 11:
<a name="l00889"></a>00889                   <span class="keywordflow">case</span> 13:
<a name="l00890"></a>00890                   <span class="keywordflow">case</span> 15:
<a name="l00891"></a>00891                     grant = r;
<a name="l00892"></a>00892                     <span class="keywordflow">break</span>;
<a name="l00893"></a>00893                   <span class="keywordflow">default</span>:
<a name="l00894"></a>00894                     grant = <span class="keyword">false</span>;
<a name="l00895"></a>00895                 }
<a name="l00896"></a>00896             }
<a name="l00897"></a>00897             <span class="keywordflow">break</span>;
<a name="l00898"></a>00898           <span class="keywordflow">case</span> <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98daa4c3712f2de98a3c6557776ed120b2ed">EL2</a>:
<a name="l00899"></a>00899           <span class="keywordflow">case</span> <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98da3dcb0a3ebc6bb1438051b3e943ae5325">EL3</a>:
<a name="l00900"></a>00900             {
<a name="l00901"></a>00901                 uint8_t perm = (ap &amp; 0x2) | xn;
<a name="l00902"></a>00902                 <span class="keywordflow">switch</span> (perm) {
<a name="l00903"></a>00903                   <span class="keywordflow">case</span> 0:
<a name="l00904"></a>00904                     grant = r || w || (x &amp;&amp; !<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.wxn) ;
<a name="l00905"></a>00905                     <span class="keywordflow">break</span>;
<a name="l00906"></a>00906                   <span class="keywordflow">case</span> 1:
<a name="l00907"></a>00907                     grant = r || w;
<a name="l00908"></a>00908                     <span class="keywordflow">break</span>;
<a name="l00909"></a>00909                   <span class="keywordflow">case</span> 2:
<a name="l00910"></a>00910                     grant = r || x;
<a name="l00911"></a>00911                     <span class="keywordflow">break</span>;
<a name="l00912"></a>00912                   <span class="keywordflow">case</span> 3:
<a name="l00913"></a>00913                     grant = r;
<a name="l00914"></a>00914                     <span class="keywordflow">break</span>;
<a name="l00915"></a>00915                   <span class="keywordflow">default</span>:
<a name="l00916"></a>00916                     grant = <span class="keyword">false</span>;
<a name="l00917"></a>00917                 }
<a name="l00918"></a>00918             }
<a name="l00919"></a>00919             <span class="keywordflow">break</span>;
<a name="l00920"></a>00920         }
<a name="l00921"></a>00921     }
<a name="l00922"></a>00922 
<a name="l00923"></a>00923     <span class="keywordflow">if</span> (!grant) {
<a name="l00924"></a>00924         <span class="keywordflow">if</span> (is_fetch) {
<a name="l00925"></a>00925             <a class="code" href="classArmISA_1_1TLB.html#aa96037381db38a7f5f9f4cf72b73a999">permsFaults</a>++;
<a name="l00926"></a>00926             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;TLB Fault: Prefetch abort on permission check. &quot;</span>
<a name="l00927"></a>00927                     <span class="stringliteral">&quot;AP:%d priv:%d write:%d ns:%d sif:%d &quot;</span>
<a name="l00928"></a>00928                     <span class="stringliteral">&quot;sctlr.afe: %d\n&quot;</span>,
<a name="l00929"></a>00929                     ap, is_priv, is_write, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#ab3f1550285f0f8622abfd6fadfe6aa39">ns</a>, <a class="code" href="classArmISA_1_1TLB.html#aef45b64be1c099cf9c7d4d8c3b7193fb">scr</a>.sif, <a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.afe);
<a name="l00930"></a>00930             <span class="comment">// Use PC value instead of vaddr because vaddr might be aligned to</span>
<a name="l00931"></a>00931             <span class="comment">// cache line and should not be the address reported in FAR</span>
<a name="l00932"></a>00932             <span class="keywordflow">return</span> std::make_shared&lt;PrefetchAbort&gt;(
<a name="l00933"></a>00933                 req-&gt;<a class="code" href="classRequest.html#aa558cd3835df8433f007d63aa833b376" title="Accessor function for pc.">getPC</a>(),
<a name="l00934"></a>00934                 <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba67e178d678012b0951bfea90f70e7090">ArmFault::PermissionLL</a> + te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af71162bb150f89b360b71f0f4c4bc6cb">lookupLevel</a>,
<a name="l00935"></a>00935                 <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>, <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7acb08e0463457bb8896b2d4f021e071f5">ArmFault::LpaeTran</a>);
<a name="l00936"></a>00936         } <span class="keywordflow">else</span> {
<a name="l00937"></a>00937             <a class="code" href="classArmISA_1_1TLB.html#aa96037381db38a7f5f9f4cf72b73a999">permsFaults</a>++;
<a name="l00938"></a>00938             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;TLB Fault: Data abort on permission check. AP:%d &quot;</span>
<a name="l00939"></a>00939                     <span class="stringliteral">&quot;priv:%d write:%d\n&quot;</span>, ap, is_priv, is_write);
<a name="l00940"></a>00940             <span class="keywordflow">return</span> std::make_shared&lt;DataAbort&gt;(
<a name="l00941"></a>00941                 vaddr_tainted, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a94f98aa8eec65aacfcfccd40a4aea72e">domain</a>, is_write,
<a name="l00942"></a>00942                 <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba67e178d678012b0951bfea90f70e7090">ArmFault::PermissionLL</a> + te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af71162bb150f89b360b71f0f4c4bc6cb">lookupLevel</a>,
<a name="l00943"></a>00943                 <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>, <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7acb08e0463457bb8896b2d4f021e071f5">ArmFault::LpaeTran</a>);
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945     }
<a name="l00946"></a>00946 
<a name="l00947"></a>00947     <span class="keywordflow">return</span> NoFault;
<a name="l00948"></a>00948 }
<a name="l00949"></a>00949 
<a name="l00950"></a>00950 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l00951"></a><a class="code" href="classArmISA_1_1TLB.html#a3c902b7580e9979a5012b130a287aa40">00951</a> <a class="code" href="classArmISA_1_1TLB.html#a3c902b7580e9979a5012b130a287aa40">TLB::translateFs</a>(<a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>,
<a name="l00952"></a>00952         <a class="code" href="classBaseTLB_1_1Translation.html">Translation</a> *translation, <span class="keywordtype">bool</span> &amp;delay, <span class="keywordtype">bool</span> timing,
<a name="l00953"></a>00953         <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094">TLB::ArmTranslationType</a> tranType, <span class="keywordtype">bool</span> functional)
<a name="l00954"></a>00954 {
<a name="l00955"></a>00955     <span class="comment">// No such thing as a functional timing access</span>
<a name="l00956"></a>00956     assert(!(timing &amp;&amp; functional));
<a name="l00957"></a>00957 
<a name="l00958"></a>00958     <a class="code" href="classArmISA_1_1TLB.html#a55ca28e8f7ad5d1230db775656384008">updateMiscReg</a>(tc, tranType);
<a name="l00959"></a>00959 
<a name="l00960"></a>00960     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> vaddr_tainted = req-&gt;<a class="code" href="classRequest.html#afd69006362aca38468eb15ad06c3f79b">getVaddr</a>();
<a name="l00961"></a>00961     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceMipsISA.html#a9bab751e4fa25d88bf84ee970a01a641">vaddr</a> = 0;
<a name="l00962"></a>00962     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a>)
<a name="l00963"></a>00963         vaddr = <a class="code" href="namespaceArmISA.html#a17830702f2a3c01ca77252e146d45bba" title="Removes the tag from tagged addresses if that mode is enabled.">purifyTaggedAddr</a>(vaddr_tainted, tc, <a class="code" href="classArmISA_1_1TLB.html#a988fddb2d918607d96728869aa647c88">aarch64EL</a>, <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a>);
<a name="l00964"></a>00964     <span class="keywordflow">else</span>
<a name="l00965"></a>00965         vaddr = vaddr_tainted;
<a name="l00966"></a>00966     uint32_t flags = req-&gt;<a class="code" href="classRequest.html#ab5c7328019f59c101363cfb6b0cb51f2" title="Accessor for flags.">getFlags</a>();
<a name="l00967"></a>00967 
<a name="l00968"></a>00968     <span class="keywordtype">bool</span> is_fetch  = (mode == <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585ea63234010c6a55c971617a58bd577566b">Execute</a>);
<a name="l00969"></a>00969     <span class="keywordtype">bool</span> is_write  = (mode == <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585ea19df812c62f939e92e6d395572c900b5">Write</a>);
<a name="l00970"></a>00970     <span class="keywordtype">bool</span> long_desc_format = <a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a> || (<a class="code" href="classArmISA_1_1TLB.html#ac124897414ac526a624ea559da1ae7e4">haveLPAE</a> &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a>.eae);
<a name="l00971"></a>00971     <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7">ArmFault::TranMethod</a> tranMethod = long_desc_format ? <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7acb08e0463457bb8896b2d4f021e071f5">ArmFault::LpaeTran</a>
<a name="l00972"></a>00972                                                        : <a class="code" href="classArmISA_1_1ArmFault.html#ac7119dff39f998f7a72c869891452cd7a0cafd1f4e2d0ba7ab9f0dbb0a16d16f9">ArmFault::VmsaTran</a>;
<a name="l00973"></a>00973 
<a name="l00974"></a>00974     req-&gt;<a class="code" href="classRequest.html#abdceecd30bceeb145c3af4ad80c21617" title="Accessor function for asid.">setAsid</a>(<a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a>);
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(TLBVerbose, <span class="stringliteral">&quot;CPSR is priv:%d UserMode:%d secure:%d S1S2NsTran:%d\n&quot;</span>,
<a name="l00977"></a>00977             <a class="code" href="classArmISA_1_1TLB.html#ad56114d8c8c01ecac6cfcef19cab341a">isPriv</a>, flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbba3b6e86a4a2b30349df260f325e251c35">UserMode</a>, <a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>, tranType &amp; <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094a4ed197054e9e92dcc10ed6a427a1cf21">S1S2NsTran</a>);
<a name="l00978"></a>00978 
<a name="l00979"></a>00979     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;translateFs addr %#x, mode %d, st2 %d, scr %#x sctlr %#x &quot;</span>
<a name="l00980"></a>00980                  <span class="stringliteral">&quot;flags %#x tranType 0x%x\n&quot;</span>, vaddr_tainted, mode, <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>,
<a name="l00981"></a>00981                  <a class="code" href="classArmISA_1_1TLB.html#aef45b64be1c099cf9c7d4d8c3b7193fb">scr</a>, <a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>, flags, tranType);
<a name="l00982"></a>00982 
<a name="l00983"></a>00983     <span class="comment">// If this is a clrex instruction, provide a PA of 0 with no fault</span>
<a name="l00984"></a>00984     <span class="comment">// This will force the monitor to set the tracked address to 0</span>
<a name="l00985"></a>00985     <span class="comment">// a bit of a hack but this effectively clrears this processors monitor</span>
<a name="l00986"></a>00986     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="classRequest.html#ade629b5668be14a369d2394039dd2055" title="This request is a clear exclusive.">Request::CLEAR_LL</a>){
<a name="l00987"></a>00987         <span class="comment">// @todo: check implications of security extensions</span>
<a name="l00988"></a>00988        req-&gt;<a class="code" href="classRequest.html#ae2e4cad1ec45a1cb2a31215f7af9f4af" title="Set just the physical address.">setPaddr</a>(0);
<a name="l00989"></a>00989        req-&gt;<a class="code" href="classRequest.html#a7d04b40518d8d721b2adc42a2c0209f7" title="Note that unlike other accessors, this function sets *specific flags* (ORs them in);...">setFlags</a>(<a class="code" href="classRequest.html#a33bf8c73df6e1a017daaa349ad9e98a1" title="The request is to an uncacheable address.">Request::UNCACHEABLE</a> | <a class="code" href="classRequest.html#a9dc1f2eb3d0b63d0375b4cd4174ab467" title="The request is required to be strictly ordered by CPU models and is non-speculative...">Request::STRICT_ORDER</a>);
<a name="l00990"></a>00990        req-&gt;<a class="code" href="classRequest.html#a7d04b40518d8d721b2adc42a2c0209f7" title="Note that unlike other accessors, this function sets *specific flags* (ORs them in);...">setFlags</a>(Request::CLEAR_LL);
<a name="l00991"></a>00991        <span class="keywordflow">return</span> NoFault;
<a name="l00992"></a>00992     }
<a name="l00993"></a>00993     <span class="keywordflow">if</span> ((req-&gt;<a class="code" href="classRequest.html#a5b8a4c6e44a4adba73cb78cb4abaea24">isInstFetch</a>() &amp;&amp; (!<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.i)) ||
<a name="l00994"></a>00994         ((!req-&gt;<a class="code" href="classRequest.html#a5b8a4c6e44a4adba73cb78cb4abaea24">isInstFetch</a>()) &amp;&amp; (!<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.c))){
<a name="l00995"></a>00995        req-&gt;<a class="code" href="classRequest.html#a7d04b40518d8d721b2adc42a2c0209f7" title="Note that unlike other accessors, this function sets *specific flags* (ORs them in);...">setFlags</a>(<a class="code" href="classRequest.html#a33bf8c73df6e1a017daaa349ad9e98a1" title="The request is to an uncacheable address.">Request::UNCACHEABLE</a> | <a class="code" href="classRequest.html#a9dc1f2eb3d0b63d0375b4cd4174ab467" title="The request is required to be strictly ordered by CPU models and is non-speculative...">Request::STRICT_ORDER</a>);
<a name="l00996"></a>00996     }
<a name="l00997"></a>00997     <span class="keywordflow">if</span> (!is_fetch) {
<a name="l00998"></a>00998         assert(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbba8f0bd8656496d2a811b655f4eb6804ab">MustBeOne</a>);
<a name="l00999"></a>00999         <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.a || !(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbbad5c5b8facc5c439d3a76a30e9437a063">AllowUnaligned</a>)) {
<a name="l01000"></a>01000             <span class="keywordflow">if</span> (vaddr &amp; <a class="code" href="namespaceArmISA.html#aedf8742bbf65a60cf102a4b3f9ba3d68">mask</a>(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbbaeba3c1af8a692106738171078a0c9415">AlignmentMask</a>)) {
<a name="l01001"></a>01001                 <a class="code" href="classArmISA_1_1TLB.html#a655dd5813d52b551be565206abb14b41">alignFaults</a>++;
<a name="l01002"></a>01002                 <span class="keywordflow">return</span> std::make_shared&lt;DataAbort&gt;(
<a name="l01003"></a>01003                     vaddr_tainted,
<a name="l01004"></a>01004                     TlbEntry::DomainType::NoAccess, is_write,
<a name="l01005"></a>01005                     <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba6d768f0e624f74c08959bf971eb97589">ArmFault::AlignmentFault</a>, <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>,
<a name="l01006"></a>01006                     tranMethod);
<a name="l01007"></a>01007             }
<a name="l01008"></a>01008         }
<a name="l01009"></a>01009     }
<a name="l01010"></a>01010 
<a name="l01011"></a>01011     <span class="comment">// If guest MMU is off or hcr.vm=0 go straight to stage2</span>
<a name="l01012"></a>01012     <span class="keywordflow">if</span> ((<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> &amp;&amp; !<a class="code" href="classArmISA_1_1TLB.html#acbee2238dee7b765078cf6a7db1e5f94">hcr</a>.vm) || (!<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> &amp;&amp; !<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.m)) {
<a name="l01013"></a>01013 
<a name="l01014"></a>01014         req-&gt;<a class="code" href="classRequest.html#ae2e4cad1ec45a1cb2a31215f7af9f4af" title="Set just the physical address.">setPaddr</a>(vaddr);
<a name="l01015"></a>01015         <span class="comment">// When the MMU is off the security attribute corresponds to the</span>
<a name="l01016"></a>01016         <span class="comment">// security state of the processor</span>
<a name="l01017"></a>01017         <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>)
<a name="l01018"></a>01018             req-&gt;<a class="code" href="classRequest.html#a7d04b40518d8d721b2adc42a2c0209f7" title="Note that unlike other accessors, this function sets *specific flags* (ORs them in);...">setFlags</a>(<a class="code" href="classRequest.html#aa73ed0b8658ef414024062287cc6acb0" title="The request targets the secure memory space.">Request::SECURE</a>);
<a name="l01019"></a>01019 
<a name="l01020"></a>01020         <span class="comment">// @todo: double check this (ARM ARM issue C B3.2.1)</span>
<a name="l01021"></a>01021         <span class="keywordflow">if</span> (long_desc_format || <a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.tre == 0) {
<a name="l01022"></a>01022             req-&gt;<a class="code" href="classRequest.html#a7d04b40518d8d721b2adc42a2c0209f7" title="Note that unlike other accessors, this function sets *specific flags* (ORs them in);...">setFlags</a>(<a class="code" href="classRequest.html#a33bf8c73df6e1a017daaa349ad9e98a1" title="The request is to an uncacheable address.">Request::UNCACHEABLE</a> | <a class="code" href="classRequest.html#a9dc1f2eb3d0b63d0375b4cd4174ab467" title="The request is required to be strictly ordered by CPU models and is non-speculative...">Request::STRICT_ORDER</a>);
<a name="l01023"></a>01023         } <span class="keywordflow">else</span> {
<a name="l01024"></a>01024             <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a802b10482266c5ce39b638711c88a8b1">nmrr</a>.ir0 == 0 || <a class="code" href="classArmISA_1_1TLB.html#a802b10482266c5ce39b638711c88a8b1">nmrr</a>.or0 == 0 || <a class="code" href="classArmISA_1_1TLB.html#a533ccc5fb8ebabb13775922cf63dd680">prrr</a>.tr0 != 0x2)
<a name="l01025"></a>01025                 req-&gt;<a class="code" href="classRequest.html#a7d04b40518d8d721b2adc42a2c0209f7" title="Note that unlike other accessors, this function sets *specific flags* (ORs them in);...">setFlags</a>(<a class="code" href="classRequest.html#a33bf8c73df6e1a017daaa349ad9e98a1" title="The request is to an uncacheable address.">Request::UNCACHEABLE</a> | <a class="code" href="classRequest.html#a9dc1f2eb3d0b63d0375b4cd4174ab467" title="The request is required to be strictly ordered by CPU models and is non-speculative...">Request::STRICT_ORDER</a>);
<a name="l01026"></a>01026         }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028         <span class="comment">// Set memory attributes</span>
<a name="l01029"></a>01029         <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> temp_te;
<a name="l01030"></a>01030         temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#ab3f1550285f0f8622abfd6fadfe6aa39">ns</a> = !<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>;
<a name="l01031"></a>01031         <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> || <a class="code" href="classArmISA_1_1TLB.html#acbee2238dee7b765078cf6a7db1e5f94">hcr</a>.dc == 0 || <a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a> ||
<a name="l01032"></a>01032            (<a class="code" href="classArmISA_1_1TLB.html#a37fb7444e14a925f74644836fe01bb8d">isHyp</a> &amp;&amp; !(tranType &amp; <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094a1d876ec22cd787c6b4c47f2f97c043c0">S1CTran</a>))) {
<a name="l01033"></a>01033 
<a name="l01034"></a>01034             temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#af18922b22f7a395bfdfd8c5a56aa2efa">mtype</a>      = is_fetch ? TlbEntry::MemoryType::Normal
<a name="l01035"></a>01035                                           : TlbEntry::MemoryType::StronglyOrdered;
<a name="l01036"></a>01036             temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#aac52d187ca4ef523ffa9c09e99998a8f">innerAttrs</a> = 0x0;
<a name="l01037"></a>01037             temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#aa8727837f6a8c6b89e4a529cd0355165">outerAttrs</a> = 0x0;
<a name="l01038"></a>01038             temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#a0de098a8a1e8fe2c9c299979c722c03b">shareable</a>  = <span class="keyword">true</span>;
<a name="l01039"></a>01039             temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#a1bfeab33f2cbc192d6ce8fc94f3b65c6">outerShareable</a> = <span class="keyword">true</span>;
<a name="l01040"></a>01040         } <span class="keywordflow">else</span> {
<a name="l01041"></a>01041             temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#af18922b22f7a395bfdfd8c5a56aa2efa">mtype</a>      = TlbEntry::MemoryType::Normal;
<a name="l01042"></a>01042             temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#aac52d187ca4ef523ffa9c09e99998a8f">innerAttrs</a> = 0x3;
<a name="l01043"></a>01043             temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#aa8727837f6a8c6b89e4a529cd0355165">outerAttrs</a> = 0x3;
<a name="l01044"></a>01044             temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#a0de098a8a1e8fe2c9c299979c722c03b">shareable</a>  = <span class="keyword">false</span>;
<a name="l01045"></a>01045             temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#a1bfeab33f2cbc192d6ce8fc94f3b65c6">outerShareable</a> = <span class="keyword">false</span>;
<a name="l01046"></a>01046         }
<a name="l01047"></a>01047         temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#a22a3864819a9ff13ffd7b22c66f44456">setAttributes</a>(long_desc_format);
<a name="l01048"></a>01048         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(TLBVerbose, <span class="stringliteral">&quot;(No MMU) setting memory attributes: shareable: &quot;</span>
<a name="l01049"></a>01049                 <span class="stringliteral">&quot;%d, innerAttrs: %d, outerAttrs: %d, isStage2: %d\n&quot;</span>,
<a name="l01050"></a>01050                 temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#a0de098a8a1e8fe2c9c299979c722c03b">shareable</a>, temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#aac52d187ca4ef523ffa9c09e99998a8f">innerAttrs</a>, temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#aa8727837f6a8c6b89e4a529cd0355165">outerAttrs</a>,
<a name="l01051"></a>01051                 <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>);
<a name="l01052"></a>01052         <a class="code" href="classArmISA_1_1TLB.html#aead531369fa0aab3365098fe114a13e1" title="Accessor functions for memory attributes for last accessed TLB entry.">setAttr</a>(temp_te.<a class="code" href="structArmISA_1_1TlbEntry.html#a001118c9e846a860827799669b467039">attributes</a>);
<a name="l01053"></a>01053 
<a name="l01054"></a>01054         <span class="keywordflow">return</span> <a class="code" href="classArmISA_1_1TLB.html#a9e1da0b92f4da89bf4c34f9b51529ed1">trickBoxCheck</a>(req, mode, TlbEntry::DomainType::NoAccess);
<a name="l01055"></a>01055     }
<a name="l01056"></a>01056 
<a name="l01057"></a>01057     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(TLBVerbose, <span class="stringliteral">&quot;Translating %s=%#x context=%d\n&quot;</span>,
<a name="l01058"></a>01058             <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> ? <span class="stringliteral">&quot;IPA&quot;</span> : <span class="stringliteral">&quot;VA&quot;</span>, vaddr_tainted, <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a>);
<a name="l01059"></a>01059     <span class="comment">// Translation enabled</span>
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *<a class="code" href="namespaceMipsISA.html#a96bd0a55377fd83938867fd4d63d664d">te</a> = NULL;
<a name="l01062"></a>01062     <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> mergeTe;
<a name="l01063"></a>01063     <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a> fault = <a class="code" href="classArmISA_1_1TLB.html#a78273d9afe906fdf79bc12fee77101a9">getResultTe</a>(&amp;te, req, tc, mode, translation, timing,
<a name="l01064"></a>01064                               functional, &amp;mergeTe);
<a name="l01065"></a>01065     <span class="comment">// only proceed if we have a valid table entry</span>
<a name="l01066"></a>01066     <span class="keywordflow">if</span> ((te == NULL) &amp;&amp; (fault == NoFault)) delay = <span class="keyword">true</span>;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068     <span class="comment">// If we have the table entry transfer some of the attributes to the</span>
<a name="l01069"></a>01069     <span class="comment">// request that triggered the translation</span>
<a name="l01070"></a>01070     <span class="keywordflow">if</span> (te != NULL) {
<a name="l01071"></a>01071         <span class="comment">// Set memory attributes</span>
<a name="l01072"></a>01072         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(TLBVerbose,
<a name="l01073"></a>01073                 <span class="stringliteral">&quot;Setting memory attributes: shareable: %d, innerAttrs: %d, &quot;</span>
<a name="l01074"></a>01074                 <span class="stringliteral">&quot;outerAttrs: %d, mtype: %d, isStage2: %d\n&quot;</span>,
<a name="l01075"></a>01075                 te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a0de098a8a1e8fe2c9c299979c722c03b">shareable</a>, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aac52d187ca4ef523ffa9c09e99998a8f">innerAttrs</a>, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aa8727837f6a8c6b89e4a529cd0355165">outerAttrs</a>,
<a name="l01076"></a>01076                 static_cast&lt;uint8_t&gt;(te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af18922b22f7a395bfdfd8c5a56aa2efa">mtype</a>), <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>);
<a name="l01077"></a>01077         <a class="code" href="classArmISA_1_1TLB.html#aead531369fa0aab3365098fe114a13e1" title="Accessor functions for memory attributes for last accessed TLB entry.">setAttr</a>(te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a001118c9e846a860827799669b467039">attributes</a>);
<a name="l01078"></a>01078 
<a name="l01079"></a>01079         <span class="keywordflow">if</span> (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aa48086307b7c0138fd5523586b237ce1">nonCacheable</a>)
<a name="l01080"></a>01080             req-&gt;<a class="code" href="classRequest.html#a7d04b40518d8d721b2adc42a2c0209f7" title="Note that unlike other accessors, this function sets *specific flags* (ORs them in);...">setFlags</a>(<a class="code" href="classRequest.html#a33bf8c73df6e1a017daaa349ad9e98a1" title="The request is to an uncacheable address.">Request::UNCACHEABLE</a>);
<a name="l01081"></a>01081 
<a name="l01082"></a>01082         <span class="comment">// Require requests to be ordered if the request goes to</span>
<a name="l01083"></a>01083         <span class="comment">// strongly ordered or device memory (i.e., anything other</span>
<a name="l01084"></a>01084         <span class="comment">// than normal memory requires strict order).</span>
<a name="l01085"></a>01085         <span class="keywordflow">if</span> (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af18922b22f7a395bfdfd8c5a56aa2efa">mtype</a> != TlbEntry::MemoryType::Normal)
<a name="l01086"></a>01086             req-&gt;<a class="code" href="classRequest.html#a7d04b40518d8d721b2adc42a2c0209f7" title="Note that unlike other accessors, this function sets *specific flags* (ORs them in);...">setFlags</a>(<a class="code" href="classRequest.html#a9dc1f2eb3d0b63d0375b4cd4174ab467" title="The request is required to be strictly ordered by CPU models and is non-speculative...">Request::STRICT_ORDER</a>);
<a name="l01087"></a>01087 
<a name="l01088"></a>01088         <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceArmISA.html#a669a5d9343209851e234d5f2f7c573d5">pa</a> = te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#aff7322ca730e3ca004347226176edb55">pAddr</a>(vaddr);
<a name="l01089"></a>01089         req-&gt;<a class="code" href="classRequest.html#ae2e4cad1ec45a1cb2a31215f7af9f4af" title="Set just the physical address.">setPaddr</a>(pa);
<a name="l01090"></a>01090 
<a name="l01091"></a>01091         <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a> &amp;&amp; !te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#ab3f1550285f0f8622abfd6fadfe6aa39">ns</a>) {
<a name="l01092"></a>01092             req-&gt;<a class="code" href="classRequest.html#a7d04b40518d8d721b2adc42a2c0209f7" title="Note that unlike other accessors, this function sets *specific flags* (ORs them in);...">setFlags</a>(<a class="code" href="classRequest.html#aa73ed0b8658ef414024062287cc6acb0" title="The request targets the secure memory space.">Request::SECURE</a>);
<a name="l01093"></a>01093         }
<a name="l01094"></a>01094         <span class="keywordflow">if</span> ((!is_fetch) &amp;&amp; (vaddr &amp; <a class="code" href="namespaceArmISA.html#aedf8742bbf65a60cf102a4b3f9ba3d68">mask</a>(flags &amp; <a class="code" href="classArmISA_1_1TLB.html#a197413c7b18469b1f2130a40ea995cbbaeba3c1af8a692106738171078a0c9415">AlignmentMask</a>)) &amp;&amp;
<a name="l01095"></a>01095             (te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#af18922b22f7a395bfdfd8c5a56aa2efa">mtype</a> != TlbEntry::MemoryType::Normal)) {
<a name="l01096"></a>01096                 <span class="comment">// Unaligned accesses to Device memory should always cause an</span>
<a name="l01097"></a>01097                 <span class="comment">// abort regardless of sctlr.a</span>
<a name="l01098"></a>01098                 <a class="code" href="classArmISA_1_1TLB.html#a655dd5813d52b551be565206abb14b41">alignFaults</a>++;
<a name="l01099"></a>01099                 <span class="keywordflow">return</span> std::make_shared&lt;DataAbort&gt;(
<a name="l01100"></a>01100                     vaddr_tainted,
<a name="l01101"></a>01101                     TlbEntry::DomainType::NoAccess, is_write,
<a name="l01102"></a>01102                     <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba6d768f0e624f74c08959bf971eb97589">ArmFault::AlignmentFault</a>, <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>,
<a name="l01103"></a>01103                     tranMethod);
<a name="l01104"></a>01104         }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106         <span class="comment">// Check for a trickbox generated address fault</span>
<a name="l01107"></a>01107         <span class="keywordflow">if</span> (fault == NoFault) {
<a name="l01108"></a>01108             fault = <a class="code" href="classArmISA_1_1TLB.html#a9e1da0b92f4da89bf4c34f9b51529ed1">trickBoxCheck</a>(req, mode, te-&gt;<a class="code" href="structArmISA_1_1TlbEntry.html#a94f98aa8eec65aacfcfccd40a4aea72e">domain</a>);
<a name="l01109"></a>01109         }
<a name="l01110"></a>01110     }
<a name="l01111"></a>01111 
<a name="l01112"></a>01112     <span class="comment">// Generate Illegal Inst Set State fault if IL bit is set in CPSR</span>
<a name="l01113"></a>01113     <span class="keywordflow">if</span> (fault == NoFault) {
<a name="l01114"></a>01114         <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a> &amp;&amp; is_fetch &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#a81dcd94edd8761d499e290a0d439f12a">cpsr</a>.il == 1) {
<a name="l01115"></a>01115             <span class="keywordflow">return</span> std::make_shared&lt;IllegalInstSetStateFault&gt;();
<a name="l01116"></a>01116         }
<a name="l01117"></a>01117     }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119     <span class="keywordflow">return</span> fault;
<a name="l01120"></a>01120 }
<a name="l01121"></a>01121 
<a name="l01122"></a>01122 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l01123"></a><a class="code" href="classArmISA_1_1TLB.html#aff53b44f224ef2da772eae67e2a4a665">01123</a> <a class="code" href="classArmISA_1_1TLB.html#aff53b44f224ef2da772eae67e2a4a665">TLB::translateAtomic</a>(<a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>,
<a name="l01124"></a>01124     <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094">TLB::ArmTranslationType</a> tranType)
<a name="l01125"></a>01125 {
<a name="l01126"></a>01126     <a class="code" href="classArmISA_1_1TLB.html#a55ca28e8f7ad5d1230db775656384008">updateMiscReg</a>(tc, tranType);
<a name="l01127"></a>01127 
<a name="l01128"></a>01128     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a>) {
<a name="l01129"></a>01129         assert(<a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>);
<a name="l01130"></a>01130         <span class="keywordflow">return</span> <a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>-&gt;<a class="code" href="classArmISA_1_1TLB.html#aff53b44f224ef2da772eae67e2a4a665">translateAtomic</a>(req, tc, mode, tranType);
<a name="l01131"></a>01131     }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133     <span class="keywordtype">bool</span> delay = <span class="keyword">false</span>;
<a name="l01134"></a>01134     <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a> fault;
<a name="l01135"></a>01135     <span class="keywordflow">if</span> (<a class="code" href="full__system_8hh.html#af929576af6f85c8849704b66d04b8370" title="The FullSystem variable can be used to determine the current mode of simulation.">FullSystem</a>)
<a name="l01136"></a>01136         fault = <a class="code" href="classArmISA_1_1TLB.html#a3c902b7580e9979a5012b130a287aa40">translateFs</a>(req, tc, mode, NULL, delay, <span class="keyword">false</span>, tranType);
<a name="l01137"></a>01137     <span class="keywordflow">else</span>
<a name="l01138"></a>01138         fault = <a class="code" href="classArmISA_1_1TLB.html#a80e334b22c1757f9785af4c74e40e4eb">translateSe</a>(req, tc, mode, NULL, delay, <span class="keyword">false</span>);
<a name="l01139"></a>01139     assert(!delay);
<a name="l01140"></a>01140     <span class="keywordflow">return</span> fault;
<a name="l01141"></a>01141 }
<a name="l01142"></a>01142 
<a name="l01143"></a>01143 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l01144"></a><a class="code" href="classArmISA_1_1TLB.html#a8a1cb0855342ca92ccd4c3f08c1dc548">01144</a> <a class="code" href="classArmISA_1_1TLB.html#a693297f6f1f044fdbfa0a2eca885c215" title="Do a functional lookup on the TLB (for debugging) and don&amp;#39;t modify any internal...">TLB::translateFunctional</a>(<a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>,
<a name="l01145"></a>01145     <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094">TLB::ArmTranslationType</a> tranType)
<a name="l01146"></a>01146 {
<a name="l01147"></a>01147     <a class="code" href="classArmISA_1_1TLB.html#a55ca28e8f7ad5d1230db775656384008">updateMiscReg</a>(tc, tranType);
<a name="l01148"></a>01148 
<a name="l01149"></a>01149     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a>) {
<a name="l01150"></a>01150         assert(<a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>);
<a name="l01151"></a>01151         <span class="keywordflow">return</span> <a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>-&gt;<a class="code" href="classArmISA_1_1TLB.html#a693297f6f1f044fdbfa0a2eca885c215" title="Do a functional lookup on the TLB (for debugging) and don&amp;#39;t modify any internal...">translateFunctional</a>(req, tc, mode, tranType);
<a name="l01152"></a>01152     }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154     <span class="keywordtype">bool</span> delay = <span class="keyword">false</span>;
<a name="l01155"></a>01155     <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a> fault;
<a name="l01156"></a>01156     <span class="keywordflow">if</span> (<a class="code" href="full__system_8hh.html#af929576af6f85c8849704b66d04b8370" title="The FullSystem variable can be used to determine the current mode of simulation.">FullSystem</a>)
<a name="l01157"></a>01157         fault = <a class="code" href="classArmISA_1_1TLB.html#a3c902b7580e9979a5012b130a287aa40">translateFs</a>(req, tc, mode, NULL, delay, <span class="keyword">false</span>, tranType, <span class="keyword">true</span>);
<a name="l01158"></a>01158    <span class="keywordflow">else</span>
<a name="l01159"></a>01159         fault = <a class="code" href="classArmISA_1_1TLB.html#a80e334b22c1757f9785af4c74e40e4eb">translateSe</a>(req, tc, mode, NULL, delay, <span class="keyword">false</span>);
<a name="l01160"></a>01160     assert(!delay);
<a name="l01161"></a>01161     <span class="keywordflow">return</span> fault;
<a name="l01162"></a>01162 }
<a name="l01163"></a>01163 
<a name="l01164"></a>01164 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l01165"></a><a class="code" href="classArmISA_1_1TLB.html#a5cb044896253e2907e6e8d73b417650a">01165</a> <a class="code" href="classArmISA_1_1TLB.html#a5cb044896253e2907e6e8d73b417650a">TLB::translateTiming</a>(<a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>,
<a name="l01166"></a>01166     <a class="code" href="classBaseTLB_1_1Translation.html">Translation</a> *translation, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>, <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094">TLB::ArmTranslationType</a> tranType)
<a name="l01167"></a>01167 {
<a name="l01168"></a>01168     <a class="code" href="classArmISA_1_1TLB.html#a55ca28e8f7ad5d1230db775656384008">updateMiscReg</a>(tc, tranType);
<a name="l01169"></a>01169 
<a name="l01170"></a>01170     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a>) {
<a name="l01171"></a>01171         assert(<a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>);
<a name="l01172"></a>01172         <span class="keywordflow">return</span> <a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>-&gt;<a class="code" href="classArmISA_1_1TLB.html#a5cb044896253e2907e6e8d73b417650a">translateTiming</a>(req, tc, translation, mode, tranType);
<a name="l01173"></a>01173     }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175     assert(translation);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177     <span class="keywordflow">return</span> <a class="code" href="classArmISA_1_1TLB.html#a37429268146c6e6f1f2ff266348fd051">translateComplete</a>(req, tc, translation, mode, tranType, <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>);
<a name="l01178"></a>01178 }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l01181"></a><a class="code" href="classArmISA_1_1TLB.html#a37429268146c6e6f1f2ff266348fd051">01181</a> <a class="code" href="classArmISA_1_1TLB.html#a37429268146c6e6f1f2ff266348fd051">TLB::translateComplete</a>(<a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>,
<a name="l01182"></a>01182         <a class="code" href="classBaseTLB_1_1Translation.html">Translation</a> *translation, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>, <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094">TLB::ArmTranslationType</a> tranType,
<a name="l01183"></a>01183         <span class="keywordtype">bool</span> callFromS2)
<a name="l01184"></a>01184 {
<a name="l01185"></a>01185     <span class="keywordtype">bool</span> delay = <span class="keyword">false</span>;
<a name="l01186"></a>01186     <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a> fault;
<a name="l01187"></a>01187     <span class="keywordflow">if</span> (<a class="code" href="full__system_8hh.html#af929576af6f85c8849704b66d04b8370" title="The FullSystem variable can be used to determine the current mode of simulation.">FullSystem</a>)
<a name="l01188"></a>01188         fault = <a class="code" href="classArmISA_1_1TLB.html#a3c902b7580e9979a5012b130a287aa40">translateFs</a>(req, tc, mode, translation, delay, <span class="keyword">true</span>, tranType);
<a name="l01189"></a>01189     <span class="keywordflow">else</span>
<a name="l01190"></a>01190         fault = <a class="code" href="classArmISA_1_1TLB.html#a80e334b22c1757f9785af4c74e40e4eb">translateSe</a>(req, tc, mode, translation, delay, <span class="keyword">true</span>);
<a name="l01191"></a>01191     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(TLBVerbose, <span class="stringliteral">&quot;Translation returning delay=%d fault=%d\n&quot;</span>, delay, fault !=
<a name="l01192"></a>01192             NoFault);
<a name="l01193"></a>01193     <span class="comment">// If we have a translation, and we&apos;re not in the middle of doing a stage</span>
<a name="l01194"></a>01194     <span class="comment">// 2 translation tell the translation that we&apos;ve either finished or its</span>
<a name="l01195"></a>01195     <span class="comment">// going to take a while. By not doing this when we&apos;re in the middle of a</span>
<a name="l01196"></a>01196     <span class="comment">// stage 2 translation we prevent marking the translation as delayed twice,</span>
<a name="l01197"></a>01197     <span class="comment">// one when the translation starts and again when the stage 1 translation</span>
<a name="l01198"></a>01198     <span class="comment">// completes.</span>
<a name="l01199"></a>01199     <span class="keywordflow">if</span> (translation &amp;&amp; (callFromS2 || !<a class="code" href="classArmISA_1_1TLB.html#a0a0d2a49b44f3e54bd986e6c7f0049dc">stage2Req</a> || req-&gt;<a class="code" href="classRequest.html#afb93a1ae179f883930104ee1d889ed3b" title="Accessor for paddr.">hasPaddr</a>() || fault != NoFault)) {
<a name="l01200"></a>01200         <span class="keywordflow">if</span> (!delay)
<a name="l01201"></a>01201             translation-&gt;<a class="code" href="classBaseTLB_1_1Translation.html#afe85aede0acd3ea166bc7a9ac74ff224">finish</a>(fault, req, tc, mode);
<a name="l01202"></a>01202         <span class="keywordflow">else</span>
<a name="l01203"></a>01203             translation-&gt;<a class="code" href="classBaseTLB_1_1Translation.html#a32fb8e6640117528da167bb47f420f7d" title="Signal that the translation has been delayed due to a hw page table walk.">markDelayed</a>();
<a name="l01204"></a>01204     }
<a name="l01205"></a>01205     <span class="keywordflow">return</span> fault;
<a name="l01206"></a>01206 }
<a name="l01207"></a>01207 
<a name="l01208"></a>01208 <a class="code" href="classBaseMasterPort.html" title="A BaseMasterPort is a protocol-agnostic master port, responsible only for the structural...">BaseMasterPort</a>*
<a name="l01209"></a><a class="code" href="classArmISA_1_1TLB.html#ac5fae45e79460e65fb49f5350b0d8a12">01209</a> <a class="code" href="classArmISA_1_1TLB.html#ac5fae45e79460e65fb49f5350b0d8a12" title="Get the table walker master port.">TLB::getMasterPort</a>()
<a name="l01210"></a>01210 {
<a name="l01211"></a>01211     <span class="keywordflow">return</span> &amp;<a class="code" href="classArmISA_1_1TLB.html#ace3820ca2b565f0f7201ddad09327be9">stage2Mmu</a>-&gt;<a class="code" href="classArmISA_1_1Stage2MMU.html#ae63b180f535974a2259e979ebe0bdd86" title="Get the port that ultimately belongs to the stage-two MMU, but is used by the two...">getPort</a>();
<a name="l01212"></a>01212 }
<a name="l01213"></a>01213 
<a name="l01214"></a>01214 <span class="keywordtype">void</span>
<a name="l01215"></a><a class="code" href="classArmISA_1_1TLB.html#a55ca28e8f7ad5d1230db775656384008">01215</a> <a class="code" href="classArmISA_1_1TLB.html#a55ca28e8f7ad5d1230db775656384008">TLB::updateMiscReg</a>(<a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>, <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094">ArmTranslationType</a> tranType)
<a name="l01216"></a>01216 {
<a name="l01217"></a>01217     <span class="comment">// check if the regs have changed, or the translation mode is different.</span>
<a name="l01218"></a>01218     <span class="comment">// NOTE: the tran type doesn&apos;t affect stage 2 TLB&apos;s as they only handle</span>
<a name="l01219"></a>01219     <span class="comment">// one type of translation anyway</span>
<a name="l01220"></a>01220     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a65b5c9f8eeb6f23d434738badc2e8603">miscRegValid</a> &amp;&amp; ((tranType == <a class="code" href="classArmISA_1_1TLB.html#a5bd475185224b35c02e03006736e87ec">curTranType</a>) || <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>)) {
<a name="l01221"></a>01221         <span class="keywordflow">return</span>;
<a name="l01222"></a>01222     }
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(TLBVerbose, <span class="stringliteral">&quot;TLB variables changed!\n&quot;</span>);
<a name="l01225"></a>01225     <a class="code" href="classArmISA_1_1TLB.html#a81dcd94edd8761d499e290a0d439f12a">cpsr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca1d2df46d160cfa336591aaebdd6f99ba">MISCREG_CPSR</a>);
<a name="l01226"></a>01226     <span class="comment">// Dependencies: SCR/SCR_EL3, CPSR</span>
<a name="l01227"></a>01227     <a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>  = <a class="code" href="namespaceArmISA.html#abb263f4ec2a2852ac26b5c33c6f5897b">inSecureState</a>(tc);
<a name="l01228"></a>01228     <a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a> &amp;= (tranType &amp; <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094a05268cf17df4c0e18959c532f44c02d3">HypMode</a>)    == 0;
<a name="l01229"></a>01229     <a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a> &amp;= (tranType &amp; <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094a4ed197054e9e92dcc10ed6a427a1cf21">S1S2NsTran</a>) == 0;
<a name="l01230"></a>01230     <a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a> = !<a class="code" href="classArmISA_1_1TLB.html#a81dcd94edd8761d499e290a0d439f12a">cpsr</a>.width;
<a name="l01231"></a>01231     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a>) {  <span class="comment">// AArch64</span>
<a name="l01232"></a>01232         <a class="code" href="classArmISA_1_1TLB.html#a988fddb2d918607d96728869aa647c88">aarch64EL</a> = (<a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98d">ExceptionLevel</a>) (uint8_t) <a class="code" href="classArmISA_1_1TLB.html#a81dcd94edd8761d499e290a0d439f12a">cpsr</a>.el;
<a name="l01233"></a>01233         <span class="keywordflow">switch</span> (<a class="code" href="classArmISA_1_1TLB.html#a988fddb2d918607d96728869aa647c88">aarch64EL</a>) {
<a name="l01234"></a>01234           <span class="keywordflow">case</span> <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98daec94daab9638b134b5dcc5b226c7c9c8">EL0</a>:
<a name="l01235"></a>01235           <span class="keywordflow">case</span> <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98dad1b4a69ba239877df9def4576845dfe5">EL1</a>:
<a name="l01236"></a>01236             {
<a name="l01237"></a>01237                 <a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca6a053ea48f0a33993f665a3583be7cce">MISCREG_SCTLR_EL1</a>);
<a name="l01238"></a>01238                 <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca483fe08e0ab9e0d7dccba21804547878">MISCREG_TCR_EL1</a>);
<a name="l01239"></a>01239                 uint64_t ttbr_asid = <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a>.a1 ?
<a name="l01240"></a>01240                     tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca50ff79a603fadbd7cac516d7bbf28ee3">MISCREG_TTBR1_EL1</a>) :
<a name="l01241"></a>01241                     tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca8445c66a08413a3565f5796bd9ac2d56">MISCREG_TTBR0_EL1</a>);
<a name="l01242"></a>01242                 <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a> = <a class="code" href="bitfield_8hh.html#a4ee0dc0723e11679c52429d5f8e05123" title="Extract the bitfield from position &amp;#39;first&amp;#39; to &amp;#39;last&amp;#39; (inclusive)...">bits</a>(ttbr_asid,
<a name="l01243"></a>01243                             (<a class="code" href="classArmISA_1_1TLB.html#a5ff7c41974308118cb7dcd6376d2a4d0">haveLargeAsid64</a> &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a>.as) ? 63 : 55, 48);
<a name="l01244"></a>01244             }
<a name="l01245"></a>01245             <span class="keywordflow">break</span>;
<a name="l01246"></a>01246           <span class="keywordflow">case</span> <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98daa4c3712f2de98a3c6557776ed120b2ed">EL2</a>:
<a name="l01247"></a>01247             <a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca4750c028a717da1f74e34035b16b9848">MISCREG_SCTLR_EL2</a>);
<a name="l01248"></a>01248             <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919caca13cb1ca00fd3bd2130da500c0b92bf">MISCREG_TCR_EL2</a>);
<a name="l01249"></a>01249             <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a> = -1;
<a name="l01250"></a>01250             <span class="keywordflow">break</span>;
<a name="l01251"></a>01251           <span class="keywordflow">case</span> <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98da3dcb0a3ebc6bb1438051b3e943ae5325">EL3</a>:
<a name="l01252"></a>01252             <a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca0b410ff413a02c9b8979d026cb151bcc">MISCREG_SCTLR_EL3</a>);
<a name="l01253"></a>01253             <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919cab0af73c5db0f641c99bcdf88b9ad7a60">MISCREG_TCR_EL3</a>);
<a name="l01254"></a>01254             <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a> = -1;
<a name="l01255"></a>01255             <span class="keywordflow">break</span>;
<a name="l01256"></a>01256         }
<a name="l01257"></a>01257         <a class="code" href="classArmISA_1_1TLB.html#aef45b64be1c099cf9c7d4d8c3b7193fb">scr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca25e01e2437793648b59e468b134153e4">MISCREG_SCR_EL3</a>);
<a name="l01258"></a>01258         <a class="code" href="classArmISA_1_1TLB.html#ad56114d8c8c01ecac6cfcef19cab341a">isPriv</a> = <a class="code" href="classArmISA_1_1TLB.html#a988fddb2d918607d96728869aa647c88">aarch64EL</a> != <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98daec94daab9638b134b5dcc5b226c7c9c8">EL0</a>;
<a name="l01259"></a>01259         <span class="comment">// @todo: modify this behaviour to support Virtualization in</span>
<a name="l01260"></a>01260         <span class="comment">// AArch64</span>
<a name="l01261"></a>01261         <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>           = 0;
<a name="l01262"></a>01262         <a class="code" href="classArmISA_1_1TLB.html#a37fb7444e14a925f74644836fe01bb8d">isHyp</a>          = <span class="keyword">false</span>;
<a name="l01263"></a>01263         <a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a> = <span class="keyword">false</span>;
<a name="l01264"></a>01264         <a class="code" href="classArmISA_1_1TLB.html#a0a0d2a49b44f3e54bd986e6c7f0049dc">stage2Req</a>      = <span class="keyword">false</span>;
<a name="l01265"></a>01265     } <span class="keywordflow">else</span> {  <span class="comment">// AArch32</span>
<a name="l01266"></a>01266         <a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>  = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a908483b73bfb72e4438766e973b6f837">flattenMiscRegNsBanked</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca540af25d1d321d1891bf4d9292c227c1">MISCREG_SCTLR</a>, tc,
<a name="l01267"></a>01267                                  !<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>));
<a name="l01268"></a>01268         <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a>  = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a908483b73bfb72e4438766e973b6f837">flattenMiscRegNsBanked</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca5bfc9d84a913f4403092c34f4fdb68f0">MISCREG_TTBCR</a>, tc,
<a name="l01269"></a>01269                                  !<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>));
<a name="l01270"></a>01270         <a class="code" href="classArmISA_1_1TLB.html#aef45b64be1c099cf9c7d4d8c3b7193fb">scr</a>    = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca6ec2fd6368d4b6668ee8155fc93d93b8">MISCREG_SCR</a>);
<a name="l01271"></a>01271         <a class="code" href="classArmISA_1_1TLB.html#ad56114d8c8c01ecac6cfcef19cab341a">isPriv</a> = <a class="code" href="classArmISA_1_1TLB.html#a81dcd94edd8761d499e290a0d439f12a">cpsr</a>.mode != <a class="code" href="namespaceArmISA.html#a5e5caf7b8ca343e256c2ac66262990caad87337169ced79741200c7319ef71811">MODE_USER</a>;
<a name="l01272"></a>01272         <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#ac124897414ac526a624ea559da1ae7e4">haveLPAE</a> &amp;&amp; <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a>.eae) {
<a name="l01273"></a>01273             <span class="comment">// Long-descriptor translation table format in use</span>
<a name="l01274"></a>01274             uint64_t ttbr_asid = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(
<a name="l01275"></a>01275                 <a class="code" href="namespaceArmISA.html#a908483b73bfb72e4438766e973b6f837">flattenMiscRegNsBanked</a>(<a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a>.a1 ? <a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919cac0d0e5ddda9dea55e2ae3223a5f1c9fc">MISCREG_TTBR1</a>
<a name="l01276"></a>01276                                                 : <a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca6a636c5129391c23216bcea3bde6f0f8">MISCREG_TTBR0</a>,
<a name="l01277"></a>01277                                        tc, !<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>));
<a name="l01278"></a>01278             <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a> = <a class="code" href="bitfield_8hh.html#a4ee0dc0723e11679c52429d5f8e05123" title="Extract the bitfield from position &amp;#39;first&amp;#39; to &amp;#39;last&amp;#39; (inclusive)...">bits</a>(ttbr_asid, 55, 48);
<a name="l01279"></a>01279         } <span class="keywordflow">else</span> {
<a name="l01280"></a>01280             <span class="comment">// Short-descriptor translation table format in use</span>
<a name="l01281"></a>01281             CONTEXTIDR context_id = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a908483b73bfb72e4438766e973b6f837">flattenMiscRegNsBanked</a>(
<a name="l01282"></a>01282                 <a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919cac2263aa3fc056992a20bdd9dce32c61c">MISCREG_CONTEXTIDR</a>, tc,!<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>));
<a name="l01283"></a>01283             <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a> = context_id.asid;
<a name="l01284"></a>01284         }
<a name="l01285"></a>01285         <a class="code" href="classArmISA_1_1TLB.html#a533ccc5fb8ebabb13775922cf63dd680">prrr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a908483b73bfb72e4438766e973b6f837">flattenMiscRegNsBanked</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca558657ebddea41bb1fc2cf61e725f6a9">MISCREG_PRRR</a>, tc,
<a name="l01286"></a>01286                                !<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>));
<a name="l01287"></a>01287         <a class="code" href="classArmISA_1_1TLB.html#a802b10482266c5ce39b638711c88a8b1">nmrr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a908483b73bfb72e4438766e973b6f837">flattenMiscRegNsBanked</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919cac979e506d9ce19425eb582d6acd8cee0">MISCREG_NMRR</a>, tc,
<a name="l01288"></a>01288                                !<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>));
<a name="l01289"></a>01289         <a class="code" href="classArmISA_1_1TLB.html#ad955d3c1c52d9b45bc86a77f6d145441">dacr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a908483b73bfb72e4438766e973b6f837">flattenMiscRegNsBanked</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca75883e1c671c8d333ef80bbb64c09233">MISCREG_DACR</a>, tc,
<a name="l01290"></a>01290                                !<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>));
<a name="l01291"></a>01291         <a class="code" href="classArmISA_1_1TLB.html#acbee2238dee7b765078cf6a7db1e5f94">hcr</a>  = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919cacc6c0d54b3de785d3e9bd57250007f71">MISCREG_HCR</a>);
<a name="l01292"></a>01292 
<a name="l01293"></a>01293         <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a1c4d7213d405a0b53006ea48ba800d0b">haveVirtualization</a>) {
<a name="l01294"></a>01294             <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>   = <a class="code" href="bitfield_8hh.html#a4ee0dc0723e11679c52429d5f8e05123" title="Extract the bitfield from position &amp;#39;first&amp;#39; to &amp;#39;last&amp;#39; (inclusive)...">bits</a>(tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919caeb8a6ed844e484a42d84318742e9ad1d">MISCREG_VTTBR</a>), 55, 48);
<a name="l01295"></a>01295             <a class="code" href="classArmISA_1_1TLB.html#a37fb7444e14a925f74644836fe01bb8d">isHyp</a>  = <a class="code" href="classArmISA_1_1TLB.html#a81dcd94edd8761d499e290a0d439f12a">cpsr</a>.mode == <a class="code" href="namespaceArmISA.html#a5e5caf7b8ca343e256c2ac66262990caabe7248ed532124da7df4c82944df7225">MODE_HYP</a>;
<a name="l01296"></a>01296             isHyp |=  tranType &amp; <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094a05268cf17df4c0e18959c532f44c02d3">HypMode</a>;
<a name="l01297"></a>01297             isHyp &amp;= (tranType &amp; <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094a4ed197054e9e92dcc10ed6a427a1cf21">S1S2NsTran</a>) == 0;
<a name="l01298"></a>01298             isHyp &amp;= (tranType &amp; <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094a1d876ec22cd787c6b4c47f2f97c043c0">S1CTran</a>)    == 0;
<a name="l01299"></a>01299             <span class="keywordflow">if</span> (isHyp) {
<a name="l01300"></a>01300                 <a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a> = tc-&gt;<a class="code" href="classThreadContext.html#a49de25575586f1e9bb3c72c2c4178c72">readMiscReg</a>(<a class="code" href="namespaceArmISA.html#a95c4749b8e05d58cf7536163a9ce919ca5a527cd4f6298497a08d3a0b3ecc9e99">MISCREG_HSCTLR</a>);
<a name="l01301"></a>01301             }
<a name="l01302"></a>01302             <span class="comment">// Work out if we should skip the first stage of translation and go</span>
<a name="l01303"></a>01303             <span class="comment">// directly to stage 2. This value is cached so we don&apos;t have to</span>
<a name="l01304"></a>01304             <span class="comment">// compute it for every translation.</span>
<a name="l01305"></a>01305             <a class="code" href="classArmISA_1_1TLB.html#a0a0d2a49b44f3e54bd986e6c7f0049dc">stage2Req</a>      = <a class="code" href="classArmISA_1_1TLB.html#acbee2238dee7b765078cf6a7db1e5f94">hcr</a>.vm &amp;&amp; !<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a> &amp;&amp; !isHyp &amp;&amp; !<a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a> &amp;&amp;
<a name="l01306"></a>01306                              !(tranType &amp; <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094a1d876ec22cd787c6b4c47f2f97c043c0">S1CTran</a>);
<a name="l01307"></a>01307             <a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a> = <a class="code" href="classArmISA_1_1TLB.html#a0a0d2a49b44f3e54bd986e6c7f0049dc">stage2Req</a> &amp;&amp; !<a class="code" href="classArmISA_1_1TLB.html#a448c01daf789a2211c750a16e1e3831b">sctlr</a>.m;
<a name="l01308"></a>01308         } <span class="keywordflow">else</span> {
<a name="l01309"></a>01309             <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>           = 0;
<a name="l01310"></a>01310             <a class="code" href="classArmISA_1_1TLB.html#a0a0d2a49b44f3e54bd986e6c7f0049dc">stage2Req</a>      = <span class="keyword">false</span>;
<a name="l01311"></a>01311             <a class="code" href="classArmISA_1_1TLB.html#a37fb7444e14a925f74644836fe01bb8d">isHyp</a>          = <span class="keyword">false</span>;
<a name="l01312"></a>01312             <a class="code" href="classArmISA_1_1TLB.html#a7b17a24fbb93079fdc1173588733bf93">directToStage2</a> = <span class="keyword">false</span>;
<a name="l01313"></a>01313         }
<a name="l01314"></a>01314     }
<a name="l01315"></a>01315     <a class="code" href="classArmISA_1_1TLB.html#a65b5c9f8eeb6f23d434738badc2e8603">miscRegValid</a> = <span class="keyword">true</span>;
<a name="l01316"></a>01316     <a class="code" href="classArmISA_1_1TLB.html#a5bd475185224b35c02e03006736e87ec">curTranType</a>  = tranType;
<a name="l01317"></a>01317 }
<a name="l01318"></a>01318 
<a name="l01319"></a>01319 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l01320"></a><a class="code" href="classArmISA_1_1TLB.html#a170107cd64693611bf5965f9c61df4c4">01320</a> <a class="code" href="classArmISA_1_1TLB.html#a170107cd64693611bf5965f9c61df4c4">TLB::getTE</a>(<a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> **<a class="code" href="namespaceMipsISA.html#a96bd0a55377fd83938867fd4d63d664d">te</a>, <a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>,
<a name="l01321"></a>01321         <a class="code" href="classBaseTLB_1_1Translation.html">Translation</a> *translation, <span class="keywordtype">bool</span> timing, <span class="keywordtype">bool</span> functional,
<a name="l01322"></a>01322         <span class="keywordtype">bool</span> is_secure, <a class="code" href="classArmISA_1_1TLB.html#a8aaaf238d2bfe38a64a59fa71b2c4094">TLB::ArmTranslationType</a> tranType)
<a name="l01323"></a>01323 {
<a name="l01324"></a>01324     <span class="keywordtype">bool</span> is_fetch = (mode == <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585ea63234010c6a55c971617a58bd577566b">Execute</a>);
<a name="l01325"></a>01325     <span class="keywordtype">bool</span> is_write = (mode == <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585ea19df812c62f939e92e6d395572c900b5">Write</a>);
<a name="l01326"></a>01326 
<a name="l01327"></a>01327     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> vaddr_tainted = req-&gt;<a class="code" href="classRequest.html#afd69006362aca38468eb15ad06c3f79b">getVaddr</a>();
<a name="l01328"></a>01328     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> <a class="code" href="namespaceMipsISA.html#a9bab751e4fa25d88bf84ee970a01a641">vaddr</a> = 0;
<a name="l01329"></a>01329     <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98d">ExceptionLevel</a> target_el = <a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a> ? <a class="code" href="classArmISA_1_1TLB.html#a988fddb2d918607d96728869aa647c88">aarch64EL</a> : <a class="code" href="namespaceArmISA.html#a6b7c17b7a5b9b9b5c8f8610bd27ba98dad1b4a69ba239877df9def4576845dfe5">EL1</a>;
<a name="l01330"></a>01330     <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a>) {
<a name="l01331"></a>01331         vaddr = <a class="code" href="namespaceArmISA.html#a17830702f2a3c01ca77252e146d45bba" title="Removes the tag from tagged addresses if that mode is enabled.">purifyTaggedAddr</a>(vaddr_tainted, tc, target_el, <a class="code" href="classArmISA_1_1TLB.html#a9938d23242082843b35b595a598c50a7">ttbcr</a>);
<a name="l01332"></a>01332     } <span class="keywordflow">else</span> {
<a name="l01333"></a>01333         vaddr = vaddr_tainted;
<a name="l01334"></a>01334     }
<a name="l01335"></a>01335     *te = <a class="code" href="classArmISA_1_1TLB.html#a7f267aa3f82802f19128f2cc0fa01766" title="Lookup an entry in the TLB.">lookup</a>(vaddr, <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a>, <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>, <a class="code" href="classArmISA_1_1TLB.html#a37fb7444e14a925f74644836fe01bb8d">isHyp</a>, is_secure, <span class="keyword">false</span>, <span class="keyword">false</span>, target_el);
<a name="l01336"></a>01336     <span class="keywordflow">if</span> (*te == NULL) {
<a name="l01337"></a>01337         <span class="keywordflow">if</span> (req-&gt;<a class="code" href="classRequest.html#a2ce7bb6276d358e2b49abd30aae0431a">isPrefetch</a>()) {
<a name="l01338"></a>01338             <span class="comment">// if the request is a prefetch don&apos;t attempt to fill the TLB or go</span>
<a name="l01339"></a>01339             <span class="comment">// any further with the memory access (here we can safely use the</span>
<a name="l01340"></a>01340             <span class="comment">// fault status for the short desc. format in all cases)</span>
<a name="l01341"></a>01341            <a class="code" href="classArmISA_1_1TLB.html#a6c80b0d2f2e71322dff7ac83e82d5bc1">prefetchFaults</a>++;
<a name="l01342"></a>01342            <span class="keywordflow">return</span> std::make_shared&lt;PrefetchAbort&gt;(
<a name="l01343"></a>01343                vaddr_tainted, <a class="code" href="classArmISA_1_1ArmFault.html#ae55c8f9f651c9cec4c0de576544e991ba5bb3b59d4db74e7b7d13cbc56db040f1">ArmFault::PrefetchTLBMiss</a>, <a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>);
<a name="l01344"></a>01344         }
<a name="l01345"></a>01345 
<a name="l01346"></a>01346         <span class="keywordflow">if</span> (is_fetch)
<a name="l01347"></a>01347             <a class="code" href="classArmISA_1_1TLB.html#a4238723b9727e30dbf6adf684ccb6042">instMisses</a>++;
<a name="l01348"></a>01348         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_write)
<a name="l01349"></a>01349             <a class="code" href="classArmISA_1_1TLB.html#ac5943c197a782c01a72a16a9921fac3c">writeMisses</a>++;
<a name="l01350"></a>01350         <span class="keywordflow">else</span>
<a name="l01351"></a>01351             <a class="code" href="classArmISA_1_1TLB.html#a664a30b4686cbd47b32c2f3f40b122a7">readMisses</a>++;
<a name="l01352"></a>01352 
<a name="l01353"></a>01353         <span class="comment">// start translation table walk, pass variables rather than</span>
<a name="l01354"></a>01354         <span class="comment">// re-retreaving in table walker for speed</span>
<a name="l01355"></a>01355         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classArmISA_1_1TLB.html">TLB</a>, <span class="stringliteral">&quot;TLB Miss: Starting hardware table walker for %#x(%d:%d)\n&quot;</span>,
<a name="l01356"></a>01356                 vaddr_tainted, <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a>, <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>);
<a name="l01357"></a>01357         <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a> fault;
<a name="l01358"></a>01358         fault = <a class="code" href="classArmISA_1_1TLB.html#ac2662183f0b2a9126911b2a57e632c42">tableWalker</a>-&gt;<a class="code" href="classArmISA_1_1TableWalker.html#a99384dd8d969f217c011ec84bfcaac4d">walk</a>(req, tc, <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a>, <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>, <a class="code" href="classArmISA_1_1TLB.html#a37fb7444e14a925f74644836fe01bb8d">isHyp</a>, mode,
<a name="l01359"></a>01359                                   translation, timing, functional, is_secure,
<a name="l01360"></a>01360                                   tranType);
<a name="l01361"></a>01361         <span class="comment">// for timing mode, return and wait for table walk,</span>
<a name="l01362"></a>01362         <span class="keywordflow">if</span> (timing || fault != NoFault) {
<a name="l01363"></a>01363             <span class="keywordflow">return</span> fault;
<a name="l01364"></a>01364         }
<a name="l01365"></a>01365 
<a name="l01366"></a>01366         *te = <a class="code" href="classArmISA_1_1TLB.html#a7f267aa3f82802f19128f2cc0fa01766" title="Lookup an entry in the TLB.">lookup</a>(vaddr, <a class="code" href="classArmISA_1_1TLB.html#a215306347fc9bf9463475f67a360eda0">asid</a>, <a class="code" href="classArmISA_1_1TLB.html#ae16d0c7dc782c209abb097a335fe526b">vmid</a>, <a class="code" href="classArmISA_1_1TLB.html#a37fb7444e14a925f74644836fe01bb8d">isHyp</a>, is_secure, <span class="keyword">false</span>, <span class="keyword">false</span>, target_el);
<a name="l01367"></a>01367         <span class="keywordflow">if</span> (!*te)
<a name="l01368"></a>01368             <a class="code" href="classArmISA_1_1TLB.html#a7acbeba474b4ae0ea99866ecb894941a">printTlb</a>();
<a name="l01369"></a>01369         assert(*te);
<a name="l01370"></a>01370     } <span class="keywordflow">else</span> {
<a name="l01371"></a>01371         <span class="keywordflow">if</span> (is_fetch)
<a name="l01372"></a>01372             <a class="code" href="classArmISA_1_1TLB.html#a644c4144f756547ac4a633f639472c9f">instHits</a>++;
<a name="l01373"></a>01373         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_write)
<a name="l01374"></a>01374             <a class="code" href="classArmISA_1_1TLB.html#a77f188052be9dc8b73d5f57f13c925ad">writeHits</a>++;
<a name="l01375"></a>01375         <span class="keywordflow">else</span>
<a name="l01376"></a>01376             <a class="code" href="classArmISA_1_1TLB.html#a687ceb21f05a04e8e9939529d680da8e">readHits</a>++;
<a name="l01377"></a>01377     }
<a name="l01378"></a>01378     <span class="keywordflow">return</span> NoFault;
<a name="l01379"></a>01379 }
<a name="l01380"></a>01380 
<a name="l01381"></a>01381 <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a>
<a name="l01382"></a><a class="code" href="classArmISA_1_1TLB.html#a78273d9afe906fdf79bc12fee77101a9">01382</a> <a class="code" href="classArmISA_1_1TLB.html#a78273d9afe906fdf79bc12fee77101a9">TLB::getResultTe</a>(<a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> **<a class="code" href="namespaceMipsISA.html#a96bd0a55377fd83938867fd4d63d664d">te</a>, <a class="code" href="classRequest.html">RequestPtr</a> req, <a class="code" href="classThreadContext.html" title="ThreadContext is the external interface to all thread state for anything outside...">ThreadContext</a> *<a class="code" href="namespaceArmISA.html#ad231afd8f3ee15e80991d6fbd5ba2e9a">tc</a>, <a class="code" href="classBaseTLB.html#a26b67ef35b9f92e337acf48571c7585e">Mode</a> <a class="code" href="namespaceArmISA.html#aab42c0db74065d35a4e8809e56f72f97">mode</a>,
<a name="l01383"></a>01383         <a class="code" href="classBaseTLB_1_1Translation.html">Translation</a> *translation, <span class="keywordtype">bool</span> timing, <span class="keywordtype">bool</span> functional,
<a name="l01384"></a>01384         <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *mergeTe)
<a name="l01385"></a>01385 {
<a name="l01386"></a>01386     <a class="code" href="base_2types_8hh.html#afbdce43497ec3a10ccb2d2141fb1def1">Fault</a> fault;
<a name="l01387"></a>01387     <a class="code" href="structArmISA_1_1TlbEntry.html">TlbEntry</a> *s1Te = NULL;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> vaddr_tainted = req-&gt;<a class="code" href="classRequest.html#afd69006362aca38468eb15ad06c3f79b">getVaddr</a>();
<a name="l01390"></a>01390 
<a name="l01391"></a>01391     <span class="comment">// Get the stage 1 table entry</span>
<a name="l01392"></a>01392     fault = <a class="code" href="classArmISA_1_1TLB.html#a170107cd64693611bf5965f9c61df4c4">getTE</a>(&amp;s1Te, req, tc, mode, translation, timing, functional,
<a name="l01393"></a>01393                   <a class="code" href="classArmISA_1_1TLB.html#ad8a6f7b25f21277caa4eb229eda8206d">isSecure</a>, <a class="code" href="classArmISA_1_1TLB.html#a5bd475185224b35c02e03006736e87ec">curTranType</a>);
<a name="l01394"></a>01394     <span class="comment">// only proceed if we have a valid table entry</span>
<a name="l01395"></a>01395     <span class="keywordflow">if</span> ((s1Te != NULL) &amp;&amp; (fault == NoFault)) {
<a name="l01396"></a>01396         <span class="comment">// Check stage 1 permissions before checking stage 2</span>
<a name="l01397"></a>01397         <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a83ddb4945c39cc32ebc2f89fc4833e5d">aarch64</a>)
<a name="l01398"></a>01398             fault = <a class="code" href="classArmISA_1_1TLB.html#a58349edfa91a94e5f65fd15230c0c0d1">checkPermissions64</a>(s1Te, req, mode, tc);
<a name="l01399"></a>01399         <span class="keywordflow">else</span>
<a name="l01400"></a>01400             fault = <a class="code" href="classArmISA_1_1TLB.html#a64041a89039c259e806abc967f5fbdb1">checkPermissions</a>(s1Te, req, mode);
<a name="l01401"></a>01401         <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a0a0d2a49b44f3e54bd986e6c7f0049dc">stage2Req</a> &amp; (fault == NoFault)) {
<a name="l01402"></a>01402             <a class="code" href="classArmISA_1_1Stage2LookUp.html">Stage2LookUp</a> *s2Lookup = <span class="keyword">new</span> <a class="code" href="classArmISA_1_1Stage2LookUp.html">Stage2LookUp</a>(<span class="keyword">this</span>, <a class="code" href="classArmISA_1_1TLB.html#ac5e8a08134f664d2097e0c77d3eb9e95">stage2Tlb</a>, *s1Te,
<a name="l01403"></a>01403                 req, translation, mode, timing, functional, <a class="code" href="classArmISA_1_1TLB.html#a5bd475185224b35c02e03006736e87ec">curTranType</a>);
<a name="l01404"></a>01404             fault = s2Lookup-&gt;<a class="code" href="classArmISA_1_1Stage2LookUp.html#a9e5802575393568e2062c3c0a9053b6e">getTe</a>(tc, mergeTe);
<a name="l01405"></a>01405             <span class="keywordflow">if</span> (s2Lookup-&gt;<a class="code" href="classArmISA_1_1Stage2LookUp.html#a3240554953ba8eb2fdfb8aeb77fbcf08">isComplete</a>()) {
<a name="l01406"></a>01406                 *te = mergeTe;
<a name="l01407"></a>01407                 <span class="comment">// We&apos;ve finished with the lookup so delete it</span>
<a name="l01408"></a>01408                 <span class="keyword">delete</span> s2Lookup;
<a name="l01409"></a>01409             } <span class="keywordflow">else</span> {
<a name="l01410"></a>01410                 <span class="comment">// The lookup hasn&apos;t completed, so we can&apos;t delete it now. We</span>
<a name="l01411"></a>01411                 <span class="comment">// get round this by asking the object to self delete when the</span>
<a name="l01412"></a>01412                 <span class="comment">// translation is complete.</span>
<a name="l01413"></a>01413                 s2Lookup-&gt;<a class="code" href="classArmISA_1_1Stage2LookUp.html#a383a1ad838157a4f8c3414273f242c6e">setSelfDelete</a>();
<a name="l01414"></a>01414             }
<a name="l01415"></a>01415         } <span class="keywordflow">else</span> {
<a name="l01416"></a>01416             <span class="comment">// This case deals with an S1 hit (or bypass), followed by</span>
<a name="l01417"></a>01417             <span class="comment">// an S2 hit-but-perms issue</span>
<a name="l01418"></a>01418             <span class="keywordflow">if</span> (<a class="code" href="classArmISA_1_1TLB.html#a9d7e3d09542f34515f4534db59d2b30c">isStage2</a>) {
<a name="l01419"></a>01419                 <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(TLBVerbose, <span class="stringliteral">&quot;s2TLB: reqVa %#x, reqPa %#x, fault %p\n&quot;</span>,
<a name="l01420"></a>01420                         vaddr_tainted, req-&gt;<a class="code" href="classRequest.html#afb93a1ae179f883930104ee1d889ed3b" title="Accessor for paddr.">hasPaddr</a>() ? req-&gt;<a class="code" href="classRequest.html#a7879d8a6ae8ad1af09a4cd55d7787fba">getPaddr</a>() : ~0, fault);
<a name="l01421"></a>01421                 <span class="keywordflow">if</span> (fault != NoFault) {
<a name="l01422"></a>01422                     <a class="code" href="classArmISA_1_1ArmFault.html">ArmFault</a> *armFault = <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="classArmISA_1_1ArmFault.html">ArmFault</a> *<span class="keyword">&gt;</span>(fault.get());
<a name="l01423"></a>01423                     armFault-&gt;<a class="code" href="classArmISA_1_1ArmFault.html#a71a314be8fa2bcbcf7c2c0e8f1646cb2">annotate</a>(<a class="code" href="classArmISA_1_1ArmFault.html#ae6dafc1e97284429cc25565e1f683984a1bbffb23e587ed481e447a5ecc9d1e61">ArmFault::S1PTW</a>, <span class="keyword">false</span>);
<a name="l01424"></a>01424                     armFault-&gt;<a class="code" href="classArmISA_1_1ArmFault.html#a71a314be8fa2bcbcf7c2c0e8f1646cb2">annotate</a>(<a class="code" href="classArmISA_1_1ArmFault.html#ae6dafc1e97284429cc25565e1f683984a815fccb247136d28886f2d82805d7bcb">ArmFault::OVA</a>, vaddr_tainted);
<a name="l01425"></a>01425                 }
<a name="l01426"></a>01426             }
<a name="l01427"></a>01427             *te = s1Te;
<a name="l01428"></a>01428         }
<a name="l01429"></a>01429     }
<a name="l01430"></a>01430     <span class="keywordflow">return</span> fault;
<a name="l01431"></a>01431 }
<a name="l01432"></a>01432 
<a name="l01433"></a>01433 <a class="code" href="classArmISA_1_1TLB.html">ArmISA::TLB</a> *
<a name="l01434"></a>01434 ArmTLBParams::create()
<a name="l01435"></a>01435 {
<a name="l01436"></a>01436     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classArmISA_1_1TLB.html#ae58edb2d376d7408e0191f42c6bba423">ArmISA::TLB</a>(<span class="keyword">this</span>);
<a name="l01437"></a>01437 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"><address style="align: right;"><small>
Generated on Mon Dec 7 02:33:06 2015 for gem5 by <a href="http://www.doxygen.org/index.html"> doxygen</a> 1.6.1</small></address>

</body>
</html>
