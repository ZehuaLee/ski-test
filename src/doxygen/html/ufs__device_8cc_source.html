<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>gem5: dev/arm/ufs_device.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>dev/arm/ufs_device.cc</h1><a href="ufs__device_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (c) 2013-2015 ARM Limited</span>
<a name="l00003"></a>00003 <span class="comment"> * All rights reserved</span>
<a name="l00004"></a>00004 <span class="comment"> *</span>
<a name="l00005"></a>00005 <span class="comment"> * The license below extends only to copyright in the software and shall</span>
<a name="l00006"></a>00006 <span class="comment"> * not be construed as granting a license to any other intellectual</span>
<a name="l00007"></a>00007 <span class="comment"> * property including but not limited to intellectual property relating</span>
<a name="l00008"></a>00008 <span class="comment"> * to a hardware implementation of the functionality of the software</span>
<a name="l00009"></a>00009 <span class="comment"> * licensed hereunder.  You may use the software subject to the license</span>
<a name="l00010"></a>00010 <span class="comment"> * terms below provided that you ensure that this notice is replicated</span>
<a name="l00011"></a>00011 <span class="comment"> * unmodified and in its entirety in all distributions of the software,</span>
<a name="l00012"></a>00012 <span class="comment"> * modified or unmodified, in source code or in binary form.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00015"></a>00015 <span class="comment"> * modification, are permitted provided that the following conditions are</span>
<a name="l00016"></a>00016 <span class="comment"> * met: redistributions of source code must retain the above copyright</span>
<a name="l00017"></a>00017 <span class="comment"> * notice, this list of conditions and the following disclaimer;</span>
<a name="l00018"></a>00018 <span class="comment"> * redistributions in binary form must reproduce the above copyright</span>
<a name="l00019"></a>00019 <span class="comment"> * notice, this list of conditions and the following disclaimer in the</span>
<a name="l00020"></a>00020 <span class="comment"> * documentation and/or other materials provided with the distribution;</span>
<a name="l00021"></a>00021 <span class="comment"> * neither the name of the copyright holders nor the names of its</span>
<a name="l00022"></a>00022 <span class="comment"> * contributors may be used to endorse or promote products derived from</span>
<a name="l00023"></a>00023 <span class="comment"> * this software without specific prior written permission.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<a name="l00026"></a>00026 <span class="comment"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<a name="l00027"></a>00027 <span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<a name="l00028"></a>00028 <span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<a name="l00029"></a>00029 <span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00030"></a>00030 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<a name="l00031"></a>00031 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<a name="l00032"></a>00032 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<a name="l00033"></a>00033 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<a name="l00034"></a>00034 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<a name="l00035"></a>00035 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> * Authors: Rene de Jong</span>
<a name="l00038"></a>00038 <span class="comment"> */</span>
<a name="l00039"></a>00039 
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="ufs__device_8hh.html" title="This is a base class for UFS devices The UFS interface consists out of one host controller...">dev/arm/ufs_device.hh</a>&quot;</span>
<a name="l00073"></a>00073 
<a name="l00077"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a0536e9a6f90f2395d9ee2b44c815779b">00077</a> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a0536e9a6f90f2395d9ee2b44c815779b" title="Constructor and destructor.">UFSHostDevice::UFSSCSIDevice::UFSSCSIDevice</a>(<span class="keyword">const</span> UFSHostDeviceParams* <a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>,
<a name="l00078"></a>00078                              uint32_t lun_id, <a class="code" href="classCallback.html" title="Generic callback class.">Callback</a> *transfer_cb,
<a name="l00079"></a>00079                              <a class="code" href="classCallback.html" title="Generic callback class.">Callback</a> *read_cb):
<a name="l00080"></a>00080     <a class="code" href="classSimObject.html" title="Abstract superclass for simulation objects.">SimObject</a>(p),
<a name="l00081"></a>00081     flashDisk(p-&gt;image[lun_id]),
<a name="l00082"></a>00082     flashDevice(p-&gt;internalflash[lun_id]),
<a name="l00083"></a>00083     blkSize(p-&gt;img_blk_size),
<a name="l00084"></a>00084     lunAvail(p-&gt;image.size()),
<a name="l00085"></a>00085     diskSize(flashDisk-&gt;size()),
<a name="l00086"></a>00086     capacityLower((diskSize - 1) &amp; 0xffffffff),
<a name="l00087"></a>00087     capacityUpper((diskSize - <a class="code" href="disk__image_8hh.html#ac729b32bca4535899ef2ee58b6a13d68">SectorSize</a>) &gt;&gt; 32),
<a name="l00088"></a>00088     lunID(lun_id),
<a name="l00089"></a>00089     transferCompleted(false),
<a name="l00090"></a>00090     readCompleted(false),
<a name="l00091"></a>00091     totalRead(0),
<a name="l00092"></a>00092     totalWrite(0),
<a name="l00093"></a>00093     amountOfWriteTransfers(0),
<a name="l00094"></a>00094     amountOfReadTransfers(0)
<a name="l00095"></a>00095 {
<a name="l00101"></a>00101     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a26a097ae58e5e1e1dfe2c25f2aef9178" title="Callbacks between Host and Device.">signalDone</a> = transfer_cb;
<a name="l00102"></a>00102     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#aa9dd572ec9ef8b7e2d063e8509036fa4" title="Callbacks between Device and Memory.">memReadCallback</a> = <span class="keyword">new</span> <a class="code" href="classMakeCallback.html" title="Helper template class to turn a simple class member function into a callback.">MakeCallback</a>&lt;<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html" title="device layer: This is your Logic unit This layer implements the SCSI functionality...">UFSSCSIDevice</a>,
<a name="l00103"></a>00103         &amp;<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#acecca8cd74148f20ddc0b8e82bc46fdd" title="Functions to indicate that the action to the SSD has completed.">UFSHostDevice::UFSSCSIDevice::readCallback</a>&gt;(<span class="keyword">this</span>);
<a name="l00104"></a>00104     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a369faf4970bc78c99ed7b4ee8352a5dc">deviceReadCallback</a> = read_cb;
<a name="l00105"></a>00105     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#ac7d21125b58c99dacbc66990366bc0d3">memWriteCallback</a> = <span class="keyword">new</span> <a class="code" href="classMakeCallback.html" title="Helper template class to turn a simple class member function into a callback.">MakeCallback</a>&lt;UFSSCSIDevice,
<a name="l00106"></a>00106         &amp;<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a0cdac87e701ba44f9730b881a406062c" title="SSD Write Done; This is the callback function for the memory model.">UFSHostDevice::UFSSCSIDevice::SSDWriteDone</a>&gt;(<span class="keyword">this</span>);
<a name="l00107"></a>00107 
<a name="l00112"></a>00112     uint32_t temp_id = ((lun_id | 0x30) &lt;&lt; 24) | 0x3A4449;
<a name="l00113"></a>00113     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2ab7545653b3f4b670e05a4e2cad37ad" title="Logic unit info; needed for SCSI Info messages and LU identification.">lunInfo</a>.<a class="code" href="structUFSHostDevice_1_1LUNInfo.html#ac6184009e0a87437dd2090e7157fe4c8">dWord0</a> = 0x02060000;   <span class="comment">//data</span>
<a name="l00114"></a>00114     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2ab7545653b3f4b670e05a4e2cad37ad" title="Logic unit info; needed for SCSI Info messages and LU identification.">lunInfo</a>.<a class="code" href="structUFSHostDevice_1_1LUNInfo.html#a805db70fe3aa2c76529c723d7d97fab7">dWord1</a> = 0x0200001F;
<a name="l00115"></a>00115     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2ab7545653b3f4b670e05a4e2cad37ad" title="Logic unit info; needed for SCSI Info messages and LU identification.">lunInfo</a>.<a class="code" href="structUFSHostDevice_1_1LUNInfo.html#aea11b00400d7e543ea4ac90308782e93">vendor0</a> = 0x484D5241;  <span class="comment">//ARMH (HMRA)</span>
<a name="l00116"></a>00116     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2ab7545653b3f4b670e05a4e2cad37ad" title="Logic unit info; needed for SCSI Info messages and LU identification.">lunInfo</a>.<a class="code" href="structUFSHostDevice_1_1LUNInfo.html#a2f1dd67bb40e6c0f232bc00883764194">vendor1</a> = 0x424D4143;  <span class="comment">//CAMB (BMAC)</span>
<a name="l00117"></a>00117     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2ab7545653b3f4b670e05a4e2cad37ad" title="Logic unit info; needed for SCSI Info messages and LU identification.">lunInfo</a>.<a class="code" href="structUFSHostDevice_1_1LUNInfo.html#a839fbae48d6d1b256fa4f9a735369b14">product0</a> = 0x356D6567; <span class="comment">//gem5  (5meg)</span>
<a name="l00118"></a>00118     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2ab7545653b3f4b670e05a4e2cad37ad" title="Logic unit info; needed for SCSI Info messages and LU identification.">lunInfo</a>.<a class="code" href="structUFSHostDevice_1_1LUNInfo.html#a130966ea608e3fc89a328338e1186f8b">product1</a> = 0x4D534655; <span class="comment">//UFSM (MSFU)</span>
<a name="l00119"></a>00119     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2ab7545653b3f4b670e05a4e2cad37ad" title="Logic unit info; needed for SCSI Info messages and LU identification.">lunInfo</a>.<a class="code" href="structUFSHostDevice_1_1LUNInfo.html#a2ad709134b6246d13920fb87b79e7f30">product2</a> = 0x4C45444F; <span class="comment">//ODEL (LEDO)</span>
<a name="l00120"></a>00120     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2ab7545653b3f4b670e05a4e2cad37ad" title="Logic unit info; needed for SCSI Info messages and LU identification.">lunInfo</a>.<a class="code" href="structUFSHostDevice_1_1LUNInfo.html#ac68949ce460b3c153e5129c5b605abdc">product3</a> = temp_id;    <span class="comment">// ID:&quot;lun_id&quot; (&quot;lun_id&quot;:DI)</span>
<a name="l00121"></a>00121     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2ab7545653b3f4b670e05a4e2cad37ad" title="Logic unit info; needed for SCSI Info messages and LU identification.">lunInfo</a>.<a class="code" href="structUFSHostDevice_1_1LUNInfo.html#a46532e654e6a79350bc7d109074a6bd8">productRevision</a> = 0x01000000; <span class="comment">//0x01</span>
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Logic unit %d assumes that %d logic units are&quot;</span>
<a name="l00124"></a>00124             <span class="stringliteral">&quot; present in the system\n&quot;</span>, <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#ab100259190c4d2460f3863c742d7dfa6">lunID</a>, <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#af0f5cd241780efd984c33ec2dbe711f1">lunAvail</a>);
<a name="l00125"></a>00125     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>,<span class="stringliteral">&quot;The disksize of lun: %d should be %d blocks\n&quot;</span>,
<a name="l00126"></a>00126             <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#ab100259190c4d2460f3863c742d7dfa6">lunID</a>, <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a6a064978f73a7a2bce170bb522fa975c">diskSize</a>);
<a name="l00127"></a>00127     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#af902c91070c5f1b4e4eeb51229534002">flashDevice</a>-&gt;<a class="code" href="classAbstractNVM.html#a36adb8c2a40714a4668367104410d8e5" title="Initialize Memory.">initializeMemory</a>(<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a6a064978f73a7a2bce170bb522fa975c">diskSize</a>, <a class="code" href="disk__image_8hh.html#ac729b32bca4535899ef2ee58b6a13d68">SectorSize</a>);
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 
<a name="l00136"></a>00136 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a43ade11b461f25a8dca0d3d9708dba06" title="These pages are SCSI specific.">UFSHostDevice::UFSSCSIDevice::controlPage</a>[3] =
<a name="l00137"></a>00137                                                 {0x01400A0A, 0x00000000,
<a name="l00138"></a>00138                                                  0x0000FFFF};
<a name="l00139"></a>00139 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a044f52e83a35b6a50c298ca82681ac29">UFSHostDevice::UFSSCSIDevice::recoveryPage</a>[3] =
<a name="l00140"></a>00140                                                 {0x03800A01, 0x00000000,
<a name="l00141"></a>00141                                                  0xFFFF0003};
<a name="l00142"></a>00142 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a7111295fba9a423d6a499e8a9b77a9ca">UFSHostDevice::UFSSCSIDevice::cachingPage</a>[5] =
<a name="l00143"></a>00143                                                 {0x00011208, 0x00000000,
<a name="l00144"></a>00144                                                  0x00000000, 0x00000020,
<a name="l00145"></a>00145                                                  0x00000000};
<a name="l00146"></a>00146 
<a name="l00147"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#aa86344585aab91b1693d9dfe8388b571">00147</a> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#aa86344585aab91b1693d9dfe8388b571">UFSHostDevice::UFSSCSIDevice::~UFSSCSIDevice</a>() {}
<a name="l00148"></a>00148 
<a name="l00160"></a>00160 <span class="keyword">struct </span><a class="code" href="structUFSHostDevice_1_1SCSIReply.html" title="SCSI reply structure.">UFSHostDevice::SCSIReply</a>
<a name="l00161"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a3f6d1c99f08702d0dd99e333b4f859f4">00161</a> <a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>::<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html" title="device layer: This is your Logic unit This layer implements the SCSI functionality...">UFSSCSIDevice</a>::SCSICMDHandle(uint32_t* SCSI_msg)
<a name="l00162"></a>00162 {
<a name="l00163"></a>00163     <span class="keyword">struct </span><a class="code" href="structUFSHostDevice_1_1SCSIReply.html" title="SCSI reply structure.">SCSIReply</a> scsi_out;
<a name="l00164"></a>00164     memset(&amp;scsi_out, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structUFSHostDevice_1_1SCSIReply.html" title="SCSI reply structure.">SCSIReply</a>));
<a name="l00165"></a>00165 
<a name="l00170"></a>00170     scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#ad7bb7acaccce6bb1ff6551421defb0ab">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPUPIUHeader.html#a107c7bcb70be00f441b0f525485dc7a8">dWord0</a> = UPIUHeaderDataIndWord0 |
<a name="l00171"></a>00171         lunID &lt;&lt; 16;
<a name="l00172"></a>00172     scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#ad7bb7acaccce6bb1ff6551421defb0ab">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPUPIUHeader.html#a721238704b7efdd4a2e52276823a0878">dWord1</a> = UPIUHeaderDataIndWord1;
<a name="l00173"></a>00173     scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#ad7bb7acaccce6bb1ff6551421defb0ab">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPUPIUHeader.html#ae4e8fe92ac0dc9e003f9e0a262d578ed">dWord2</a> = UPIUHeaderDataIndWord2;
<a name="l00174"></a>00174     statusCheck(SCSIGood, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00175"></a>00175     scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00176"></a>00176     scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a0ee7e32d969e34bbd6e15ff7117a24ba">LUN</a> = lunID;
<a name="l00177"></a>00177     scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = SCSIGood;
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;SCSI command:%2x\n&quot;</span>, SCSI_msg[4]);
<a name="l00182"></a>00182     <span class="keywordflow">switch</span> (SCSI_msg[4] &amp; 0xFF) {
<a name="l00183"></a>00183 
<a name="l00184"></a>00184       <span class="keywordflow">case</span> SCSIInquiry: {
<a name="l00188"></a>00188           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 36;
<a name="l00189"></a>00189           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>.resize(9);
<a name="l00190"></a>00190 
<a name="l00191"></a>00191           <span class="keywordflow">for</span> (uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; 9; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++)
<a name="l00192"></a>00192               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] =
<a name="l00193"></a>00193                   (reinterpret_cast&lt;uint32_t*&gt; (&amp;lunInfo))[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>];
<a name="l00194"></a>00194       } <span class="keywordflow">break</span>;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196       <span class="keywordflow">case</span> SCSIRead6: {
<a name="l00200"></a>00200           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> = 0x02;
<a name="l00201"></a>00201           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203           uint8_t* tempptr = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;SCSI_msg[4]);
<a name="l00204"></a>00204 
<a name="l00209"></a>00209           uint32_t tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(tempptr);
<a name="l00210"></a>00210           uint64_t read_offset = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp) &amp; 0x1FFFFF;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212           uint32_t read_size = tempptr[4];
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 
<a name="l00215"></a>00215           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> =  read_size * blkSize;
<a name="l00216"></a>00216           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a90e3e00dfe48b56f481c6ad1453735f1">offset</a> = read_offset * blkSize;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218           <span class="keywordflow">if</span> ((read_offset + read_size) &gt; diskSize)
<a name="l00219"></a>00219               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = SCSIIllegalRequest;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221           <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Read6 offset: 0x%8x, for %d blocks\n&quot;</span>,
<a name="l00222"></a>00222                   read_offset, read_size);
<a name="l00223"></a>00223 
<a name="l00227"></a>00227           statusCheck(scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a>, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00228"></a>00228           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00229"></a>00229           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = (scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> == SCSIGood) ? SCSIGood :
<a name="l00230"></a>00230               SCSICheckCondition;
<a name="l00231"></a>00231 
<a name="l00232"></a>00232       } <span class="keywordflow">break</span>;
<a name="l00233"></a>00233 
<a name="l00234"></a>00234       <span class="keywordflow">case</span> SCSIRead10: {
<a name="l00235"></a>00235           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> = 0x02;
<a name="l00236"></a>00236           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00237"></a>00237 
<a name="l00238"></a>00238           uint8_t* tempptr = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;SCSI_msg[4]);
<a name="l00239"></a>00239 
<a name="l00241"></a>00241           uint32_t tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[2]);
<a name="l00242"></a>00242           uint64_t read_offset = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp);
<a name="l00243"></a>00243 
<a name="l00244"></a>00244           uint16_t tmpsize = *<span class="keyword">reinterpret_cast&lt;</span>uint16_t*<span class="keyword">&gt;</span>(&amp;tempptr[7]);
<a name="l00245"></a>00245           uint32_t read_size = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmpsize);
<a name="l00246"></a>00246 
<a name="l00247"></a>00247           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> =  read_size * blkSize;
<a name="l00248"></a>00248           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a90e3e00dfe48b56f481c6ad1453735f1">offset</a> = read_offset * blkSize;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250           <span class="keywordflow">if</span> ((read_offset + read_size) &gt; diskSize)
<a name="l00251"></a>00251               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = SCSIIllegalRequest;
<a name="l00252"></a>00252 
<a name="l00253"></a>00253           <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Read10 offset: 0x%8x, for %d blocks\n&quot;</span>,
<a name="l00254"></a>00254                   read_offset, read_size);
<a name="l00255"></a>00255 
<a name="l00259"></a>00259           statusCheck(scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a>, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00260"></a>00260           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00261"></a>00261           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = (scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> == SCSIGood) ? SCSIGood :
<a name="l00262"></a>00262               SCSICheckCondition;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264       } <span class="keywordflow">break</span>;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266       <span class="keywordflow">case</span> SCSIRead16: {
<a name="l00267"></a>00267           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> = 0x02;
<a name="l00268"></a>00268           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270           uint8_t* tempptr = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;SCSI_msg[4]);
<a name="l00271"></a>00271 
<a name="l00273"></a>00273           uint32_t tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[2]);
<a name="l00274"></a>00274           uint64_t read_offset = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp);
<a name="l00275"></a>00275 
<a name="l00276"></a>00276           tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[6]);
<a name="l00277"></a>00277           read_offset = (read_offset &lt;&lt; 32) | <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp);
<a name="l00278"></a>00278 
<a name="l00279"></a>00279           tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[10]);
<a name="l00280"></a>00280           uint32_t read_size = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp);
<a name="l00281"></a>00281 
<a name="l00282"></a>00282           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> =  read_size * blkSize;
<a name="l00283"></a>00283           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a90e3e00dfe48b56f481c6ad1453735f1">offset</a> = read_offset * blkSize;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285           <span class="keywordflow">if</span> ((read_offset + read_size) &gt; diskSize)
<a name="l00286"></a>00286               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = SCSIIllegalRequest;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288           <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Read16 offset: 0x%8x, for %d blocks\n&quot;</span>,
<a name="l00289"></a>00289                   read_offset, read_size);
<a name="l00290"></a>00290 
<a name="l00294"></a>00294           statusCheck(scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a>, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00295"></a>00295           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00296"></a>00296           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = (scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> == SCSIGood) ? SCSIGood :
<a name="l00297"></a>00297               SCSICheckCondition;
<a name="l00298"></a>00298 
<a name="l00299"></a>00299       } <span class="keywordflow">break</span>;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301       <span class="keywordflow">case</span> SCSIReadCapacity10: {
<a name="l00305"></a>00305           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 8;
<a name="l00306"></a>00306           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>.resize(2);
<a name="l00307"></a>00307           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[0] =
<a name="l00308"></a>00308               <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(capacityLower);<span class="comment">//last block</span>
<a name="l00309"></a>00309           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[1] = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(blkSize);<span class="comment">//blocksize</span>
<a name="l00310"></a>00310 
<a name="l00311"></a>00311       } <span class="keywordflow">break</span>;
<a name="l00312"></a>00312       <span class="keywordflow">case</span> SCSIReadCapacity16: {
<a name="l00313"></a>00313           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 32;
<a name="l00314"></a>00314           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>.resize(8);
<a name="l00315"></a>00315           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[0] =
<a name="l00316"></a>00316               <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(capacityUpper);<span class="comment">//last block</span>
<a name="l00317"></a>00317           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[1] =
<a name="l00318"></a>00318               <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(capacityLower);<span class="comment">//last block</span>
<a name="l00319"></a>00319           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[2] = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(blkSize);<span class="comment">//blocksize</span>
<a name="l00320"></a>00320           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[3] = 0x00;<span class="comment">//</span>
<a name="l00321"></a>00321           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[4] = 0x00;<span class="comment">//reserved</span>
<a name="l00322"></a>00322           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[5] = 0x00;<span class="comment">//reserved</span>
<a name="l00323"></a>00323           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[6] = 0x00;<span class="comment">//reserved</span>
<a name="l00324"></a>00324           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[7] = 0x00;<span class="comment">//reserved</span>
<a name="l00325"></a>00325 
<a name="l00326"></a>00326       } <span class="keywordflow">break</span>;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328       <span class="keywordflow">case</span> SCSIReportLUNs: {
<a name="l00332"></a>00332           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = (<a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a> * 8) + 8;<span class="comment">//list + overhead</span>
<a name="l00333"></a>00333           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>.resize(2 * <a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a> + 2);
<a name="l00334"></a>00334           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[0] = (<a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a> * 8) &lt;&lt; 24;<span class="comment">//LUN listlength</span>
<a name="l00335"></a>00335           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[1] = 0x00;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337           <span class="keywordflow">for</span> (uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; <a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a>; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++) {
<a name="l00338"></a>00338               <span class="comment">//LUN &quot;count&quot;</span>
<a name="l00339"></a>00339               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[2 + 2 * <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] = (<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &amp; 0x7F) &lt;&lt; 8;
<a name="l00340"></a>00340               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[3 + 2 * <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] = 0x00;
<a name="l00341"></a>00341           }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343       } <span class="keywordflow">break</span>;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345       <span class="keywordflow">case</span> SCSIStartStop: {
<a name="l00346"></a>00346           <span class="comment">//Just acknowledge; not deemed relevant ATM</span>
<a name="l00347"></a>00347           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349       } <span class="keywordflow">break</span>;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351       <span class="keywordflow">case</span> SCSITestUnitReady: {
<a name="l00352"></a>00352           <span class="comment">//Just acknowledge; not deemed relevant ATM</span>
<a name="l00353"></a>00353           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355       } <span class="keywordflow">break</span>;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357       <span class="keywordflow">case</span> SCSIVerify10: {
<a name="l00362"></a>00362           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364           uint8_t* tempptr = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;SCSI_msg[4]);
<a name="l00365"></a>00365 
<a name="l00367"></a>00367           uint32_t tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[2]);
<a name="l00368"></a>00368           uint64_t read_offset = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370           uint16_t tmpsize = *<span class="keyword">reinterpret_cast&lt;</span>uint16_t*<span class="keyword">&gt;</span>(&amp;tempptr[7]);
<a name="l00371"></a>00371           uint32_t read_size = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmpsize);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373           <span class="keywordflow">if</span> ((read_offset + read_size) &gt; diskSize)
<a name="l00374"></a>00374               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = SCSIIllegalRequest;
<a name="l00375"></a>00375 
<a name="l00379"></a>00379           statusCheck(scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a>, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00380"></a>00380           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00381"></a>00381           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = (scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> == SCSIGood) ? SCSIGood :
<a name="l00382"></a>00382               SCSICheckCondition;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384       } <span class="keywordflow">break</span>;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386       <span class="keywordflow">case</span> SCSIWrite6: {
<a name="l00391"></a>00391           uint8_t* tempptr = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;SCSI_msg[4]);
<a name="l00392"></a>00392 
<a name="l00397"></a>00397           uint32_t tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(tempptr);
<a name="l00398"></a>00398           uint64_t write_offset = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp) &amp; 0x1FFFFF;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400           uint32_t write_size = tempptr[4];
<a name="l00401"></a>00401 
<a name="l00402"></a>00402           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> =  write_size * blkSize;
<a name="l00403"></a>00403           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a90e3e00dfe48b56f481c6ad1453735f1">offset</a> = write_offset * blkSize;
<a name="l00404"></a>00404           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> = 0x01;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406           <span class="keywordflow">if</span> ((write_offset + write_size) &gt; diskSize)
<a name="l00407"></a>00407               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = SCSIIllegalRequest;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409           <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write6 offset: 0x%8x, for %d blocks\n&quot;</span>,
<a name="l00410"></a>00410                   write_offset, write_size);
<a name="l00411"></a>00411 
<a name="l00415"></a>00415           statusCheck(scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a>, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00416"></a>00416           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00417"></a>00417           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = (scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> == SCSIGood) ? SCSIGood :
<a name="l00418"></a>00418               SCSICheckCondition;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420       } <span class="keywordflow">break</span>;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422       <span class="keywordflow">case</span> SCSIWrite10: {
<a name="l00423"></a>00423           uint8_t* tempptr = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;SCSI_msg[4]);
<a name="l00424"></a>00424 
<a name="l00426"></a>00426           uint32_t tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[2]);
<a name="l00427"></a>00427           uint64_t write_offset = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp);
<a name="l00428"></a>00428 
<a name="l00429"></a>00429           uint16_t tmpsize = *<span class="keyword">reinterpret_cast&lt;</span>uint16_t*<span class="keyword">&gt;</span>(&amp;tempptr[7]);
<a name="l00430"></a>00430           uint32_t write_size = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmpsize);
<a name="l00431"></a>00431 
<a name="l00432"></a>00432           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> =  write_size * blkSize;
<a name="l00433"></a>00433           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a90e3e00dfe48b56f481c6ad1453735f1">offset</a> = write_offset * blkSize;
<a name="l00434"></a>00434           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> = 0x01;
<a name="l00435"></a>00435 
<a name="l00436"></a>00436           <span class="keywordflow">if</span> ((write_offset + write_size) &gt; diskSize)
<a name="l00437"></a>00437               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = SCSIIllegalRequest;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439           <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write10 offset: 0x%8x, for %d blocks\n&quot;</span>,
<a name="l00440"></a>00440                   write_offset, write_size);
<a name="l00441"></a>00441 
<a name="l00445"></a>00445           statusCheck(scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a>, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00446"></a>00446           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00447"></a>00447           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = (scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> == SCSIGood) ? SCSIGood :
<a name="l00448"></a>00448               SCSICheckCondition;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450       } <span class="keywordflow">break</span>;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452       <span class="keywordflow">case</span> SCSIWrite16: {
<a name="l00453"></a>00453           uint8_t* tempptr = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;SCSI_msg[4]);
<a name="l00454"></a>00454 
<a name="l00456"></a>00456           uint32_t tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[2]);
<a name="l00457"></a>00457           uint64_t write_offset = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459           tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[6]);
<a name="l00460"></a>00460           write_offset = (write_offset &lt;&lt; 32) | <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp);
<a name="l00461"></a>00461 
<a name="l00462"></a>00462           tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[10]);
<a name="l00463"></a>00463           uint32_t write_size = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = write_size * blkSize;
<a name="l00466"></a>00466           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a90e3e00dfe48b56f481c6ad1453735f1">offset</a> = write_offset * blkSize;
<a name="l00467"></a>00467           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> = 0x01;
<a name="l00468"></a>00468 
<a name="l00469"></a>00469           <span class="keywordflow">if</span> ((write_offset + write_size) &gt; diskSize)
<a name="l00470"></a>00470               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = SCSIIllegalRequest;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472           <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write16 offset: 0x%8x, for %d blocks\n&quot;</span>,
<a name="l00473"></a>00473                   write_offset, write_size);
<a name="l00474"></a>00474 
<a name="l00478"></a>00478           statusCheck(scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a>, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00479"></a>00479           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00480"></a>00480           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = (scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> == SCSIGood) ? SCSIGood :
<a name="l00481"></a>00481               SCSICheckCondition;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483       } <span class="keywordflow">break</span>;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485       <span class="keywordflow">case</span> SCSIFormatUnit: {<span class="comment">//not yet verified</span>
<a name="l00486"></a>00486           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00487"></a>00487           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> = 0x01;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489       } <span class="keywordflow">break</span>;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491       <span class="keywordflow">case</span> SCSISendDiagnostic: {<span class="comment">//not yet verified</span>
<a name="l00492"></a>00492           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494       } <span class="keywordflow">break</span>;
<a name="l00495"></a>00495 
<a name="l00496"></a>00496       <span class="keywordflow">case</span> SCSISynchronizeCache: {
<a name="l00497"></a>00497           <span class="comment">//do we have cache (we don&apos;t have cache at this moment)</span>
<a name="l00498"></a>00498           <span class="comment">//TODO: here will synchronization happen when cache is modelled</span>
<a name="l00499"></a>00499           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501       } <span class="keywordflow">break</span>;
<a name="l00502"></a>00502 
<a name="l00503"></a>00503         <span class="comment">//UFS SCSI additional command set for full functionality</span>
<a name="l00504"></a>00504       <span class="keywordflow">case</span> SCSIModeSelect10:
<a name="l00505"></a>00505         <span class="comment">//TODO:</span>
<a name="l00506"></a>00506         <span class="comment">//scsi_out.expectMore = 0x01;//not supported due to modepage support</span>
<a name="l00507"></a>00507         <span class="comment">//code isn&apos;t dead, code suggest what is to be done when implemented</span>
<a name="l00508"></a>00508         <span class="keywordflow">break</span>;
<a name="l00509"></a>00509 
<a name="l00510"></a>00510       <span class="keywordflow">case</span> SCSIModeSense6: <span class="keywordflow">case</span> SCSIModeSense10: {
<a name="l00515"></a>00515           <span class="keywordflow">if</span> ((SCSI_msg[4] &amp; 0x3F0000) &gt;&gt; 16 == 0x0A) {<span class="comment">//control page</span>
<a name="l00516"></a>00516               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>.resize((<span class="keyword">sizeof</span>(controlPage) &gt;&gt; 2) + 2);
<a name="l00517"></a>00517               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[0] = 0x00000A00;<span class="comment">//control page code</span>
<a name="l00518"></a>00518               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[1] = 0x00000000;<span class="comment">//See JEDEC220 ch8</span>
<a name="l00519"></a>00519 
<a name="l00520"></a>00520               <span class="keywordflow">for</span> (uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; 3; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++)
<a name="l00521"></a>00521                   scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[2 + <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] = controlPage[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>];
<a name="l00522"></a>00522 
<a name="l00523"></a>00523               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 20;
<a name="l00524"></a>00524               <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;CONTROL page\n&quot;</span>);
<a name="l00525"></a>00525 
<a name="l00526"></a>00526           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((SCSI_msg[4] &amp; 0x3F0000) &gt;&gt; 16 == 0x01) {<span class="comment">//recovery page</span>
<a name="l00527"></a>00527               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>.resize((<span class="keyword">sizeof</span>(recoveryPage) &gt;&gt; 2)
<a name="l00528"></a>00528                                               + 2);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[0] = 0x00000100;<span class="comment">//recovery page code</span>
<a name="l00531"></a>00531               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[1] = 0x00000000;<span class="comment">//See JEDEC220 ch8</span>
<a name="l00532"></a>00532 
<a name="l00533"></a>00533               <span class="keywordflow">for</span> (uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; 3; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++)
<a name="l00534"></a>00534                   scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[2 + <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] = recoveryPage[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>];
<a name="l00535"></a>00535 
<a name="l00536"></a>00536               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 20;
<a name="l00537"></a>00537               <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;RECOVERY page\n&quot;</span>);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((SCSI_msg[4] &amp; 0x3F0000) &gt;&gt; 16 == 0x08) {<span class="comment">//caching page</span>
<a name="l00540"></a>00540 
<a name="l00541"></a>00541               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>.resize((<span class="keyword">sizeof</span>(cachingPage) &gt;&gt; 2) + 2);
<a name="l00542"></a>00542               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[0] = 0x00001200;<span class="comment">//caching page code</span>
<a name="l00543"></a>00543               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[1] = 0x00000000;<span class="comment">//See JEDEC220 ch8</span>
<a name="l00544"></a>00544 
<a name="l00545"></a>00545               <span class="keywordflow">for</span> (uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; 5; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++)
<a name="l00546"></a>00546                   scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[2 + <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] = cachingPage[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>];
<a name="l00547"></a>00547 
<a name="l00548"></a>00548               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 20;
<a name="l00549"></a>00549               <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;CACHE page\n&quot;</span>);
<a name="l00550"></a>00550 
<a name="l00551"></a>00551           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((SCSI_msg[4] &amp; 0x3F0000) &gt;&gt; 16 == 0x3F) {<span class="comment">//ALL the pages!</span>
<a name="l00552"></a>00552 
<a name="l00553"></a>00553               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>.resize(((<span class="keyword">sizeof</span>(controlPage) +
<a name="l00554"></a>00554                                                 <span class="keyword">sizeof</span>(recoveryPage) +
<a name="l00555"></a>00555                                                 <span class="keyword">sizeof</span>(cachingPage)) &gt;&gt; 2)
<a name="l00556"></a>00556                                               + 2);
<a name="l00557"></a>00557               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[0] = 0x00003200;<span class="comment">//all page code</span>
<a name="l00558"></a>00558               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[1] = 0x00000000;<span class="comment">//See JEDEC220 ch8</span>
<a name="l00559"></a>00559 
<a name="l00560"></a>00560               <span class="keywordflow">for</span> (uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; 3; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++)
<a name="l00561"></a>00561                   scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[2 + <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] = recoveryPage[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>];
<a name="l00562"></a>00562 
<a name="l00563"></a>00563               for (uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; 5; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++)
<a name="l00564"></a>00564                   scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[5 + <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] = cachingPage[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>];
<a name="l00565"></a>00565 
<a name="l00566"></a>00566               for (uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; 3; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++)
<a name="l00567"></a>00567                   scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[10 + <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] = controlPage[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>];
<a name="l00568"></a>00568 
<a name="l00569"></a>00569               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 52;
<a name="l00570"></a>00570               <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Return ALL the pages!!!\n&quot;</span>);
<a name="l00571"></a>00571 
<a name="l00572"></a>00572           } <span class="keywordflow">else</span> <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;Wrong mode page requested\n&quot;</span>);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#a4298335c2f00e1cf8c63e7e4203ccaaf">dataCount</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> &lt;&lt; 24;
<a name="l00575"></a>00575       } <span class="keywordflow">break</span>;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577       <span class="keywordflow">case</span> SCSIRequestSense: {
<a name="l00578"></a>00578           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00579"></a>00579 
<a name="l00580"></a>00580       } <span class="keywordflow">break</span>;
<a name="l00581"></a>00581 
<a name="l00582"></a>00582       <span class="keywordflow">case</span> SCSIUnmap:<span class="keywordflow">break</span>;<span class="comment">//not yet verified</span>
<a name="l00583"></a>00583 
<a name="l00584"></a>00584       <span class="keywordflow">case</span> SCSIWriteBuffer: {
<a name="l00585"></a>00585           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> = 0x01;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587           uint8_t* tempptr = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;SCSI_msg[4]);
<a name="l00588"></a>00588 
<a name="l00590"></a>00590           uint32_t tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[2]);
<a name="l00591"></a>00591           uint64_t write_offset = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp) &amp; 0xFFFFFF;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593           tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[5]);
<a name="l00594"></a>00594           uint32_t write_size = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp) &amp; 0xFFFFFF;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> =  write_size;
<a name="l00597"></a>00597           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a90e3e00dfe48b56f481c6ad1453735f1">offset</a> = write_offset;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599       } <span class="keywordflow">break</span>;
<a name="l00600"></a>00600 
<a name="l00601"></a>00601       <span class="keywordflow">case</span> SCSIReadBuffer: {
<a name="l00607"></a>00607           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> = 0x02;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609           uint8_t* tempptr = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;SCSI_msg[4]);
<a name="l00610"></a>00610 
<a name="l00612"></a>00612           uint32_t tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[2]);
<a name="l00613"></a>00613           uint64_t read_offset = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp) &amp; 0xFFFFFF;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615           tmp = *<span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>(&amp;tempptr[5]);
<a name="l00616"></a>00616           uint32_t read_size = <a class="code" href="byteswap_8hh.html#a2af77d34ef12718184be94c5b14a27ce">betoh</a>(tmp) &amp; 0xFFFFFF;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = read_size;
<a name="l00619"></a>00619           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a90e3e00dfe48b56f481c6ad1453735f1">offset</a> = read_offset;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621           <span class="keywordflow">if</span> ((read_offset + read_size) &gt; capacityLower * blkSize)
<a name="l00622"></a>00622               scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = SCSIIllegalRequest;
<a name="l00623"></a>00623 
<a name="l00624"></a>00624           <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Read buffer location: 0x%8x\n&quot;</span>,
<a name="l00625"></a>00625                   read_offset);
<a name="l00626"></a>00626           <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Number of bytes: 0x%8x\n&quot;</span>, read_size);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628           statusCheck(scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a>, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00629"></a>00629           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00630"></a>00630           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = (scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> == SCSIGood) ? SCSIGood :
<a name="l00631"></a>00631               SCSICheckCondition;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633       } <span class="keywordflow">break</span>;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635       <span class="keywordflow">case</span> SCSIMaintenanceIn: {
<a name="l00642"></a>00642           <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Ignoring Maintenance In command\n&quot;</span>);
<a name="l00643"></a>00643           statusCheck(SCSIIllegalRequest, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00644"></a>00644           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00645"></a>00645           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = (scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> == SCSIGood) ? SCSIGood :
<a name="l00646"></a>00646               SCSICheckCondition;
<a name="l00647"></a>00647           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00648"></a>00648       } <span class="keywordflow">break</span>;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650       <span class="keywordflow">default</span>: {
<a name="l00651"></a>00651           statusCheck(SCSIIllegalRequest, scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>);
<a name="l00652"></a>00652           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> = scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[0];
<a name="l00653"></a>00653           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> = (scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> == SCSIGood) ? SCSIGood :
<a name="l00654"></a>00654               SCSICheckCondition;
<a name="l00655"></a>00655           scsi_out.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> = 0;
<a name="l00656"></a>00656           <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;Unsupported scsi message type: %2x\n&quot;</span>, SCSI_msg[4] &amp; 0xFF);
<a name="l00657"></a>00657           <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;0x%8x\n&quot;</span>, SCSI_msg[0]);
<a name="l00658"></a>00658           <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;0x%8x\n&quot;</span>, SCSI_msg[1]);
<a name="l00659"></a>00659           <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;0x%8x\n&quot;</span>, SCSI_msg[2]);
<a name="l00660"></a>00660           <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;0x%8x\n&quot;</span>, SCSI_msg[3]);
<a name="l00661"></a>00661           <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;0x%8x\n&quot;</span>, SCSI_msg[4]);
<a name="l00662"></a>00662       } <span class="keywordflow">break</span>;
<a name="l00663"></a>00663     }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="keywordflow">return</span> scsi_out;
<a name="l00666"></a>00666 }
<a name="l00667"></a>00667 
<a name="l00674"></a>00674 <span class="keywordtype">void</span>
<a name="l00675"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a37420e19ae2730233b676dbc9f4338db">00675</a> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a37420e19ae2730233b676dbc9f4338db" title="Status of SCSI.">UFSHostDevice::UFSSCSIDevice::statusCheck</a>(uint8_t <a class="code" href="namespaceArmISA.html#ab7583452c2328b9aaf5982ce3225554a">status</a>,
<a name="l00676"></a>00676                                 uint8_t* sensecodelist)
<a name="l00677"></a>00677 {
<a name="l00678"></a>00678     <span class="keywordflow">for</span> (uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; 19; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++)
<a name="l00679"></a>00679         sensecodelist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] = 0;
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     sensecodelist[0] = 18; <span class="comment">//sense length</span>
<a name="l00682"></a>00682     sensecodelist[1] = 0x70; <span class="comment">//we send a valid frame</span>
<a name="l00683"></a>00683     sensecodelist[3] = status &amp; 0xF; <span class="comment">//mask to be sure + sensecode</span>
<a name="l00684"></a>00684     sensecodelist[8] = 0x1F; <span class="comment">//data length</span>
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00691"></a>00691 <span class="keywordtype">void</span>
<a name="l00692"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a60ae2506a2bdb8965bd6404f00904867">00692</a> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a60ae2506a2bdb8965bd6404f00904867" title="Disk access functions.">UFSHostDevice::UFSSCSIDevice::readFlash</a>(uint8_t* readaddr, uint64_t <a class="code" href="namespaceArmISA.html#a19e4a68ca5c93c6136351d804b432b09">offset</a>,
<a name="l00693"></a>00693                                    uint32_t size)
<a name="l00694"></a>00694 {
<a name="l00696"></a>00696     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; (size / <a class="code" href="disk__image_8hh.html#ac729b32bca4535899ef2ee58b6a13d68">SectorSize</a>); <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++)
<a name="l00697"></a>00697         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a5b76022fadc77b868093d2f726838ec5" title="The objects this model links to.">flashDisk</a>-&gt;<a class="code" href="classDiskImage.html#a9115e4e1dcfc7a6f096765e7f71a2eff">read</a>(&amp;(readaddr[<a class="code" href="disk__image_8hh.html#ac729b32bca4535899ef2ee58b6a13d68">SectorSize</a>*<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>]), (offset /
<a name="l00698"></a>00698                                                         <a class="code" href="disk__image_8hh.html#ac729b32bca4535899ef2ee58b6a13d68">SectorSize</a>) + count);
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00705"></a>00705 <span class="keywordtype">void</span>
<a name="l00706"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#aa1218b2eba65c6138c20844246b93c06">00706</a> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#aa1218b2eba65c6138c20844246b93c06" title="Write flash.">UFSHostDevice::UFSSCSIDevice::writeFlash</a>(uint8_t* writeaddr, uint64_t <a class="code" href="namespaceArmISA.html#a19e4a68ca5c93c6136351d804b432b09">offset</a>,
<a name="l00707"></a>00707                                     uint32_t size)
<a name="l00708"></a>00708 {
<a name="l00710"></a>00710     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; (size / <a class="code" href="disk__image_8hh.html#ac729b32bca4535899ef2ee58b6a13d68">SectorSize</a>); <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++)
<a name="l00711"></a>00711         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a5b76022fadc77b868093d2f726838ec5" title="The objects this model links to.">flashDisk</a>-&gt;<a class="code" href="classDiskImage.html#a31495c165ea95b76285e5f241c78f5c3">write</a>(&amp;(writeaddr[<a class="code" href="disk__image_8hh.html#ac729b32bca4535899ef2ee58b6a13d68">SectorSize</a> * <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>]),
<a name="l00712"></a>00712                          (offset / <a class="code" href="disk__image_8hh.html#ac729b32bca4535899ef2ee58b6a13d68">SectorSize</a>) + count);
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00719"></a><a class="code" href="classUFSHostDevice.html#a7d8b75128b6d66a69c176288712b875c">00719</a> <a class="code" href="classUFSHostDevice.html#a7d8b75128b6d66a69c176288712b875c" title="Constructor for the UFS Host device.">UFSHostDevice::UFSHostDevice</a>(<span class="keyword">const</span> UFSHostDeviceParams* <a class="code" href="namespaceMipsISA.html#ae12ae9e12fab22594609e2fefce7f7c2">p</a>) :
<a name="l00720"></a>00720     <a class="code" href="classDmaDevice.html">DmaDevice</a>(p),
<a name="l00721"></a>00721     <a class="code" href="classUFSHostDevice.html#affa8ce012dc48726416c4cd7cdf1180d" title="Host controller information.">pioAddr</a>(p-&gt;pio_addr),
<a name="l00722"></a>00722     <a class="code" href="classUFSHostDevice.html#a125c59dd539330089aedb2c4003089ff">pioSize</a>(0x0FFF),
<a name="l00723"></a>00723     <a class="code" href="classUFSHostDevice.html#a643c0a3668c1597e33b721ebd3d6fded">pioDelay</a>(p-&gt;pio_latency),
<a name="l00724"></a>00724     <a class="code" href="classUFSHostDevice.html#aaffec0570461ca146db679667d44876f">intNum</a>(p-&gt;int_num),
<a name="l00725"></a>00725     <a class="code" href="classUFSHostDevice.html#a987ab112c90c4c3eb5d1ccbee82c864a">gic</a>(p-&gt;<a class="code" href="classUFSHostDevice.html#a987ab112c90c4c3eb5d1ccbee82c864a">gic</a>),
<a name="l00726"></a>00726     <a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a>(p-&gt;image.size()),
<a name="l00727"></a>00727     <a class="code" href="classUFSHostDevice.html#acf02882943451c5bf52ba1a261e9f217">UFSSlots</a>(p-&gt;ufs_slots - 1),
<a name="l00728"></a>00728     <a class="code" href="classUFSHostDevice.html#a0c2bb7b9016db0c72c2c1640c9769966" title="Track number of DMA transactions in progress.">readPendingNum</a>(0),
<a name="l00729"></a>00729     <a class="code" href="classUFSHostDevice.html#a1ef599ebb3035b24426fd3a88e41cb5d">writePendingNum</a>(0),
<a name="l00730"></a>00730     <a class="code" href="classUFSHostDevice.html#a16f2e11f7a738325c2670d4436a741b7" title="Statistics helper variables Active doorbells indicates how many doorbells are in...">activeDoorbells</a>(0),
<a name="l00731"></a>00731     <a class="code" href="classUFSHostDevice.html#a9ad1d3e7f1698d45335b6a5ec7128e04">pendingDoorbells</a>(0),
<a name="l00732"></a>00732     <a class="code" href="classUFSHostDevice.html#ae9df73da0e26359e8b0f11d94b79a1c8" title="interrupt verification This keeps track of the number of interrupts generated.">countInt</a>(0),
<a name="l00733"></a>00733     <a class="code" href="classUFSHostDevice.html#a9fdd54e78b6c6797f78e869fe67b1362" title="Track the transfer This is allows the driver to &amp;quot;group&amp;quot; certain transfers...">transferTrack</a>(0),
<a name="l00734"></a>00734     <a class="code" href="classUFSHostDevice.html#a2ad1bf7f00d4e944c7ca004b5ddb2c81">taskCommandTrack</a>(0),
<a name="l00735"></a>00735     <a class="code" href="classUFSHostDevice.html#af08a84cb2546369cd56722161985d383">idlePhaseStart</a>(0),
<a name="l00736"></a>00736     <a class="code" href="classUFSHostDevice.html#aaeca5f87415474b86c6c3690e68f9e88" title="drain manager Needed to be able to implement checkpoint functionality">drainManager</a>(NULL),
<a name="l00737"></a>00737     <a class="code" href="classUFSHostDevice.html#aadf97748a0d65f612d66caa66694653a" title="The events that control the functionality.">SCSIResumeEvent</a>(this),
<a name="l00738"></a>00738     <a class="code" href="classUFSHostDevice.html#a8cf81d83001c40ab22899e26a798856a" title="Wait for the moment where we can send the last frame.">UTPEvent</a>(this)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;The hostcontroller hosts %d Logic units\n&quot;</span>,
<a name="l00741"></a>00741             <a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a>);
<a name="l00742"></a>00742     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>.resize(<a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a>);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <a class="code" href="classUFSHostDevice.html#a0e5c2208e40f9b90cb48fe8a73328abb" title="Callbacks for the logic units.">transferDoneCallback</a> = <span class="keyword">new</span> <a class="code" href="classMakeCallback.html" title="Helper template class to turn a simple class member function into a callback.">MakeCallback</a>&lt;<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>,
<a name="l00745"></a>00745         &amp;<a class="code" href="classUFSHostDevice.html#a32d78ae4c6ef3dbfe3ac26d55692a6cc" title="LU callback function to indicate that the action has completed.">UFSHostDevice::LUNSignal</a>&gt;(<span class="keyword">this</span>);
<a name="l00746"></a>00746     <a class="code" href="classUFSHostDevice.html#ab90be2d6333101131603513849f1d8aa">memReadCallback</a> = <span class="keyword">new</span> <a class="code" href="classMakeCallback.html" title="Helper template class to turn a simple class member function into a callback.">MakeCallback</a>&lt;UFSHostDevice,
<a name="l00747"></a>00747         &amp;<a class="code" href="classUFSHostDevice.html#ac4324a5e5064eca02bdbbdb99c830f73" title="Read callback Call back function for the logic units to indicate the completion of...">UFSHostDevice::readCallback</a>&gt;(<span class="keyword">this</span>);
<a name="l00748"></a>00748 
<a name="l00749"></a>00749     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; <a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a>; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++) {
<a name="l00750"></a>00750         <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] = <span class="keyword">new</span> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html" title="device layer: This is your Logic unit This layer implements the SCSI functionality...">UFSSCSIDevice</a>(p, <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>, <a class="code" href="classUFSHostDevice.html#a0e5c2208e40f9b90cb48fe8a73328abb" title="Callbacks for the logic units.">transferDoneCallback</a>,
<a name="l00751"></a>00751                                              memReadCallback);
<a name="l00752"></a>00752     }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#acf02882943451c5bf52ba1a261e9f217">UFSSlots</a> &gt; 31)
<a name="l00755"></a>00755         <a class="code" href="base_2misc_8hh.html#a8224a361dddd2ad59b411982e5ea746f">warn</a>(<span class="stringliteral">&quot;UFSSlots = %d, this will results in %d command slots&quot;</span>,
<a name="l00756"></a>00756              <a class="code" href="classUFSHostDevice.html#acf02882943451c5bf52ba1a261e9f217">UFSSlots</a>, (<a class="code" href="classUFSHostDevice.html#acf02882943451c5bf52ba1a261e9f217">UFSSlots</a> &amp; 0x1F));
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     <span class="keywordflow">if</span> ((<a class="code" href="classUFSHostDevice.html#acf02882943451c5bf52ba1a261e9f217">UFSSlots</a> &amp; 0x1F) == 0)
<a name="l00759"></a>00759         <a class="code" href="base_2misc_8hh.html#acad519418dbfdd70c1208711e609c80e">fatal</a>(<span class="stringliteral">&quot;Number of UFS command slots should be between 1 and 32.&quot;</span>);
<a name="l00760"></a>00760 
<a name="l00761"></a>00761     <a class="code" href="classUFSHostDevice.html#a375bf9fdfede7b0dbf301dae79ae2328" title="Initialization function.">setValues</a>();
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00768"></a>00768 <a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>*
<a name="l00769"></a>00769 UFSHostDeviceParams::create()
<a name="l00770"></a>00770 {
<a name="l00771"></a>00771     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classUFSHostDevice.html#a7d8b75128b6d66a69c176288712b875c" title="Constructor for the UFS Host device.">UFSHostDevice</a>(<span class="keyword">this</span>);
<a name="l00772"></a>00772 }
<a name="l00773"></a>00773 
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 <span class="keywordtype">void</span>
<a name="l00776"></a><a class="code" href="classUFSHostDevice.html#ab93a44d559afdc243605292580c49010">00776</a> <a class="code" href="classUFSHostDevice.html#ab93a44d559afdc243605292580c49010" title="register statistics">UFSHostDevice::regStats</a>()
<a name="l00777"></a>00777 {
<a name="l00778"></a>00778     <span class="keyword">using namespace </span>Stats;
<a name="l00779"></a>00779 
<a name="l00780"></a>00780     std::string UFSHost_name = <a class="code" href="classSimObject.html#a96c36bff06d98deb79d09e93652667ae">name</a>() + <span class="stringliteral">&quot;.UFSDiskHost&quot;</span>;
<a name="l00781"></a>00781 
<a name="l00782"></a>00782     <span class="comment">// Register the stats</span>
<a name="l00784"></a>00784 <span class="comment"></span>    <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a62d92b8f207b4baf4d4116ab09d8e780" title="Queue lengths.">currentSCSIQueue</a>
<a name="l00785"></a>00785         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.currentSCSIQueue&quot;</span>)
<a name="l00786"></a>00786         .desc(<span class="stringliteral">&quot;Most up to date length of the command queue&quot;</span>)
<a name="l00787"></a>00787         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00788"></a>00788     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a43d0d620384cff08b2e92c2c00018bcf">currentReadSSDQueue</a>
<a name="l00789"></a>00789         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.currentReadSSDQueue&quot;</span>)
<a name="l00790"></a>00790         .desc(<span class="stringliteral">&quot;Most up to date length of the read SSD queue&quot;</span>)
<a name="l00791"></a>00791         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00792"></a>00792     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a8a172bbf52ecd08342c5de5f8804363d">currentWriteSSDQueue</a>
<a name="l00793"></a>00793         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.currentWriteSSDQueue&quot;</span>)
<a name="l00794"></a>00794         .desc(<span class="stringliteral">&quot;Most up to date length of the write SSD queue&quot;</span>)
<a name="l00795"></a>00795         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00796"></a>00796 
<a name="l00798"></a>00798     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a74c51fedf7b3099ab65a2ba7c246f42a" title="Amount of data read/written.">totalReadSSD</a>
<a name="l00799"></a>00799         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.totalReadSSD&quot;</span>)
<a name="l00800"></a>00800         .desc(<span class="stringliteral">&quot;Number of bytes read from SSD&quot;</span>)
<a name="l00801"></a>00801         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00802"></a>00802 
<a name="l00803"></a>00803     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#abb0ae411e57216d72afb5f35386b2d31">totalWrittenSSD</a>
<a name="l00804"></a>00804         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.totalWrittenSSD&quot;</span>)
<a name="l00805"></a>00805         .desc(<span class="stringliteral">&quot;Number of bytes written to SSD&quot;</span>)
<a name="l00806"></a>00806         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00807"></a>00807 
<a name="l00808"></a>00808     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a41045da6e6a2fe8908a4f4ade559c32b">totalReadDiskTransactions</a>
<a name="l00809"></a>00809         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.totalReadDiskTransactions&quot;</span>)
<a name="l00810"></a>00810         .desc(<span class="stringliteral">&quot;Number of transactions from disk&quot;</span>)
<a name="l00811"></a>00811         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00812"></a>00812     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#abf6416da786bec167b699a87ed46407a">totalWriteDiskTransactions</a>
<a name="l00813"></a>00813         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.totalWriteDiskTransactions&quot;</span>)
<a name="l00814"></a>00814         .desc(<span class="stringliteral">&quot;Number of transactions to disk&quot;</span>)
<a name="l00815"></a>00815         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00816"></a>00816     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a4c4d93883188a5f9d275d1c609b32d81">totalReadUFSTransactions</a>
<a name="l00817"></a>00817         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.totalReadUFSTransactions&quot;</span>)
<a name="l00818"></a>00818         .desc(<span class="stringliteral">&quot;Number of transactions from device&quot;</span>)
<a name="l00819"></a>00819         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00820"></a>00820     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#aaf7fdd74be7d255ff861389bb8e9a8bd">totalWriteUFSTransactions</a>
<a name="l00821"></a>00821         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.totalWriteUFSTransactions&quot;</span>)
<a name="l00822"></a>00822         .desc(<span class="stringliteral">&quot;Number of transactions to device&quot;</span>)
<a name="l00823"></a>00823         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00824"></a>00824 
<a name="l00826"></a>00826     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a1dc2da7fe00602f38ddbd28ca757ecb9" title="Average bandwidth for reads and writes.">averageReadSSDBW</a>
<a name="l00827"></a>00827         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.averageReadSSDBandwidth&quot;</span>)
<a name="l00828"></a>00828         .desc(<span class="stringliteral">&quot;Average read bandwidth (bytes/s)&quot;</span>)
<a name="l00829"></a>00829         .flags(<a class="code" href="namespaceStats.html#a00451440f3857f3f127f9493cfe6eede" title="Don&amp;#39;t print if this is zero.">nozero</a>);
<a name="l00830"></a>00830 
<a name="l00831"></a>00831     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a1dc2da7fe00602f38ddbd28ca757ecb9" title="Average bandwidth for reads and writes.">averageReadSSDBW</a> = <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a74c51fedf7b3099ab65a2ba7c246f42a" title="Amount of data read/written.">totalReadSSD</a> / <a class="code" href="stat__control_8cc.html#aaad77dbb4162ef5a66c24dcd1ce256d0">simSeconds</a>;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a541e24331b62dbb7908e8bc4730efdec">averageWriteSSDBW</a>
<a name="l00834"></a>00834         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.averageWriteSSDBandwidth&quot;</span>)
<a name="l00835"></a>00835         .desc(<span class="stringliteral">&quot;Average write bandwidth (bytes/s)&quot;</span>)
<a name="l00836"></a>00836         .flags(<a class="code" href="namespaceStats.html#a00451440f3857f3f127f9493cfe6eede" title="Don&amp;#39;t print if this is zero.">nozero</a>);
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a541e24331b62dbb7908e8bc4730efdec">averageWriteSSDBW</a> = <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#abb0ae411e57216d72afb5f35386b2d31">totalWrittenSSD</a> / <a class="code" href="stat__control_8cc.html#aaad77dbb4162ef5a66c24dcd1ce256d0">simSeconds</a>;
<a name="l00839"></a>00839 
<a name="l00840"></a>00840     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#ac138a757c136787c7d73f70ae7b7947b" title="Average Queue lengths.">averageSCSIQueue</a>
<a name="l00841"></a>00841         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.averageSCSIQueueLength&quot;</span>)
<a name="l00842"></a>00842         .desc(<span class="stringliteral">&quot;Average command queue length&quot;</span>)
<a name="l00843"></a>00843         .flags(<a class="code" href="namespaceStats.html#a00451440f3857f3f127f9493cfe6eede" title="Don&amp;#39;t print if this is zero.">nozero</a>);
<a name="l00844"></a>00844     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a23109e7eed3e72e7ccf67d8448920e8d">averageReadSSDQueue</a>
<a name="l00845"></a>00845         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.averageReadSSDQueueLength&quot;</span>)
<a name="l00846"></a>00846         .desc(<span class="stringliteral">&quot;Average read queue length&quot;</span>)
<a name="l00847"></a>00847         .flags(<a class="code" href="namespaceStats.html#a00451440f3857f3f127f9493cfe6eede" title="Don&amp;#39;t print if this is zero.">nozero</a>);
<a name="l00848"></a>00848     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#aca9914fdc01d503c47c0438ba85af129">averageWriteSSDQueue</a>
<a name="l00849"></a>00849         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.averageWriteSSDQueueLength&quot;</span>)
<a name="l00850"></a>00850         .desc(<span class="stringliteral">&quot;Average write queue length&quot;</span>)
<a name="l00851"></a>00851         .flags(<a class="code" href="namespaceStats.html#a00451440f3857f3f127f9493cfe6eede" title="Don&amp;#39;t print if this is zero.">nozero</a>);
<a name="l00852"></a>00852 
<a name="l00854"></a>00854     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#af3b48f723b46a79c59baaa56430938ef" title="Number of doorbells rung.">curDoorbell</a>
<a name="l00855"></a>00855         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.curDoorbell&quot;</span>)
<a name="l00856"></a>00856         .desc(<span class="stringliteral">&quot;Most up to date number of doorbells used&quot;</span>)
<a name="l00857"></a>00857         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#af3b48f723b46a79c59baaa56430938ef" title="Number of doorbells rung.">curDoorbell</a> = <a class="code" href="classUFSHostDevice.html#a16f2e11f7a738325c2670d4436a741b7" title="Statistics helper variables Active doorbells indicates how many doorbells are in...">activeDoorbells</a>;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a7b479e73fd8dcda6080ed2bd1274c8d3">maxDoorbell</a>
<a name="l00862"></a>00862         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.maxDoorbell&quot;</span>)
<a name="l00863"></a>00863         .desc(<span class="stringliteral">&quot;Maximum number of doorbells utilized&quot;</span>)
<a name="l00864"></a>00864         .flags(<a class="code" href="namespaceStats.html#a507af8a4bacac09cfb2123412d8af2cb" title="Nothing extra to print.">none</a>);
<a name="l00865"></a>00865     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a3cf6be69d2d598b2f94f7d5c1bb8c106">averageDoorbell</a>
<a name="l00866"></a>00866         .<a class="code" href="classStats_1_1DataWrap.html#a8f6effeadf113613c8e96c732bef7228" title="Set the name and marks this stat to print at the end of simulation.">name</a>(UFSHost_name + <span class="stringliteral">&quot;.averageDoorbell&quot;</span>)
<a name="l00867"></a>00867         .desc(<span class="stringliteral">&quot;Average number of Doorbells used&quot;</span>)
<a name="l00868"></a>00868         .flags(<a class="code" href="namespaceStats.html#a00451440f3857f3f127f9493cfe6eede" title="Don&amp;#39;t print if this is zero.">nozero</a>);
<a name="l00869"></a>00869 
<a name="l00871"></a>00871     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a07947f527ad6944def2bb4add98c18d6" title="Histogram of latencies.">transactionLatency</a>
<a name="l00872"></a>00872         .<a class="code" href="classStats_1_1Histogram.html#a838a65c82a6d558a2f8cdcb927c1662a" title="Set the parameters of this histogram.">init</a>(100)
<a name="l00873"></a>00873         .name(UFSHost_name + <span class="stringliteral">&quot;.transactionLatency&quot;</span>)
<a name="l00874"></a>00874         .desc(<span class="stringliteral">&quot;Histogram of transaction times&quot;</span>)
<a name="l00875"></a>00875         .flags(<a class="code" href="namespaceStats.html#a5f76f954301997f032327da330cdc19b" title="Print the percent of the total that this entry represents.">pdf</a>);
<a name="l00876"></a>00876 
<a name="l00877"></a>00877     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a220bd20af66f3f99eb56c6383fda3a30">idleTimes</a>
<a name="l00878"></a>00878         .<a class="code" href="classStats_1_1Histogram.html#a838a65c82a6d558a2f8cdcb927c1662a" title="Set the parameters of this histogram.">init</a>(100)
<a name="l00879"></a>00879         .name(UFSHost_name + <span class="stringliteral">&quot;.idlePeriods&quot;</span>)
<a name="l00880"></a>00880         .desc(<span class="stringliteral">&quot;Histogram of idle times&quot;</span>)
<a name="l00881"></a>00881         .flags(<a class="code" href="namespaceStats.html#a5f76f954301997f032327da330cdc19b" title="Print the percent of the total that this entry represents.">pdf</a>);
<a name="l00882"></a>00882 
<a name="l00883"></a>00883 }
<a name="l00884"></a>00884 
<a name="l00888"></a><a class="code" href="classUFSHostDevice.html#a375bf9fdfede7b0dbf301dae79ae2328">00888</a> <span class="keywordtype">void</span> <a class="code" href="classUFSHostDevice.html#a375bf9fdfede7b0dbf301dae79ae2328" title="Initialization function.">UFSHostDevice::setValues</a>()
<a name="l00889"></a>00889 {
<a name="l00895"></a>00895     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#afd1f31c7d2f6a7f94b05044688557a0b" title="Specify the host capabilities.">HCCAP</a> = 0x06070000 | (<a class="code" href="classUFSHostDevice.html#acf02882943451c5bf52ba1a261e9f217">UFSSlots</a> &amp; 0x1F);
<a name="l00896"></a>00896     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac30f7b58006d5cfbf0652a0a62b029e1">HCversion</a> = 0x00010000; <span class="comment">//version is 1.0</span>
<a name="l00897"></a>00897     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a76d6ae8d4340b784b6ff49f3c01b49dc">HCHCDDID</a> = 0xAA003C3C;<span class="comment">// Arbitrary number</span>
<a name="l00898"></a>00898     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a70af4ce70e09dc557c0759d48b32d1e1">HCHCPMID</a> = 0x41524D48; <span class="comment">//ARMH (not an official MIPI number)</span>
<a name="l00899"></a>00899     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a> = 0x00;
<a name="l00900"></a>00900     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a90d54007266225daf88e81aaea8195c5">TMUTMRLDBR</a> = 0x00;
<a name="l00901"></a>00901     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a8b39ec0e4fa93fa2afe4e95208568fb4" title="Command registers.">CMDUICCMDR</a> = 0x00;
<a name="l00902"></a>00902     <span class="comment">// We can process CMD, TM, TR, device present</span>
<a name="l00903"></a>00903     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ad784275e67d9221789a55ef048a937ab">ORHostControllerStatus</a> = 0x08;
<a name="l00904"></a>00904     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5eae3895696f3ad615fda3da5b620755" title="Transfer control registers.">TRUTRLBA</a> = 0x00;
<a name="l00905"></a>00905     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5084e4bb5cae1d813c1393c3399cbad4">TRUTRLBAU</a> = 0x00;
<a name="l00906"></a>00906     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ae88095cd29608faea0953f0f95f66922" title="Task control registers.">TMUTMRLBA</a> = 0x00;
<a name="l00907"></a>00907     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ade659563004928dff18ea6bfcc9eb3d8">TMUTMRLBAU</a> = 0x00;
<a name="l00908"></a>00908 }
<a name="l00909"></a>00909 
<a name="l00914"></a>00914 <a class="code" href="classstd_1_1list.html">AddrRangeList</a>
<a name="l00915"></a><a class="code" href="classUFSHostDevice.html#a444238c3c017d6a0ecb687012cf06db9">00915</a> <a class="code" href="classUFSHostDevice.html#a444238c3c017d6a0ecb687012cf06db9" title="Address range functions.">UFSHostDevice::getAddrRanges</a>()<span class="keyword"> const</span>
<a name="l00916"></a>00916 <span class="keyword"></span>{
<a name="l00917"></a>00917     <a class="code" href="classstd_1_1list.html">AddrRangeList</a> ranges;
<a name="l00918"></a>00918     ranges.push_back(<a class="code" href="addr__range_8hh.html#a59cd089c5b2fbc6eecd8507757432740">RangeSize</a>(<a class="code" href="classUFSHostDevice.html#affa8ce012dc48726416c4cd7cdf1180d" title="Host controller information.">pioAddr</a>, <a class="code" href="classUFSHostDevice.html#a125c59dd539330089aedb2c4003089ff">pioSize</a>));
<a name="l00919"></a>00919     <span class="keywordflow">return</span> ranges;
<a name="l00920"></a>00920 }
<a name="l00921"></a>00921 
<a name="l00927"></a>00927 <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a>
<a name="l00928"></a><a class="code" href="classUFSHostDevice.html#a83000b816a76017d2c52478529e5bd8a">00928</a> <a class="code" href="classUFSHostDevice.html#a83000b816a76017d2c52478529e5bd8a" title="register access functions">UFSHostDevice::read</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt)
<a name="l00929"></a>00929 {
<a name="l00930"></a>00930     uint32_t data = 0;
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <span class="keywordflow">switch</span> (pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>() &amp; 0xFF)
<a name="l00933"></a>00933     {
<a name="l00934"></a>00934 
<a name="l00935"></a>00935       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da481be304461e6af529843cf46d6ac6c6">regControllerCapabilities</a>:
<a name="l00936"></a>00936         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#afd1f31c7d2f6a7f94b05044688557a0b" title="Specify the host capabilities.">HCCAP</a>;
<a name="l00937"></a>00937         <span class="keywordflow">break</span>;
<a name="l00938"></a>00938 
<a name="l00939"></a>00939       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daa4591ca59cd55a51c919ad98630c6270">regUFSVersion</a>:
<a name="l00940"></a>00940         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac30f7b58006d5cfbf0652a0a62b029e1">HCversion</a>;
<a name="l00941"></a>00941         <span class="keywordflow">break</span>;
<a name="l00942"></a>00942 
<a name="l00943"></a>00943       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da0274c91c048fb2e393f6d43c5b42471e">regControllerDEVID</a>:
<a name="l00944"></a>00944         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a76d6ae8d4340b784b6ff49f3c01b49dc">HCHCDDID</a>;
<a name="l00945"></a>00945         <span class="keywordflow">break</span>;
<a name="l00946"></a>00946 
<a name="l00947"></a>00947       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da8d37a1d56c2a2a51045641b088a45f6c">regControllerPRODID</a>:
<a name="l00948"></a>00948         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a70af4ce70e09dc557c0759d48b32d1e1">HCHCPMID</a>;
<a name="l00949"></a>00949         <span class="keywordflow">break</span>;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02dacc38c891fdbd0831db664822f875a626">regInterruptStatus</a>:
<a name="l00952"></a>00952         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a47d13a137b1124b6c2bc1f8799507e5d" title="Operation and runtime registers.">ORInterruptStatus</a>;
<a name="l00953"></a>00953         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a47d13a137b1124b6c2bc1f8799507e5d" title="Operation and runtime registers.">ORInterruptStatus</a> = 0x00;
<a name="l00954"></a>00954         <span class="comment">//TODO: Revise and extend</span>
<a name="l00955"></a>00955         <a class="code" href="classUFSHostDevice.html#a3570e43eb14a85c8e7840afd27eb9845" title="Interrupt control functions.">clearInterrupt</a>();
<a name="l00956"></a>00956         <span class="keywordflow">break</span>;
<a name="l00957"></a>00957 
<a name="l00958"></a>00958       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daaad38c2876bbd9b8baca5f9b4866ba23">regInterruptEnable</a>:
<a name="l00959"></a>00959         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a098e95648daad02ea1778085a46c15b5">ORInterruptEnable</a>;
<a name="l00960"></a>00960         <span class="keywordflow">break</span>;
<a name="l00961"></a>00961 
<a name="l00962"></a>00962       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da178f79c71e476a2f274a48b8f9a2e36e">regControllerStatus</a>:
<a name="l00963"></a>00963         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ad784275e67d9221789a55ef048a937ab">ORHostControllerStatus</a>;
<a name="l00964"></a>00964         <span class="keywordflow">break</span>;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da57e820f293b4bc643203c6949a8f7575">regControllerEnable</a>:
<a name="l00967"></a>00967         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5fd4cc066e9a5b84340c8b04beb8403f">ORHostControllerEnable</a>;
<a name="l00968"></a>00968         <span class="keywordflow">break</span>;
<a name="l00969"></a>00969 
<a name="l00970"></a>00970       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da9bbb45bbc37f4965f20e872b2bae234f">regUICErrorCodePHYAdapterLayer</a>:
<a name="l00971"></a>00971         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a482f1961962352ff9acbebf4f55d2de2">ORUECPA</a>;
<a name="l00972"></a>00972         <span class="keywordflow">break</span>;
<a name="l00973"></a>00973 
<a name="l00974"></a>00974       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da7083e21ee94914c921db799a795c0e51">regUICErrorCodeDataLinkLayer</a>:
<a name="l00975"></a>00975         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#aded35cbd372fa874fbd6caf9bb9f3f00">ORUECDL</a>;
<a name="l00976"></a>00976         <span class="keywordflow">break</span>;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da2dc3ecf99356465b7089a6cd0ba2f766">regUICErrorCodeNetworkLayer</a>:
<a name="l00979"></a>00979         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a65e517745cb54d095912588568d0ae6e">ORUECN</a>;
<a name="l00980"></a>00980         <span class="keywordflow">break</span>;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da98cd53e68c0b47822e4829b598430e90">regUICErrorCodeTransportLayer</a>:
<a name="l00983"></a>00983         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a9d63a4b2398cb1716316c7332dae5471">ORUECT</a>;
<a name="l00984"></a>00984         <span class="keywordflow">break</span>;
<a name="l00985"></a>00985 
<a name="l00986"></a>00986       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da8708fc941ed9fbea752cf6b6b991c512">regUICErrorCodeDME</a>:
<a name="l00987"></a>00987         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ab15b2888caf32a01aa550affd3334529">ORUECDME</a>;
<a name="l00988"></a>00988         <span class="keywordflow">break</span>;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daddc3f05d8b30d981e4b4d92f3be2ce41">regUTPTransferREQINTAGGControl</a>:
<a name="l00991"></a>00991         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a72c5cf03cc499ca64ec04ca6b01cddf4">ORUTRIACR</a>;
<a name="l00992"></a>00992         <span class="keywordflow">break</span>;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da00633166e61091278363eb7e412d1b6c">regUTPTransferREQListBaseL</a>:
<a name="l00995"></a>00995         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5eae3895696f3ad615fda3da5b620755" title="Transfer control registers.">TRUTRLBA</a>;
<a name="l00996"></a>00996         <span class="keywordflow">break</span>;
<a name="l00997"></a>00997 
<a name="l00998"></a>00998       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daacc929122b4ac86e0cb0d9b4d9e1e91d">regUTPTransferREQListBaseH</a>:
<a name="l00999"></a>00999         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5084e4bb5cae1d813c1393c3399cbad4">TRUTRLBAU</a>;
<a name="l01000"></a>01000         <span class="keywordflow">break</span>;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da374d60125ac6953255d8dc7f9dd06ff1">regUTPTransferREQDoorbell</a>:
<a name="l01003"></a>01003         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>;
<a name="l01004"></a>01004         <span class="keywordflow">break</span>;
<a name="l01005"></a>01005 
<a name="l01006"></a>01006       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da50b10c0d010a09e11fc6336b78c25fbd">regUTPTransferREQListClear</a>:
<a name="l01007"></a>01007         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ae3366a893332b85b69bcda9f6c3967c1">TRUTRLCLR</a>;
<a name="l01008"></a>01008         <span class="keywordflow">break</span>;
<a name="l01009"></a>01009 
<a name="l01010"></a>01010       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daf340b5324bfc4aaba7e3ed1187d3c7b3">regUTPTransferREQListRunStop</a>:
<a name="l01011"></a>01011         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a2cdf6251ad43f0f6465894003cfcaa90">TRUTRLRSR</a>;
<a name="l01012"></a>01012         <span class="keywordflow">break</span>;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da951b45e4bd387da3bd97ee1374f8df52">regUTPTaskREQListBaseL</a>:
<a name="l01015"></a>01015         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ae88095cd29608faea0953f0f95f66922" title="Task control registers.">TMUTMRLBA</a>;
<a name="l01016"></a>01016         <span class="keywordflow">break</span>;
<a name="l01017"></a>01017 
<a name="l01018"></a>01018       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da4daab8a74c75ec995d5e821d920e1ce1">regUTPTaskREQListBaseH</a>:
<a name="l01019"></a>01019         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ade659563004928dff18ea6bfcc9eb3d8">TMUTMRLBAU</a>;
<a name="l01020"></a>01020         <span class="keywordflow">break</span>;
<a name="l01021"></a>01021 
<a name="l01022"></a>01022       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02dab005ad5f156c86741a93ea9b04f1fdf6">regUTPTaskREQDoorbell</a>:
<a name="l01023"></a>01023         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a90d54007266225daf88e81aaea8195c5">TMUTMRLDBR</a>;
<a name="l01024"></a>01024         <span class="keywordflow">break</span>;
<a name="l01025"></a>01025 
<a name="l01026"></a>01026       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da9110cfe62f3186d7eb7b48f50bbc019e">regUTPTaskREQListClear</a>:
<a name="l01027"></a>01027         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a4c698065435a1954c4feab2ec1e1dc4d">TMUTMRLCLR</a>;
<a name="l01028"></a>01028         <span class="keywordflow">break</span>;
<a name="l01029"></a>01029 
<a name="l01030"></a>01030       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da30dbe0e97045aed7628a372451b09614">regUTPTaskREQListRunStop</a>:
<a name="l01031"></a>01031         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a4d78c51409cb92e84d72a50313f3296c">TMUTMRLRSR</a>;
<a name="l01032"></a>01032         <span class="keywordflow">break</span>;
<a name="l01033"></a>01033 
<a name="l01034"></a>01034       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daccd3abb2b875eaf6a394c54d6fe3c667">regUICCommand</a>:
<a name="l01035"></a>01035         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a8b39ec0e4fa93fa2afe4e95208568fb4" title="Command registers.">CMDUICCMDR</a>;
<a name="l01036"></a>01036         <span class="keywordflow">break</span>;
<a name="l01037"></a>01037 
<a name="l01038"></a>01038       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daba51480e9d60c8a4fc06d0cb94351e7e">regUICCommandArg1</a>:
<a name="l01039"></a>01039         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac412bb2bb91c3ae9185d01203b256987">CMDUCMDARG1</a>;
<a name="l01040"></a>01040         <span class="keywordflow">break</span>;
<a name="l01041"></a>01041 
<a name="l01042"></a>01042       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da27b1e08bba1f424e31288240572824df">regUICCommandArg2</a>:
<a name="l01043"></a>01043         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a6127a10048e2a802e3a2e8e4132cc3b8">CMDUCMDARG2</a>;
<a name="l01044"></a>01044         <span class="keywordflow">break</span>;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da133c3a5a9a9530c1e4aab668baef9626">regUICCommandArg3</a>:
<a name="l01047"></a>01047         data = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a54c6de434119e255662aff7ca373f201">CMDUCMDARG3</a>;
<a name="l01048"></a>01048         <span class="keywordflow">break</span>;
<a name="l01049"></a>01049 
<a name="l01050"></a>01050       <span class="keywordflow">default</span>:
<a name="l01051"></a>01051         data = 0x00;
<a name="l01052"></a>01052         <span class="keywordflow">break</span>;
<a name="l01053"></a>01053     }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055     pkt-&gt;<a class="code" href="classPacket.html#ac63debc6335e01dcb4941e4c760a6962" title="set the value in the data pointer to v.">set</a>&lt;uint32_t&gt;(data);
<a name="l01056"></a>01056     pkt-&gt;<a class="code" href="classPacket.html#a51e1ba3f32ebb3c8be10cf9b58ca54e0" title="Take a request packet and modify it in place to be suitable for returning as a response...">makeResponse</a>();
<a name="l01057"></a>01057     <span class="keywordflow">return</span> <a class="code" href="classUFSHostDevice.html#a643c0a3668c1597e33b721ebd3d6fded">pioDelay</a>;
<a name="l01058"></a>01058 }
<a name="l01059"></a>01059 
<a name="l01065"></a>01065 <a class="code" href="base_2types_8hh.html#a5c8ed81b7d238c9083e1037ba6d61643" title="Tick count type.">Tick</a>
<a name="l01066"></a><a class="code" href="classUFSHostDevice.html#a23d2d9d31b5a11d8e13df699bdb8f3a4">01066</a> <a class="code" href="classUFSHostDevice.html#a23d2d9d31b5a11d8e13df699bdb8f3a4" title="UFSHCD write function.">UFSHostDevice::write</a>(<a class="code" href="classPacket.html" title="A Packet is used to encapsulate a transfer between two objects in the memory system...">PacketPtr</a> pkt)
<a name="l01067"></a>01067 {
<a name="l01068"></a>01068     uint32_t data = 0;
<a name="l01069"></a>01069 
<a name="l01070"></a>01070     <span class="keywordflow">switch</span> (pkt-&gt;<a class="code" href="classPacket.html#ad7c96bd8cd06acddebb3a373b37e6e59">getSize</a>()) {
<a name="l01071"></a>01071 
<a name="l01072"></a>01072       <span class="keywordflow">case</span> 1:
<a name="l01073"></a>01073         data = pkt-&gt;<a class="code" href="classPacket.html#a8d770519cb0e5f874bab168362f54082" title="return the value of what is pointed to in the packet.">get</a>&lt;uint8_t&gt;();
<a name="l01074"></a>01074         <span class="keywordflow">break</span>;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076       <span class="keywordflow">case</span> 2:
<a name="l01077"></a>01077         data = pkt-&gt;<a class="code" href="classPacket.html#a8d770519cb0e5f874bab168362f54082" title="return the value of what is pointed to in the packet.">get</a>&lt;uint16_t&gt;();
<a name="l01078"></a>01078         <span class="keywordflow">break</span>;
<a name="l01079"></a>01079 
<a name="l01080"></a>01080       <span class="keywordflow">case</span> 4:
<a name="l01081"></a>01081         data = pkt-&gt;<a class="code" href="classPacket.html#a8d770519cb0e5f874bab168362f54082" title="return the value of what is pointed to in the packet.">get</a>&lt;uint32_t&gt;();
<a name="l01082"></a>01082         <span class="keywordflow">break</span>;
<a name="l01083"></a>01083 
<a name="l01084"></a>01084       <span class="keywordflow">default</span>:
<a name="l01085"></a>01085         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;Undefined UFSHCD controller write size!\n&quot;</span>);
<a name="l01086"></a>01086         <span class="keywordflow">break</span>;
<a name="l01087"></a>01087     }
<a name="l01088"></a>01088 
<a name="l01089"></a>01089     <span class="keywordflow">switch</span> (pkt-&gt;<a class="code" href="classPacket.html#a1c04785186ba5aa70a40cac9b2bfc86e">getAddr</a>() &amp; 0xFF)
<a name="l01090"></a>01090     {
<a name="l01091"></a>01091       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da481be304461e6af529843cf46d6ac6c6">regControllerCapabilities</a>:<span class="comment">//you shall not write to this</span>
<a name="l01092"></a>01092         <span class="keywordflow">break</span>;
<a name="l01093"></a>01093 
<a name="l01094"></a>01094       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daa4591ca59cd55a51c919ad98630c6270">regUFSVersion</a>:<span class="comment">//you shall not write to this</span>
<a name="l01095"></a>01095         <span class="keywordflow">break</span>;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da0274c91c048fb2e393f6d43c5b42471e">regControllerDEVID</a>:<span class="comment">//you shall not write to this</span>
<a name="l01098"></a>01098         <span class="keywordflow">break</span>;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da8d37a1d56c2a2a51045641b088a45f6c">regControllerPRODID</a>:<span class="comment">//you shall not write to this</span>
<a name="l01101"></a>01101         <span class="keywordflow">break</span>;
<a name="l01102"></a>01102 
<a name="l01103"></a>01103       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02dacc38c891fdbd0831db664822f875a626">regInterruptStatus</a>:<span class="comment">//you shall not write to this</span>
<a name="l01104"></a>01104         <span class="keywordflow">break</span>;
<a name="l01105"></a>01105 
<a name="l01106"></a>01106       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daaad38c2876bbd9b8baca5f9b4866ba23">regInterruptEnable</a>:
<a name="l01107"></a>01107         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a098e95648daad02ea1778085a46c15b5">ORInterruptEnable</a> = data;
<a name="l01108"></a>01108         <span class="keywordflow">break</span>;
<a name="l01109"></a>01109 
<a name="l01110"></a>01110       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da178f79c71e476a2f274a48b8f9a2e36e">regControllerStatus</a>:
<a name="l01111"></a>01111         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ad784275e67d9221789a55ef048a937ab">ORHostControllerStatus</a> = data;
<a name="l01112"></a>01112         <span class="keywordflow">break</span>;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da57e820f293b4bc643203c6949a8f7575">regControllerEnable</a>:
<a name="l01115"></a>01115         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5fd4cc066e9a5b84340c8b04beb8403f">ORHostControllerEnable</a> = data;
<a name="l01116"></a>01116         <span class="keywordflow">break</span>;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da9bbb45bbc37f4965f20e872b2bae234f">regUICErrorCodePHYAdapterLayer</a>:
<a name="l01119"></a>01119         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a482f1961962352ff9acbebf4f55d2de2">ORUECPA</a> = data;
<a name="l01120"></a>01120         <span class="keywordflow">break</span>;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da7083e21ee94914c921db799a795c0e51">regUICErrorCodeDataLinkLayer</a>:
<a name="l01123"></a>01123         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#aded35cbd372fa874fbd6caf9bb9f3f00">ORUECDL</a> = data;
<a name="l01124"></a>01124         <span class="keywordflow">break</span>;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da2dc3ecf99356465b7089a6cd0ba2f766">regUICErrorCodeNetworkLayer</a>:
<a name="l01127"></a>01127         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a65e517745cb54d095912588568d0ae6e">ORUECN</a> = data;
<a name="l01128"></a>01128         <span class="keywordflow">break</span>;
<a name="l01129"></a>01129 
<a name="l01130"></a>01130       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da98cd53e68c0b47822e4829b598430e90">regUICErrorCodeTransportLayer</a>:
<a name="l01131"></a>01131         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a9d63a4b2398cb1716316c7332dae5471">ORUECT</a> = data;
<a name="l01132"></a>01132         <span class="keywordflow">break</span>;
<a name="l01133"></a>01133 
<a name="l01134"></a>01134       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da8708fc941ed9fbea752cf6b6b991c512">regUICErrorCodeDME</a>:
<a name="l01135"></a>01135         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ab15b2888caf32a01aa550affd3334529">ORUECDME</a> = data;
<a name="l01136"></a>01136         <span class="keywordflow">break</span>;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daddc3f05d8b30d981e4b4d92f3be2ce41">regUTPTransferREQINTAGGControl</a>:
<a name="l01139"></a>01139         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a72c5cf03cc499ca64ec04ca6b01cddf4">ORUTRIACR</a> = data;
<a name="l01140"></a>01140         <span class="keywordflow">break</span>;
<a name="l01141"></a>01141 
<a name="l01142"></a>01142       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da00633166e61091278363eb7e412d1b6c">regUTPTransferREQListBaseL</a>:
<a name="l01143"></a>01143         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5eae3895696f3ad615fda3da5b620755" title="Transfer control registers.">TRUTRLBA</a> = data;
<a name="l01144"></a>01144         <span class="keywordflow">if</span> (((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5eae3895696f3ad615fda3da5b620755" title="Transfer control registers.">TRUTRLBA</a> | <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5084e4bb5cae1d813c1393c3399cbad4">TRUTRLBAU</a>) != 0x00) &amp;&amp;
<a name="l01145"></a>01145             ((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ae88095cd29608faea0953f0f95f66922" title="Task control registers.">TMUTMRLBA</a> | <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ade659563004928dff18ea6bfcc9eb3d8">TMUTMRLBAU</a>)!= 0x00))
<a name="l01146"></a>01146             <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ad784275e67d9221789a55ef048a937ab">ORHostControllerStatus</a> |= <a class="code" href="classUFSHostDevice.html#a98894aa7d578f6d0c2535f95decbd626">UICCommandReady</a>;
<a name="l01147"></a>01147         <span class="keywordflow">break</span>;
<a name="l01148"></a>01148 
<a name="l01149"></a>01149       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daacc929122b4ac86e0cb0d9b4d9e1e91d">regUTPTransferREQListBaseH</a>:
<a name="l01150"></a>01150         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5084e4bb5cae1d813c1393c3399cbad4">TRUTRLBAU</a> = data;
<a name="l01151"></a>01151         if (((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5eae3895696f3ad615fda3da5b620755" title="Transfer control registers.">TRUTRLBA</a> | <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5084e4bb5cae1d813c1393c3399cbad4">TRUTRLBAU</a>) != 0x00) &amp;&amp;
<a name="l01152"></a>01152             ((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ae88095cd29608faea0953f0f95f66922" title="Task control registers.">TMUTMRLBA</a> | <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ade659563004928dff18ea6bfcc9eb3d8">TMUTMRLBAU</a>) != 0x00))
<a name="l01153"></a>01153             <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ad784275e67d9221789a55ef048a937ab">ORHostControllerStatus</a> |= <a class="code" href="classUFSHostDevice.html#a98894aa7d578f6d0c2535f95decbd626">UICCommandReady</a>;
<a name="l01154"></a>01154         <span class="keywordflow">break</span>;
<a name="l01155"></a>01155 
<a name="l01156"></a>01156       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da374d60125ac6953255d8dc7f9dd06ff1">regUTPTransferREQDoorbell</a>:
<a name="l01157"></a>01157         <span class="keywordflow">if</span> (!(<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>) &amp;&amp; data)
<a name="l01158"></a>01158             <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a220bd20af66f3f99eb56c6383fda3a30">idleTimes</a>.<a class="code" href="classStats_1_1DistBase.html#a5cb4a9cb9fac72ca7c0a8737c31d11be" title="Add a value to the distribtion n times.">sample</a>(<a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() - <a class="code" href="classUFSHostDevice.html#af08a84cb2546369cd56722161985d383">idlePhaseStart</a>);
<a name="l01159"></a>01159         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a> |= data;
<a name="l01160"></a>01160         <a class="code" href="classUFSHostDevice.html#a6689fda1fb21622f2f5e547e583ad8f5" title="Handler functions.">requestHandler</a>();
<a name="l01161"></a>01161         <span class="keywordflow">break</span>;
<a name="l01162"></a>01162 
<a name="l01163"></a>01163       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da50b10c0d010a09e11fc6336b78c25fbd">regUTPTransferREQListClear</a>:
<a name="l01164"></a>01164         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ae3366a893332b85b69bcda9f6c3967c1">TRUTRLCLR</a> = data;
<a name="l01165"></a>01165         <span class="keywordflow">break</span>;
<a name="l01166"></a>01166 
<a name="l01167"></a>01167       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daf340b5324bfc4aaba7e3ed1187d3c7b3">regUTPTransferREQListRunStop</a>:
<a name="l01168"></a>01168         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a2cdf6251ad43f0f6465894003cfcaa90">TRUTRLRSR</a> = data;
<a name="l01169"></a>01169         <span class="keywordflow">break</span>;
<a name="l01170"></a>01170 
<a name="l01171"></a>01171       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da951b45e4bd387da3bd97ee1374f8df52">regUTPTaskREQListBaseL</a>:
<a name="l01172"></a>01172         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ae88095cd29608faea0953f0f95f66922" title="Task control registers.">TMUTMRLBA</a> = data;
<a name="l01173"></a>01173         <span class="keywordflow">if</span> (((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5eae3895696f3ad615fda3da5b620755" title="Transfer control registers.">TRUTRLBA</a> | <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5084e4bb5cae1d813c1393c3399cbad4">TRUTRLBAU</a>) != 0x00) &amp;&amp;
<a name="l01174"></a>01174             ((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ae88095cd29608faea0953f0f95f66922" title="Task control registers.">TMUTMRLBA</a> | <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ade659563004928dff18ea6bfcc9eb3d8">TMUTMRLBAU</a>) != 0x00))
<a name="l01175"></a>01175             <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ad784275e67d9221789a55ef048a937ab">ORHostControllerStatus</a> |= <a class="code" href="classUFSHostDevice.html#a98894aa7d578f6d0c2535f95decbd626">UICCommandReady</a>;
<a name="l01176"></a>01176         <span class="keywordflow">break</span>;
<a name="l01177"></a>01177 
<a name="l01178"></a>01178       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da4daab8a74c75ec995d5e821d920e1ce1">regUTPTaskREQListBaseH</a>:
<a name="l01179"></a>01179         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ade659563004928dff18ea6bfcc9eb3d8">TMUTMRLBAU</a> = data;
<a name="l01180"></a>01180         <span class="keywordflow">if</span> (((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5eae3895696f3ad615fda3da5b620755" title="Transfer control registers.">TRUTRLBA</a> | <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5084e4bb5cae1d813c1393c3399cbad4">TRUTRLBAU</a>) != 0x00) &amp;&amp;
<a name="l01181"></a>01181             ((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ae88095cd29608faea0953f0f95f66922" title="Task control registers.">TMUTMRLBA</a> | <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ade659563004928dff18ea6bfcc9eb3d8">TMUTMRLBAU</a>) != 0x00))
<a name="l01182"></a>01182             <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ad784275e67d9221789a55ef048a937ab">ORHostControllerStatus</a> |= <a class="code" href="classUFSHostDevice.html#a98894aa7d578f6d0c2535f95decbd626">UICCommandReady</a>;
<a name="l01183"></a>01183         <span class="keywordflow">break</span>;
<a name="l01184"></a>01184 
<a name="l01185"></a>01185       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02dab005ad5f156c86741a93ea9b04f1fdf6">regUTPTaskREQDoorbell</a>:
<a name="l01186"></a>01186         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a90d54007266225daf88e81aaea8195c5">TMUTMRLDBR</a> |= data;
<a name="l01187"></a>01187         <a class="code" href="classUFSHostDevice.html#a6689fda1fb21622f2f5e547e583ad8f5" title="Handler functions.">requestHandler</a>();
<a name="l01188"></a>01188         <span class="keywordflow">break</span>;
<a name="l01189"></a>01189 
<a name="l01190"></a>01190       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da9110cfe62f3186d7eb7b48f50bbc019e">regUTPTaskREQListClear</a>:
<a name="l01191"></a>01191         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a4c698065435a1954c4feab2ec1e1dc4d">TMUTMRLCLR</a> = data;
<a name="l01192"></a>01192         <span class="keywordflow">break</span>;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da30dbe0e97045aed7628a372451b09614">regUTPTaskREQListRunStop</a>:
<a name="l01195"></a>01195         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a4d78c51409cb92e84d72a50313f3296c">TMUTMRLRSR</a> = data;
<a name="l01196"></a>01196         <span class="keywordflow">break</span>;
<a name="l01197"></a>01197 
<a name="l01198"></a>01198       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daccd3abb2b875eaf6a394c54d6fe3c667">regUICCommand</a>:
<a name="l01199"></a>01199         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a8b39ec0e4fa93fa2afe4e95208568fb4" title="Command registers.">CMDUICCMDR</a> = data;
<a name="l01200"></a>01200         <a class="code" href="classUFSHostDevice.html#a6689fda1fb21622f2f5e547e583ad8f5" title="Handler functions.">requestHandler</a>();
<a name="l01201"></a>01201         <span class="keywordflow">break</span>;
<a name="l01202"></a>01202 
<a name="l01203"></a>01203       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02daba51480e9d60c8a4fc06d0cb94351e7e">regUICCommandArg1</a>:
<a name="l01204"></a>01204         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac412bb2bb91c3ae9185d01203b256987">CMDUCMDARG1</a> = data;
<a name="l01205"></a>01205         <span class="keywordflow">break</span>;
<a name="l01206"></a>01206 
<a name="l01207"></a>01207       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da27b1e08bba1f424e31288240572824df">regUICCommandArg2</a>:
<a name="l01208"></a>01208         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a6127a10048e2a802e3a2e8e4132cc3b8">CMDUCMDARG2</a> = data;
<a name="l01209"></a>01209         <span class="keywordflow">break</span>;
<a name="l01210"></a>01210 
<a name="l01211"></a>01211       <span class="keywordflow">case</span> <a class="code" href="classUFSHostDevice.html#ad2247ca7dee36f882e3d2a512537f02da133c3a5a9a9530c1e4aab668baef9626">regUICCommandArg3</a>:
<a name="l01212"></a>01212         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a54c6de434119e255662aff7ca373f201">CMDUCMDARG3</a> = data;
<a name="l01213"></a>01213         <span class="keywordflow">break</span>;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215       <span class="keywordflow">default</span>:<span class="keywordflow">break</span>;<span class="comment">//nothing happens, you try to access a register that</span>
<a name="l01216"></a>01216                     <span class="comment">//does not exist</span>
<a name="l01217"></a>01217 
<a name="l01218"></a>01218     }
<a name="l01219"></a>01219 
<a name="l01220"></a>01220     pkt-&gt;<a class="code" href="classPacket.html#a51e1ba3f32ebb3c8be10cf9b58ca54e0" title="Take a request packet and modify it in place to be suitable for returning as a response...">makeResponse</a>();
<a name="l01221"></a>01221     <span class="keywordflow">return</span> <a class="code" href="classUFSHostDevice.html#a643c0a3668c1597e33b721ebd3d6fded">pioDelay</a>;
<a name="l01222"></a>01222 }
<a name="l01223"></a>01223 
<a name="l01229"></a>01229 <span class="keywordtype">void</span>
<a name="l01230"></a><a class="code" href="classUFSHostDevice.html#a6689fda1fb21622f2f5e547e583ad8f5">01230</a> <a class="code" href="classUFSHostDevice.html#a6689fda1fb21622f2f5e547e583ad8f5" title="Handler functions.">UFSHostDevice::requestHandler</a>()
<a name="l01231"></a>01231 {
<a name="l01232"></a>01232     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> address = 0x00;
<a name="l01233"></a>01233     <span class="keywordtype">int</span> <a class="code" href="namespaceArmISA.html#aedf8742bbf65a60cf102a4b3f9ba3d68">mask</a> = 0x01;
<a name="l01234"></a>01234     <span class="keywordtype">int</span> size;
<a name="l01235"></a>01235     <span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0;
<a name="l01236"></a>01236     <span class="keyword">struct </span><a class="code" href="structUFSHostDevice_1_1taskStart.html" title="Task start information.">taskStart</a> task_info;
<a name="l01237"></a>01237     <span class="keyword">struct </span><a class="code" href="structUFSHostDevice_1_1transferStart.html" title="Transfer start information.">transferStart</a> transferstart_info;
<a name="l01238"></a>01238     transferstart_info.<a class="code" href="structUFSHostDevice_1_1transferStart.html#ad20d4c119b6c8e82610d6cad99fbeaa3">done</a> = 0;
<a name="l01239"></a>01239 
<a name="l01245"></a>01245     <span class="keywordflow">while</span> (((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a8b39ec0e4fa93fa2afe4e95208568fb4" title="Command registers.">CMDUICCMDR</a> &gt; 0x00) |
<a name="l01246"></a>01246             ((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a90d54007266225daf88e81aaea8195c5">TMUTMRLDBR</a> ^ <a class="code" href="classUFSHostDevice.html#a2ad1bf7f00d4e944c7ca004b5ddb2c81">taskCommandTrack</a>) &gt; 0x00) |
<a name="l01247"></a>01247             ((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a> ^ <a class="code" href="classUFSHostDevice.html#a9fdd54e78b6c6797f78e869fe67b1362" title="Track the transfer This is allows the driver to &amp;quot;group&amp;quot; certain transfers...">transferTrack</a>) &gt; 0x00)) ) {
<a name="l01248"></a>01248 
<a name="l01249"></a>01249         <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a8b39ec0e4fa93fa2afe4e95208568fb4" title="Command registers.">CMDUICCMDR</a> &gt; 0x00) {
<a name="l01254"></a>01254             <a class="code" href="classUFSHostDevice.html#a244ebbc28d0b9a2595d4eb159743ab2c" title="Command handler function.">commandHandler</a>();
<a name="l01255"></a>01255             <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a47d13a137b1124b6c2bc1f8799507e5d" title="Operation and runtime registers.">ORInterruptStatus</a> |= <a class="code" href="classUFSHostDevice.html#a576c3aae41360d989456d8f9cb5ed3f1">UICCommandCOMPL</a>;
<a name="l01256"></a>01256             <a class="code" href="classUFSHostDevice.html#a99c0eda6ffc1939b05cb5e4492ac117b" title="set interrupt and sort out the doorbell register.">generateInterrupt</a>();
<a name="l01257"></a>01257             <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a8b39ec0e4fa93fa2afe4e95208568fb4" title="Command registers.">CMDUICCMDR</a> = 0x00;
<a name="l01258"></a>01258             <span class="keywordflow">return</span>; <span class="comment">//command, nothing more we can do</span>
<a name="l01259"></a>01259 
<a name="l01260"></a>01260         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a90d54007266225daf88e81aaea8195c5">TMUTMRLDBR</a> ^ <a class="code" href="classUFSHostDevice.html#a2ad1bf7f00d4e944c7ca004b5ddb2c81">taskCommandTrack</a>) &gt; 0x00) {
<a name="l01265"></a>01265             size = <span class="keyword">sizeof</span>(<a class="code" href="structUFSHostDevice_1_1UTPUPIUTaskReq.html" title="struct UTPUPIUTaskReq - Task request UPIU structure header - UPIU header structure...">UTPUPIUTaskReq</a>);
<a name="l01267"></a>01267             count = <a class="code" href="bitfield_8hh.html#a224a4f55757322870a3fa87b5d5254ee" title="Returns the bit position of the LSB that is set in the input.">findLsbSet</a>((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a90d54007266225daf88e81aaea8195c5">TMUTMRLDBR</a> ^ <a class="code" href="classUFSHostDevice.html#a2ad1bf7f00d4e944c7ca004b5ddb2c81">taskCommandTrack</a>));
<a name="l01268"></a>01268             address = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ade659563004928dff18ea6bfcc9eb3d8">TMUTMRLBAU</a>;
<a name="l01269"></a>01269             <span class="comment">//&lt;-64 bit</span>
<a name="l01270"></a>01270             address = (count * size) + (address &lt;&lt; 32) +
<a name="l01271"></a>01271                 <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ae88095cd29608faea0953f0f95f66922" title="Task control registers.">TMUTMRLBA</a>;
<a name="l01272"></a>01272             <a class="code" href="classUFSHostDevice.html#a2ad1bf7f00d4e944c7ca004b5ddb2c81">taskCommandTrack</a> |= mask &lt;&lt; count;
<a name="l01273"></a>01273 
<a name="l01274"></a>01274             <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;UFSmodel received a task from the system; this might&quot;</span>
<a name="l01275"></a>01275                    <span class="stringliteral">&quot; lead to untested behaviour.\n&quot;</span>);
<a name="l01276"></a>01276 
<a name="l01277"></a>01277             task_info.<a class="code" href="structUFSHostDevice_1_1taskStart.html#abce34ce2f1b57a7e728afa5dff24493c">mask</a> = mask &lt;&lt; count;
<a name="l01278"></a>01278             task_info.<a class="code" href="structUFSHostDevice_1_1taskStart.html#ab6daa416c3d8d92442995218c96e0995">address</a> = address;
<a name="l01279"></a>01279             task_info.<a class="code" href="structUFSHostDevice_1_1taskStart.html#a5cba896495f1b8381ba013d00c293287">size</a> = size;
<a name="l01280"></a>01280             task_info.<a class="code" href="structUFSHostDevice_1_1taskStart.html#a1893dc5939c4a8e880d6273e651aa73b">done</a> = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a90d54007266225daf88e81aaea8195c5">TMUTMRLDBR</a>;
<a name="l01281"></a>01281             <a class="code" href="classUFSHostDevice.html#a3a1417b4e9c1813ae13da072112d05e0" title="When a task/transfer is started it needs information about the task/transfer it is...">taskInfo</a>.push_back(task_info);
<a name="l01282"></a>01282             <a class="code" href="classUFSHostDevice.html#a43b88841e2b65caf68dc581c4219e308" title="Multiple tasks transfers can be scheduled at once for the device, the only thing...">taskEventQueue</a>.push_back(<span class="keyword">this</span>);
<a name="l01283"></a>01283             <a class="code" href="classUFSHostDevice.html#a8c9877d376633c69e4188d0db080a589" title="DMA transfer functions These allow the host to push/pull the data to the memory The...">writeDevice</a>(&amp;<a class="code" href="classUFSHostDevice.html#a43b88841e2b65caf68dc581c4219e308" title="Multiple tasks transfers can be scheduled at once for the device, the only thing...">taskEventQueue</a>.back(), <span class="keyword">false</span>, address, size,
<a name="l01284"></a>01284                         <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>
<a name="l01285"></a>01285                         (&amp;<a class="code" href="classUFSHostDevice.html#a3a1417b4e9c1813ae13da072112d05e0" title="When a task/transfer is started it needs information about the task/transfer it is...">taskInfo</a>.back().destination), 0, 0);
<a name="l01286"></a>01286 
<a name="l01287"></a>01287         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a> ^ <a class="code" href="classUFSHostDevice.html#a9fdd54e78b6c6797f78e869fe67b1362" title="Track the transfer This is allows the driver to &amp;quot;group&amp;quot; certain transfers...">transferTrack</a>) &gt; 0x00) {
<a name="l01293"></a>01293             size = <span class="keyword">sizeof</span>(<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html" title="struct UTPTransferReqDesc - UTRD structure header: UTRD header DW-0 to DW-3 commandDescBaseAddrLo:...">UTPTransferReqDesc</a>);
<a name="l01295"></a>01295             count = <a class="code" href="bitfield_8hh.html#a224a4f55757322870a3fa87b5d5254ee" title="Returns the bit position of the LSB that is set in the input.">findLsbSet</a>((<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a> ^ <a class="code" href="classUFSHostDevice.html#a9fdd54e78b6c6797f78e869fe67b1362" title="Track the transfer This is allows the driver to &amp;quot;group&amp;quot; certain transfers...">transferTrack</a>));
<a name="l01296"></a>01296             address = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5084e4bb5cae1d813c1393c3399cbad4">TRUTRLBAU</a>;
<a name="l01297"></a>01297             <span class="comment">//&lt;-64 bit</span>
<a name="l01298"></a>01298             address = (count * size) + (address &lt;&lt; 32) + <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a5eae3895696f3ad615fda3da5b620755" title="Transfer control registers.">TRUTRLBA</a>;
<a name="l01299"></a>01299 
<a name="l01300"></a>01300             <a class="code" href="classUFSHostDevice.html#a9fdd54e78b6c6797f78e869fe67b1362" title="Track the transfer This is allows the driver to &amp;quot;group&amp;quot; certain transfers...">transferTrack</a> |= mask &lt;&lt; count;
<a name="l01301"></a>01301             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Doorbell register: 0x%8x select #:&quot;</span>
<a name="l01302"></a>01302                     <span class="stringliteral">&quot; 0x%8x completion info: 0x%8x\n&quot;</span>, <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>,
<a name="l01303"></a>01303                     count, transferstart_info.<a class="code" href="structUFSHostDevice_1_1transferStart.html#ad20d4c119b6c8e82610d6cad99fbeaa3">done</a>);
<a name="l01304"></a>01304 
<a name="l01305"></a>01305             transferstart_info.<a class="code" href="structUFSHostDevice_1_1transferStart.html#ad20d4c119b6c8e82610d6cad99fbeaa3">done</a> = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>;
<a name="l01306"></a>01306 
<a name="l01308"></a>01308             <a class="code" href="classUFSHostDevice.html#ac6cef6d6deeb2b63d75b9af0a7530c62" title="Helper for latency stats These variables keep track of the latency for every doorbell...">transactionStart</a>[count] = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>(); <span class="comment">//note the start time</span>
<a name="l01309"></a>01309             ++<a class="code" href="classUFSHostDevice.html#a16f2e11f7a738325c2670d4436a741b7" title="Statistics helper variables Active doorbells indicates how many doorbells are in...">activeDoorbells</a>;
<a name="l01310"></a>01310             <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a7b479e73fd8dcda6080ed2bd1274c8d3">maxDoorbell</a> = (<a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a7b479e73fd8dcda6080ed2bd1274c8d3">maxDoorbell</a>.<a class="code" href="classStats_1_1ScalarBase.html#a493ab4422b5bfd7aed998cfd6f21b1de" title="Return the current value of this stat as its base type.">value</a>() &lt; <a class="code" href="classUFSHostDevice.html#a16f2e11f7a738325c2670d4436a741b7" title="Statistics helper variables Active doorbells indicates how many doorbells are in...">activeDoorbells</a>)
<a name="l01311"></a>01311                 ? <a class="code" href="classUFSHostDevice.html#a16f2e11f7a738325c2670d4436a741b7" title="Statistics helper variables Active doorbells indicates how many doorbells are in...">activeDoorbells</a> : <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a7b479e73fd8dcda6080ed2bd1274c8d3">maxDoorbell</a>.<a class="code" href="classStats_1_1ScalarBase.html#a493ab4422b5bfd7aed998cfd6f21b1de" title="Return the current value of this stat as its base type.">value</a>();
<a name="l01312"></a>01312             <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a3cf6be69d2d598b2f94f7d5c1bb8c106">averageDoorbell</a> = <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a7b479e73fd8dcda6080ed2bd1274c8d3">maxDoorbell</a>.<a class="code" href="classStats_1_1ScalarBase.html#a493ab4422b5bfd7aed998cfd6f21b1de" title="Return the current value of this stat as its base type.">value</a>();
<a name="l01313"></a>01313 
<a name="l01319"></a>01319             transferstart_info.<a class="code" href="structUFSHostDevice_1_1transferStart.html#a4c40e6df1ca0a693a66e1166f83b193d">mask</a> = mask &lt;&lt; count;
<a name="l01320"></a>01320             transferstart_info.<a class="code" href="structUFSHostDevice_1_1transferStart.html#a2c1ec6a4dec3f1f58d484d69ee3d55b7">address</a> = address;
<a name="l01321"></a>01321             transferstart_info.<a class="code" href="structUFSHostDevice_1_1transferStart.html#a54f9cebf16e7816159fd4c60c837ffcf">size</a> = size;
<a name="l01322"></a>01322             transferstart_info.<a class="code" href="structUFSHostDevice_1_1transferStart.html#ad20d4c119b6c8e82610d6cad99fbeaa3">done</a> = <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>;
<a name="l01323"></a>01323             <a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.push_back(transferstart_info);
<a name="l01324"></a>01324 
<a name="l01326"></a>01326             <a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.back().destination = <span class="keyword">new</span> <span class="keyword">struct</span>
<a name="l01327"></a>01327                 <a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html" title="struct UTPTransferReqDesc - UTRD structure header: UTRD header DW-0 to DW-3 commandDescBaseAddrLo:...">UTPTransferReqDesc</a>;
<a name="l01328"></a>01328             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Initial transfer start: 0x%8x\n&quot;</span>,
<a name="l01329"></a>01329                     transferstart_info.<a class="code" href="structUFSHostDevice_1_1transferStart.html#ad20d4c119b6c8e82610d6cad99fbeaa3">done</a>);
<a name="l01330"></a>01330             <a class="code" href="classUFSHostDevice.html#a906cf4e1a2bd3226f9dc2ab047935cde">transferEventQueue</a>.push_back(<span class="keyword">this</span>);
<a name="l01331"></a>01331 
<a name="l01332"></a>01332             <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#a906cf4e1a2bd3226f9dc2ab047935cde">transferEventQueue</a>.size() &lt; 2) {
<a name="l01333"></a>01333                 <a class="code" href="classUFSHostDevice.html#a8c9877d376633c69e4188d0db080a589" title="DMA transfer functions These allow the host to push/pull the data to the memory The...">writeDevice</a>(&amp;<a class="code" href="classUFSHostDevice.html#a906cf4e1a2bd3226f9dc2ab047935cde">transferEventQueue</a>.front(), <span class="keyword">false</span>,
<a name="l01334"></a>01334                             address, size, <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>
<a name="l01335"></a>01335                             (<a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.front().destination),0, 0);
<a name="l01336"></a>01336                 <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Transfer scheduled\n&quot;</span>);
<a name="l01337"></a>01337             }
<a name="l01338"></a>01338         }
<a name="l01339"></a>01339     }
<a name="l01340"></a>01340 }
<a name="l01341"></a>01341 
<a name="l01346"></a>01346 <span class="keywordtype">void</span>
<a name="l01347"></a><a class="code" href="classUFSHostDevice.html#a0a800aaa686c13700089c627fe244591">01347</a> <a class="code" href="classUFSHostDevice.html#a0a800aaa686c13700089c627fe244591" title="Task Start function.">UFSHostDevice::taskStart</a>()
<a name="l01348"></a>01348 {
<a name="l01349"></a>01349     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Task start&quot;</span>);
<a name="l01350"></a>01350     <a class="code" href="classUFSHostDevice.html#acdeeb5d6e448679537fc1b783cbc81a3" title="Task handler function.">taskHandler</a>(&amp;<a class="code" href="classUFSHostDevice.html#a3a1417b4e9c1813ae13da072112d05e0" title="When a task/transfer is started it needs information about the task/transfer it is...">taskInfo</a>.front().destination, <a class="code" href="classUFSHostDevice.html#a3a1417b4e9c1813ae13da072112d05e0" title="When a task/transfer is started it needs information about the task/transfer it is...">taskInfo</a>.front().mask,
<a name="l01351"></a>01351                 <a class="code" href="classUFSHostDevice.html#a3a1417b4e9c1813ae13da072112d05e0" title="When a task/transfer is started it needs information about the task/transfer it is...">taskInfo</a>.front().address, <a class="code" href="classUFSHostDevice.html#a3a1417b4e9c1813ae13da072112d05e0" title="When a task/transfer is started it needs information about the task/transfer it is...">taskInfo</a>.front().size);
<a name="l01352"></a>01352     <a class="code" href="classUFSHostDevice.html#a3a1417b4e9c1813ae13da072112d05e0" title="When a task/transfer is started it needs information about the task/transfer it is...">taskInfo</a>.pop_front();
<a name="l01353"></a>01353     <a class="code" href="classUFSHostDevice.html#a43b88841e2b65caf68dc581c4219e308" title="Multiple tasks transfers can be scheduled at once for the device, the only thing...">taskEventQueue</a>.pop_front();
<a name="l01354"></a>01354 }
<a name="l01355"></a>01355 
<a name="l01360"></a>01360 <span class="keywordtype">void</span>
<a name="l01361"></a><a class="code" href="classUFSHostDevice.html#a807eba6e29725755376b83d17dcea227">01361</a> <a class="code" href="classUFSHostDevice.html#a807eba6e29725755376b83d17dcea227" title="Transfer Start function.">UFSHostDevice::transferStart</a>()
<a name="l01362"></a>01362 {
<a name="l01363"></a>01363     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Enter transfer event\n&quot;</span>);
<a name="l01364"></a>01364     <a class="code" href="classUFSHostDevice.html#ab99774ea692a4e887e1ca86dfd3e940a" title="Transfer handler function.">transferHandler</a>(<a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.front().destination,
<a name="l01365"></a>01365                     <a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.front().mask,
<a name="l01366"></a>01366                     <a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.front().address,
<a name="l01367"></a>01367                     <a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.front().size,
<a name="l01368"></a>01368                     <a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.front().done);
<a name="l01369"></a>01369 
<a name="l01370"></a>01370     <a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.pop_front();
<a name="l01371"></a>01371     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Transfer queue size at end of event: &quot;</span>
<a name="l01372"></a>01372             <span class="stringliteral">&quot;0x%8x\n&quot;</span>, <a class="code" href="classUFSHostDevice.html#a906cf4e1a2bd3226f9dc2ab047935cde">transferEventQueue</a>.size());
<a name="l01373"></a>01373 }
<a name="l01374"></a>01374 
<a name="l01380"></a>01380 <span class="keywordtype">void</span>
<a name="l01381"></a><a class="code" href="classUFSHostDevice.html#a244ebbc28d0b9a2595d4eb159743ab2c">01381</a> <a class="code" href="classUFSHostDevice.html#a244ebbc28d0b9a2595d4eb159743ab2c" title="Command handler function.">UFSHostDevice::commandHandler</a>()
<a name="l01382"></a>01382 {
<a name="l01383"></a>01383     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a8b39ec0e4fa93fa2afe4e95208568fb4" title="Command registers.">CMDUICCMDR</a> == 0x16) {
<a name="l01384"></a>01384         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ad784275e67d9221789a55ef048a937ab">ORHostControllerStatus</a> |= 0x0F;<span class="comment">//link startup</span>
<a name="l01385"></a>01385     }
<a name="l01386"></a>01386 
<a name="l01387"></a>01387 }
<a name="l01388"></a>01388 
<a name="l01394"></a>01394 <span class="keywordtype">void</span>
<a name="l01395"></a><a class="code" href="classUFSHostDevice.html#acdeeb5d6e448679537fc1b783cbc81a3">01395</a> <a class="code" href="classUFSHostDevice.html#acdeeb5d6e448679537fc1b783cbc81a3" title="Task handler function.">UFSHostDevice::taskHandler</a>(<span class="keyword">struct</span> <a class="code" href="structUFSHostDevice_1_1UTPUPIUTaskReq.html" title="struct UTPUPIUTaskReq - Task request UPIU structure header - UPIU header structure...">UTPUPIUTaskReq</a>* request_in,
<a name="l01396"></a>01396                            uint32_t req_pos, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> finaladdress, uint32_t
<a name="l01397"></a>01397                            finalsize)
<a name="l01398"></a>01398 {
<a name="l01403"></a>01403     <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;taskHandler\n&quot;</span>);
<a name="l01404"></a>01404     <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;%8x\n&quot;</span>, request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPUPIUTaskReq.html#ac7ab8b82b6f4113f29cd7ba9f1d4d84a">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPUPIUHeader.html#a107c7bcb70be00f441b0f525485dc7a8">dWord0</a>);
<a name="l01405"></a>01405     <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;%8x\n&quot;</span>, request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPUPIUTaskReq.html#ac7ab8b82b6f4113f29cd7ba9f1d4d84a">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPUPIUHeader.html#a721238704b7efdd4a2e52276823a0878">dWord1</a>);
<a name="l01406"></a>01406     <a class="code" href="base_2misc_8hh.html#ae7d790080fa18103d7582effff570b9e">inform</a>(<span class="stringliteral">&quot;%8x\n&quot;</span>, request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPUPIUTaskReq.html#ac7ab8b82b6f4113f29cd7ba9f1d4d84a">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPUPIUHeader.html#ae4e8fe92ac0dc9e003f9e0a262d578ed">dWord2</a>);
<a name="l01407"></a>01407 
<a name="l01408"></a>01408     request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPUPIUTaskReq.html#ac7ab8b82b6f4113f29cd7ba9f1d4d84a">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPUPIUHeader.html#ae4e8fe92ac0dc9e003f9e0a262d578ed">dWord2</a> &amp;= 0xffffff00;
<a name="l01409"></a>01409 
<a name="l01410"></a>01410     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a90d54007266225daf88e81aaea8195c5">TMUTMRLDBR</a> &amp;= ~(req_pos);
<a name="l01411"></a>01411     <a class="code" href="classUFSHostDevice.html#a2ad1bf7f00d4e944c7ca004b5ddb2c81">taskCommandTrack</a> &amp;= ~(req_pos);
<a name="l01412"></a>01412     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a47d13a137b1124b6c2bc1f8799507e5d" title="Operation and runtime registers.">ORInterruptStatus</a> |= <a class="code" href="classUFSHostDevice.html#acb934c31fb64417a09fc26151b738600">UTPTaskREQCOMPL</a>;
<a name="l01413"></a>01413 
<a name="l01414"></a>01414     <a class="code" href="classUFSHostDevice.html#ad901dabdffb2047844f124ee5ce1328d" title="Dma transaction function: read device.">readDevice</a>(<span class="keyword">true</span>, finaladdress, finalsize, reinterpret_cast&lt;uint8_t*&gt;
<a name="l01415"></a>01415                (request_in), <span class="keyword">true</span>, NULL);
<a name="l01416"></a>01416 
<a name="l01417"></a>01417 }
<a name="l01418"></a>01418 
<a name="l01430"></a>01430 <span class="keywordtype">void</span>
<a name="l01431"></a><a class="code" href="classUFSHostDevice.html#ab99774ea692a4e887e1ca86dfd3e940a">01431</a> <a class="code" href="classUFSHostDevice.html#ab99774ea692a4e887e1ca86dfd3e940a" title="Transfer handler function.">UFSHostDevice::transferHandler</a>(<span class="keyword">struct</span> <a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html" title="struct UTPTransferReqDesc - UTRD structure header: UTRD header DW-0 to DW-3 commandDescBaseAddrLo:...">UTPTransferReqDesc</a>* request_in,
<a name="l01432"></a>01432                                <span class="keywordtype">int</span> req_pos, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> finaladdress, uint32_t
<a name="l01433"></a>01433                                finalsize, uint32_t done)
<a name="l01434"></a>01434 {
<a name="l01435"></a>01435 
<a name="l01436"></a>01436     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> cmd_desc_addr = 0x00;
<a name="l01437"></a>01437 
<a name="l01438"></a>01438 
<a name="l01439"></a>01439     <span class="comment">//acknowledge handling of the message</span>
<a name="l01440"></a>01440     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;SCSI message detected\n&quot;</span>);
<a name="l01441"></a>01441     request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#a567f254f85ec248db6d91a324ab81b7d" title="struct RequestDescHeader dword0: Descriptor Header DW0 dword1: Descriptor Header...">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc_1_1RequestDescHeader.html#a47800dc094978ab49f52abfcc8fb079c">dWord2</a> &amp;= 0xffffff00;
<a name="l01442"></a>01442     <a class="code" href="classUFSHostDevice.html#a9ddaf7164922015fc943e5554fc7ef04" title="SCSI resume info information structure for SCSI resume.">SCSIInfo</a>.<a class="code" href="structUFSHostDevice_1_1SCSIResumeInfo.html#a4400e726324b078d04fa91902c048f9e">RequestIn</a> = request_in;
<a name="l01443"></a>01443     <a class="code" href="classUFSHostDevice.html#a9ddaf7164922015fc943e5554fc7ef04" title="SCSI resume info information structure for SCSI resume.">SCSIInfo</a>.<a class="code" href="structUFSHostDevice_1_1SCSIResumeInfo.html#af7b0ce07b1f9f02764c4daafca26bdbc">reqPos</a> = req_pos;
<a name="l01444"></a>01444     <a class="code" href="classUFSHostDevice.html#a9ddaf7164922015fc943e5554fc7ef04" title="SCSI resume info information structure for SCSI resume.">SCSIInfo</a>.<a class="code" href="structUFSHostDevice_1_1SCSIResumeInfo.html#a876207db9cc8fe1313b43bab5c22315d">finalAddress</a> = finaladdress;
<a name="l01445"></a>01445     <a class="code" href="classUFSHostDevice.html#a9ddaf7164922015fc943e5554fc7ef04" title="SCSI resume info information structure for SCSI resume.">SCSIInfo</a>.<a class="code" href="structUFSHostDevice_1_1SCSIResumeInfo.html#aacdd632a4c2866dfaddd0d855022e13b">finalSize</a> = finalsize;
<a name="l01446"></a>01446     <a class="code" href="classUFSHostDevice.html#a9ddaf7164922015fc943e5554fc7ef04" title="SCSI resume info information structure for SCSI resume.">SCSIInfo</a>.<a class="code" href="structUFSHostDevice_1_1SCSIResumeInfo.html#a94477884c29018d0a23af69592ddb183">destination</a>.resize(request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#aa3f6d368f1ede42de584587084287b37">PRDTableOffset</a> * 4
<a name="l01447"></a>01447         + request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#ae1805af8a12decc1275b688a1a63bc82">PRDTableLength</a> * <span class="keyword">sizeof</span>(<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html" title="struct UFSHCDSGEntry - UFSHCI PRD Entry baseAddr: Lower 32bit physical address DW-0...">UFSHCDSGEntry</a>));
<a name="l01448"></a>01448     <a class="code" href="classUFSHostDevice.html#a9ddaf7164922015fc943e5554fc7ef04" title="SCSI resume info information structure for SCSI resume.">SCSIInfo</a>.<a class="code" href="structUFSHostDevice_1_1SCSIResumeInfo.html#a2a906bc2e028fcd5359f63e02dcf34ff">done</a> = done;
<a name="l01449"></a>01449 
<a name="l01450"></a>01450     assert(!<a class="code" href="classUFSHostDevice.html#aadf97748a0d65f612d66caa66694653a" title="The events that control the functionality.">SCSIResumeEvent</a>.<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>());
<a name="l01454"></a>01454     cmd_desc_addr = request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#a93f673feec757aeceffdfbc3299b97fa">commandDescBaseAddrHi</a>;
<a name="l01455"></a>01455     cmd_desc_addr = (cmd_desc_addr &lt;&lt; 32) |
<a name="l01456"></a>01456         (request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#a511f4a9dd9569da43e8cb780da504563">commandDescBaseAddrLo</a> &amp; 0xffffffff);
<a name="l01457"></a>01457 
<a name="l01458"></a>01458     <a class="code" href="classUFSHostDevice.html#a8c9877d376633c69e4188d0db080a589" title="DMA transfer functions These allow the host to push/pull the data to the memory The...">writeDevice</a>(&amp;<a class="code" href="classUFSHostDevice.html#aadf97748a0d65f612d66caa66694653a" title="The events that control the functionality.">SCSIResumeEvent</a>, <span class="keyword">false</span>, cmd_desc_addr,
<a name="l01459"></a>01459                 <a class="code" href="classUFSHostDevice.html#a9ddaf7164922015fc943e5554fc7ef04" title="SCSI resume info information structure for SCSI resume.">SCSIInfo</a>.<a class="code" href="structUFSHostDevice_1_1SCSIResumeInfo.html#a94477884c29018d0a23af69592ddb183">destination</a>.size(), &amp;<a class="code" href="classUFSHostDevice.html#a9ddaf7164922015fc943e5554fc7ef04" title="SCSI resume info information structure for SCSI resume.">SCSIInfo</a>.<a class="code" href="structUFSHostDevice_1_1SCSIResumeInfo.html#a94477884c29018d0a23af69592ddb183">destination</a>[0],0, 0);
<a name="l01460"></a>01460 
<a name="l01461"></a>01461     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;SCSI scheduled\n&quot;</span>);
<a name="l01462"></a>01462 
<a name="l01463"></a>01463     <a class="code" href="classUFSHostDevice.html#a906cf4e1a2bd3226f9dc2ab047935cde">transferEventQueue</a>.pop_front();
<a name="l01464"></a>01464 }
<a name="l01465"></a>01465 
<a name="l01473"></a>01473 <span class="keywordtype">void</span>
<a name="l01474"></a><a class="code" href="classUFSHostDevice.html#a8a08d054940867f114c461a5ed477afb">01474</a> <a class="code" href="classUFSHostDevice.html#a8a08d054940867f114c461a5ed477afb" title="Transfer SCSI function.">UFSHostDevice::SCSIStart</a>()
<a name="l01475"></a>01475 {
<a name="l01476"></a>01476     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;SCSI message on hold until ready\n&quot;</span>);
<a name="l01477"></a>01477     uint32_t LUN = <a class="code" href="classUFSHostDevice.html#a9ddaf7164922015fc943e5554fc7ef04" title="SCSI resume info information structure for SCSI resume.">SCSIInfo</a>.<a class="code" href="structUFSHostDevice_1_1SCSIResumeInfo.html#a94477884c29018d0a23af69592ddb183">destination</a>[2];
<a name="l01478"></a>01478     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;SCSIInfoQueue.push_back(<a class="code" href="classUFSHostDevice.html#a9ddaf7164922015fc943e5554fc7ef04" title="SCSI resume info information structure for SCSI resume.">SCSIInfo</a>);
<a name="l01479"></a>01479 
<a name="l01480"></a>01480     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;SCSI queue %d has %d elements\n&quot;</span>, LUN,
<a name="l01481"></a>01481             <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;SCSIInfoQueue.size());
<a name="l01482"></a>01482 
<a name="l01484"></a>01484     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;SCSIInfoQueue.size() &lt; 2) <span class="comment">//LUN is available</span>
<a name="l01485"></a>01485         <a class="code" href="classUFSHostDevice.html#abbd53b76896313d34e8c9ed20b5fc79c" title="Starts the scsi handling function in the apropriate Logic unit, prepares the right...">SCSIResume</a>(LUN);
<a name="l01486"></a>01486 
<a name="l01487"></a>01487     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;SCSIInfoQueue.size() &gt; 32)
<a name="l01488"></a>01488         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;SCSI queue is getting too big %d\n&quot;</span>, <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;
<a name="l01489"></a>01489               SCSIInfoQueue.size());
<a name="l01490"></a>01490 
<a name="l01495"></a>01495     <span class="keywordflow">if</span> (!<a class="code" href="classUFSHostDevice.html#a906cf4e1a2bd3226f9dc2ab047935cde">transferEventQueue</a>.empty()) {
<a name="l01496"></a>01496 
<a name="l01501"></a>01501         <a class="code" href="classUFSHostDevice.html#a8c9877d376633c69e4188d0db080a589" title="DMA transfer functions These allow the host to push/pull the data to the memory The...">writeDevice</a>(&amp;<a class="code" href="classUFSHostDevice.html#a906cf4e1a2bd3226f9dc2ab047935cde">transferEventQueue</a>.front(), <span class="keyword">false</span>,
<a name="l01502"></a>01502                     <a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.front().address,
<a name="l01503"></a>01503                     <a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.front().size, <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>
<a name="l01504"></a>01504                     (<a class="code" href="classUFSHostDevice.html#ac72374443f2d7b5088387317d84f3be7">transferStartInfo</a>.front().destination), 0, 0);
<a name="l01505"></a>01505 
<a name="l01506"></a>01506         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Transfer scheduled&quot;</span>);
<a name="l01507"></a>01507     }
<a name="l01508"></a>01508 }
<a name="l01509"></a>01509 
<a name="l01518"></a>01518 <span class="keywordtype">void</span>
<a name="l01519"></a><a class="code" href="classUFSHostDevice.html#abbd53b76896313d34e8c9ed20b5fc79c">01519</a> <a class="code" href="classUFSHostDevice.html#abbd53b76896313d34e8c9ed20b5fc79c" title="Starts the scsi handling function in the apropriate Logic unit, prepares the right...">UFSHostDevice::SCSIResume</a>(uint32_t lun_id)
<a name="l01520"></a>01520 {
<a name="l01521"></a>01521     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;SCSIresume\n&quot;</span>);
<a name="l01522"></a>01522     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;SCSIInfoQueue.empty())
<a name="l01523"></a>01523         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;No SCSI message scheduled lun:%d Doorbell: 0x%8x&quot;</span>, lun_id,
<a name="l01524"></a>01524               <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>);
<a name="l01525"></a>01525 
<a name="l01527"></a>01527     <span class="keyword">struct </span><a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html" title="struct UTPTransferReqDesc - UTRD structure header: UTRD header DW-0 to DW-3 commandDescBaseAddrLo:...">UTPTransferReqDesc</a>* request_in = <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;
<a name="l01528"></a>01528         SCSIInfoQueue.front().RequestIn;
<a name="l01529"></a>01529 
<a name="l01530"></a>01530     uint32_t req_pos = <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;SCSIInfoQueue.front().reqPos;
<a name="l01531"></a>01531 
<a name="l01532"></a>01532     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> finaladdress = <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;SCSIInfoQueue.front().
<a name="l01533"></a>01533         finalAddress;
<a name="l01534"></a>01534 
<a name="l01535"></a>01535     uint32_t finalsize = <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;SCSIInfoQueue.front().finalSize;
<a name="l01536"></a>01536 
<a name="l01537"></a>01537     uint32_t* transfercommand = <span class="keyword">reinterpret_cast&lt;</span>uint32_t*<span class="keyword">&gt;</span>
<a name="l01538"></a>01538         (&amp;(<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;SCSIInfoQueue.front().destination[0]));
<a name="l01539"></a>01539 
<a name="l01540"></a>01540     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Task tag: 0x%8x\n&quot;</span>, transfercommand[0]&gt;&gt;24);
<a name="l01542"></a>01542     <a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a> = <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[(transfercommand[0] &amp; 0xFF0000) &gt;&gt; 16]-&gt;
<a name="l01543"></a>01543         SCSICMDHandle(transfercommand);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;LUN: %d\n&quot;</span>, <a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a0ee7e32d969e34bbd6e15ff7117a24ba">LUN</a>);
<a name="l01546"></a>01546 
<a name="l01551"></a>01551     request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#a567f254f85ec248db6d91a324ab81b7d" title="struct RequestDescHeader dword0: Descriptor Header DW0 dword1: Descriptor Header...">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc_1_1RequestDescHeader.html#a651d389463ed004837cd1b045308045f">dWord0</a> = ((request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#a567f254f85ec248db6d91a324ab81b7d" title="struct RequestDescHeader dword0: Descriptor Header DW0 dword1: Descriptor Header...">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc_1_1RequestDescHeader.html#a651d389463ed004837cd1b045308045f">dWord0</a> &gt;&gt; 24) == 0x21)
<a name="l01552"></a>01552         ? 0x36 : 0x21;
<a name="l01553"></a>01553     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.requestOut.header.dWord0 =
<a name="l01554"></a>01554         request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#a567f254f85ec248db6d91a324ab81b7d" title="struct RequestDescHeader dword0: Descriptor Header DW0 dword1: Descriptor Header...">header</a>.<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc_1_1RequestDescHeader.html#a651d389463ed004837cd1b045308045f">dWord0</a> | (<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a0ee7e32d969e34bbd6e15ff7117a24ba">LUN</a> &lt;&lt; 8)
<a name="l01555"></a>01555         | (transfercommand[0] &amp; 0xFF000000);
<a name="l01557"></a>01557     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.requestOut.header.dWord1 = 0x00000000 |
<a name="l01558"></a>01558         (<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a1b3228868649c468b9c5dcbd3c4016e8">status</a> &lt;&lt; 24);
<a name="l01560"></a>01560     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.requestOut.header.dWord2 = 0x00000000 |
<a name="l01561"></a>01561         ((<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a> + 2) &lt;&lt; 24) | 0x05;
<a name="l01563"></a>01563     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.requestOut.senseDataLen =
<a name="l01564"></a>01564         <a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a>;
<a name="l01565"></a>01565 
<a name="l01566"></a>01566     <span class="comment">//data</span>
<a name="l01567"></a>01567     <span class="keywordflow">for</span> (uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>&lt;<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a00abe3f6f0aea0f22edd0550c84ede0e">senseSize</a>; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++) {
<a name="l01568"></a>01568         <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.requestOut.senseData[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>] =
<a name="l01569"></a>01569             <a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#af849bd6b3fabd0ce0568c618e8aaf0be">senseCode</a>[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> + 1];
<a name="l01570"></a>01570     }
<a name="l01571"></a>01571 
<a name="l01572"></a>01572     <span class="comment">/*</span>
<a name="l01573"></a>01573 <span class="comment">     * At position defined by &quot;request_in-&gt;PRDTableOffset&quot; (counting 32 bit</span>
<a name="l01574"></a>01574 <span class="comment">     * words) in array &quot;transfercommand&quot; we have a scatter gather list, which</span>
<a name="l01575"></a>01575 <span class="comment">     * is usefull to us if we interpreted it as a UFSHCDSGEntry structure.</span>
<a name="l01576"></a>01576 <span class="comment">     */</span>
<a name="l01577"></a>01577     <span class="keyword">struct </span><a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html" title="struct UFSHCDSGEntry - UFSHCI PRD Entry baseAddr: Lower 32bit physical address DW-0...">UFSHCDSGEntry</a>* sglist =  <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html" title="struct UFSHCDSGEntry - UFSHCI PRD Entry baseAddr: Lower 32bit physical address DW-0...">UFSHCDSGEntry</a>*<span class="keyword">&gt;</span>
<a name="l01578"></a>01578         (&amp;(transfercommand[(request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#aa3f6d368f1ede42de584587084287b37">PRDTableOffset</a>)]));
<a name="l01579"></a>01579 
<a name="l01580"></a>01580     uint32_t length = request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#ae1805af8a12decc1275b688a1a63bc82">PRDTableLength</a>;
<a name="l01581"></a>01581     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;# PRDT entries: %d\n&quot;</span>, length);
<a name="l01582"></a>01582 
<a name="l01583"></a>01583     <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> response_addr = request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#a93f673feec757aeceffdfbc3299b97fa">commandDescBaseAddrHi</a>;
<a name="l01584"></a>01584     response_addr = (response_addr &lt;&lt; 32) |
<a name="l01585"></a>01585         ((request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#a511f4a9dd9569da43e8cb780da504563">commandDescBaseAddrLo</a> +
<a name="l01586"></a>01586           (request_in-&gt;<a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html#aef2cc171453a0e1d94b510bc5fa5d4ad">responseUPIULength</a> &lt;&lt; 2)) &amp; 0xffffffff);
<a name="l01587"></a>01587 
<a name="l01589"></a>01589     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.responseStartAddr = response_addr;
<a name="l01590"></a>01590     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.reqPos = req_pos;
<a name="l01591"></a>01591     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.size = finalsize;
<a name="l01592"></a>01592     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.address = finaladdress;
<a name="l01593"></a>01593     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.destination = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>
<a name="l01594"></a>01594         (<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;SCSIInfoQueue.front().RequestIn);
<a name="l01595"></a>01595     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.finished = <span class="keyword">true</span>;
<a name="l01596"></a>01596     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;transferInfo.lunID = <a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a0ee7e32d969e34bbd6e15ff7117a24ba">LUN</a>;
<a name="l01597"></a>01597 
<a name="l01603"></a>01603     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> == 0x01) {
<a name="l01605"></a>01605         <a class="code" href="classUFSHostDevice.html#a43c98267d32cb45293de172eda4f04f7" title="Disk transfer management functions these set up the queues, and initiated them, leading...">manageWriteTransfer</a>(<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a0ee7e32d969e34bbd6e15ff7117a24ba">LUN</a>, <a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a90e3e00dfe48b56f481c6ad1453735f1">offset</a>,
<a name="l01606"></a>01606                             length, sglist);
<a name="l01607"></a>01607 
<a name="l01608"></a>01608     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a45dc3783afabbc9e66973ce9d26fcfc9">expectMore</a> == 0x02) {
<a name="l01610"></a>01610         <a class="code" href="classUFSHostDevice.html#aebef3ab77126553cee4fb576cc989e31" title="Manage read transfer.">manageReadTransfer</a>(<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a>, <a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a0ee7e32d969e34bbd6e15ff7117a24ba">LUN</a>,
<a name="l01611"></a>01611                            <a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a90e3e00dfe48b56f481c6ad1453735f1">offset</a>, length, sglist);
<a name="l01612"></a>01612 
<a name="l01613"></a>01613     } <span class="keywordflow">else</span> {
<a name="l01615"></a>01615         uint32_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0;
<a name="l01616"></a>01616         uint32_t size_accum = 0;
<a name="l01617"></a>01617         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Data DMA size: 0x%8x\n&quot;</span>,
<a name="l01618"></a>01618                 <a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a>);
<a name="l01619"></a>01619 
<a name="l01621"></a>01621         <span class="keywordflow">while</span> ((length &gt; count) &amp;&amp; size_accum
<a name="l01622"></a>01622                &lt; (<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> - 1) &amp;&amp;
<a name="l01623"></a>01623                (<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> != 0x00)) {
<a name="l01624"></a>01624             <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> SCSI_start = sglist[count].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a39591760945b8859853cd55ab9d72aaf">upperAddr</a>;
<a name="l01625"></a>01625             SCSI_start = (SCSI_start &lt;&lt; 32) |
<a name="l01626"></a>01626                 (sglist[count].baseAddr &amp; 0xFFFFFFFF);
<a name="l01627"></a>01627             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Data DMA start: 0x%8x\n&quot;</span>, SCSI_start);
<a name="l01628"></a>01628             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Data DMA size: 0x%8x\n&quot;</span>,
<a name="l01629"></a>01629                     (sglist[count].size + 1));
<a name="l01637"></a>01637             uint32_t size_to_send = sglist[count].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a5e2eecd16309b8821bc9313b8ae50931">size</a> + 1;
<a name="l01638"></a>01638 
<a name="l01639"></a>01639             <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> &lt; (size_to_send + size_accum))
<a name="l01640"></a>01640                 size_to_send = <a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> - size_accum;
<a name="l01641"></a>01641 
<a name="l01642"></a>01642             <a class="code" href="classUFSHostDevice.html#ad901dabdffb2047844f124ee5ce1328d" title="Dma transaction function: read device.">readDevice</a>(<span class="keyword">false</span>, SCSI_start, size_to_send,
<a name="l01643"></a>01643                        reinterpret_cast&lt;uint8_t*&gt;
<a name="l01644"></a>01644                        (&amp;(<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#ae5dae5cb1cac4c293144499765bd2b92">message</a>.<a class="code" href="structUFSHostDevice_1_1UPIUMessage.html#af166dbbfd54134ee7fba8e83302dd566">dataMsg</a>[size_accum])),
<a name="l01645"></a>01645                        <span class="keyword">false</span>, NULL);
<a name="l01646"></a>01646 
<a name="l01647"></a>01647             size_accum += size_to_send;
<a name="l01648"></a>01648             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Total remaining: 0x%8x,accumulated so far&quot;</span>
<a name="l01649"></a>01649                     <span class="stringliteral">&quot; : 0x%8x\n&quot;</span>, (<a class="code" href="classUFSHostDevice.html#a980f9a20b4cfcc5ac36b10dc8a2dafa9" title="SCSI reply structure, used for direct answering.">request_out_datain</a>.<a class="code" href="structUFSHostDevice_1_1SCSIReply.html#a54f8331af028a92c9c49c0283625342c">msgSize</a> - size_accum),
<a name="l01650"></a>01650                     size_accum);
<a name="l01651"></a>01651 
<a name="l01652"></a>01652             ++count;
<a name="l01653"></a>01653             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Transfer #: %d\n&quot;</span>, count);
<a name="l01654"></a>01654         }
<a name="l01655"></a>01655 
<a name="l01657"></a>01657         <a class="code" href="classUFSHostDevice.html#ab7284900b111b9990ac2f494a19413c7" title="transfer done, the beginning of the final stage of the transfer.">transferDone</a>(response_addr, req_pos, <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;
<a name="l01658"></a>01658                      <a class="code" href="structUFSHostDevice_1_1transferInfo.html" title="Different events, and scenarios require different types of information.">transferInfo</a>.requestOut, finalsize, finaladdress,
<a name="l01659"></a>01659                      reinterpret_cast&lt;uint8_t*&gt;(request_in), <span class="keyword">true</span>, lun_id);
<a name="l01660"></a>01660     }
<a name="l01661"></a>01661 
<a name="l01662"></a>01662     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;SCSI resume done\n&quot;</span>);
<a name="l01663"></a>01663 }
<a name="l01664"></a>01664 
<a name="l01670"></a>01670 <span class="keywordtype">void</span>
<a name="l01671"></a><a class="code" href="classUFSHostDevice.html#a32d78ae4c6ef3dbfe3ac26d55692a6cc">01671</a> <a class="code" href="classUFSHostDevice.html#a32d78ae4c6ef3dbfe3ac26d55692a6cc" title="LU callback function to indicate that the action has completed.">UFSHostDevice::LUNSignal</a>()
<a name="l01672"></a>01672 {
<a name="l01673"></a>01673     uint8_t this_lun = 0;
<a name="l01674"></a>01674 
<a name="l01675"></a>01675     <span class="comment">//while we haven&apos;t found the right lun, keep searching</span>
<a name="l01676"></a>01676     <span class="keywordflow">while</span>((this_lun &lt; <a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a>) &amp;&amp; !<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;finishedCommand())
<a name="l01677"></a>01677         ++this_lun;
<a name="l01678"></a>01678 
<a name="l01679"></a>01679     <span class="keywordflow">if</span> (this_lun &lt; <a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a>) {
<a name="l01680"></a>01680         <span class="comment">//Clear signal.</span>
<a name="l01681"></a>01681         <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;clearSignal();
<a name="l01682"></a>01682         <span class="comment">//found it; call transferDone</span>
<a name="l01683"></a>01683         <a class="code" href="classUFSHostDevice.html#ab7284900b111b9990ac2f494a19413c7" title="transfer done, the beginning of the final stage of the transfer.">transferDone</a>(<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;<a class="code" href="structUFSHostDevice_1_1transferInfo.html" title="Different events, and scenarios require different types of information.">transferInfo</a>.responseStartAddr,
<a name="l01684"></a>01684                      <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;transferInfo.reqPos,
<a name="l01685"></a>01685                      <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;transferInfo.requestOut,
<a name="l01686"></a>01686                      <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;transferInfo.size,
<a name="l01687"></a>01687                      <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;transferInfo.address,
<a name="l01688"></a>01688                      <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;transferInfo.destination,
<a name="l01689"></a>01689                      <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;transferInfo.finished,
<a name="l01690"></a>01690                      <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;transferInfo.lunID);
<a name="l01691"></a>01691     }
<a name="l01692"></a>01692 
<a name="l01693"></a>01693     <span class="keywordflow">else</span>
<a name="l01694"></a>01694         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;no LUN finished in tick %d\n&quot;</span>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l01695"></a>01695 }
<a name="l01696"></a>01696 
<a name="l01702"></a>01702 <span class="keywordtype">void</span>
<a name="l01703"></a><a class="code" href="classUFSHostDevice.html#ab7284900b111b9990ac2f494a19413c7">01703</a> <a class="code" href="classUFSHostDevice.html#ab7284900b111b9990ac2f494a19413c7" title="transfer done, the beginning of the final stage of the transfer.">UFSHostDevice::transferDone</a>(<a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> responseStartAddr, uint32_t req_pos,
<a name="l01704"></a>01704                             <span class="keyword">struct</span> <a class="code" href="structUFSHostDevice_1_1UTPUPIURSP.html" title="struct UTPUPIURSP - Response UPIU structure header: UPIU header DW-0 to DW-2 residualTransferCount:...">UTPUPIURSP</a> request_out, uint32_t size,
<a name="l01705"></a>01705                             <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> address, uint8_t* <a class="code" href="namespaceX86ISA.html#aa49a1e243decf460110b2436025d8823">destination</a>,
<a name="l01706"></a>01706                             <span class="keywordtype">bool</span> finished, uint32_t lun_id)
<a name="l01707"></a>01707 {
<a name="l01709"></a>01709     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;SCSIInfoQueue.empty())
<a name="l01710"></a>01710         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;No SCSI message scheduled lun:%d Doorbell: 0x%8x&quot;</span>, lun_id,
<a name="l01711"></a>01711               <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>);
<a name="l01712"></a>01712 
<a name="l01713"></a>01713     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;DMA start: 0x%8x; DMA size: 0x%8x\n&quot;</span>,
<a name="l01714"></a>01714             responseStartAddr, <span class="keyword">sizeof</span>(request_out));
<a name="l01715"></a>01715 
<a name="l01716"></a>01716     <span class="keyword">struct </span><a class="code" href="structUFSHostDevice_1_1transferStart.html" title="Transfer start information.">transferStart</a> lastinfo;
<a name="l01717"></a>01717     lastinfo.<a class="code" href="structUFSHostDevice_1_1transferStart.html#a4c40e6df1ca0a693a66e1166f83b193d">mask</a> = req_pos;
<a name="l01718"></a>01718     lastinfo.<a class="code" href="structUFSHostDevice_1_1transferStart.html#ad20d4c119b6c8e82610d6cad99fbeaa3">done</a> = finished;
<a name="l01719"></a>01719     lastinfo.<a class="code" href="structUFSHostDevice_1_1transferStart.html#a2c1ec6a4dec3f1f58d484d69ee3d55b7">address</a> = address;
<a name="l01720"></a>01720     lastinfo.<a class="code" href="structUFSHostDevice_1_1transferStart.html#a54f9cebf16e7816159fd4c60c837ffcf">size</a> = size;
<a name="l01721"></a>01721     lastinfo.<a class="code" href="structUFSHostDevice_1_1transferStart.html#a1c057ed8bd33c61428e3ea1c47fef16b">destination</a> = <span class="keyword">reinterpret_cast&lt;</span><a class="code" href="structUFSHostDevice_1_1UTPTransferReqDesc.html" title="struct UTPTransferReqDesc - UTRD structure header: UTRD header DW-0 to DW-3 commandDescBaseAddrLo:...">UTPTransferReqDesc</a>*<span class="keyword">&gt;</span>
<a name="l01722"></a>01722         (destination);
<a name="l01723"></a>01723     lastinfo.<a class="code" href="structUFSHostDevice_1_1transferStart.html#a4af863efdb18e207743e4e6cfd487084">lun_id</a> = lun_id;
<a name="l01724"></a>01724 
<a name="l01725"></a>01725     <a class="code" href="classUFSHostDevice.html#adaa5cb5f2698e8d845d41615dc0ea074" title="To finish the transaction one needs information about the original message.">transferEnd</a>.push_back(lastinfo);
<a name="l01726"></a>01726 
<a name="l01727"></a>01727     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Transfer done start\n&quot;</span>);
<a name="l01728"></a>01728 
<a name="l01729"></a>01729     <a class="code" href="classUFSHostDevice.html#ad901dabdffb2047844f124ee5ce1328d" title="Dma transaction function: read device.">readDevice</a>(<span class="keyword">false</span>, responseStartAddr, <span class="keyword">sizeof</span>(request_out),
<a name="l01730"></a>01730                reinterpret_cast&lt;uint8_t*&gt;
<a name="l01731"></a>01731                (&amp;(<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;<a class="code" href="structUFSHostDevice_1_1transferInfo.html" title="Different events, and scenarios require different types of information.">transferInfo</a>.requestOut)),
<a name="l01732"></a>01732                <span class="keyword">true</span>, &amp;<a class="code" href="classUFSHostDevice.html#a8cf81d83001c40ab22899e26a798856a" title="Wait for the moment where we can send the last frame.">UTPEvent</a>);
<a name="l01733"></a>01733 }
<a name="l01734"></a>01734 
<a name="l01741"></a>01741 <span class="keywordtype">void</span>
<a name="l01742"></a><a class="code" href="classUFSHostDevice.html#a9de6e5d410663f3af1fdef53b55997f8">01742</a> <a class="code" href="classUFSHostDevice.html#a9de6e5d410663f3af1fdef53b55997f8" title="final UTP, sends the last acknowledge data structure to the system; prepares the...">UFSHostDevice::finalUTP</a>()
<a name="l01743"></a>01743 {
<a name="l01744"></a>01744     uint32_t lun_id = <a class="code" href="classUFSHostDevice.html#adaa5cb5f2698e8d845d41615dc0ea074" title="To finish the transaction one needs information about the original message.">transferEnd</a>.front().lun_id;
<a name="l01745"></a>01745 
<a name="l01746"></a>01746     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;SCSIInfoQueue.pop_front();
<a name="l01747"></a>01747     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;SCSIInfoQueue size: %d, lun: %d\n&quot;</span>,
<a name="l01748"></a>01748             <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;SCSIInfoQueue.size(), lun_id);
<a name="l01749"></a>01749 
<a name="l01751"></a>01751     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a> &amp; <a class="code" href="classUFSHostDevice.html#adaa5cb5f2698e8d845d41615dc0ea074" title="To finish the transaction one needs information about the original message.">transferEnd</a>.front().mask) {
<a name="l01752"></a>01752         uint8_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0;
<a name="l01753"></a>01753         <span class="keywordflow">while</span> (!(<a class="code" href="classUFSHostDevice.html#adaa5cb5f2698e8d845d41615dc0ea074" title="To finish the transaction one needs information about the original message.">transferEnd</a>.front().mask &amp; (0x1 &lt;&lt; count)))
<a name="l01754"></a>01754             ++count;
<a name="l01755"></a>01755         <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a07947f527ad6944def2bb4add98c18d6" title="Histogram of latencies.">transactionLatency</a>.<a class="code" href="classStats_1_1DistBase.html#a5cb4a9cb9fac72ca7c0a8737c31d11be" title="Add a value to the distribtion n times.">sample</a>(<a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>() -
<a name="l01756"></a>01756                                         <a class="code" href="classUFSHostDevice.html#ac6cef6d6deeb2b63d75b9af0a7530c62" title="Helper for latency stats These variables keep track of the latency for every doorbell...">transactionStart</a>[count]);
<a name="l01757"></a>01757     }
<a name="l01758"></a>01758 
<a name="l01760"></a>01760     <a class="code" href="classUFSHostDevice.html#ad901dabdffb2047844f124ee5ce1328d" title="Dma transaction function: read device.">readDevice</a>(<span class="keyword">true</span>, <a class="code" href="classUFSHostDevice.html#adaa5cb5f2698e8d845d41615dc0ea074" title="To finish the transaction one needs information about the original message.">transferEnd</a>.front().address,
<a name="l01761"></a>01761                <a class="code" href="classUFSHostDevice.html#adaa5cb5f2698e8d845d41615dc0ea074" title="To finish the transaction one needs information about the original message.">transferEnd</a>.front().size, <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>
<a name="l01762"></a>01762                (<a class="code" href="classUFSHostDevice.html#adaa5cb5f2698e8d845d41615dc0ea074" title="To finish the transaction one needs information about the original message.">transferEnd</a>.front().destination), <span class="keyword">true</span>, NULL);
<a name="l01763"></a>01763 
<a name="l01765"></a>01765     <a class="code" href="classUFSHostDevice.html#a9fdd54e78b6c6797f78e869fe67b1362" title="Track the transfer This is allows the driver to &amp;quot;group&amp;quot; certain transfers...">transferTrack</a> &amp;= ~(<a class="code" href="classUFSHostDevice.html#adaa5cb5f2698e8d845d41615dc0ea074" title="To finish the transaction one needs information about the original message.">transferEnd</a>.front().mask);
<a name="l01766"></a>01766     --<a class="code" href="classUFSHostDevice.html#a16f2e11f7a738325c2670d4436a741b7" title="Statistics helper variables Active doorbells indicates how many doorbells are in...">activeDoorbells</a>;
<a name="l01767"></a>01767     ++<a class="code" href="classUFSHostDevice.html#a9ad1d3e7f1698d45335b6a5ec7128e04">pendingDoorbells</a>;
<a name="l01768"></a>01768     <a class="code" href="classUFSHostDevice.html#ad79d4e27ba055c7dee98c3faff190ac3" title="garbage queue, ensure clearing of the allocated memory">garbage</a>.push_back(<a class="code" href="classUFSHostDevice.html#adaa5cb5f2698e8d845d41615dc0ea074" title="To finish the transaction one needs information about the original message.">transferEnd</a>.front().destination);
<a name="l01769"></a>01769     <a class="code" href="classUFSHostDevice.html#adaa5cb5f2698e8d845d41615dc0ea074" title="To finish the transaction one needs information about the original message.">transferEnd</a>.pop_front();
<a name="l01770"></a>01770     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;UTP handled\n&quot;</span>);
<a name="l01771"></a>01771 
<a name="l01773"></a>01773     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a3cf6be69d2d598b2f94f7d5c1bb8c106">averageDoorbell</a> = <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a7b479e73fd8dcda6080ed2bd1274c8d3">maxDoorbell</a>.<a class="code" href="classStats_1_1ScalarBase.html#a493ab4422b5bfd7aed998cfd6f21b1de" title="Return the current value of this stat as its base type.">value</a>();
<a name="l01774"></a>01774 
<a name="l01775"></a>01775     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;activeDoorbells: %d, pendingDoorbells: %d,&quot;</span>
<a name="l01776"></a>01776             <span class="stringliteral">&quot; garbage: %d, TransferEvent: %d\n&quot;</span>, <a class="code" href="classUFSHostDevice.html#a16f2e11f7a738325c2670d4436a741b7" title="Statistics helper variables Active doorbells indicates how many doorbells are in...">activeDoorbells</a>,
<a name="l01777"></a>01777             <a class="code" href="classUFSHostDevice.html#a9ad1d3e7f1698d45335b6a5ec7128e04">pendingDoorbells</a>, <a class="code" href="classUFSHostDevice.html#ad79d4e27ba055c7dee98c3faff190ac3" title="garbage queue, ensure clearing of the allocated memory">garbage</a>.size(), <a class="code" href="classUFSHostDevice.html#a906cf4e1a2bd3226f9dc2ab047935cde">transferEventQueue</a>.size());
<a name="l01778"></a>01778 
<a name="l01780"></a>01780     <span class="keywordflow">if</span> (!<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun_id]-&gt;SCSIInfoQueue.empty())
<a name="l01781"></a>01781         <a class="code" href="classUFSHostDevice.html#abbd53b76896313d34e8c9ed20b5fc79c" title="Starts the scsi handling function in the apropriate Logic unit, prepares the right...">SCSIResume</a>(lun_id);
<a name="l01782"></a>01782 }
<a name="l01783"></a>01783 
<a name="l01787"></a>01787 <span class="keywordtype">void</span>
<a name="l01788"></a><a class="code" href="classUFSHostDevice.html#a716c4c8aa36cdc5b7057bba546e1f0bb">01788</a> <a class="code" href="classUFSHostDevice.html#a716c4c8aa36cdc5b7057bba546e1f0bb" title="Read done Started at the end of a transaction after the last read action.">UFSHostDevice::readDone</a>()
<a name="l01789"></a>01789 {
<a name="l01790"></a>01790     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Read done start\n&quot;</span>);
<a name="l01791"></a>01791     --<a class="code" href="classUFSHostDevice.html#a0c2bb7b9016db0c72c2c1640c9769966" title="Track number of DMA transactions in progress.">readPendingNum</a>;
<a name="l01792"></a>01792 
<a name="l01794"></a>01794     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#ad79d4e27ba055c7dee98c3faff190ac3" title="garbage queue, ensure clearing of the allocated memory">garbage</a>.size() &gt; 0) {
<a name="l01795"></a>01795         <span class="keyword">delete</span> <a class="code" href="classUFSHostDevice.html#ad79d4e27ba055c7dee98c3faff190ac3" title="garbage queue, ensure clearing of the allocated memory">garbage</a>.front();
<a name="l01796"></a>01796         <a class="code" href="classUFSHostDevice.html#ad79d4e27ba055c7dee98c3faff190ac3" title="garbage queue, ensure clearing of the allocated memory">garbage</a>.pop_front();
<a name="l01797"></a>01797         }
<a name="l01798"></a>01798 
<a name="l01800"></a>01800     <span class="keywordflow">if</span>(!(<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a47d13a137b1124b6c2bc1f8799507e5d" title="Operation and runtime registers.">ORInterruptStatus</a> &amp; 0x01)) {
<a name="l01801"></a>01801         <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#a47d13a137b1124b6c2bc1f8799507e5d" title="Operation and runtime registers.">ORInterruptStatus</a> |= <a class="code" href="classUFSHostDevice.html#a27697d97aa3d4781af6668f558d98cd7" title="Bits of interest within UFS data packages.">UTPTransferREQCOMPL</a>;
<a name="l01802"></a>01802         <a class="code" href="classUFSHostDevice.html#a99c0eda6ffc1939b05cb5e4492ac117b" title="set interrupt and sort out the doorbell register.">generateInterrupt</a>();
<a name="l01803"></a>01803     }
<a name="l01804"></a>01804 
<a name="l01805"></a>01805 
<a name="l01806"></a>01806     <span class="keywordflow">if</span>(!<a class="code" href="classUFSHostDevice.html#ac08ac50075113848011226ba98121ddb" title="Transfer flow events Basically these events form two queues, one from memory to UFS...">readDoneEvent</a>.empty()) {
<a name="l01807"></a>01807         <a class="code" href="classUFSHostDevice.html#ac08ac50075113848011226ba98121ddb" title="Transfer flow events Basically these events form two queues, one from memory to UFS...">readDoneEvent</a>.pop_front();
<a name="l01808"></a>01808     }
<a name="l01809"></a>01809 }
<a name="l01810"></a>01810 
<a name="l01815"></a>01815 <span class="keywordtype">void</span>
<a name="l01816"></a><a class="code" href="classUFSHostDevice.html#a99c0eda6ffc1939b05cb5e4492ac117b">01816</a> <a class="code" href="classUFSHostDevice.html#a99c0eda6ffc1939b05cb5e4492ac117b" title="set interrupt and sort out the doorbell register.">UFSHostDevice::generateInterrupt</a>()
<a name="l01817"></a>01817 {
<a name="l01819"></a>01819     <a class="code" href="classUFSHostDevice.html#ae9df73da0e26359e8b0f11d94b79a1c8" title="interrupt verification This keeps track of the number of interrupts generated.">countInt</a>++;
<a name="l01820"></a>01820 
<a name="l01822"></a>01822     <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a> &amp;= <a class="code" href="classUFSHostDevice.html#a9fdd54e78b6c6797f78e869fe67b1362" title="Track the transfer This is allows the driver to &amp;quot;group&amp;quot; certain transfers...">transferTrack</a>;
<a name="l01823"></a>01823     <a class="code" href="classUFSHostDevice.html#a9ad1d3e7f1698d45335b6a5ec7128e04">pendingDoorbells</a> = 0;
<a name="l01824"></a>01824     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Clear doorbell %X\n&quot;</span>, <a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>);
<a name="l01825"></a>01825 
<a name="l01827"></a>01827     <a class="code" href="classUFSHostDevice.html#a987ab112c90c4c3eb5d1ccbee82c864a">gic</a>-&gt;<a class="code" href="classBaseGic.html#a9f3e3273b9bb7b3b004d8702542f630e" title="Post an interrupt from a device that is connected to the GIC.">sendInt</a>(<a class="code" href="classUFSHostDevice.html#aaffec0570461ca146db679667d44876f">intNum</a>);
<a name="l01828"></a>01828     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Send interrupt @ transaction: 0x%8x!\n&quot;</span>,
<a name="l01829"></a>01829             <a class="code" href="classUFSHostDevice.html#ae9df73da0e26359e8b0f11d94b79a1c8" title="interrupt verification This keeps track of the number of interrupts generated.">countInt</a>);
<a name="l01830"></a>01830 }
<a name="l01831"></a>01831 
<a name="l01836"></a>01836 <span class="keywordtype">void</span>
<a name="l01837"></a><a class="code" href="classUFSHostDevice.html#a3570e43eb14a85c8e7840afd27eb9845">01837</a> <a class="code" href="classUFSHostDevice.html#a3570e43eb14a85c8e7840afd27eb9845" title="Interrupt control functions.">UFSHostDevice::clearInterrupt</a>()
<a name="l01838"></a>01838 {
<a name="l01839"></a>01839     <a class="code" href="classUFSHostDevice.html#a987ab112c90c4c3eb5d1ccbee82c864a">gic</a>-&gt;<a class="code" href="classBaseGic.html#a328f3e426fd8f8bb0a96341eee65d54c" title="Clear an interrupt from a device that is connected to the GIC.">clearInt</a>(<a class="code" href="classUFSHostDevice.html#aaffec0570461ca146db679667d44876f">intNum</a>);
<a name="l01840"></a>01840     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Clear interrupt: 0x%8x!\n&quot;</span>, <a class="code" href="classUFSHostDevice.html#ae9df73da0e26359e8b0f11d94b79a1c8" title="interrupt verification This keeps track of the number of interrupts generated.">countInt</a>);
<a name="l01841"></a>01841 
<a name="l01842"></a>01842     <span class="keywordflow">if</span> (!(<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>)) {
<a name="l01843"></a>01843         <a class="code" href="classUFSHostDevice.html#af08a84cb2546369cd56722161985d383">idlePhaseStart</a> = <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>();
<a name="l01844"></a>01844     }
<a name="l01846"></a>01846 }
<a name="l01847"></a>01847 
<a name="l01872"></a>01872 <span class="keywordtype">void</span>
<a name="l01873"></a><a class="code" href="classUFSHostDevice.html#a8c9877d376633c69e4188d0db080a589">01873</a> <a class="code" href="classUFSHostDevice.html#a8c9877d376633c69e4188d0db080a589" title="DMA transfer functions These allow the host to push/pull the data to the memory The...">UFSHostDevice::writeDevice</a>(<a class="code" href="classEvent.html">Event</a>* additional_action, <span class="keywordtype">bool</span> toDisk, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a>
<a name="l01874"></a>01874                            start, <span class="keywordtype">int</span> size, uint8_t* <a class="code" href="namespaceX86ISA.html#aa49a1e243decf460110b2436025d8823">destination</a>, uint64_t
<a name="l01875"></a>01875                            SCSIDiskOffset, uint32_t lun_id)
<a name="l01876"></a>01876 {
<a name="l01877"></a>01877     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write transaction Start: 0x%8x; Size: %d\n&quot;</span>,
<a name="l01878"></a>01878             start, size);
<a name="l01879"></a>01879 
<a name="l01881"></a>01881     <span class="keywordflow">if</span> (toDisk) {
<a name="l01882"></a>01882         ++<a class="code" href="classUFSHostDevice.html#a1ef599ebb3035b24426fd3a88e41cb5d">writePendingNum</a>;
<a name="l01883"></a>01883 
<a name="l01884"></a>01884         <span class="keywordflow">while</span>(!<a class="code" href="classUFSHostDevice.html#a7b9c9749123042c563cd1d6fde9074e7">writeDoneEvent</a>.empty() &amp;&amp; (<a class="code" href="classUFSHostDevice.html#a7b9c9749123042c563cd1d6fde9074e7">writeDoneEvent</a>.front().when()
<a name="l01885"></a>01885                                           &lt; <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>()))
<a name="l01886"></a>01886             <a class="code" href="classUFSHostDevice.html#a7b9c9749123042c563cd1d6fde9074e7">writeDoneEvent</a>.pop_front();
<a name="l01887"></a>01887 
<a name="l01888"></a>01888         <a class="code" href="classUFSHostDevice.html#a7b9c9749123042c563cd1d6fde9074e7">writeDoneEvent</a>.push_back(<span class="keyword">this</span>);
<a name="l01889"></a>01889         assert(!<a class="code" href="classUFSHostDevice.html#a7b9c9749123042c563cd1d6fde9074e7">writeDoneEvent</a>.back().scheduled());
<a name="l01890"></a>01890 
<a name="l01892"></a>01892         <span class="keyword">struct </span><a class="code" href="structUFSHostDevice_1_1transferInfo.html" title="Different events, and scenarios require different types of information.">transferInfo</a> new_transfer;
<a name="l01893"></a>01893         new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#aefa854de3f030b322c7cae6ba70799ff">offset</a> = SCSIDiskOffset;
<a name="l01894"></a>01894         new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#a56008d7471b5de71be81c7d7221522a4">size</a> = size;
<a name="l01895"></a>01895         new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#a8235fcc2f2ac7a0522c0460103bb1d92">lunID</a> = lun_id;
<a name="l01896"></a>01896         new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#af06b7cca56e405504ee077251537fac6">filePointer</a> = 0;
<a name="l01897"></a>01897         <a class="code" href="classUFSHostDevice.html#a170d0b32c309d44f0769def6a5d9ae41" title="Information from DMA transaction to disk.">SSDWriteinfo</a>.push_back(new_transfer);
<a name="l01898"></a>01898 
<a name="l01900"></a>01900         <a class="code" href="classUFSHostDevice.html#a170d0b32c309d44f0769def6a5d9ae41" title="Information from DMA transaction to disk.">SSDWriteinfo</a>.back().buffer.resize(size);
<a name="l01901"></a>01901 
<a name="l01903"></a>01903         <a class="code" href="classDmaDevice.html#adcc428c24da4c0a453f7b292997a06a9">dmaPort</a>.<a class="code" href="classDmaPort.html#a7958618461b4379816e5337c73153236">dmaAction</a>(<a class="code" href="classMemCmd.html#ae5c39c2de0ad998b5176bc519b358102aa21449f51bc9023b2dc730a7cd2cbf16">MemCmd::ReadReq</a>, start, size,
<a name="l01904"></a>01904                           &amp;<a class="code" href="classUFSHostDevice.html#a7b9c9749123042c563cd1d6fde9074e7">writeDoneEvent</a>.back(),
<a name="l01905"></a>01905                           &amp;<a class="code" href="classUFSHostDevice.html#a170d0b32c309d44f0769def6a5d9ae41" title="Information from DMA transaction to disk.">SSDWriteinfo</a>.back().buffer[0], 0);
<a name="l01906"></a>01906         <span class="comment">//yes, a readreq at a write device function is correct.</span>
<a name="l01907"></a>01907         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write to disk scheduled\n&quot;</span>);
<a name="l01908"></a>01908 
<a name="l01909"></a>01909     } <span class="keywordflow">else</span> {
<a name="l01910"></a>01910         assert(!additional_action-&gt;<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>());
<a name="l01911"></a>01911         <a class="code" href="classDmaDevice.html#adcc428c24da4c0a453f7b292997a06a9">dmaPort</a>.<a class="code" href="classDmaPort.html#a7958618461b4379816e5337c73153236">dmaAction</a>(<a class="code" href="classMemCmd.html#ae5c39c2de0ad998b5176bc519b358102aa21449f51bc9023b2dc730a7cd2cbf16">MemCmd::ReadReq</a>, start, size,
<a name="l01912"></a>01912                           additional_action, destination, 0);
<a name="l01913"></a>01913         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write scheduled\n&quot;</span>);
<a name="l01914"></a>01914     }
<a name="l01915"></a>01915 }
<a name="l01916"></a>01916 
<a name="l01922"></a>01922 <span class="keywordtype">void</span>
<a name="l01923"></a><a class="code" href="classUFSHostDevice.html#a43c98267d32cb45293de172eda4f04f7">01923</a> <a class="code" href="classUFSHostDevice.html#a43c98267d32cb45293de172eda4f04f7" title="Disk transfer management functions these set up the queues, and initiated them, leading...">UFSHostDevice::manageWriteTransfer</a>(uint8_t LUN, uint64_t <a class="code" href="namespaceArmISA.html#a19e4a68ca5c93c6136351d804b432b09">offset</a>, uint32_t
<a name="l01924"></a>01924                                    sg_table_length, <span class="keyword">struct</span> <a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html" title="struct UFSHCDSGEntry - UFSHCI PRD Entry baseAddr: Lower 32bit physical address DW-0...">UFSHCDSGEntry</a>*
<a name="l01925"></a>01925                                    sglist)
<a name="l01926"></a>01926 {
<a name="l01927"></a>01927     <span class="keyword">struct </span><a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html" title="Disk transfer burst information.">writeToDiskBurst</a> next_packet;
<a name="l01928"></a>01928 
<a name="l01929"></a>01929     next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a95ce91c55a426c2d31909bd41d222160">SCSIDiskOffset</a> = offset;
<a name="l01930"></a>01930 
<a name="l01931"></a>01931     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;setTotalWrite(sg_table_length);
<a name="l01932"></a>01932 
<a name="l01937"></a>01937     <span class="keywordflow">for</span> (uint32_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; sg_table_length; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++) {
<a name="l01938"></a>01938         next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a88b983d39149f5560614ddf17d58447f">start</a> = sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a39591760945b8859853cd55ab9d72aaf">upperAddr</a>;
<a name="l01939"></a>01939         next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a88b983d39149f5560614ddf17d58447f">start</a> = (next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a88b983d39149f5560614ddf17d58447f">start</a> &lt;&lt; 32) |
<a name="l01940"></a>01940             (sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].baseAddr &amp; 0xFFFFFFFF);
<a name="l01941"></a>01941         next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a26f4db4829b10374d6db5474f5bb87b8">LUN</a> = LUN;
<a name="l01942"></a>01942         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write data DMA start: 0x%8x\n&quot;</span>,
<a name="l01943"></a>01943                 next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a88b983d39149f5560614ddf17d58447f">start</a>);
<a name="l01944"></a>01944         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write data DMA size: 0x%8x\n&quot;</span>,
<a name="l01945"></a>01945                 (sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].size + 1));
<a name="l01946"></a>01946         assert(sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].size &gt; 0);
<a name="l01947"></a>01947 
<a name="l01948"></a>01948         <span class="keywordflow">if</span> (<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> != 0)
<a name="l01949"></a>01949             next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a95ce91c55a426c2d31909bd41d222160">SCSIDiskOffset</a> = next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a95ce91c55a426c2d31909bd41d222160">SCSIDiskOffset</a> +
<a name="l01950"></a>01950                 (sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> - 1].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a5e2eecd16309b8821bc9313b8ae50931">size</a> + 1);
<a name="l01951"></a>01951 
<a name="l01952"></a>01952         next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a5076a02ef8a7f779ae4ea0d550c76be5">size</a> = sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a5e2eecd16309b8821bc9313b8ae50931">size</a> + 1;
<a name="l01953"></a>01953 
<a name="l01955"></a>01955         <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#ac517d135aba91b1c6afb06a9f298936f" title="Information to get a DMA transaction.">dmaWriteInfo</a>.empty())
<a name="l01956"></a>01956             <a class="code" href="classUFSHostDevice.html#a8c9877d376633c69e4188d0db080a589" title="DMA transfer functions These allow the host to push/pull the data to the memory The...">writeDevice</a>(NULL, <span class="keyword">true</span>, next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a88b983d39149f5560614ddf17d58447f">start</a>, next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a5076a02ef8a7f779ae4ea0d550c76be5">size</a>,
<a name="l01957"></a>01957                         NULL, next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a95ce91c55a426c2d31909bd41d222160">SCSIDiskOffset</a>, next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a26f4db4829b10374d6db5474f5bb87b8">LUN</a>);
<a name="l01958"></a>01958         <span class="keywordflow">else</span>
<a name="l01959"></a>01959             <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write not initiated queue: %d\n&quot;</span>,
<a name="l01960"></a>01960                     <a class="code" href="classUFSHostDevice.html#ac517d135aba91b1c6afb06a9f298936f" title="Information to get a DMA transaction.">dmaWriteInfo</a>.size());
<a name="l01961"></a>01961 
<a name="l01962"></a>01962         <a class="code" href="classUFSHostDevice.html#ac517d135aba91b1c6afb06a9f298936f" title="Information to get a DMA transaction.">dmaWriteInfo</a>.push_back(next_packet);
<a name="l01963"></a>01963         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write Location: 0x%8x\n&quot;</span>,
<a name="l01964"></a>01964                 next_packet.<a class="code" href="structUFSHostDevice_1_1writeToDiskBurst.html#a95ce91c55a426c2d31909bd41d222160">SCSIDiskOffset</a>);
<a name="l01965"></a>01965 
<a name="l01966"></a>01966         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write transfer #: 0x%8x\n&quot;</span>, <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> + 1);
<a name="l01967"></a>01967 
<a name="l01969"></a>01969         <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#abb0ae411e57216d72afb5f35386b2d31">totalWrittenSSD</a> += (sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a5e2eecd16309b8821bc9313b8ae50931">size</a> + 1);
<a name="l01970"></a>01970     }
<a name="l01971"></a>01971 
<a name="l01973"></a>01973     ++<a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#aaf7fdd74be7d255ff861389bb8e9a8bd">totalWriteUFSTransactions</a>;
<a name="l01974"></a>01974 }
<a name="l01975"></a>01975 
<a name="l01981"></a>01981 <span class="keywordtype">void</span>
<a name="l01982"></a><a class="code" href="classUFSHostDevice.html#a8ae430d8a91a02c9c9029e214da46a3a">01982</a> <a class="code" href="classUFSHostDevice.html#a8ae430d8a91a02c9c9029e214da46a3a" title="Write done After a DMA write with data intended for the disk, this function is called...">UFSHostDevice::writeDone</a>()
<a name="l01983"></a>01983 {
<a name="l01985"></a>01985     assert(<a class="code" href="classUFSHostDevice.html#ac517d135aba91b1c6afb06a9f298936f" title="Information to get a DMA transaction.">dmaWriteInfo</a>.size() &gt; 0);
<a name="l01986"></a>01986     <a class="code" href="classUFSHostDevice.html#ac517d135aba91b1c6afb06a9f298936f" title="Information to get a DMA transaction.">dmaWriteInfo</a>.pop_front();
<a name="l01987"></a>01987     assert(<a class="code" href="classUFSHostDevice.html#a170d0b32c309d44f0769def6a5d9ae41" title="Information from DMA transaction to disk.">SSDWriteinfo</a>.size() &gt; 0);
<a name="l01988"></a>01988     uint32_t lun = <a class="code" href="classUFSHostDevice.html#a170d0b32c309d44f0769def6a5d9ae41" title="Information from DMA transaction to disk.">SSDWriteinfo</a>.front().lunID;
<a name="l01989"></a>01989 
<a name="l01991"></a>01991     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write done entered, queue: %d\n&quot;</span>,
<a name="l01992"></a>01992             <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun]-&gt;SSDWriteDoneInfo.size());
<a name="l01994"></a>01994     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun]-&gt;writeFlash(&amp;<a class="code" href="classUFSHostDevice.html#a170d0b32c309d44f0769def6a5d9ae41" title="Information from DMA transaction to disk.">SSDWriteinfo</a>.front().buffer[0],
<a name="l01995"></a>01995                                <a class="code" href="classUFSHostDevice.html#a170d0b32c309d44f0769def6a5d9ae41" title="Information from DMA transaction to disk.">SSDWriteinfo</a>.front().offset,
<a name="l01996"></a>01996                                <a class="code" href="classUFSHostDevice.html#a170d0b32c309d44f0769def6a5d9ae41" title="Information from DMA transaction to disk.">SSDWriteinfo</a>.front().size);
<a name="l01997"></a>01997 
<a name="l02003"></a>02003     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun]-&gt;SSDWriteDoneInfo.push_back(<a class="code" href="classUFSHostDevice.html#a170d0b32c309d44f0769def6a5d9ae41" title="Information from DMA transaction to disk.">SSDWriteinfo</a>.front());
<a name="l02004"></a>02004     <a class="code" href="classUFSHostDevice.html#a170d0b32c309d44f0769def6a5d9ae41" title="Information from DMA transaction to disk.">SSDWriteinfo</a>.pop_front();
<a name="l02005"></a>02005 
<a name="l02006"></a>02006     --<a class="code" href="classUFSHostDevice.html#a1ef599ebb3035b24426fd3a88e41cb5d">writePendingNum</a>;
<a name="l02008"></a>02008     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun]-&gt;SSDWriteStart();
<a name="l02009"></a>02009 
<a name="l02011"></a>02011     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a8a172bbf52ecd08342c5de5f8804363d">currentWriteSSDQueue</a> = <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun]-&gt;SSDWriteDoneInfo.size();
<a name="l02012"></a>02012     <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#aca9914fdc01d503c47c0438ba85af129">averageWriteSSDQueue</a> = <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[lun]-&gt;SSDWriteDoneInfo.size();
<a name="l02013"></a>02013     ++<a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#abf6416da786bec167b699a87ed46407a">totalWriteDiskTransactions</a>;
<a name="l02014"></a>02014 
<a name="l02016"></a>02016     <span class="keywordflow">if</span> (!<a class="code" href="classUFSHostDevice.html#ac517d135aba91b1c6afb06a9f298936f" title="Information to get a DMA transaction.">dmaWriteInfo</a>.empty())
<a name="l02017"></a>02017         <a class="code" href="classUFSHostDevice.html#a8c9877d376633c69e4188d0db080a589" title="DMA transfer functions These allow the host to push/pull the data to the memory The...">writeDevice</a>(NULL, <span class="keyword">true</span>, <a class="code" href="classUFSHostDevice.html#ac517d135aba91b1c6afb06a9f298936f" title="Information to get a DMA transaction.">dmaWriteInfo</a>.front().start,
<a name="l02018"></a>02018                     <a class="code" href="classUFSHostDevice.html#ac517d135aba91b1c6afb06a9f298936f" title="Information to get a DMA transaction.">dmaWriteInfo</a>.front().size,  NULL,
<a name="l02019"></a>02019                     <a class="code" href="classUFSHostDevice.html#ac517d135aba91b1c6afb06a9f298936f" title="Information to get a DMA transaction.">dmaWriteInfo</a>.front().SCSIDiskOffset,
<a name="l02020"></a>02020                     <a class="code" href="classUFSHostDevice.html#ac517d135aba91b1c6afb06a9f298936f" title="Information to get a DMA transaction.">dmaWriteInfo</a>.front().LUN);
<a name="l02021"></a>02021     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write done end\n&quot;</span>);
<a name="l02022"></a>02022 }
<a name="l02023"></a>02023 
<a name="l02027"></a>02027 <span class="keywordtype">void</span>
<a name="l02028"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#ad4d66dd01b4ed22da5f2201917e835e4">02028</a> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#ad4d66dd01b4ed22da5f2201917e835e4" title="SSD write start.">UFSHostDevice::UFSSCSIDevice::SSDWriteStart</a>()
<a name="l02029"></a>02029 {
<a name="l02030"></a>02030     assert(<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a91c3121844b28fa20400aab80252732f" title="SSDWriteDoneInfo: Structure from dma to disk, that contains data, and helper info...">SSDWriteDoneInfo</a>.size() &gt; 0);
<a name="l02031"></a>02031     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#af902c91070c5f1b4e4eeb51229534002">flashDevice</a>-&gt;<a class="code" href="classAbstractNVM.html#a9274e2b3ef2966207f6f8f5e54c17c83">writeMemory</a>(
<a name="l02032"></a>02032         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a91c3121844b28fa20400aab80252732f" title="SSDWriteDoneInfo: Structure from dma to disk, that contains data, and helper info...">SSDWriteDoneInfo</a>.front().offset,
<a name="l02033"></a>02033         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a91c3121844b28fa20400aab80252732f" title="SSDWriteDoneInfo: Structure from dma to disk, that contains data, and helper info...">SSDWriteDoneInfo</a>.front().size, <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#ac7d21125b58c99dacbc66990366bc0d3">memWriteCallback</a>);
<a name="l02034"></a>02034 
<a name="l02035"></a>02035     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a91c3121844b28fa20400aab80252732f" title="SSDWriteDoneInfo: Structure from dma to disk, that contains data, and helper info...">SSDWriteDoneInfo</a>.pop_front();
<a name="l02036"></a>02036 
<a name="l02037"></a>02037     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write is started; left in queue: %d\n&quot;</span>,
<a name="l02038"></a>02038             <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a91c3121844b28fa20400aab80252732f" title="SSDWriteDoneInfo: Structure from dma to disk, that contains data, and helper info...">SSDWriteDoneInfo</a>.size());
<a name="l02039"></a>02039 }
<a name="l02040"></a>02040 
<a name="l02041"></a>02041 
<a name="l02046"></a>02046 <span class="keywordtype">void</span>
<a name="l02047"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a0cdac87e701ba44f9730b881a406062c">02047</a> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a0cdac87e701ba44f9730b881a406062c" title="SSD Write Done; This is the callback function for the memory model.">UFSHostDevice::UFSSCSIDevice::SSDWriteDone</a>()
<a name="l02048"></a>02048 {
<a name="l02049"></a>02049     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write disk, aiming for %d messages, %d so far\n&quot;</span>,
<a name="l02050"></a>02050             <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a874e9b169496f13634c0f4a3398b0bee">totalWrite</a>, <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a5f13117b45f84478ce0b82b8a3457b93" title="transaction progress tracking">amountOfWriteTransfers</a>);
<a name="l02051"></a>02051 
<a name="l02052"></a>02052     <span class="comment">//we have done one extra transfer</span>
<a name="l02053"></a>02053     ++<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a5f13117b45f84478ce0b82b8a3457b93" title="transaction progress tracking">amountOfWriteTransfers</a>;
<a name="l02054"></a>02054 
<a name="l02056"></a>02056     assert(<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a874e9b169496f13634c0f4a3398b0bee">totalWrite</a> &gt;= <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a5f13117b45f84478ce0b82b8a3457b93" title="transaction progress tracking">amountOfWriteTransfers</a> &amp;&amp; <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a874e9b169496f13634c0f4a3398b0bee">totalWrite</a> != 0);
<a name="l02057"></a>02057 
<a name="l02059"></a>02059     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a874e9b169496f13634c0f4a3398b0bee">totalWrite</a> == <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a5f13117b45f84478ce0b82b8a3457b93" title="transaction progress tracking">amountOfWriteTransfers</a>) {
<a name="l02060"></a>02060         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Write transactions finished\n&quot;</span>);
<a name="l02061"></a>02061         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a874e9b169496f13634c0f4a3398b0bee">totalWrite</a> = 0;
<a name="l02062"></a>02062         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a5f13117b45f84478ce0b82b8a3457b93" title="transaction progress tracking">amountOfWriteTransfers</a> = 0;
<a name="l02063"></a>02063 
<a name="l02064"></a>02064         <span class="comment">//Callback UFS Host</span>
<a name="l02065"></a>02065         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a9793c88e63bc7266cec0da280bc17f38" title="set signal to indicate that the transaction has been completed.">setSignal</a>();
<a name="l02066"></a>02066         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a26a097ae58e5e1e1dfe2c25f2aef9178" title="Callbacks between Host and Device.">signalDone</a>-&gt;<a class="code" href="classCallback.html#abd55ae2a374bf4361387fb44552d80f7" title="virtual process function that is invoked when the callback queue is executed.">process</a>();
<a name="l02067"></a>02067     }
<a name="l02068"></a>02068 
<a name="l02069"></a>02069 }
<a name="l02070"></a>02070 
<a name="l02076"></a>02076 <span class="keywordtype">void</span>
<a name="l02077"></a><a class="code" href="classUFSHostDevice.html#ad901dabdffb2047844f124ee5ce1328d">02077</a> <a class="code" href="classUFSHostDevice.html#ad901dabdffb2047844f124ee5ce1328d" title="Dma transaction function: read device.">UFSHostDevice::readDevice</a>(<span class="keywordtype">bool</span> lastTransfer, <a class="code" href="base_2types_8hh.html#af1bb03d6a4ee096394a6749f0a169232" title="Address type This will probably be moved somewhere else in the near future.">Addr</a> start, uint32_t size,
<a name="l02078"></a>02078                           uint8_t* <a class="code" href="namespaceX86ISA.html#aa49a1e243decf460110b2436025d8823">destination</a>, <span class="keywordtype">bool</span> no_cache, <a class="code" href="classEvent.html">Event</a>*
<a name="l02079"></a>02079                           additional_action)
<a name="l02080"></a>02080 {
<a name="l02081"></a>02081     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Read start: 0x%8x; Size: %d, data[0]: 0x%8x\n&quot;</span>,
<a name="l02082"></a>02082             start, size, (reinterpret_cast&lt;uint32_t *&gt;(destination))[0]);
<a name="l02083"></a>02083 
<a name="l02085"></a>02085     <span class="keywordflow">if</span> (lastTransfer) {
<a name="l02086"></a>02086         ++<a class="code" href="classUFSHostDevice.html#a0c2bb7b9016db0c72c2c1640c9769966" title="Track number of DMA transactions in progress.">readPendingNum</a>;
<a name="l02087"></a>02087         <a class="code" href="classUFSHostDevice.html#ac08ac50075113848011226ba98121ddb" title="Transfer flow events Basically these events form two queues, one from memory to UFS...">readDoneEvent</a>.push_back(<span class="keyword">this</span>);
<a name="l02088"></a>02088         assert(!<a class="code" href="classUFSHostDevice.html#ac08ac50075113848011226ba98121ddb" title="Transfer flow events Basically these events form two queues, one from memory to UFS...">readDoneEvent</a>.back().scheduled());
<a name="l02089"></a>02089         <a class="code" href="classDmaDevice.html#adcc428c24da4c0a453f7b292997a06a9">dmaPort</a>.<a class="code" href="classDmaPort.html#a7958618461b4379816e5337c73153236">dmaAction</a>(<a class="code" href="classMemCmd.html#ae5c39c2de0ad998b5176bc519b358102a6b6c4696087b2f083bdad6d143d3f0c0">MemCmd::WriteReq</a>, start, size,
<a name="l02090"></a>02090                           &amp;<a class="code" href="classUFSHostDevice.html#ac08ac50075113848011226ba98121ddb" title="Transfer flow events Basically these events form two queues, one from memory to UFS...">readDoneEvent</a>.back(), destination, 0);
<a name="l02091"></a>02091         <span class="comment">//yes, a writereq at a read device function is correct.</span>
<a name="l02092"></a>02092 
<a name="l02093"></a>02093     } <span class="keywordflow">else</span> {
<a name="l02094"></a>02094         <span class="keywordflow">if</span> (additional_action != NULL)
<a name="l02095"></a>02095             assert(!additional_action-&gt;<a class="code" href="classEvent.html#a36bdc2ee73215ed7670a7bfc0f25ab8b" title="Determine if the current event is scheduled.">scheduled</a>());
<a name="l02096"></a>02096 
<a name="l02097"></a>02097         <a class="code" href="classDmaDevice.html#adcc428c24da4c0a453f7b292997a06a9">dmaPort</a>.<a class="code" href="classDmaPort.html#a7958618461b4379816e5337c73153236">dmaAction</a>(<a class="code" href="classMemCmd.html#ae5c39c2de0ad998b5176bc519b358102a6b6c4696087b2f083bdad6d143d3f0c0">MemCmd::WriteReq</a>, start, size,
<a name="l02098"></a>02098                           additional_action, destination, 0);
<a name="l02099"></a>02099 
<a name="l02100"></a>02100     }
<a name="l02101"></a>02101 
<a name="l02102"></a>02102 }
<a name="l02103"></a>02103 
<a name="l02109"></a>02109 <span class="keywordtype">void</span>
<a name="l02110"></a><a class="code" href="classUFSHostDevice.html#aebef3ab77126553cee4fb576cc989e31">02110</a> <a class="code" href="classUFSHostDevice.html#aebef3ab77126553cee4fb576cc989e31" title="Manage read transfer.">UFSHostDevice::manageReadTransfer</a>(uint32_t size, uint32_t LUN, uint64_t
<a name="l02111"></a>02111                                   <a class="code" href="namespaceArmISA.html#a19e4a68ca5c93c6136351d804b432b09">offset</a>, uint32_t sg_table_length,
<a name="l02112"></a>02112                                   <span class="keyword">struct</span> <a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html" title="struct UFSHCDSGEntry - UFSHCI PRD Entry baseAddr: Lower 32bit physical address DW-0...">UFSHCDSGEntry</a>* sglist)
<a name="l02113"></a>02113 {
<a name="l02114"></a>02114     uint32_t size_accum = 0;
<a name="l02115"></a>02115 
<a name="l02116"></a>02116     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Data READ size: %d\n&quot;</span>, size);
<a name="l02117"></a>02117 
<a name="l02122"></a>02122     <span class="keywordflow">for</span> (uint32_t <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> &lt; sg_table_length; <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>++) {
<a name="l02123"></a>02123         <span class="keyword">struct </span><a class="code" href="structUFSHostDevice_1_1transferInfo.html" title="Different events, and scenarios require different types of information.">transferInfo</a> new_transfer;
<a name="l02124"></a>02124         new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#aefa854de3f030b322c7cae6ba70799ff">offset</a> = sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a39591760945b8859853cd55ab9d72aaf">upperAddr</a>;
<a name="l02125"></a>02125         new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#aefa854de3f030b322c7cae6ba70799ff">offset</a> = (new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#aefa854de3f030b322c7cae6ba70799ff">offset</a> &lt;&lt; 32) |
<a name="l02126"></a>02126             (sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].baseAddr &amp; 0xFFFFFFFF);
<a name="l02127"></a>02127         new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#af06b7cca56e405504ee077251537fac6">filePointer</a> = offset + size_accum;
<a name="l02128"></a>02128         new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#a56008d7471b5de71be81c7d7221522a4">size</a> = (sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a5e2eecd16309b8821bc9313b8ae50931">size</a> + 1);
<a name="l02129"></a>02129         new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#a8235fcc2f2ac7a0522c0460103bb1d92">lunID</a> = LUN;
<a name="l02130"></a>02130 
<a name="l02131"></a>02131         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Data READ start: 0x%8x; size: %d\n&quot;</span>,
<a name="l02132"></a>02132                 new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#aefa854de3f030b322c7cae6ba70799ff">offset</a>, new_transfer.<a class="code" href="structUFSHostDevice_1_1transferInfo.html#a56008d7471b5de71be81c7d7221522a4">size</a>);
<a name="l02133"></a>02133 
<a name="l02134"></a>02134         <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;SSDReadInfo.push_back(new_transfer);
<a name="l02135"></a>02135         <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;SSDReadInfo.back().buffer.resize(sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].size
<a name="l02136"></a>02136                                                          + 1);
<a name="l02137"></a>02137 
<a name="l02143"></a>02143         <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;readFlash(&amp;<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;
<a name="l02144"></a>02144                                   SSDReadInfo.back().buffer[0],
<a name="l02145"></a>02145                                   offset + size_accum,
<a name="l02146"></a>02146                                   sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a5e2eecd16309b8821bc9313b8ae50931">size</a> + 1);
<a name="l02147"></a>02147 
<a name="l02148"></a>02148         size_accum += (sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a5e2eecd16309b8821bc9313b8ae50931">size</a> + 1);
<a name="l02149"></a>02149 
<a name="l02150"></a>02150         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Transfer %d; Remaining: 0x%8x, Accumulated:&quot;</span>
<a name="l02151"></a>02151                 <span class="stringliteral">&quot; 0x%8x\n&quot;</span>, (<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> + 1), (size-size_accum), size_accum);
<a name="l02152"></a>02152 
<a name="l02154"></a>02154         <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a74c51fedf7b3099ab65a2ba7c246f42a" title="Amount of data read/written.">totalReadSSD</a> += (sglist[<a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a>].<a class="code" href="structUFSHostDevice_1_1UFSHCDSGEntry.html#a5e2eecd16309b8821bc9313b8ae50931">size</a> + 1);
<a name="l02155"></a>02155         <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a43d0d620384cff08b2e92c2c00018bcf">currentReadSSDQueue</a> = <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;SSDReadInfo.size();
<a name="l02156"></a>02156         <a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a23109e7eed3e72e7ccf67d8448920e8d">averageReadSSDQueue</a> = <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;SSDReadInfo.size();
<a name="l02157"></a>02157     }
<a name="l02158"></a>02158 
<a name="l02159"></a>02159     <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[LUN]-&gt;SSDReadStart(sg_table_length);
<a name="l02160"></a>02160 
<a name="l02162"></a>02162     ++<a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a4c4d93883188a5f9d275d1c609b32d81">totalReadUFSTransactions</a>;
<a name="l02163"></a>02163 
<a name="l02164"></a>02164 }
<a name="l02165"></a>02165 
<a name="l02166"></a>02166 
<a name="l02167"></a>02167 
<a name="l02174"></a>02174 <span class="keywordtype">void</span>
<a name="l02175"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#af7c1c12234b53ffab3030d070f425010">02175</a> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#af7c1c12234b53ffab3030d070f425010" title="Start the transactions to (and from) the disk The host will queue all the transactions...">UFSHostDevice::UFSSCSIDevice::SSDReadStart</a>(uint32_t total_read)
<a name="l02176"></a>02176 {
<a name="l02177"></a>02177     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a29ca714c725f63640153212a293e5025" title="Total amount transactions that need to be made.">totalRead</a> = total_read;
<a name="l02178"></a>02178     <span class="keywordflow">for</span> (uint32_t number_handled = 0; number_handled &lt; <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a9f508af3e6c17046a46be683eb267307" title="SSDReadInfo: Structure from disk to dma, that contains data, and helper info to get...">SSDReadInfo</a>.size();
<a name="l02179"></a>02179          number_handled++) {
<a name="l02184"></a>02184         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#af902c91070c5f1b4e4eeb51229534002">flashDevice</a>-&gt;<a class="code" href="classAbstractNVM.html#ae0a089c473545774e4fbd44c334b854f" title="Access functions Access function to simulate a read/write access to the memory.">readMemory</a>(<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a9f508af3e6c17046a46be683eb267307" title="SSDReadInfo: Structure from disk to dma, that contains data, and helper info to get...">SSDReadInfo</a>.front().filePointer,
<a name="l02185"></a>02185                                 <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a9f508af3e6c17046a46be683eb267307" title="SSDReadInfo: Structure from disk to dma, that contains data, and helper info to get...">SSDReadInfo</a>.front().size, <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#aa9dd572ec9ef8b7e2d063e8509036fa4" title="Callbacks between Device and Memory.">memReadCallback</a>);
<a name="l02186"></a>02186     }
<a name="l02187"></a>02187 
<a name="l02188"></a>02188 }
<a name="l02189"></a>02189 
<a name="l02190"></a>02190 
<a name="l02195"></a>02195 <span class="keywordtype">void</span>
<a name="l02196"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#aa0cc090071f12edbb0db52c712a70c3e">02196</a> <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#aa0cc090071f12edbb0db52c712a70c3e" title="SSD Read done; Determines if the final callback of the transaction should be made...">UFSHostDevice::UFSSCSIDevice::SSDReadDone</a>()
<a name="l02197"></a>02197 {
<a name="l02198"></a>02198     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;SSD read done at lun %d, Aiming for %d messages,&quot;</span>
<a name="l02199"></a>02199             <span class="stringliteral">&quot; %d so far\n&quot;</span>, <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#ab100259190c4d2460f3863c742d7dfa6">lunID</a>, <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a29ca714c725f63640153212a293e5025" title="Total amount transactions that need to be made.">totalRead</a>, <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2dc780c849388bcac5d99b971653f4a9">amountOfReadTransfers</a>);
<a name="l02200"></a>02200 
<a name="l02201"></a>02201     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a29ca714c725f63640153212a293e5025" title="Total amount transactions that need to be made.">totalRead</a> == <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2dc780c849388bcac5d99b971653f4a9">amountOfReadTransfers</a>) {
<a name="l02202"></a>02202         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a29ca714c725f63640153212a293e5025" title="Total amount transactions that need to be made.">totalRead</a> = 0;
<a name="l02203"></a>02203         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2dc780c849388bcac5d99b971653f4a9">amountOfReadTransfers</a> = 0;
<a name="l02204"></a>02204 
<a name="l02206"></a>02206         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a9793c88e63bc7266cec0da280bc17f38" title="set signal to indicate that the transaction has been completed.">setSignal</a>();
<a name="l02207"></a>02207         <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a26a097ae58e5e1e1dfe2c25f2aef9178" title="Callbacks between Host and Device.">signalDone</a>-&gt;<a class="code" href="classCallback.html#abd55ae2a374bf4361387fb44552d80f7" title="virtual process function that is invoked when the callback queue is executed.">process</a>();
<a name="l02208"></a>02208     }
<a name="l02209"></a>02209 
<a name="l02210"></a>02210 }
<a name="l02211"></a>02211 
<a name="l02216"></a>02216 <span class="keywordtype">void</span>
<a name="l02217"></a><a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#acecca8cd74148f20ddc0b8e82bc46fdd">02217</a> <a class="code" href="classUFSHostDevice.html#ac4324a5e5064eca02bdbbdb99c830f73" title="Read callback Call back function for the logic units to indicate the completion of...">UFSHostDevice::UFSSCSIDevice::readCallback</a>()
<a name="l02218"></a>02218 {
<a name="l02219"></a>02219     ++<a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a2dc780c849388bcac5d99b971653f4a9">amountOfReadTransfers</a>;
<a name="l02220"></a>02220 
<a name="l02224"></a>02224     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a51e88737623b4fdb2d0236ee79cd0d68" title="set signal to indicate that the read action has been completed">setReadSignal</a>();
<a name="l02225"></a>02225     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#a369faf4970bc78c99ed7b4ee8352a5dc">deviceReadCallback</a>-&gt;<a class="code" href="classCallback.html#abd55ae2a374bf4361387fb44552d80f7" title="virtual process function that is invoked when the callback queue is executed.">process</a>();
<a name="l02226"></a>02226 
<a name="l02227"></a>02227     <span class="comment">//Are we done yet?</span>
<a name="l02228"></a>02228     <a class="code" href="classUFSHostDevice_1_1UFSSCSIDevice.html#aa0cc090071f12edbb0db52c712a70c3e" title="SSD Read done; Determines if the final callback of the transaction should be made...">SSDReadDone</a>();
<a name="l02229"></a>02229 }
<a name="l02230"></a>02230 
<a name="l02236"></a>02236 <span class="keywordtype">void</span>
<a name="l02237"></a><a class="code" href="classUFSHostDevice.html#ac4324a5e5064eca02bdbbdb99c830f73">02237</a> <a class="code" href="classUFSHostDevice.html#ac4324a5e5064eca02bdbbdb99c830f73" title="Read callback Call back function for the logic units to indicate the completion of...">UFSHostDevice::readCallback</a>()
<a name="l02238"></a>02238 {
<a name="l02239"></a>02239     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Read Callback\n&quot;</span>);
<a name="l02240"></a>02240     uint8_t this_lun = 0;
<a name="l02241"></a>02241 
<a name="l02242"></a>02242     <span class="comment">//while we haven&apos;t found the right lun, keep searching</span>
<a name="l02243"></a>02243     <span class="keywordflow">while</span>((this_lun &lt; <a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a>) &amp;&amp; !<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;finishedRead())
<a name="l02244"></a>02244         ++this_lun;
<a name="l02245"></a>02245 
<a name="l02246"></a>02246     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Found LUN %d messages pending for clean: %d\n&quot;</span>,
<a name="l02247"></a>02247             this_lun, <a class="code" href="classUFSHostDevice.html#a0c157aeb57ad361cda7a370559ab48cd" title="Information from the Disk, waiting to be pushed to the DMA.">SSDReadPending</a>.size());
<a name="l02248"></a>02248 
<a name="l02249"></a>02249     <span class="keywordflow">if</span> (this_lun &lt; <a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a>) {
<a name="l02250"></a>02250         <span class="comment">//Clear signal.</span>
<a name="l02251"></a>02251         <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;clearReadSignal();
<a name="l02252"></a>02252         <a class="code" href="classUFSHostDevice.html#a0c157aeb57ad361cda7a370559ab48cd" title="Information from the Disk, waiting to be pushed to the DMA.">SSDReadPending</a>.push_back(<a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;SSDReadInfo.front());
<a name="l02253"></a>02253         <a class="code" href="classUFSHostDevice.html#af41e655708399351b96c0d65d77adb04" title="logic units connected to the UFS Host device Note again that the &amp;quot;device&amp;quot;...">UFSDevice</a>[this_lun]-&gt;SSDReadInfo.pop_front();
<a name="l02254"></a>02254         <a class="code" href="classUFSHostDevice.html#a623d595cec1e11d9edaa207ba2d7471f" title="Event after a read to clean up the UTP data structures.">readGarbageEventQueue</a>.push_back(<span class="keyword">this</span>);
<a name="l02255"></a>02255 
<a name="l02256"></a>02256         <span class="comment">//make sure the queue is popped a the end of the dma transaction</span>
<a name="l02257"></a>02257         <a class="code" href="classUFSHostDevice.html#ad901dabdffb2047844f124ee5ce1328d" title="Dma transaction function: read device.">readDevice</a>(<span class="keyword">false</span>, <a class="code" href="classUFSHostDevice.html#a0c157aeb57ad361cda7a370559ab48cd" title="Information from the Disk, waiting to be pushed to the DMA.">SSDReadPending</a>.front().offset,
<a name="l02258"></a>02258                    <a class="code" href="classUFSHostDevice.html#a0c157aeb57ad361cda7a370559ab48cd" title="Information from the Disk, waiting to be pushed to the DMA.">SSDReadPending</a>.front().size,
<a name="l02259"></a>02259                    &amp;<a class="code" href="classUFSHostDevice.html#a0c157aeb57ad361cda7a370559ab48cd" title="Information from the Disk, waiting to be pushed to the DMA.">SSDReadPending</a>.front().buffer[0], <span class="keyword">false</span>,
<a name="l02260"></a>02260                    &amp;<a class="code" href="classUFSHostDevice.html#a623d595cec1e11d9edaa207ba2d7471f" title="Event after a read to clean up the UTP data structures.">readGarbageEventQueue</a>.back());
<a name="l02261"></a>02261 
<a name="l02263"></a>02263         ++<a class="code" href="classUFSHostDevice.html#afc5c67585a481a5fdc9f9ccdb110ae5a" title="RequestHandler stats.">stats</a>.<a class="code" href="structUFSHostDevice_1_1UFSHostDeviceStats.html#a41045da6e6a2fe8908a4f4ade559c32b">totalReadDiskTransactions</a>;
<a name="l02264"></a>02264     }
<a name="l02265"></a>02265     <span class="keywordflow">else</span>
<a name="l02266"></a>02266         <a class="code" href="base_2misc_8hh.html#a1445e207e36c97ff84c54b47288cea19">panic</a>(<span class="stringliteral">&quot;no read finished in tick %d\n&quot;</span>, <a class="code" href="statistics_8hh.html#a7acdccbf0d35ce0c159c0cdd36371b22" title="The current simulated tick.">curTick</a>());
<a name="l02267"></a>02267 }
<a name="l02268"></a>02268 
<a name="l02273"></a>02273 <span class="keywordtype">void</span>
<a name="l02274"></a><a class="code" href="classUFSHostDevice.html#a83f5818b278086314c754455d514e03f">02274</a> <a class="code" href="classUFSHostDevice.html#a83f5818b278086314c754455d514e03f" title="Read garbage A read from disk data structure can vary in size and is therefor allocated...">UFSHostDevice::readGarbage</a>()
<a name="l02275"></a>02275 {
<a name="l02276"></a>02276     <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;Clean read data, %d\n&quot;</span>, <a class="code" href="classUFSHostDevice.html#a0c157aeb57ad361cda7a370559ab48cd" title="Information from the Disk, waiting to be pushed to the DMA.">SSDReadPending</a>.size());
<a name="l02277"></a>02277     <a class="code" href="classUFSHostDevice.html#a0c157aeb57ad361cda7a370559ab48cd" title="Information from the Disk, waiting to be pushed to the DMA.">SSDReadPending</a>.pop_front();
<a name="l02278"></a>02278     <a class="code" href="classUFSHostDevice.html#a623d595cec1e11d9edaa207ba2d7471f" title="Event after a read to clean up the UTP data structures.">readGarbageEventQueue</a>.pop_front();
<a name="l02279"></a>02279 }
<a name="l02280"></a>02280 
<a name="l02285"></a>02285 <span class="keywordtype">void</span>
<a name="l02286"></a><a class="code" href="classUFSHostDevice.html#a47801b1a2e4a15d1ae9e2b0cce1dc27a">02286</a> <a class="code" href="classUFSHostDevice.html#a47801b1a2e4a15d1ae9e2b0cce1dc27a" title="Serialize; needed to make checkpoints.">UFSHostDevice::serialize</a>(std::ostream &amp;<a class="code" href="namespaceX86ISA.html#aea9fbab71662ba06cf536e05edfaaad1">os</a>)
<a name="l02287"></a>02287 {
<a name="l02288"></a>02288     <a class="code" href="classUFSHostDevice.html#a47801b1a2e4a15d1ae9e2b0cce1dc27a" title="Serialize; needed to make checkpoints.">DmaDevice::serialize</a>(os);
<a name="l02289"></a>02289 
<a name="l02290"></a>02290     uint8_t* temp_HCI_mem = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>);
<a name="l02291"></a>02291     <a class="code" href="serialize_8hh.html#a9aa03522128bc19a3bc0294501226f8b">SERIALIZE_ARRAY</a>(temp_HCI_mem, <span class="keyword">sizeof</span>(<a class="code" href="structUFSHostDevice_1_1HCIMem.html" title="Host Controller Interface This is a set of registers that allow the driver to control...">HCIMem</a>));
<a name="l02292"></a>02292 
<a name="l02293"></a>02293     uint32_t lun_avail = <a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a>;
<a name="l02294"></a>02294     <a class="code" href="serialize_8hh.html#a49163149ec656ffecff0e46aee418e29">SERIALIZE_SCALAR</a>(lun_avail);
<a name="l02295"></a>02295 }
<a name="l02296"></a>02296 
<a name="l02297"></a>02297 
<a name="l02302"></a>02302 <span class="keywordtype">void</span>
<a name="l02303"></a><a class="code" href="classUFSHostDevice.html#a514c422a734637c333e37886f86a528a">02303</a> <a class="code" href="classUFSHostDevice.html#a514c422a734637c333e37886f86a528a" title="Unserialize; needed to restore from checkpoints.">UFSHostDevice::unserialize</a>(<a class="code" href="classCheckpoint.html">Checkpoint</a> *cp, <span class="keyword">const</span> std::string &amp;section)
<a name="l02304"></a>02304 {
<a name="l02305"></a>02305     <a class="code" href="classUFSHostDevice.html#a514c422a734637c333e37886f86a528a" title="Unserialize; needed to restore from checkpoints.">DmaDevice::unserialize</a>(cp, section);
<a name="l02306"></a>02306     uint8_t* temp_HCI_mem = <span class="keyword">reinterpret_cast&lt;</span>uint8_t*<span class="keyword">&gt;</span>(&amp;<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>);
<a name="l02307"></a>02307     <a class="code" href="serialize_8hh.html#a8de12bf68d0f92f7ab8585820607932e">UNSERIALIZE_ARRAY</a>(temp_HCI_mem, <span class="keyword">sizeof</span>(<a class="code" href="structUFSHostDevice_1_1HCIMem.html" title="Host Controller Interface This is a set of registers that allow the driver to control...">HCIMem</a>));
<a name="l02308"></a>02308 
<a name="l02309"></a>02309     uint32_t lun_avail;
<a name="l02310"></a>02310     <a class="code" href="serialize_8hh.html#a13d18ccba3d8bcbcd5aab2e37c380bff">UNSERIALIZE_SCALAR</a>(lun_avail);
<a name="l02311"></a>02311     assert(<a class="code" href="classUFSHostDevice.html#a5bca87883eaaf14f7e657d2b912cd20d">lunAvail</a> == lun_avail);
<a name="l02312"></a>02312 }
<a name="l02313"></a>02313 
<a name="l02314"></a>02314 
<a name="l02319"></a>02319 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>
<a name="l02320"></a><a class="code" href="classUFSHostDevice.html#aa682ec081f300a366492687287dfdfa7">02320</a> <a class="code" href="classUFSHostDevice.html#aa682ec081f300a366492687287dfdfa7" title="Drain; needed to enable checkpoints.">UFSHostDevice::drain</a>(<a class="code" href="classDrainManager.html" title="This class coordinates draining of a System.">DrainManager</a> *<a class="code" href="namespaceMipsISA.html#afed89bf85db8c823833a4921f0b24ac8">dm</a>)
<a name="l02321"></a>02321 {
<a name="l02322"></a>02322     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="namespaceX86ISA.html#a749793fafee6c9c40af6247a89e054ac">count</a> = 0;
<a name="l02323"></a>02323 
<a name="l02324"></a>02324     <span class="comment">// check pio, dma port, and doorbells</span>
<a name="l02325"></a>02325     count = <a class="code" href="classPioDevice.html#a81c4d0791b19b64007a79efe336a65e8" title="The pioPort that handles the requests for us and provides us requests that it sees...">pioPort</a>.<a class="code" href="classQueuedSlavePort.html#a86b3526181124e25a7f42c1c2027d1ec">drain</a>(dm) + <a class="code" href="classDmaDevice.html#adcc428c24da4c0a453f7b292997a06a9">dmaPort</a>.<a class="code" href="classDmaPort.html#a4b32fa5eddee7eab3af628f9504aa3de">drain</a>(dm);
<a name="l02326"></a>02326 
<a name="l02327"></a>02327     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>) {
<a name="l02328"></a>02328         count += 1;
<a name="l02329"></a>02329         <a class="code" href="classUFSHostDevice.html#aaeca5f87415474b86c6c3690e68f9e88" title="drain manager Needed to be able to implement checkpoint functionality">drainManager</a> = dm;
<a name="l02330"></a>02330     } <span class="keywordflow">else</span> {
<a name="l02331"></a>02331         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;UFSHostDevice in drained state\n&quot;</span>);
<a name="l02332"></a>02332     }
<a name="l02333"></a>02333 
<a name="l02334"></a>02334     <span class="keywordflow">if</span> (count) {
<a name="l02335"></a>02335         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;UFSDevice is draining...\n&quot;</span>);
<a name="l02336"></a>02336         <a class="code" href="classDrainable.html#afce7a34e1fcacc71267a947a3feb941b">setDrainState</a>(<a class="code" href="classDrainable.html#a6173416423af6af1bfe17262be40b5ffabd11bb9d2e9941029e08925c2a151162" title="Running normally.">Drainable::Draining</a>);
<a name="l02337"></a>02337     } <span class="keywordflow">else</span> {
<a name="l02338"></a>02338         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;UFSDevice drained\n&quot;</span>);
<a name="l02339"></a>02339         <a class="code" href="classDrainable.html#afce7a34e1fcacc71267a947a3feb941b">setDrainState</a>(<a class="code" href="classDrainable.html#a6173416423af6af1bfe17262be40b5ffad08d746efca2f68aeb28f73f94237603" title="Draining buffers pending serialization/handover.">Drainable::Drained</a>);
<a name="l02340"></a>02340     }
<a name="l02341"></a>02341     <span class="keywordflow">return</span> count;
<a name="l02342"></a>02342 }
<a name="l02343"></a>02343 
<a name="l02348"></a>02348 <span class="keywordtype">void</span>
<a name="l02349"></a><a class="code" href="classUFSHostDevice.html#aaa4c519c77e200fb2473d6b7263686c7">02349</a> <a class="code" href="classUFSHostDevice.html#aaa4c519c77e200fb2473d6b7263686c7" title="Checkdrain; needed to enable checkpoints.">UFSHostDevice::checkDrain</a>()
<a name="l02350"></a>02350 {
<a name="l02351"></a>02351     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#aaeca5f87415474b86c6c3690e68f9e88" title="drain manager Needed to be able to implement checkpoint functionality">drainManager</a> == NULL) {
<a name="l02352"></a>02352         <span class="keywordflow">return</span>;
<a name="l02353"></a>02353     }
<a name="l02354"></a>02354 
<a name="l02355"></a>02355     <span class="keywordflow">if</span> (<a class="code" href="classUFSHostDevice.html#a42bb5c0dfc5f68271dfa9341da2f90c5" title="Host controller memory.">UFSHCIMem</a>.<a class="code" href="structUFSHostDevice_1_1HCIMem.html#ac7d50898a3d027db433676adba473db5">TRUTRLDBR</a>) {
<a name="l02356"></a>02356         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;UFSDevice is still draining; with %d active&quot;</span>
<a name="l02357"></a>02357             <span class="stringliteral">&quot; doorbells\n&quot;</span>, <a class="code" href="classUFSHostDevice.html#a16f2e11f7a738325c2670d4436a741b7" title="Statistics helper variables Active doorbells indicates how many doorbells are in...">activeDoorbells</a>);
<a name="l02358"></a>02358     } <span class="keywordflow">else</span> {
<a name="l02359"></a>02359         <a class="code" href="base_2trace_8hh.html#aefe58fddf89e41edd783bf4c3e31d2c3">DPRINTF</a>(<a class="code" href="classUFSHostDevice.html" title="UFS command flow state machine digraph CommandFlow{ node [fontsize=10]; IDLE -&amp;gt;...">UFSHostDevice</a>, <span class="stringliteral">&quot;UFSDevice is done draining\n&quot;</span>);
<a name="l02360"></a>02360         <a class="code" href="classUFSHostDevice.html#aaeca5f87415474b86c6c3690e68f9e88" title="drain manager Needed to be able to implement checkpoint functionality">drainManager</a>-&gt;<a class="code" href="classDrainManager.html#abd134e8277be09e702b63f36f6ee31d0" title="Notify the DrainManager that a Drainable object has finished draining.">signalDrainDone</a>();
<a name="l02361"></a>02361         <a class="code" href="classUFSHostDevice.html#aaeca5f87415474b86c6c3690e68f9e88" title="drain manager Needed to be able to implement checkpoint functionality">drainManager</a> = NULL;
<a name="l02362"></a>02362     }
<a name="l02363"></a>02363 }
</pre></div></div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&nbsp;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"><address style="align: right;"><small>
Generated on Mon Dec 7 02:33:10 2015 for gem5 by <a href="http://www.doxygen.org/index.html"> doxygen</a> 1.6.1</small></address>

</body>
</html>
